This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.dockerignore
.editorconfig
.env.example
.gitattributes
.github/workflows/ci.yml
.gitignore
.husky/pre-commit
.prettierrc
app/Console/Commands/IndexProducts.php
app/Http/Controllers/Auth/AuthenticatedSessionController.php
app/Http/Controllers/Auth/ConfirmablePasswordController.php
app/Http/Controllers/Auth/EmailVerificationNotificationController.php
app/Http/Controllers/Auth/EmailVerificationPromptController.php
app/Http/Controllers/Auth/NewPasswordController.php
app/Http/Controllers/Auth/PasswordController.php
app/Http/Controllers/Auth/PasswordResetLinkController.php
app/Http/Controllers/Auth/RegisteredUserController.php
app/Http/Controllers/Auth/VerifyEmailController.php
app/Http/Controllers/Controller.php
app/Http/Controllers/ProfileController.php
app/Http/Middleware/HandleInertiaRequests.php
app/Http/Requests/Auth/LoginRequest.php
app/Http/Requests/ProfileUpdateRequest.php
app/Mail/ReservationConfirmed.php
app/Models/User.php
app/Notifications/ReservationCreated.php
app/Observers/ProductObserver.php
app/Observers/ServiceObserver.php
app/Observers/UserObserver.php
app/Observers/VehiculoObserver.php
app/Observers/WorkOrderObserver.php
app/Policies/VehiculoPolicy.php
app/Providers/AppServiceProvider.php
app/Providers/BroadcastServiceProvider.php
app/Providers/PolicyServiceProvider.php
app/Services/ChatbotService.php
app/Services/EmbeddingService.php
artisan
bootstrap/app.php
bootstrap/cache/.gitignore
bootstrap/providers.php
composer.json
config/app.php
config/auth.php
config/broadcasting.php
config/cache.php
config/database.php
config/filesystems.php
config/logging.php
config/mail.php
config/permission.php
config/queue.php
config/reverb.php
config/services.php
config/session.php
database/.gitignore
database/factories/ProductFactory.php
database/factories/SupplierFactory.php
database/factories/UserFactory.php
database/factories/VehiculoFactory.php
database/migrations/0001_01_01_000000_create_users_table.php
database/migrations/0001_01_01_000001_create_cache_table.php
database/migrations/0001_01_01_000002_create_jobs_table.php
database/migrations/2025_11_03_130548_create_permission_tables.php
database/migrations/2025_11_04_010930_create_vehiculos_table.php
database/migrations/2025_11_04_193207_create_suppliers_table.php
database/migrations/2025_11_04_193251_create_products_table.php
database/migrations/2025_11_04_193421_create_product_supplier_table.php
database/migrations/2025_11_04_193514_create_inventory_movements_table.php
database/migrations/2025_11_06_010312_create_work_orders_table.php
database/migrations/2025_11_06_010608_create_work_order_product_table.php
database/migrations/2025_11_06_015636_create_services_table.php
database/migrations/2025_11_06_015800_create_work_order_service_table.php
database/migrations/2025_11_06_015847_create_external_costs_table.php
database/migrations/2025_11_06_224559_create_daily_capacities_table.php
database/migrations/2025_11_06_224636_create_reservations_table.php
database/migrations/2025_11_18_035950_create_notifications_table.php
database/migrations/2025_11_21_130534_add_embedding_to_products_table.php
database/seeders/DatabaseSeeder.php
database/seeders/DemoSeeder.php
docker/entrypoint.sh
docker/nginx.conf
docker/supervisord.conf
Dockerfile
eslint.config.js
jsconfig.json
lang/es.json
lang/es/actions.php
lang/es/auth.php
lang/es/http-statuses.php
lang/es/pagination.php
lang/es/passwords.php
lang/es/validation.php
package.json
phpunit.xml
postcss.config.js
public/.htaccess
public/favicon.ico
public/images/logo-dark.png
public/images/logo-full.jpg
public/images/logo-light.png
public/index.php
public/robots.txt
public/videos/mechanic-bg.mp4
README.md
resources/css/app.css
resources/js/app.js
resources/js/bootstrap.js
resources/js/Components/ApplicationLogo.vue
resources/js/Components/ChatbotWidget.vue
resources/js/Components/Checkbox.vue
resources/js/Components/ConfirmationModal.vue
resources/js/Components/DangerButton.vue
resources/js/Components/Dashboard/BarChart.vue
resources/js/Components/Dashboard/DoughnutChart.vue
resources/js/Components/Dashboard/StatCard.vue
resources/js/Components/Dropdown.vue
resources/js/Components/DropdownLink.vue
resources/js/Components/FlashMessage.vue
resources/js/Components/InputError.vue
resources/js/Components/InputLabel.vue
resources/js/Components/Modal.vue
resources/js/Components/NavLink.vue
resources/js/Components/NotificationBell.vue
resources/js/Components/Pagination.vue
resources/js/Components/PrimaryButton.vue
resources/js/Components/ResponsiveNavLink.vue
resources/js/Components/SearchInput.vue
resources/js/Components/SecondaryButton.vue
resources/js/Components/Sidebar.vue
resources/js/Components/TextInput.vue
resources/js/Composables/useAudioSynthesis.js
resources/js/Composables/useDarkMode.js
resources/js/Layouts/AuthenticatedLayout.vue
resources/js/Layouts/GuestLayout.vue
resources/js/Layouts/PublicLayout.vue
resources/js/Pages/Auth/ConfirmPassword.vue
resources/js/Pages/Auth/ForgotPassword.vue
resources/js/Pages/Auth/Login.vue
resources/js/Pages/Auth/Register.vue
resources/js/Pages/Auth/ResetPassword.vue
resources/js/Pages/Auth/VerifyEmail.vue
resources/js/Pages/ClientPortal/Dashboard.vue
resources/js/Pages/ClientPortal/Vehicles/Create.vue
resources/js/Pages/ClientPortal/Vehicles/Edit.vue
resources/js/Pages/ClientPortal/Vehicles/Index.vue
resources/js/Pages/ClientScheduling/BookingIndex.vue
resources/js/Pages/Crm/Clientes/Create.vue
resources/js/Pages/Crm/Clientes/Edit.vue
resources/js/Pages/Crm/Clientes/Index.vue
resources/js/Pages/Crm/Clientes/Show.vue
resources/js/Pages/Crm/Vehiculos/Create.vue
resources/js/Pages/Crm/Vehiculos/Edit.vue
resources/js/Pages/Dashboard.vue
resources/js/Pages/Inventory/Products/Create.vue
resources/js/Pages/Inventory/Products/Edit.vue
resources/js/Pages/Inventory/Products/Index.vue
resources/js/Pages/Inventory/Suppliers/Create.vue
resources/js/Pages/Inventory/Suppliers/Edit.vue
resources/js/Pages/Inventory/Suppliers/Index.vue
resources/js/Pages/MechanicPanel/Dashboard.vue
resources/js/Pages/Profile/Edit.vue
resources/js/Pages/Profile/Partials/DeleteUserForm.vue
resources/js/Pages/Profile/Partials/UpdatePasswordForm.vue
resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.vue
resources/js/Pages/Scheduling/Admin/CapacityIndex.vue
resources/js/Pages/Scheduling/Admin/ReservationIndex.vue
resources/js/Pages/Welcome.vue
resources/js/Pages/WorkManagement/Create.vue
resources/js/Pages/WorkManagement/Index.vue
resources/js/Pages/WorkManagement/Services/Create.vue
resources/js/Pages/WorkManagement/Services/Edit.vue
resources/js/Pages/WorkManagement/Services/Index.vue
resources/js/Pages/WorkManagement/Show.vue
resources/js/ziggy.js
resources/views/app.blade.php
resources/views/emails/reservations/confirmed.blade.php
routes/auth.php
routes/channels.php
routes/console.php
src/ClientPortal/Http/Controllers/DashboardController.php
src/ClientPortal/Http/Controllers/VehiculoController.php
src/ClientPortal/Providers/ClientPortalServiceProvider.php
src/ClientPortal/routes/web.php
src/ClientScheduling/Http/Controllers/BookingController.php
src/ClientScheduling/Providers/ClientSchedulingServiceProvider.php
src/ClientScheduling/routes/web.php
src/Core/Http/Controllers/ChatbotController.php
src/Core/Http/Controllers/DashboardController.php
src/Core/Providers/CoreServiceProvider.php
src/Core/routes/web.php
src/Crm/Actions/CreateUserAsClientAction.php
src/Crm/Http/Controllers/CrmController.php
src/Crm/Http/Controllers/VehiculoController.php
src/Crm/Http/Requests/StoreUserAsClientRequest.php
src/Crm/Http/Requests/UpdateUserAsClientRequest.php
src/Crm/Http/Requests/UpdateVehiculoRequest.php
src/Crm/Models/Vehiculo.php
src/Crm/Providers/CrmServiceProvider.php
src/Crm/routes/web.php
src/Inventory/Actions/ActualizarProductoAction.php
src/Inventory/Actions/CrearNuevoProductoAction.php
src/Inventory/Http/Controllers/ProductController.php
src/Inventory/Http/Controllers/SupplierController.php
src/Inventory/Http/Requests/StoreProductRequest.php
src/Inventory/Http/Requests/StoreSupplierRequest.php
src/Inventory/Http/Requests/UpdateProductRequest.php
src/Inventory/Http/Requests/UpdateSupplierRequest.php
src/Inventory/Models/InventoryMovement.php
src/Inventory/Models/Product.php
src/Inventory/Models/Supplier.php
src/Inventory/Providers/InventoryServiceProvider.php
src/Inventory/routes/web.php
src/MechanicPanel/Http/Controllers/DashboardController.php
src/MechanicPanel/Providers/MechanicPanelServiceProvider.php
src/MechanicPanel/routes/web.php
src/Scheduling/Http/Controllers/CapacityController.php
src/Scheduling/Http/Controllers/ReservationController.php
src/Scheduling/Models/DailyCapacity.php
src/Scheduling/Models/Reservation.php
src/Scheduling/Providers/SchedulingServiceProvider.php
src/Scheduling/routes/admin.php
src/WorkManagement/Http/Controllers/ServiceController.php
src/WorkManagement/Http/Controllers/WorkOrderController.php
src/WorkManagement/Http/Requests/StoreServiceRequest.php
src/WorkManagement/Http/Requests/UpdateServiceRequest.php
src/WorkManagement/Models/ExternalCost.php
src/WorkManagement/Models/Service.php
src/WorkManagement/Models/WorkOrder.php
src/WorkManagement/Providers/WorkManagementServiceProvider.php
src/WorkManagement/routes/web.php
storage/app/.gitignore
storage/app/private/.gitignore
storage/app/public/.gitignore
storage/framework/.gitignore
storage/framework/cache/.gitignore
storage/framework/cache/data/.gitignore
storage/framework/sessions/.gitignore
storage/framework/testing/.gitignore
storage/framework/views/.gitignore
storage/logs/.gitignore
tailwind.config.js
tests/Feature/Auth/AuthenticationTest.php
tests/Feature/Auth/EmailVerificationTest.php
tests/Feature/Auth/PasswordConfirmationTest.php
tests/Feature/Auth/PasswordResetTest.php
tests/Feature/Auth/PasswordUpdateTest.php
tests/Feature/Auth/RegistrationTest.php
tests/Feature/Crm/ClientCreationTest.php
tests/Feature/ExampleTest.php
tests/Feature/ProfileTest.php
tests/TestCase.php
tests/Unit/ExampleTest.php
tests/Unit/ProductPriceTest.php
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".dockerignore">
/vendor/
/node_modules/
/.env
/.env.backup
/.git
/.github
/tests
/storage/*.key
Dockerfile
README.md
</file>

<file path=".editorconfig">
root = true

[*]
charset = utf-8
end_of_line = lf
indent_size = 4
indent_style = space
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false

[*.{yml,yaml}]
indent_size = 2

[compose.yaml]
indent_size = 4
</file>

<file path=".gitattributes">
* text=auto eol=lf

*.blade.php diff=html
*.css diff=css
*.html diff=html
*.md diff=markdown
*.php diff=php

/.github export-ignore
CHANGELOG.md export-ignore
.styleci.yml export-ignore
</file>

<file path=".gitignore">
*.log
.DS_Store
.env
.env.backup
.env.production
.phpactor.json
.phpunit.result.cache
/.fleet
/.idea
/.nova
/.phpunit.cache
/.vscode
/.zed
/auth.json
/node_modules
/public/build
/public/hot
/public/storage
/storage/*.key
/storage/pail
/vendor
Homestead.json
Homestead.yaml
Thumbs.db
</file>

<file path=".prettierrc">
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 4,
  "trailingComma": "es5",
  "printWidth": 120
}
</file>

<file path="app/Console/Commands/IndexProducts.php">
<?php

namespace App\Console\Commands;

use App\Services\EmbeddingService;
use FlipperBox\Inventory\Models\Product;
use Illuminate\Console\Command;

class IndexProducts extends Command
{
    protected $signature = 'products:index {--all : Forzar re-indexado de todos los productos}';

    protected $description = 'Generar embeddings para productos del inventario';

    public function handle(EmbeddingService $embeddingService): int
    {
        $this->info('Iniciando indexación de productos...');

        $query = Product::query();

        if (! $this->option('all')) {
            $query->whereNull('embedding');
            $this->info('Modo: Solo productos sin embedding.');
        } else {
            $this->info('Modo: Re-indexado completo.');
        }

        $total = $query->count();
        $bar = $this->output->createProgressBar($total);
        $bar->start();

        $query->chunk(50, function ($products) use ($embeddingService, $bar) {
            foreach ($products as $product) {
                $text = "Producto: {$product->name}. SKU: {$product->sku}. Descripción: {$product->description}.";
                $embedding = $embeddingService->generate($text);

                if ($embedding) {
                    $product->embedding = $embedding;
                    $product->saveQuietly();
                } else {
                    $this->error("\nError generando embedding para ID: {$product->id}");
                }

                $bar->advance();
            }
        });

        $bar->finish();
        $this->newLine();
        $this->info('Indexación completada.');

        return self::SUCCESS;
    }
}
</file>

<file path="app/Http/Controllers/Auth/ConfirmablePasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class ConfirmablePasswordController extends Controller
{
    /**
     * Show the confirm password view.
     */
    public function show(): Response
    {
        return Inertia::render('Auth/ConfirmPassword');
    }

    /**
     * Confirm the user's password.
     */
    public function store(Request $request): RedirectResponse
    {
        if (! Auth::guard('web')->validate([
            'email' => $request->user()->email,
            'password' => $request->password,
        ])) {
            throw ValidationException::withMessages([
                'password' => __('auth.password'),
            ]);
        }

        $request->session()->put('auth.password_confirmed_at', time());

        return redirect()->intended(route('dashboard', absolute: false));
    }
}
</file>

<file path="app/Http/Controllers/Auth/EmailVerificationNotificationController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;

class EmailVerificationNotificationController extends Controller
{
    /**
     * Send a new email verification notification.
     */
    public function store(Request $request): RedirectResponse
    {
        if ($request->user()->hasVerifiedEmail()) {
            return redirect()->intended(route('dashboard', absolute: false));
        }

        $request->user()->sendEmailVerificationNotification();

        return back()->with('status', 'verification-link-sent');
    }
}
</file>

<file path="app/Http/Controllers/Auth/EmailVerificationPromptController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Inertia\Inertia;
use Inertia\Response;

class EmailVerificationPromptController extends Controller
{
    /**
     * Display the email verification prompt.
     */
    public function __invoke(Request $request): RedirectResponse|Response
    {
        return $request->user()->hasVerifiedEmail()
                    ? redirect()->intended(route('dashboard', absolute: false))
                    : Inertia::render('Auth/VerifyEmail', ['status' => session('status')]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/NewPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Auth\Events\PasswordReset;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Str;
use Illuminate\Validation\Rules;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class NewPasswordController extends Controller
{
    /**
     * Display the password reset view.
     */
    public function create(Request $request): Response
    {
        return Inertia::render('Auth/ResetPassword', [
            'email' => $request->email,
            'token' => $request->route('token'),
        ]);
    }

    /**
     * Handle an incoming new password request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'token' => 'required',
            'email' => 'required|email',
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
        ]);

        // Here we will attempt to reset the user's password. If it is successful we
        // will update the password on an actual user model and persist it to the
        // database. Otherwise we will parse the error and return the response.
        $status = Password::reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function ($user) use ($request) {
                $user->forceFill([
                    'password' => Hash::make($request->password),
                    'remember_token' => Str::random(60),
                ])->save();

                event(new PasswordReset($user));
            }
        );

        // If the password was successfully reset, we will redirect the user back to
        // the application's home authenticated view. If there is an error we can
        // redirect them back to where they came from with their error message.
        if ($status == Password::PASSWORD_RESET) {
            return redirect()->route('login')->with('status', __($status));
        }

        throw ValidationException::withMessages([
            'email' => [trans($status)],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/PasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules\Password;

class PasswordController extends Controller
{
    /**
     * Update the user's password.
     */
    public function update(Request $request): RedirectResponse
    {
        $validated = $request->validate([
            'current_password' => ['required', 'current_password'],
            'password' => ['required', Password::defaults(), 'confirmed'],
        ]);

        $request->user()->update([
            'password' => Hash::make($validated['password']),
        ]);

        return back();
    }
}
</file>

<file path="app/Http/Controllers/Auth/PasswordResetLinkController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Password;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class PasswordResetLinkController extends Controller
{
    /**
     * Display the password reset link request view.
     */
    public function create(): Response
    {
        return Inertia::render('Auth/ForgotPassword', [
            'status' => session('status'),
        ]);
    }

    /**
     * Handle an incoming password reset link request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'email' => 'required|email',
        ]);

        // We will send the password reset link to this user. Once we have attempted
        // to send the link, we will examine the response then see the message we
        // need to show to the user. Finally, we'll send out a proper response.
        $status = Password::sendResetLink(
            $request->only('email')
        );

        if ($status == Password::RESET_LINK_SENT) {
            return back()->with('status', __($status));
        }

        throw ValidationException::withMessages([
            'email' => [trans($status)],
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/VerifyEmailController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Auth\Events\Verified;
use Illuminate\Foundation\Auth\EmailVerificationRequest;
use Illuminate\Http\RedirectResponse;

class VerifyEmailController extends Controller
{
    /**
     * Mark the authenticated user's email address as verified.
     */
    public function __invoke(EmailVerificationRequest $request): RedirectResponse
    {
        if ($request->user()->hasVerifiedEmail()) {
            return redirect()->intended(route('dashboard', absolute: false).'?verified=1');
        }

        if ($request->user()->markEmailAsVerified()) {
            event(new Verified($request->user()));
        }

        return redirect()->intended(route('dashboard', absolute: false).'?verified=1');
    }
}
</file>

<file path="app/Http/Controllers/ProfileController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\ProfileUpdateRequest;
use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Redirect;
use Inertia\Inertia;
use Inertia\Response;

class ProfileController extends Controller
{
    /**
     * Display the user's profile form.
     */
    public function edit(Request $request): Response
    {
        return Inertia::render('Profile/Edit', [
            'mustVerifyEmail' => $request->user() instanceof MustVerifyEmail,
            'status' => session('status'),
        ]);
    }

    /**
     * Update the user's profile information.
     */
    public function update(ProfileUpdateRequest $request): RedirectResponse
    {
        $request->user()->fill($request->validated());

        if ($request->user()->isDirty('email')) {
            $request->user()->email_verified_at = null;
        }

        $request->user()->save();

        return Redirect::route('profile.edit');
    }

    /**
     * Delete the user's account.
     */
    public function destroy(Request $request): RedirectResponse
    {
        $request->validate([
            'password' => ['required', 'current_password'],
        ]);

        $user = $request->user();

        Auth::logout();

        $user->delete();

        $request->session()->invalidate();
        $request->session()->regenerateToken();

        return Redirect::to('/');
    }
}
</file>

<file path="app/Http/Requests/Auth/LoginRequest.php">
<?php

namespace App\Http\Requests\Auth;

use Illuminate\Auth\Events\Lockout;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\RateLimiter;
use Illuminate\Support\Str;
use Illuminate\Validation\ValidationException;

class LoginRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        return [
            'email' => ['required', 'string', 'email'],
            'password' => ['required', 'string'],
        ];
    }

    /**
     * Attempt to authenticate the request's credentials.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function authenticate(): void
    {
        $this->ensureIsNotRateLimited();

        if (! Auth::attempt($this->only('email', 'password'), $this->boolean('remember'))) {
            RateLimiter::hit($this->throttleKey());

            throw ValidationException::withMessages([
                'email' => trans('auth.failed'),
            ]);
        }

        RateLimiter::clear($this->throttleKey());
    }

    /**
     * Ensure the login request is not rate limited.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function ensureIsNotRateLimited(): void
    {
        if (! RateLimiter::tooManyAttempts($this->throttleKey(), 5)) {
            return;
        }

        event(new Lockout($this));

        $seconds = RateLimiter::availableIn($this->throttleKey());

        throw ValidationException::withMessages([
            'email' => trans('auth.throttle', [
                'seconds' => $seconds,
                'minutes' => ceil($seconds / 60),
            ]),
        ]);
    }

    /**
     * Get the rate limiting throttle key for the request.
     */
    public function throttleKey(): string
    {
        return Str::transliterate(Str::lower($this->string('email')).'|'.$this->ip());
    }
}
</file>

<file path="app/Http/Requests/ProfileUpdateRequest.php">
<?php

namespace App\Http\Requests;

use App\Models\User;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class ProfileUpdateRequest extends FormRequest
{
    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:255'],
            'email' => [
                'required',
                'string',
                'lowercase',
                'email',
                'max:255',
                Rule::unique(User::class)->ignore($this->user()->id),
            ],
        ];
    }
}
</file>

<file path="app/Observers/ServiceObserver.php">
<?php

namespace App\Observers;

use FlipperBox\WorkManagement\Models\Service;
use Illuminate\Validation\ValidationException;

class ServiceObserver
{
    /**
     * Handle the Service "deleting" event.
     */
    public function deleting(Service $service): void
    {
        // Regla de Integridad: No se puede eliminar un servicio si ha sido usado en alguna orden de trabajo.
        if ($service->workOrders()->exists()) {
            throw ValidationException::withMessages([
                'error' => "No se puede eliminar el servicio '{$service->name}' porque forma parte del historial de Órdenes de Trabajo. Considere editarlo o cambiar su nombre a 'OBSOLETO'.",
            ]);
        }
    }
}
</file>

<file path="app/Services/EmbeddingService.php">
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class EmbeddingService
{
    private string $apiKey;

    private string $model = 'BAAI/bge-base-en-v1.5';

    private string $apiUrl;

    public function __construct()
    {
        $this->apiKey = config('services.huggingface.api_key');

        $this->apiUrl = "https://router.huggingface.co/hf-inference/models/{$this->model}";
    }

    /**
     * Genera el embedding para un texto dado.
     * Retorna null si falla.
     */
    public function generate(string $text): ?array
    {
        if (empty($this->apiKey)) {
            Log::error('EmbeddingService: La API Key de Hugging Face no está configurada.');

            return null;
        }

        try {
            $response = Http::withToken($this->apiKey)
                ->timeout(30)
                ->retry(3, 100)
                ->post($this->apiUrl, [
                    'inputs' => $text,
                    'options' => ['wait_for_model' => true], // Esperar si el modelo está "dormido"
                ]);

            if ($response->successful()) {
                $embedding = $response->json();

                // Validación básica de que recibimos un vector
                if (is_array($embedding) && count($embedding) > 0 && is_numeric($embedding[0])) {
                    return $embedding;
                }

                // A veces la API devuelve una lista de embeddings si el input es un array
                if (isset($embedding[0]) && is_array($embedding[0])) {
                    return $embedding[0];
                }
            }

            Log::error('EmbeddingService Error: '.$response->status().' - '.$response->body());

            return null;

        } catch (\Exception $e) {
            Log::error('EmbeddingService Exception: '.$e->getMessage());

            return null;
        }
    }
}
</file>

<file path="artisan">
#!/usr/bin/env php
<?php

use Illuminate\Foundation\Application;
use Symfony\Component\Console\Input\ArgvInput;

define('LARAVEL_START', microtime(true));

// Register the Composer autoloader...
require __DIR__.'/vendor/autoload.php';

// Bootstrap Laravel and handle the command...
/** @var Application $app */
$app = require_once __DIR__.'/bootstrap/app.php';

$status = $app->handleCommand(new ArgvInput);

exit($status);
</file>

<file path="bootstrap/cache/.gitignore">
*
!.gitignore
</file>

<file path="config/auth.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option defines the default authentication "guard" and password
    | reset "broker" for your application. You may change these values
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard' => env('AUTH_GUARD', 'web'),
        'passwords' => env('AUTH_PASSWORD_BROKER', 'users'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | which utilizes session storage plus the Eloquent user provider.
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | Supported: "session"
    |
    */

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | If you have multiple user tables or models you may configure multiple
    | providers to represent the model / table. These providers may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => env('AUTH_MODEL', App\Models\User::class),
        ],

        // 'users' => [
        //     'driver' => 'database',
        //     'table' => 'users',
        // ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | These configuration options specify the behavior of Laravel's password
    | reset functionality, including the table utilized for token storage
    | and the user provider that is invoked to actually retrieve users.
    |
    | The expiry time is the number of minutes that each reset token will be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    | The throttle setting is the number of seconds a user must wait before
    | generating more password reset tokens. This prevents the user from
    | quickly generating a very large amount of password reset tokens.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => env('AUTH_PASSWORD_RESET_TOKEN_TABLE', 'password_reset_tokens'),
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Password Confirmation Timeout
    |--------------------------------------------------------------------------
    |
    | Here you may define the number of seconds before a password confirmation
    | window expires and users are asked to re-enter their password via the
    | confirmation screen. By default, the timeout lasts for three hours.
    |
    */

    'password_timeout' => env('AUTH_PASSWORD_TIMEOUT', 10800),

];
</file>

<file path="config/broadcasting.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Broadcaster
    |--------------------------------------------------------------------------
    |
    | This option controls the default broadcaster that will be used by the
    | framework when an event needs to be broadcast. You may set this to
    | any of the connections defined in the "connections" array below.
    |
    | Supported: "reverb", "pusher", "ably", "redis", "log", "null"
    |
    */

    'default' => env('BROADCAST_CONNECTION', 'null'),

    /*
    |--------------------------------------------------------------------------
    | Broadcast Connections
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the broadcast connections that will be used
    | to broadcast events to other systems or over WebSockets. Samples of
    | each available type of connection are provided inside this array.
    |
    */

    'connections' => [

        'reverb' => [
            'driver' => 'reverb',
            'key' => env('REVERB_APP_KEY'),
            'secret' => env('REVERB_APP_SECRET'),
            'app_id' => env('REVERB_APP_ID'),
            'options' => [
                'host' => env('REVERB_HOST'),
                'port' => env('REVERB_PORT', 443),
                'scheme' => env('REVERB_SCHEME', 'https'),
                'useTLS' => env('REVERB_SCHEME', 'https') === 'https',
            ],
            'client_options' => [
                // Guzzle client options: https://docs.guzzlephp.org/en/stable/request-options.html
            ],
        ],

        'pusher' => [
            'driver' => 'pusher',
            'key' => env('PUSHER_APP_KEY'),
            'secret' => env('PUSHER_APP_SECRET'),
            'app_id' => env('PUSHER_APP_ID'),
            'options' => [
                'cluster' => env('PUSHER_APP_CLUSTER'),
                'host' => env('PUSHER_HOST') ?: 'api-'.env('PUSHER_APP_CLUSTER', 'mt1').'.pusher.com',
                'port' => env('PUSHER_PORT', 443),
                'scheme' => env('PUSHER_SCHEME', 'https'),
                'encrypted' => true,
                'useTLS' => env('PUSHER_SCHEME', 'https') === 'https',
            ],
            'client_options' => [
                // Guzzle client options: https://docs.guzzlephp.org/en/stable/request-options.html
            ],
        ],

        'ably' => [
            'driver' => 'ably',
            'key' => env('ABLY_KEY'),
        ],

        'log' => [
            'driver' => 'log',
        ],

        'null' => [
            'driver' => 'null',
        ],

    ],

];
</file>

<file path="config/cache.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Cache Store
    |--------------------------------------------------------------------------
    |
    | This option controls the default cache store that will be used by the
    | framework. This connection is utilized if another isn't explicitly
    | specified when running a cache operation inside the application.
    |
    */

    'default' => env('CACHE_STORE', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Cache Stores
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the cache "stores" for your application as
    | well as their drivers. You may even define multiple stores for the
    | same cache driver to group types of items stored in your caches.
    |
    | Supported drivers: "array", "database", "file", "memcached",
    |                    "redis", "dynamodb", "octane",
    |                    "failover", "null"
    |
    */

    'stores' => [

        'array' => [
            'driver' => 'array',
            'serialize' => false,
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_CACHE_CONNECTION'),
            'table' => env('DB_CACHE_TABLE', 'cache'),
            'lock_connection' => env('DB_CACHE_LOCK_CONNECTION'),
            'lock_table' => env('DB_CACHE_LOCK_TABLE'),
        ],

        'file' => [
            'driver' => 'file',
            'path' => storage_path('framework/cache/data'),
            'lock_path' => storage_path('framework/cache/data'),
        ],

        'memcached' => [
            'driver' => 'memcached',
            'persistent_id' => env('MEMCACHED_PERSISTENT_ID'),
            'sasl' => [
                env('MEMCACHED_USERNAME'),
                env('MEMCACHED_PASSWORD'),
            ],
            'options' => [
                // Memcached::OPT_CONNECT_TIMEOUT => 2000,
            ],
            'servers' => [
                [
                    'host' => env('MEMCACHED_HOST', '127.0.0.1'),
                    'port' => env('MEMCACHED_PORT', 11211),
                    'weight' => 100,
                ],
            ],
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_CACHE_CONNECTION', 'cache'),
            'lock_connection' => env('REDIS_CACHE_LOCK_CONNECTION', 'default'),
        ],

        'dynamodb' => [
            'driver' => 'dynamodb',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'table' => env('DYNAMODB_CACHE_TABLE', 'cache'),
            'endpoint' => env('DYNAMODB_ENDPOINT'),
        ],

        'octane' => [
            'driver' => 'octane',
        ],

        'failover' => [
            'driver' => 'failover',
            'stores' => [
                'database',
                'array',
            ],
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Cache Key Prefix
    |--------------------------------------------------------------------------
    |
    | When utilizing the APC, database, memcached, Redis, and DynamoDB cache
    | stores, there might be other applications using the same cache. For
    | that reason, you may prefix every cache key to avoid collisions.
    |
    */

    'prefix' => env('CACHE_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-cache-'),

];
</file>

<file path="config/filesystems.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Filesystem Disk
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default filesystem disk that should be used
    | by the framework. The "local" disk, as well as a variety of cloud
    | based disks are available to your application for file storage.
    |
    */

    'default' => env('FILESYSTEM_DISK', 'local'),

    /*
    |--------------------------------------------------------------------------
    | Filesystem Disks
    |--------------------------------------------------------------------------
    |
    | Below you may configure as many filesystem disks as necessary, and you
    | may even configure multiple disks for the same driver. Examples for
    | most supported storage drivers are configured here for reference.
    |
    | Supported drivers: "local", "ftp", "sftp", "s3"
    |
    */

    'disks' => [

        'local' => [
            'driver' => 'local',
            'root' => storage_path('app/private'),
            'serve' => true,
            'throw' => false,
            'report' => false,
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
            'throw' => false,
            'report' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
            'throw' => false,
            'report' => false,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Symbolic Links
    |--------------------------------------------------------------------------
    |
    | Here you may configure the symbolic links that will be created when the
    | `storage:link` Artisan command is executed. The array keys should be
    | the locations of the links and the values should be their targets.
    |
    */

    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],

];
</file>

<file path="config/logging.php">
<?php

use Monolog\Handler\NullHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Handler\SyslogUdpHandler;
use Monolog\Processor\PsrLogMessageProcessor;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Log Channel
    |--------------------------------------------------------------------------
    |
    | This option defines the default log channel that is utilized to write
    | messages to your logs. The value provided here should match one of
    | the channels present in the list of "channels" configured below.
    |
    */

    'default' => env('LOG_CHANNEL', 'stack'),

    /*
    |--------------------------------------------------------------------------
    | Deprecations Log Channel
    |--------------------------------------------------------------------------
    |
    | This option controls the log channel that should be used to log warnings
    | regarding deprecated PHP and library features. This allows you to get
    | your application ready for upcoming major versions of dependencies.
    |
    */

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => env('LOG_DEPRECATIONS_TRACE', false),
    ],

    /*
    |--------------------------------------------------------------------------
    | Log Channels
    |--------------------------------------------------------------------------
    |
    | Here you may configure the log channels for your application. Laravel
    | utilizes the Monolog PHP logging library, which includes a variety
    | of powerful log handlers and formatters that you're free to use.
    |
    | Available drivers: "single", "daily", "slack", "syslog",
    |                    "errorlog", "monolog", "custom", "stack"
    |
    */

    'channels' => [

        'stack' => [
            'driver' => 'stack',
            'channels' => explode(',', (string) env('LOG_STACK', 'single')),
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => env('LOG_DAILY_DAYS', 14),
            'replace_placeholders' => true,
        ],

        'slack' => [
            'driver' => 'slack',
            'url' => env('LOG_SLACK_WEBHOOK_URL'),
            'username' => env('LOG_SLACK_USERNAME', 'Laravel Log'),
            'emoji' => env('LOG_SLACK_EMOJI', ':boom:'),
            'level' => env('LOG_LEVEL', 'critical'),
            'replace_placeholders' => true,
        ],

        'papertrail' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => env('LOG_PAPERTRAIL_HANDLER', SyslogUdpHandler::class),
            'handler_with' => [
                'host' => env('PAPERTRAIL_URL'),
                'port' => env('PAPERTRAIL_PORT'),
                'connectionString' => 'tls://'.env('PAPERTRAIL_URL').':'.env('PAPERTRAIL_PORT'),
            ],
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'stderr' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => StreamHandler::class,
            'handler_with' => [
                'stream' => 'php://stderr',
            ],
            'formatter' => env('LOG_STDERR_FORMATTER'),
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'syslog' => [
            'driver' => 'syslog',
            'level' => env('LOG_LEVEL', 'debug'),
            'facility' => env('LOG_SYSLOG_FACILITY', LOG_USER),
            'replace_placeholders' => true,
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'null' => [
            'driver' => 'monolog',
            'handler' => NullHandler::class,
        ],

        'emergency' => [
            'path' => storage_path('logs/laravel.log'),
        ],

    ],

];
</file>

<file path="config/mail.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Mailer
    |--------------------------------------------------------------------------
    |
    | This option controls the default mailer that is used to send all email
    | messages unless another mailer is explicitly specified when sending
    | the message. All additional mailers can be configured within the
    | "mailers" array. Examples of each type of mailer are provided.
    |
    */

    'default' => env('MAIL_MAILER', 'log'),

    /*
    |--------------------------------------------------------------------------
    | Mailer Configurations
    |--------------------------------------------------------------------------
    |
    | Here you may configure all of the mailers used by your application plus
    | their respective settings. Several examples have been configured for
    | you and you are free to add your own as your application requires.
    |
    | Laravel supports a variety of mail "transport" drivers that can be used
    | when delivering an email. You may specify which one you're using for
    | your mailers below. You may also add additional mailers if needed.
    |
    | Supported: "smtp", "sendmail", "mailgun", "ses", "ses-v2",
    |            "postmark", "resend", "log", "array",
    |            "failover", "roundrobin"
    |
    */

    'mailers' => [

        'smtp' => [
            'transport' => 'smtp',
            'scheme' => env('MAIL_SCHEME'),
            'url' => env('MAIL_URL'),
            'host' => env('MAIL_HOST', '127.0.0.1'),
            'port' => env('MAIL_PORT', 2525),
            'username' => env('MAIL_USERNAME'),
            'password' => env('MAIL_PASSWORD'),
            'timeout' => null,
            'local_domain' => env('MAIL_EHLO_DOMAIN', parse_url((string) env('APP_URL', 'http://localhost'), PHP_URL_HOST)),
        ],

        'ses' => [
            'transport' => 'ses',
        ],

        'postmark' => [
            'transport' => 'postmark',
            // 'message_stream_id' => env('POSTMARK_MESSAGE_STREAM_ID'),
            // 'client' => [
            //     'timeout' => 5,
            // ],
        ],

        'resend' => [
            'transport' => 'resend',
        ],

        'sendmail' => [
            'transport' => 'sendmail',
            'path' => env('MAIL_SENDMAIL_PATH', '/usr/sbin/sendmail -bs -i'),
        ],

        'log' => [
            'transport' => 'log',
            'channel' => env('MAIL_LOG_CHANNEL'),
        ],

        'array' => [
            'transport' => 'array',
        ],

        'failover' => [
            'transport' => 'failover',
            'mailers' => [
                'smtp',
                'log',
            ],
            'retry_after' => 60,
        ],

        'roundrobin' => [
            'transport' => 'roundrobin',
            'mailers' => [
                'ses',
                'postmark',
            ],
            'retry_after' => 60,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Global "From" Address
    |--------------------------------------------------------------------------
    |
    | You may wish for all emails sent by your application to be sent from
    | the same address. Here you may specify a name and address that is
    | used globally for all emails that are sent by your application.
    |
    */

    'from' => [
        'address' => env('MAIL_FROM_ADDRESS', 'hello@example.com'),
        'name' => env('MAIL_FROM_NAME', 'Example'),
    ],

];
</file>

<file path="config/permission.php">
<?php

return [

    'models' => [

        /*
         * When using the "HasPermissions" trait from this package, we need to know which
         * Eloquent model should be used to retrieve your permissions. Of course, it
         * is often just the "Permission" model but you may use whatever you like.
         *
         * The model you want to use as a Permission model needs to implement the
         * `Spatie\Permission\Contracts\Permission` contract.
         */

        'permission' => Spatie\Permission\Models\Permission::class,

        /*
         * When using the "HasRoles" trait from this package, we need to know which
         * Eloquent model should be used to retrieve your roles. Of course, it
         * is often just the "Role" model but you may use whatever you like.
         *
         * The model you want to use as a Role model needs to implement the
         * `Spatie\Permission\Contracts\Role` contract.
         */

        'role' => Spatie\Permission\Models\Role::class,

    ],

    'table_names' => [

        /*
         * When using the "HasRoles" trait from this package, we need to know which
         * table should be used to retrieve your roles. We have chosen a basic
         * default value but you may easily change it to any table you like.
         */

        'roles' => 'roles',

        /*
         * When using the "HasPermissions" trait from this package, we need to know which
         * table should be used to retrieve your permissions. We have chosen a basic
         * default value but you may easily change it to any table you like.
         */

        'permissions' => 'permissions',

        /*
         * When using the "HasPermissions" trait from this package, we need to know which
         * table should be used to retrieve your models permissions. We have chosen a
         * basic default value but you may easily change it to any table you like.
         */

        'model_has_permissions' => 'model_has_permissions',

        /*
         * When using the "HasRoles" trait from this package, we need to know which
         * table should be used to retrieve your models roles. We have chosen a
         * basic default value but you may easily change it to any table you like.
         */

        'model_has_roles' => 'model_has_roles',

        /*
         * When using the "HasRoles" trait from this package, we need to know which
         * table should be used to retrieve your roles permissions. We have chosen a
         * basic default value but you may easily change it to any table you like.
         */

        'role_has_permissions' => 'role_has_permissions',
    ],

    'column_names' => [
        /*
         * Change this if you want to name the related pivots other than defaults
         */
        'role_pivot_key' => null, // default 'role_id',
        'permission_pivot_key' => null, // default 'permission_id',

        /*
         * Change this if you want to name the related model primary key other than
         * `model_id`.
         *
         * For example, this would be nice if your primary keys are all UUIDs. In
         * that case, name this `model_uuid`.
         */

        'model_morph_key' => 'model_id',

        /*
         * Change this if you want to use the teams feature and your related model's
         * foreign key is other than `team_id`.
         */

        'team_foreign_key' => 'team_id',
    ],

    /*
     * When set to true, the method for checking permissions will be registered on the gate.
     * Set this to false if you want to implement custom logic for checking permissions.
     */

    'register_permission_check_method' => true,

    /*
     * When set to true, Laravel\Octane\Events\OperationTerminated event listener will be registered
     * this will refresh permissions on every TickTerminated, TaskTerminated and RequestTerminated
     * NOTE: This should not be needed in most cases, but an Octane/Vapor combination benefited from it.
     */
    'register_octane_reset_listener' => false,

    /*
     * Events will fire when a role or permission is assigned/unassigned:
     * \Spatie\Permission\Events\RoleAttached
     * \Spatie\Permission\Events\RoleDetached
     * \Spatie\Permission\Events\PermissionAttached
     * \Spatie\Permission\Events\PermissionDetached
     *
     * To enable, set to true, and then create listeners to watch these events.
     */
    'events_enabled' => false,

    /*
     * Teams Feature.
     * When set to true the package implements teams using the 'team_foreign_key'.
     * If you want the migrations to register the 'team_foreign_key', you must
     * set this to true before doing the migration.
     * If you already did the migration then you must make a new migration to also
     * add 'team_foreign_key' to 'roles', 'model_has_roles', and 'model_has_permissions'
     * (view the latest version of this package's migration file)
     */

    'teams' => false,

    /*
     * The class to use to resolve the permissions team id
     */
    'team_resolver' => \Spatie\Permission\DefaultTeamResolver::class,

    /*
     * Passport Client Credentials Grant
     * When set to true the package will use Passports Client to check permissions
     */

    'use_passport_client_credentials' => false,

    /*
     * When set to true, the required permission names are added to exception messages.
     * This could be considered an information leak in some contexts, so the default
     * setting is false here for optimum safety.
     */

    'display_permission_in_exception' => false,

    /*
     * When set to true, the required role names are added to exception messages.
     * This could be considered an information leak in some contexts, so the default
     * setting is false here for optimum safety.
     */

    'display_role_in_exception' => false,

    /*
     * By default wildcard permission lookups are disabled.
     * See documentation to understand supported syntax.
     */

    'enable_wildcard_permission' => false,

    /*
     * The class to use for interpreting wildcard permissions.
     * If you need to modify delimiters, override the class and specify its name here.
     */
    // 'wildcard_permission' => Spatie\Permission\WildcardPermission::class,

    /* Cache-specific settings */

    'cache' => [

        /*
         * By default all permissions are cached for 24 hours to speed up performance.
         * When permissions or roles are updated the cache is flushed automatically.
         */

        'expiration_time' => \DateInterval::createFromDateString('24 hours'),

        /*
         * The cache key used to store all permissions.
         */

        'key' => 'spatie.permission.cache',

        /*
         * You may optionally indicate a specific cache driver to use for permission and
         * role caching using any of the `store` drivers listed in the cache.php config
         * file. Using 'default' here means to use the `default` set in cache.php.
         */

        'store' => 'default',
    ],
];
</file>

<file path="config/queue.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Queue Connection Name
    |--------------------------------------------------------------------------
    |
    | Laravel's queue supports a variety of backends via a single, unified
    | API, giving you convenient access to each backend using identical
    | syntax for each. The default queue connection is defined below.
    |
    */

    'default' => env('QUEUE_CONNECTION', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Queue Connections
    |--------------------------------------------------------------------------
    |
    | Here you may configure the connection options for every queue backend
    | used by your application. An example configuration is provided for
    | each backend supported by Laravel. You're also free to add more.
    |
    | Drivers: "sync", "database", "beanstalkd", "sqs", "redis",
    |          "deferred", "failover", "null"
    |
    */

    'connections' => [

        'sync' => [
            'driver' => 'sync',
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_QUEUE_CONNECTION'),
            'table' => env('DB_QUEUE_TABLE', 'jobs'),
            'queue' => env('DB_QUEUE', 'default'),
            'retry_after' => (int) env('DB_QUEUE_RETRY_AFTER', 90),
            'after_commit' => false,
        ],

        'beanstalkd' => [
            'driver' => 'beanstalkd',
            'host' => env('BEANSTALKD_QUEUE_HOST', 'localhost'),
            'queue' => env('BEANSTALKD_QUEUE', 'default'),
            'retry_after' => (int) env('BEANSTALKD_QUEUE_RETRY_AFTER', 90),
            'block_for' => 0,
            'after_commit' => false,
        ],

        'sqs' => [
            'driver' => 'sqs',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'prefix' => env('SQS_PREFIX', 'https://sqs.us-east-1.amazonaws.com/your-account-id'),
            'queue' => env('SQS_QUEUE', 'default'),
            'suffix' => env('SQS_SUFFIX'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'after_commit' => false,
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_QUEUE_CONNECTION', 'default'),
            'queue' => env('REDIS_QUEUE', 'default'),
            'retry_after' => (int) env('REDIS_QUEUE_RETRY_AFTER', 90),
            'block_for' => null,
            'after_commit' => false,
        ],

        'deferred' => [
            'driver' => 'deferred',
        ],

        'failover' => [
            'driver' => 'failover',
            'connections' => [
                'database',
                'deferred',
            ],
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Job Batching
    |--------------------------------------------------------------------------
    |
    | The following options configure the database and table that store job
    | batching information. These options can be updated to any database
    | connection and table which has been defined by your application.
    |
    */

    'batching' => [
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'job_batches',
    ],

    /*
    |--------------------------------------------------------------------------
    | Failed Queue Jobs
    |--------------------------------------------------------------------------
    |
    | These options configure the behavior of failed queue job logging so you
    | can control how and where failed jobs are stored. Laravel ships with
    | support for storing failed jobs in a simple file or in a database.
    |
    | Supported drivers: "database-uuids", "dynamodb", "file", "null"
    |
    */

    'failed' => [
        'driver' => env('QUEUE_FAILED_DRIVER', 'database-uuids'),
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'failed_jobs',
    ],

];
</file>

<file path="config/reverb.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Reverb Server
    |--------------------------------------------------------------------------
    |
    | This option controls the default server used by Reverb to handle
    | incoming messages as well as broadcasting message to all your
    | connected clients. At this time only "reverb" is supported.
    |
    */

    'default' => env('REVERB_SERVER', 'reverb'),

    /*
    |--------------------------------------------------------------------------
    | Reverb Servers
    |--------------------------------------------------------------------------
    |
    | Here you may define details for each of the supported Reverb servers.
    | Each server has its own configuration options that are defined in
    | the array below. You should ensure all the options are present.
    |
    */

    'servers' => [

        'reverb' => [
            'host' => env('REVERB_SERVER_HOST', '0.0.0.0'),
            'port' => env('REVERB_SERVER_PORT', 8080),
            'path' => env('REVERB_SERVER_PATH', ''),
            'hostname' => env('REVERB_HOST'),
            'options' => [
                'tls' => [],
            ],
            'max_request_size' => env('REVERB_MAX_REQUEST_SIZE', 10_000),
            'scaling' => [
                'enabled' => env('REVERB_SCALING_ENABLED', false),
                'channel' => env('REVERB_SCALING_CHANNEL', 'reverb'),
                'server' => [
                    'url' => env('REDIS_URL'),
                    'host' => env('REDIS_HOST', '127.0.0.1'),
                    'port' => env('REDIS_PORT', '6379'),
                    'username' => env('REDIS_USERNAME'),
                    'password' => env('REDIS_PASSWORD'),
                    'database' => env('REDIS_DB', '0'),
                    'timeout' => env('REDIS_TIMEOUT', 60),
                ],
            ],
            'pulse_ingest_interval' => env('REVERB_PULSE_INGEST_INTERVAL', 15),
            'telescope_ingest_interval' => env('REVERB_TELESCOPE_INGEST_INTERVAL', 15),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Reverb Applications
    |--------------------------------------------------------------------------
    |
    | Here you may define how Reverb applications are managed. If you choose
    | to use the "config" provider, you may define an array of apps which
    | your server will support, including their connection credentials.
    |
    */

    'apps' => [

        'provider' => 'config',

        'apps' => [
            [
                'key' => env('REVERB_APP_KEY'),
                'secret' => env('REVERB_APP_SECRET'),
                'app_id' => env('REVERB_APP_ID'),
                'options' => [
                    'host' => env('REVERB_HOST'),
                    'port' => env('REVERB_PORT', 443),
                    'scheme' => env('REVERB_SCHEME', 'https'),
                    'useTLS' => env('REVERB_SCHEME', 'https') === 'https',
                ],
                'allowed_origins' => ['*'],
                'ping_interval' => env('REVERB_APP_PING_INTERVAL', 60),
                'activity_timeout' => env('REVERB_APP_ACTIVITY_TIMEOUT', 30),
                'max_connections' => env('REVERB_APP_MAX_CONNECTIONS'),
                'max_message_size' => env('REVERB_APP_MAX_MESSAGE_SIZE', 10_000),
            ],
        ],

    ],

];
</file>

<file path="config/session.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Session Driver
    |--------------------------------------------------------------------------
    |
    | This option determines the default session driver that is utilized for
    | incoming requests. Laravel supports a variety of storage options to
    | persist session data. Database storage is a great default choice.
    |
    | Supported: "file", "cookie", "database", "memcached",
    |            "redis", "dynamodb", "array"
    |
    */

    'driver' => env('SESSION_DRIVER', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Session Lifetime
    |--------------------------------------------------------------------------
    |
    | Here you may specify the number of minutes that you wish the session
    | to be allowed to remain idle before it expires. If you want them
    | to expire immediately when the browser is closed then you may
    | indicate that via the expire_on_close configuration option.
    |
    */

    'lifetime' => (int) env('SESSION_LIFETIME', 120),

    'expire_on_close' => env('SESSION_EXPIRE_ON_CLOSE', false),

    /*
    |--------------------------------------------------------------------------
    | Session Encryption
    |--------------------------------------------------------------------------
    |
    | This option allows you to easily specify that all of your session data
    | should be encrypted before it's stored. All encryption is performed
    | automatically by Laravel and you may use the session like normal.
    |
    */

    'encrypt' => env('SESSION_ENCRYPT', false),

    /*
    |--------------------------------------------------------------------------
    | Session File Location
    |--------------------------------------------------------------------------
    |
    | When utilizing the "file" session driver, the session files are placed
    | on disk. The default storage location is defined here; however, you
    | are free to provide another location where they should be stored.
    |
    */

    'files' => storage_path('framework/sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Connection
    |--------------------------------------------------------------------------
    |
    | When using the "database" or "redis" session drivers, you may specify a
    | connection that should be used to manage these sessions. This should
    | correspond to a connection in your database configuration options.
    |
    */

    'connection' => env('SESSION_CONNECTION'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Table
    |--------------------------------------------------------------------------
    |
    | When using the "database" session driver, you may specify the table to
    | be used to store sessions. Of course, a sensible default is defined
    | for you; however, you're welcome to change this to another table.
    |
    */

    'table' => env('SESSION_TABLE', 'sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Cache Store
    |--------------------------------------------------------------------------
    |
    | When using one of the framework's cache driven session backends, you may
    | define the cache store which should be used to store the session data
    | between requests. This must match one of your defined cache stores.
    |
    | Affects: "dynamodb", "memcached", "redis"
    |
    */

    'store' => env('SESSION_STORE'),

    /*
    |--------------------------------------------------------------------------
    | Session Sweeping Lottery
    |--------------------------------------------------------------------------
    |
    | Some session drivers must manually sweep their storage location to get
    | rid of old sessions from storage. Here are the chances that it will
    | happen on a given request. By default, the odds are 2 out of 100.
    |
    */

    'lottery' => [2, 100],

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Name
    |--------------------------------------------------------------------------
    |
    | Here you may change the name of the session cookie that is created by
    | the framework. Typically, you should not need to change this value
    | since doing so does not grant a meaningful security improvement.
    |
    */

    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug((string) env('APP_NAME', 'laravel')).'-session'
    ),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Path
    |--------------------------------------------------------------------------
    |
    | The session cookie path determines the path for which the cookie will
    | be regarded as available. Typically, this will be the root path of
    | your application, but you're free to change this when necessary.
    |
    */

    'path' => env('SESSION_PATH', '/'),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Domain
    |--------------------------------------------------------------------------
    |
    | This value determines the domain and subdomains the session cookie is
    | available to. By default, the cookie will be available to the root
    | domain and all subdomains. Typically, this shouldn't be changed.
    |
    */

    'domain' => env('SESSION_DOMAIN'),

    /*
    |--------------------------------------------------------------------------
    | HTTPS Only Cookies
    |--------------------------------------------------------------------------
    |
    | By setting this option to true, session cookies will only be sent back
    | to the server if the browser has a HTTPS connection. This will keep
    | the cookie from being sent to you when it can't be done securely.
    |
    */

    'secure' => env('SESSION_SECURE_COOKIE'),

    /*
    |--------------------------------------------------------------------------
    | HTTP Access Only
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will prevent JavaScript from accessing the
    | value of the cookie and the cookie will only be accessible through
    | the HTTP protocol. It's unlikely you should disable this option.
    |
    */

    'http_only' => env('SESSION_HTTP_ONLY', true),

    /*
    |--------------------------------------------------------------------------
    | Same-Site Cookies
    |--------------------------------------------------------------------------
    |
    | This option determines how your cookies behave when cross-site requests
    | take place, and can be used to mitigate CSRF attacks. By default, we
    | will set this value to "lax" to permit secure cross-site requests.
    |
    | See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value
    |
    | Supported: "lax", "strict", "none", null
    |
    */

    'same_site' => env('SESSION_SAME_SITE', 'lax'),

    /*
    |--------------------------------------------------------------------------
    | Partitioned Cookies
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will tie the cookie to the top-level site for
    | a cross-site context. Partitioned cookies are accepted by the browser
    | when flagged "secure" and the Same-Site attribute is set to "none".
    |
    */

    'partitioned' => env('SESSION_PARTITIONED_COOKIE', false),

];
</file>

<file path="database/.gitignore">
*.sqlite*
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/0001_01_01_000002_create_jobs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->id();
            $table->string('queue')->index();
            $table->longText('payload');
            $table->unsignedTinyInteger('attempts');
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
        });

        Schema::create('job_batches', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('name');
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->longText('failed_job_ids');
            $table->mediumText('options')->nullable();
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();
        });

        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->id();
            $table->string('uuid')->unique();
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->longText('exception');
            $table->timestamp('failed_at')->useCurrent();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('jobs');
        Schema::dropIfExists('job_batches');
        Schema::dropIfExists('failed_jobs');
    }
};
</file>

<file path="database/migrations/2025_11_03_130548_create_permission_tables.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $teams = config('permission.teams');
        $tableNames = config('permission.table_names');
        $columnNames = config('permission.column_names');
        $pivotRole = $columnNames['role_pivot_key'] ?? 'role_id';
        $pivotPermission = $columnNames['permission_pivot_key'] ?? 'permission_id';

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not loaded. Run [php artisan config:clear] and try again.');
        throw_if($teams && empty($columnNames['team_foreign_key'] ?? null), Exception::class, 'Error: team_foreign_key on config/permission.php not loaded. Run [php artisan config:clear] and try again.');

        Schema::create($tableNames['permissions'], static function (Blueprint $table) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // permission id
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();

            $table->unique(['name', 'guard_name']);
        });

        Schema::create($tableNames['roles'], static function (Blueprint $table) use ($teams, $columnNames) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // role id
            if ($teams || config('permission.testing')) { // permission.testing is a fix for sqlite testing
                $table->unsignedBigInteger($columnNames['team_foreign_key'])->nullable();
                $table->index($columnNames['team_foreign_key'], 'roles_team_foreign_key_index');
            }
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();
            if ($teams || config('permission.testing')) {
                $table->unique([$columnNames['team_foreign_key'], 'name', 'guard_name']);
            } else {
                $table->unique(['name', 'guard_name']);
            }
        });

        Schema::create($tableNames['model_has_permissions'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotPermission, $teams) {
            $table->unsignedBigInteger($pivotPermission);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_permissions_model_id_model_type_index');

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_permissions_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            } else {
                $table->primary([$pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            }

        });

        Schema::create($tableNames['model_has_roles'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotRole, $teams) {
            $table->unsignedBigInteger($pivotRole);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_roles_model_id_model_type_index');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_roles_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            } else {
                $table->primary([$pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            }
        });

        Schema::create($tableNames['role_has_permissions'], static function (Blueprint $table) use ($tableNames, $pivotRole, $pivotPermission) {
            $table->unsignedBigInteger($pivotPermission);
            $table->unsignedBigInteger($pivotRole);

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');

            $table->primary([$pivotPermission, $pivotRole], 'role_has_permissions_permission_id_role_id_primary');
        });

        app('cache')
            ->store(config('permission.cache.store') != 'default' ? config('permission.cache.store') : null)
            ->forget(config('permission.cache.key'));
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        $tableNames = config('permission.table_names');

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not found and defaults could not be merged. Please publish the package configuration before proceeding, or drop the tables manually.');

        Schema::drop($tableNames['role_has_permissions']);
        Schema::drop($tableNames['model_has_roles']);
        Schema::drop($tableNames['model_has_permissions']);
        Schema::drop($tableNames['roles']);
        Schema::drop($tableNames['permissions']);
    }
};
</file>

<file path="database/migrations/2025_11_04_193207_create_suppliers_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('suppliers', function (Blueprint $table) {
            $table->id();
            $table->string('name')->unique();
            $table->string('contact_person')->nullable();
            $table->string('phone')->nullable();
            $table->string('email')->nullable();
            $table->text('address')->nullable();
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('suppliers');
    }
};
</file>

<file path="database/migrations/2025_11_04_193421_create_product_supplier_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_supplier', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('supplier_id')->constrained()->onDelete('cascade');
            $table->decimal('cost', 10, 2)->comment('Costo del producto para este proveedor');
            $table->timestamps();
            $table->unique(['product_id', 'supplier_id']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_supplier');
    }
};
</file>

<file path="database/migrations/2025_11_04_193514_create_inventory_movements_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('inventory_movements', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null')->comment('Usuario que realizó el movimiento');
            $table->enum('type', ['in', 'out', 'adjustment']);
            $table->integer('quantity');
            $table->string('reason')->nullable()->comment('Ej: Venta, Compra, Devolución, Ajuste manual');
            $table->timestamps();
            $table->index(['product_id', 'created_at']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('inventory_movements');
    }
};
</file>

<file path="database/migrations/2025_11_06_010312_create_work_orders_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('work_orders', function (Blueprint $table) {
            $table->id();
            $table->foreignId('vehicle_id')->constrained('vehiculos')->onDelete('cascade');
            $table->foreignId('mechanic_id')->nullable()->constrained('users')->onDelete('set null')->comment('Mecánico asignado');
            $table->enum('status', ['Pendiente', 'En Progreso', 'Completada', 'Cancelada'])->default('Pendiente');
            $table->text('description')->comment('Descripción inicial del problema o servicio solicitado');
            $table->text('notes')->nullable()->comment('Notas internas del mecánico');
            $table->timestamp('entry_date')->useCurrent();
            $table->timestamp('completion_date')->nullable();
            $table->decimal('total', 10, 2)->nullable();
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('work_orders');
    }
};
</file>

<file path="database/migrations/2025_11_06_010608_create_work_order_product_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('work_order_product', function (Blueprint $table) {
            $table->id();
            $table->foreignId('work_order_id')->constrained('work_orders')->onDelete('cascade');
            $table->foreignId('product_id')->constrained('products')->onDelete('cascade');
            $table->integer('quantity');
            $table->decimal('unit_price', 10, 2)->comment('Precio del producto al momento de la venta');
            $table->timestamps();
            $table->unique(['work_order_id', 'product_id']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('work_order_product');
    }
};
</file>

<file path="database/migrations/2025_11_06_015800_create_work_order_service_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('work_order_service', function (Blueprint $table) {
            $table->id();
            $table->foreignId('work_order_id')->constrained('work_orders')->onDelete('cascade');
            $table->foreignId('service_id')->constrained('services')->onDelete('cascade');
            $table->decimal('price', 10, 2)->comment('Precio del servicio al momento de la orden');
            $table->timestamps();
            $table->unique(['work_order_id', 'service_id']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('work_order_service');
    }
};
</file>

<file path="database/migrations/2025_11_06_015847_create_external_costs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('external_costs', function (Blueprint $table) {
            $table->id();
            $table->foreignId('work_order_id')->constrained('work_orders')->onDelete('cascade');
            $table->string('description');
            $table->decimal('cost', 10, 2);
            $table->decimal('price', 10, 2);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('external_costs');
    }
};
</file>

<file path="database/migrations/2025_11_06_224559_create_daily_capacities_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('daily_capacities', function (Blueprint $table) {
            $table->id();
            $table->date('date')->unique();
            $table->unsignedInteger('total_slots')->comment('Capacidad total para el día');
            $table->unsignedInteger('booked_slots')->default(0)->comment('Cupos ya reservados');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('daily_capacities');
    }
};
</file>

<file path="database/migrations/2025_11_18_035950_create_notifications_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('notifications', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->string('type');
            $table->morphs('notifiable');
            $table->text('data');
            $table->timestamp('read_at')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('notifications');
    }
};
</file>

<file path="docker/entrypoint.sh">
#!/bin/sh

# Salir si ocurre un error
set -e

# 1. Crear directorios de caché de Laravel
mkdir -p storage/framework/sessions
mkdir -p storage/framework/views
mkdir -p storage/framework/cache
mkdir -p storage/logs

# 2. Permisos
chown -R www-data:www-data storage bootstrap/cache

# 3. Optimización de Laravel para Producción
php artisan config:cache
php artisan event:cache
php artisan route:cache
php artisan view:cache

# 4. Ejecutar migraciones
php artisan migrate --force

# 5. Ejecutar el comando pasado al contenedor (Supervisord)
exec "$@"
</file>

<file path="docker/nginx.conf">
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log /dev/stdout;
    error_log /dev/stderr;
    gzip on;
    client_max_body_size 20M;

    # Configuración para permitir WebSockets
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        root /var/www/html/public;
        index index.php index.html;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        charset utf-8;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # --- CONFIGURACIÓN PARA REVERB (WEBSOCKETS) ---
        location /app {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # ----------------------------------------------

        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        error_page 404 /index.php;

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }
    }
}
</file>

<file path="docker/supervisord.conf">
[supervisord]
nodaemon=true
logfile=/dev/null
logfile_maxbytes=0
pidfile=/run/supervisord.pid

[program:php-fpm]
command=php-fpm -F
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
startretries=0

[program:nginx]
command=nginx -g 'daemon off;'
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
startretries=0

[program:laravel-worker]
command=php artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/html/storage/logs/worker.log

[program:laravel-reverb]
command=php artisan reverb:start --host=0.0.0.0 --port=8080
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/html/storage/logs/reverb.log
</file>

<file path="eslint.config.js">
import js from '@eslint/js';
import pluginVue from 'eslint-plugin-vue';
import eslintConfigPrettier from 'eslint-config-prettier';
import globals from 'globals';

export default [
  {
    ignores: ['public/**', 'vendor/**', 'resources/js/ziggy.js', 'bootstrap/ssr/**'],
  },
  js.configs.recommended,
  ...pluginVue.configs['flat/recommended'],
  eslintConfigPrettier,
  {
    languageOptions: {
      ecmaVersion: 2022,
      sourceType: 'module',
      globals: {
        ...globals.browser,
        ...globals.es2021,
        route: 'readonly',
        axios: 'readonly',
        Echo: 'readonly',
        Pusher: 'readonly',
      },
    },
    rules: {
      'no-undef': 'error',
      'no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
      'vue/require-default-prop': 'off',
      'vue/multi-word-component-names': 'off',
      'vue/no-v-html': 'off',
      'vue/require-prop-types': 'off',
    },
  },
];
</file>

<file path="jsconfig.json">
{
    "compilerOptions": {
        "baseUrl": ".",
        "paths": {
            "@/*": ["resources/js/*"],
            "ziggy-js": ["./vendor/tightenco/ziggy"]
        }
    },
    "exclude": ["node_modules", "public"]
}
</file>

<file path="lang/es.json">
{
    "(and :count more error)": "(y :count error más)",
    "(and :count more errors)": "(y :count error más)|(y :count errores más)|(y :count errores más)",
    "A decryption key is required.": "Se requiere una clave de descifrado.",
    "A new verification link has been sent to the email address you provided during registration.": "Se ha enviado un nuevo enlace de verificación a la dirección de correo electrónico que proporcionó durante el registro.",
    "A new verification link has been sent to your email address.": "Se ha enviado un nuevo enlace de verificación a su dirección de correo electrónico.",
    "A Timeout Occurred": "Se produjo un tiempo de espera",
    "Accept": "Aceptar",
    "Accepted": "Aceptado",
    "Action": "Acción",
    "Actions": "Acciones",
    "Add": "Añadir",
    "Add :name": "Agregar :name",
    "Admin": "Administrar",
    "Agree": "Aceptar",
    "All rights reserved.": "Todos los derechos reservados.",
    "Already registered?": "¿Ya se registró?",
    "Already Reported": "Ya Reportado",
    "Archive": "Archivar",
    "Are you sure you want to delete your account?": "¿Está seguro que desea eliminar su cuenta?",
    "Assign": "Asignar",
    "Associate": "Asociar",
    "Attach": "Adjuntar",
    "Bad Gateway": "Mala puerta de enlace",
    "Bad Request": "Solicitud incorrecta",
    "Bandwidth Limit Exceeded": "Límite de ancho de banda excedido",
    "Browse": "Navegar",
    "Cancel": "Cancelar",
    "Choose": "Elija",
    "Choose :name": "Elegir :name",
    "Choose File": "Elija archivo",
    "Choose Image": "Elegir Imagen",
    "Click here to re-send the verification email.": "Haga clic aquí para reenviar el correo de verificación.",
    "Click to copy": "Haga clic para copiar",
    "Client Closed Request": "Solicitud cerrada del cliente",
    "Close": "Cerrar",
    "Collapse": "Colapsar",
    "Collapse All": "Colapsar todo",
    "Comment": "Comentar",
    "Confirm": "Confirmar",
    "Confirm Password": "Confirmar contraseña",
    "Conflict": "Conflicto",
    "Connect": "Conectar",
    "Connection Closed Without Response": "Conexión cerrada sin respuesta",
    "Connection Timed Out": "Tiempo de conexión agotado",
    "Continue": "Continuar",
    "Create": "Crear",
    "Create :name": "Crear :name",
    "Created": "Creado",
    "Current Password": "Contraseña actual",
    "Dashboard": "Panel",
    "Delete": "Eliminar",
    "Delete :name": "Eliminar :name",
    "Delete Account": "Borrar cuenta",
    "Detach": "Desvincular",
    "Details": "Detalles",
    "Disable": "Deshabilitar",
    "Discard": "Descartar",
    "Done": "Hecho",
    "Down": "Abajo",
    "Duplicate": "Duplicar",
    "Duplicate :name": "Duplicar :name",
    "Edit": "Editar",
    "Edit :name": "Editar :name",
    "Email": "Correo electrónico",
    "email": "El campo :attribute no es un correo válido.",
    "Email Password Reset Link": "Enviar enlace para restablecer contraseña",
    "Enable": "Habilitar",
    "Encrypted environment file already exists.": "El archivo de entorno cifrado ya existe.",
    "Encrypted environment file not found.": "No se encontró el archivo de entorno cifrado.",
    "Ensure your account is using a long, random password to stay secure.": "Asegúrese que su cuenta esté usando una contraseña larga y aleatoria para mantenerse seguro.",
    "Environment file already exists.": "El archivo de entorno ya existe.",
    "Environment file not found.": "Archivo de entorno no encontrado.",
    "errors": "errores",
    "Expand": "Expandir",
    "Expand All": "Expandir todo",
    "Expectation Failed": "Expectativa fallida",
    "Explanation": "Explicación",
    "Export": "Exportar",
    "Export :name": "Exportar :name",
    "Failed Dependency": "Dependencia fallida",
    "File": "Archivo",
    "Files": "Archivos",
    "Forbidden": "Prohibido",
    "Forgot your password?": "¿Olvidó su contraseña?",
    "Forgot your password? No problem. Just let us know your email address and we will email you a password reset link that will allow you to choose a new one.": "¿Olvidó su contraseña? No hay problema. Simplemente déjenos saber su dirección de correo electrónico y le enviaremos un enlace para restablecer la contraseña que le permitirá elegir una nueva.",
    "Found": "Encontrado",
    "Gateway Timeout": "Tiempo de espera de puerta de enlace",
    "Go Home": "Ir a inicio",
    "Go to page :page": "Ir a la página :page",
    "Gone": "Recurso no disponible",
    "Hello!": "¡Hola!",
    "Hide": "Ocultar",
    "Hide :name": "Ocultar :name",
    "Home": "Inicio",
    "HTTP Version Not Supported": "Versión HTTP no compatible",
    "I'm a teapot": "Soy una tetera",
    "If you did not create an account, no further action is required.": "Si no ha creado una cuenta, no se requiere ninguna acción adicional.",
    "If you did not request a password reset, no further action is required.": "Si no ha solicitado el restablecimiento de contraseña, omita este mensaje de correo electrónico.",
    "If you're having trouble clicking the \":actionText\" button, copy and paste the URL below\ninto your web browser:": "Si está teniendo problemas al hacer clic en el botón \":actionText\", copie y pegue la URL de abajo\nen su navegador web:",
    "IM Used": "IM usado",
    "Image": "Imagen",
    "Impersonate": "Personificar",
    "Impersonation": "Personificación",
    "Import": "Importar",
    "Import :name": "Importar :name",
    "Insufficient Storage": "Espacio insuficiente",
    "Internal Server Error": "Error interno del servidor",
    "Introduction": "Introducción",
    "Invalid filename.": "Nombre de archivo no válido.",
    "Invalid JSON was returned from the route.": "Se devolvió un JSON no válido desde la ruta.",
    "Invalid SSL Certificate": "Certificado SSL no válido",
    "Length Required": "Longitud requerida",
    "Like": "Me gusta",
    "Load": "Cargar",
    "Localize": "Localizar",
    "Location": "Ubicación",
    "Locked": "Bloqueado",
    "Log In": "Iniciar sesión",
    "Log in": "Iniciar sesión",
    "Log Out": "Finalizar sesión",
    "Login": "Iniciar sesión",
    "Logout": "Finalizar sesión",
    "Loop Detected": "Bucle detectado",
    "Maintenance Mode": "Modo de mantenimiento",
    "Method Not Allowed": "Método no permitido",
    "Misdirected Request": "Solicitud mal dirigida",
    "Moved Permanently": "Movido permanentemente",
    "Multi-Status": "Multiestado",
    "Multiple Choices": "Múltiples opciones",
    "Name": "Nombre",
    "name": "nombre",
    "Network Authentication Required": "Se requiere autenticación de red",
    "Network Connect Timeout Error": "Error de tiempo de espera de conexión de red",
    "Network Read Timeout Error": "Error de tiempo de espera de lectura de red",
    "New": "Nuevo",
    "New :name": "Nuevo :name",
    "New Password": "Nueva Contraseña",
    "No": "No",
    "No Content": "Sin contenido",
    "Non-Authoritative Information": "Información no autorizada",
    "Not Acceptable": "Inaceptable",
    "Not Extended": "no extendido",
    "Not Found": "No encontrado",
    "Not Implemented": "No se ha implementado",
    "Not Modified": "No modificado",
    "of": "de",
    "OK": "Correcto",
    "Once your account is deleted, all of its resources and data will be permanently deleted. Before deleting your account, please download any data or information that you wish to retain.": "Una vez que se elimine su cuenta, todos sus recursos y datos se eliminarán de forma permanente. Antes de borrar su cuenta, por favor descargue cualquier dato o información que desee conservar.",
    "Once your account is deleted, all of its resources and data will be permanently deleted. Please enter your password to confirm you would like to permanently delete your account.": "Una vez que se elimine su cuenta, todos sus recursos y datos se eliminarán de forma permanente. Ingrese su contraseña para confirmar que desea eliminar su cuenta de forma permanente.",
    "Open": "Abrir",
    "Open in a current window": "Abrir en una ventana actual",
    "Open in a new window": "Abrir en una ventana nueva",
    "Open in a parent frame": "Abrir en un marco principal",
    "Open in the topmost frame": "Abrir en el marco superior",
    "Open on the website": "Abrir en el sitio web",
    "Origin Is Unreachable": "El origen es inalcanzable",
    "Page Expired": "Página expirada",
    "Pagination Navigation": "Navegación por los enlaces de paginación",
    "Partial Content": "Contenido parcial",
    "Password": "Contraseña",
    "password": "La contraseña es incorrecta.",
    "Payload Too Large": "Solicitud demasiado grande",
    "Payment Required": "Pago requerido",
    "Permanent Redirect": "Redirección permanente",
    "Please click the button below to verify your email address.": "Por favor, haga clic en el botón de abajo para verificar su dirección de correo electrónico.",
    "Precondition Failed": "Error de condición previa",
    "Precondition Required": "Precondición requerida",
    "Preview": "Previsualizar",
    "Price": "Precio",
    "Processing": "Procesando",
    "Profile": "Perfil",
    "Profile Information": "Información de perfil",
    "Proxy Authentication Required": "Se requiere autenticación proxy",
    "Railgun Error": "Error de cañón de riel",
    "Range Not Satisfiable": "Rango no satisfactorio",
    "Record": "Registro",
    "Regards,": "Saludos,",
    "Register": "Registrarse",
    "Remember me": "Mantener sesión activa",
    "Request Header Fields Too Large": "Campos de encabezado de solicitud demasiado grandes",
    "Request Timeout": "Solicitud de tiempo de espera",
    "Resend Verification Email": "Reenviar correo de verificación",
    "Reset Content": "Restablecer contenido",
    "Reset Password": "Restablecer contraseña",
    "Reset Password Notification": "Notificación de restablecimiento de contraseña",
    "Restore": "Restaurar",
    "Restore :name": "Restaurar :name",
    "results": "resultados",
    "Retry With": "Reintentar con",
    "Save": "Guardar",
    "Save & Close": "Guardar y cerrar",
    "Save & Return": "Guardar y volver",
    "Save :name": "Guardar :name",
    "Saved.": "Guardado.",
    "Search": "Buscar",
    "Search :name": "Buscar :name",
    "See Other": "Ver otros",
    "Select": "Seleccione",
    "Select All": "Seleccionar todo",
    "Send": "Enviar",
    "Server Error": "Error del servidor",
    "Service Unavailable": "Servicio no disponible",
    "Session Has Expired": "La sesión ha expirado",
    "Settings": "Ajustes",
    "Show": "Mostrar",
    "Show :name": "Mostrar :name",
    "Show All": "Mostrar todo",
    "Showing": "Mostrando",
    "Sign In": "Iniciar sesión",
    "Solve": "Resolver",
    "SSL Handshake Failed": "Protocolo de enlace SSL fallido",
    "Start": "Comenzar",
    "Stop": "Detener",
    "Submit": "Enviar",
    "Subscribe": "Suscriba",
    "Switch": "Cambiar",
    "Switch To Role": "Cambiar de rol",
    "Switching Protocols": "Protocolos de conmutación",
    "Tag": "Etiqueta",
    "Tags": "Etiquetas",
    "Temporary Redirect": "Redirección temporal",
    "Thanks for signing up! Before getting started, could you verify your email address by clicking on the link we just emailed to you? If you didn't receive the email, we will gladly send you another.": "¡Gracias por registrarse! Antes de comenzar, ¿podría verificar su dirección de correo electrónico haciendo clic en el enlace que le acabamos de enviar? Si no recibió el correo electrónico, con gusto le enviaremos otro.",
    "The given data was invalid.": "Los datos proporcionados no son válidos.",
    "The response is not a streamed response.": "La respuesta no es una respuesta transmitida.",
    "The response is not a view.": "La respuesta no es una vista.",
    "This action is unauthorized.": "Esta acción no está autorizada.",
    "This is a secure area of the application. Please confirm your password before continuing.": "Esta es un área segura de la aplicación. Confirme su contraseña antes de continuar.",
    "This password reset link will expire in :count minutes.": "Este enlace de restablecimiento de contraseña expirará en :count minutos.",
    "to": "al",
    "Toggle navigation": "Alternar navegación",
    "Too Early": "Demasiado temprano",
    "Too Many Requests": "Demasiadas peticiones",
    "Translate": "Traducir",
    "Translate It": "Traducirlo",
    "Unauthorized": "No autorizado",
    "Unavailable For Legal Reasons": "No disponible por razones legales",
    "Unknown Error": "Error desconocido",
    "Unpack": "Desglosar",
    "Unprocessable Entity": "Entidad no procesable",
    "Unsubscribe": "Darse de baja",
    "Unsupported Media Type": "Tipo de medio no admitido",
    "Up": "Arriba",
    "Update": "Actualizar",
    "Update :name": "Actualizar :name",
    "Update Password": "Actualizar contraseña",
    "Update your account's profile information and email address.": "Actualice la información de su cuenta y la dirección de correo electrónico.",
    "Upgrade Required": "Se requiere actualización",
    "URI Too Long": "URI demasiado largo",
    "Use Proxy": "Usa proxy",
    "User": "Usuario",
    "Variant Also Negotiates": "Variante También Negocia",
    "Verify Email Address": "Confirme su correo electrónico",
    "View": "Ver",
    "View :name": "Ver :name",
    "Web Server is Down": "El servidor web está caído",
    "Whoops!": "¡Ups!",
    "Yes": "Sí",
    "You are receiving this email because we received a password reset request for your account.": "Ha recibido este mensaje porque se solicitó un restablecimiento de contraseña para su cuenta.",
    "You're logged in!": "¡Usted está conectado!",
    "Your email address is unverified.": "Su dirección de correo electrónico no está verificada."
}
</file>

<file path="phpunit.xml">
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory>app</directory>
        </include>
    </source>
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="APP_MAINTENANCE_DRIVER" value="file"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="BROADCAST_CONNECTION" value="null"/>
        <env name="CACHE_STORE" value="array"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="PULSE_ENABLED" value="false"/>
        <env name="TELESCOPE_ENABLED" value="false"/>
        <env name="NIGHTWATCH_ENABLED" value="false"/>
    </php>
</phpunit>
</file>

<file path="postcss.config.js">
export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
};
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
</file>

<file path="public/index.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Http\Request;

define('LARAVEL_START', microtime(true));

// Determine if the application is in maintenance mode...
if (file_exists($maintenance = __DIR__.'/../storage/framework/maintenance.php')) {
    require $maintenance;
}

// Register the Composer autoloader...
require __DIR__.'/../vendor/autoload.php';

// Bootstrap Laravel and handle the request...
/** @var Application $app */
$app = require_once __DIR__.'/../bootstrap/app.php';

$app->handleRequest(Request::capture());
</file>

<file path="public/robots.txt">
User-agent: *
Disallow:
</file>

<file path="resources/css/app.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="resources/js/Components/DangerButton.vue">
<template>
    <button
        class="inline-flex items-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition duration-150 ease-in-out hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 active:bg-red-700"
    >
        <slot />
    </button>
</template>
</file>

<file path="resources/js/Components/InputError.vue">
<script setup>
defineProps({
    message: {
        type: String,
    },
});
</script>

<template>
    <div v-show="message">
        <p class="text-sm text-red-600">
            {{ message }}
        </p>
    </div>
</template>
</file>

<file path="resources/js/Components/PrimaryButton.vue">
<template>
    <button
        class="inline-flex items-center rounded-md border border-transparent bg-gray-800 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition duration-150 ease-in-out hover:bg-gray-700 focus:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 active:bg-gray-900"
    >
        <slot />
    </button>
</template>
</file>

<file path="resources/js/Components/SearchInput.vue">
<script setup>
import { ref, watch } from 'vue';
import { router } from '@inertiajs/vue3';
import { debounce } from 'lodash';

const props = defineProps({
    modelValue: String,
    placeholder: {
        type: String,
        default: 'Buscar...',
    },
    routeParams: {
        type: Object,
        default: () => ({}),
    },
});

const search = ref(props.modelValue);

// Usamos debounce para esperar 300ms después de que el usuario deje de escribir
const updateSearch = debounce((value) => {
    router.get(
        route(route().current()),
        { search: value, ...props.routeParams },
        { preserveState: true, preserveScroll: true, replace: true }
    );
}, 300);

watch(search, (value) => {
    updateSearch(value);
});
</script>

<template>
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
            </svg>
        </div>
        <input
            v-model="search"
            type="text"
            class="pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150 ease-in-out"
            :placeholder="placeholder"
        />
    </div>
</template>
</file>

<file path="resources/js/Components/SecondaryButton.vue">
<script setup>
defineProps({
    type: {
        type: String,
        default: 'button',
    },
});
</script>

<template>
    <button
        :type="type"
        class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-widest text-gray-700 shadow-sm transition duration-150 ease-in-out hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-25"
    >
        <slot />
    </button>
</template>
</file>

<file path="resources/js/Composables/useDarkMode.js">
import { ref, onMounted } from 'vue';

const isDark = ref(false);

export function useDarkMode() {
    const toggleDarkMode = () => {
        isDark.value = !isDark.value;
        updateHtmlClass();
        localStorage.setItem('theme', isDark.value ? 'dark' : 'light');
    };

    const updateHtmlClass = () => {
        if (isDark.value) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    };

    onMounted(() => {
        // Verificar preferencia guardada o preferencia del sistema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            isDark.value = savedTheme === 'dark';
        } else {
            isDark.value = window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        updateHtmlClass();
    });

    return { isDark, toggleDarkMode };
}
</file>

<file path="resources/js/Layouts/PublicLayout.vue">
<script setup>
import { Link } from '@inertiajs/vue3';
import { useDarkMode } from '@/Composables/useDarkMode';
import ApplicationLogo from '@/Components/ApplicationLogo.vue';
import ChatbotWidget from '@/Components/ChatbotWidget.vue';

const { isDark, toggleDarkMode } = useDarkMode();

defineProps({
    canLogin: { type: Boolean, default: false },
    canRegister: { type: Boolean, default: false },
});
</script>

<template>
    <div
        class="min-h-screen flex flex-col font-sans text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-900 transition-colors duration-500"
    >
        <!-- NAVBAR -->
        <nav
            class="z-50 w-full px-6 py-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 shadow-sm transition-colors duration-500"
        >
            <!-- Logo FlipperBox -->
            <Link href="/" class="flex items-center gap-3 h-10 group">
                <ApplicationLogo class="h-full w-auto group-hover:scale-105 transition transform" />
            </Link>

            <div class="flex items-center gap-4">
                <!-- Switch Dark Mode -->
                <button
                    class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition text-gray-600 dark:text-gray-300"
                    :title="isDark ? 'Cambiar a modo Claro' : 'Cambiar a modo Oscuro'"
                    @click="toggleDarkMode"
                >
                    <svg
                        v-if="isDark"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                        />
                    </svg>
                    <svg
                        v-else
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                        />
                    </svg>
                </button>

                <!-- Links de Auth -->
                <div v-if="canLogin" class="flex gap-3">
                    <Link
                        v-if="$page.props.auth.user"
                        :href="route('dashboard')"
                        class="font-bold hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center"
                    >
                        Dashboard
                    </Link>
                    <template v-else>
                        <Link
                            :href="route('login')"
                            class="px-5 py-2 rounded-full font-bold text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-white/10 transition text-sm"
                        >
                            Ingresar
                        </Link>
                        <Link
                            v-if="canRegister"
                            :href="route('register')"
                            class="px-5 py-2 rounded-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold shadow-lg shadow-cyan-500/30 transition transform hover:scale-105 border border-white/10 text-sm hidden sm:block"
                        >
                            Registrarse
                        </Link>
                    </template>
                </div>
            </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="flex-grow flex flex-col">
            <slot />
        </main>

        <!-- FOOTER -->
        <footer
            class="z-10 py-8 text-center text-sm border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400 transition-colors duration-500"
        >
            <p>&copy; {{ new Date().getFullYear() }} Flipper Servicios. Av. Gendarmería Nacional 2758, Formosa.</p>
        </footer>

        <ChatbotWidget />
    </div>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Services/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const form = useForm({
    name: '',
    description: '',
    price: 0.0,
});

const submit = () => {
    form.post(route('services.store'));
};
</script>

<template>
    <Head title="Crear Servicio" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Crear Nuevo Servicio</h2>
                <Link
                    :href="route('services.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Nombre -->
                                <div>
                                    <InputLabel for="name" value="Nombre del Servicio" />
                                    <TextInput
                                        id="name"
                                        v-model="form.name"
                                        type="text"
                                        class="mt-1 block w-full"
                                        placeholder="Ej. Cambio de Aceite y Filtros"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.name" />
                                </div>

                                <!-- Descripción -->
                                <div>
                                    <InputLabel for="description" value="Descripción (Opcional)" />
                                    <textarea
                                        id="description"
                                        v-model="form.description"
                                        rows="3"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-indigo-600 dark:focus:ring-indigo-600"
                                        placeholder="Detalles sobre qué incluye este servicio..."
                                    ></textarea>
                                    <InputError class="mt-2" :message="form.errors.description" />
                                </div>

                                <!-- Precio -->
                                <div>
                                    <InputLabel for="price" value="Precio de Mano de Obra ($)" />
                                    <TextInput
                                        id="price"
                                        v-model="form.price"
                                        type="number"
                                        step="0.01"
                                        class="mt-1 block w-full sm:w-1/3"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.price" />
                                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                        Este es el precio base. Puede ajustarse individualmente en cada orden de
                                        trabajo.
                                    </p>
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-4 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2 disabled:opacity-50"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Servicio</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Services/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const props = defineProps({
    service: {
        type: Object,
        required: true,
    },
});

const form = useForm({
    name: props.service.name,
    description: props.service.description,
    price: props.service.price,
});

const submit = () => {
    form.patch(route('services.update', props.service.id), {
        preserveScroll: true,
    });
};
</script>

<template>
    <Head :title="`Editar Servicio: ${service.name}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Editar Servicio</h2>
                <Link
                    :href="route('services.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Nombre -->
                                <div>
                                    <InputLabel for="name" value="Nombre del Servicio" />
                                    <TextInput
                                        id="name"
                                        v-model="form.name"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.name" />
                                </div>

                                <!-- Descripción -->
                                <div>
                                    <InputLabel for="description" value="Descripción (Opcional)" />
                                    <textarea
                                        id="description"
                                        v-model="form.description"
                                        rows="3"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-indigo-600 dark:focus:ring-indigo-600"
                                    ></textarea>
                                    <InputError class="mt-2" :message="form.errors.description" />
                                </div>

                                <!-- Precio -->
                                <div>
                                    <InputLabel for="price" value="Precio de Mano de Obra ($)" />
                                    <TextInput
                                        id="price"
                                        v-model="form.price"
                                        type="number"
                                        step="0.01"
                                        class="mt-1 block w-full sm:w-1/3"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.price" />
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-4 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2 disabled:opacity-50"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Actualizar Servicio</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Services/Index.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import SearchInput from '@/Components/SearchInput.vue';
import { ref } from 'vue';

defineProps({
    services: Object,
    filters: Object,
});

const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

// --- Lógica Modal ---
const confirmingDeletion = ref(false);
const itemToDelete = ref(null);

const confirmDeletion = (item) => {
    itemToDelete.value = item;
    confirmingDeletion.value = true;
};

const deleteItem = () => {
    router.delete(route('services.destroy', itemToDelete.value.id), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};

const closeModal = () => {
    confirmingDeletion.value = false;
    itemToDelete.value = null;
};

const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
</script>

<template>
    <Head title="Servicios" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Gestión de Servicios</h2>
                <Link
                    v-if="can('gestionar servicios')"
                    :href="route('services.create')"
                    class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                        ></path>
                    </svg>
                    Nuevo Servicio
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <!-- Barra de Búsqueda -->
                <div class="mb-6">
                    <SearchInput :model-value="filters.search" placeholder="Buscar por nombre o descripción..." />
                </div>

                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th class="px-6 py-4 font-bold tracking-wider">Servicio</th>
                                        <th class="px-6 py-4 font-bold tracking-wider">Descripción</th>
                                        <th class="px-6 py-4 font-bold tracking-wider">Precio Base</th>
                                        <th class="px-6 py-4 font-bold tracking-wider text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="service in services.data"
                                        :key="service.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                                    >
                                        <th
                                            class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap"
                                        >
                                            {{ service.name }}
                                        </th>
                                        <td class="px-6 py-4 text-gray-500 dark:text-gray-400 max-w-md truncate">
                                            {{ service.description || '-' }}
                                        </td>
                                        <td class="px-6 py-4 font-mono text-gray-900 dark:text-gray-300">
                                            {{ formatCurrency(service.price) }}
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm font-medium">
                                            <Link
                                                v-if="can('gestionar servicios')"
                                                :href="route('services.edit', service.id)"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                            >
                                                Editar
                                            </Link>
                                            <button
                                                v-if="can('gestionar servicios')"
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmDeletion(service)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="services.data.length === 0">
                                        <td colspan="4" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            <p class="text-lg font-medium">No se encontraron servicios.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div
                        v-if="services.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="services.links" />
                    </div>
                </div>
            </div>
        </div>

        <ConfirmationModal
            :show="confirmingDeletion"
            title="Eliminar Servicio"
            :message="`¿Estás seguro de que deseas eliminar el servicio '${itemToDelete?.name}'? Esta acción no se puede deshacer.`"
            @close="closeModal"
            @confirm="deleteItem"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/views/app.blade.php">
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title inertia>{{ config('app.name', 'Laravel') }}</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.bunny.net">
        <link href="https://fonts.bunny.net/css?family=figtree:400,500,600&display=swap" rel="stylesheet" />

        <!-- Scripts -->
        @routes
        @vite(['resources/js/app.js', "resources/js/Pages/{$page['component']}.vue"])
        @inertiaHead
    </head>
    <body class="font-sans antialiased">
        @inertia
    </body>
</html>
</file>

<file path="resources/views/emails/reservations/confirmed.blade.php">
<x-mail::message>
# ¡Hola, {{ $reservation->user->name }}!

Tu reserva ha sido confirmada exitosamente. Te esperamos en nuestro taller.

## Detalles de la Reserva

- **Fecha:** {{ \Carbon\Carbon::parse($reservation->reservation_date)->format('d/m/Y') }}
- **Vehículo:** {{ $reservation->vehicle->marca }} {{ $reservation->vehicle->modelo }} ({{ $reservation->vehicle->patente }})
@if($reservation->notes)
- **Tus Notas:** {{ $reservation->notes }}
@endif

<x-mail::button :url="$url">
Ver Mi Reserva
</x-mail::button>

Si necesitas cancelar o reprogramar, puedes hacerlo desde tu portal hasta 24 horas antes.

Gracias,<br>
El equipo de {{ config('app.name') }}
</x-mail::message>
</file>

<file path="routes/auth.php">
<?php

use App\Http\Controllers\Auth\AuthenticatedSessionController;
use App\Http\Controllers\Auth\ConfirmablePasswordController;
use App\Http\Controllers\Auth\EmailVerificationNotificationController;
use App\Http\Controllers\Auth\EmailVerificationPromptController;
use App\Http\Controllers\Auth\NewPasswordController;
use App\Http\Controllers\Auth\PasswordController;
use App\Http\Controllers\Auth\PasswordResetLinkController;
use App\Http\Controllers\Auth\RegisteredUserController;
use App\Http\Controllers\Auth\VerifyEmailController;
use Illuminate\Support\Facades\Route;

Route::middleware('guest')->group(function () {
    Route::get('register', [RegisteredUserController::class, 'create'])
        ->name('register');

    Route::post('register', [RegisteredUserController::class, 'store']);

    Route::get('login', [AuthenticatedSessionController::class, 'create'])
        ->name('login');

    Route::post('login', [AuthenticatedSessionController::class, 'store']);

    Route::get('forgot-password', [PasswordResetLinkController::class, 'create'])
        ->name('password.request');

    Route::post('forgot-password', [PasswordResetLinkController::class, 'store'])
        ->name('password.email');

    Route::get('reset-password/{token}', [NewPasswordController::class, 'create'])
        ->name('password.reset');

    Route::post('reset-password', [NewPasswordController::class, 'store'])
        ->name('password.store');
});

Route::middleware('auth')->group(function () {
    Route::get('verify-email', EmailVerificationPromptController::class)
        ->name('verification.notice');

    Route::get('verify-email/{id}/{hash}', VerifyEmailController::class)
        ->middleware(['signed', 'throttle:6,1'])
        ->name('verification.verify');

    Route::post('email/verification-notification', [EmailVerificationNotificationController::class, 'store'])
        ->middleware('throttle:6,1')
        ->name('verification.send');

    Route::get('confirm-password', [ConfirmablePasswordController::class, 'show'])
        ->name('password.confirm');

    Route::post('confirm-password', [ConfirmablePasswordController::class, 'store']);

    Route::put('password', [PasswordController::class, 'update'])->name('password.update');

    Route::post('logout', [AuthenticatedSessionController::class, 'destroy'])
        ->name('logout');
});
</file>

<file path="routes/console.php">
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');
</file>

<file path="src/WorkManagement/Http/Controllers/ServiceController.php">
<?php

namespace FlipperBox\WorkManagement\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\WorkManagement\Http\Requests\StoreServiceRequest;
use FlipperBox\WorkManagement\Http\Requests\UpdateServiceRequest;
use FlipperBox\WorkManagement\Models\Service;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class ServiceController extends Controller
{
    public function index(Request $request): Response
    {
        $query = Service::latest();

        if ($request->has('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('name', 'ilike', "%{$search}%")
                    ->orWhere('description', 'ilike', "%{$search}%");
            });
        }

        return Inertia::render('WorkManagement/Services/Index', [
            'services' => $query->paginate(10)->withQueryString(),
            'filters' => $request->only(['search']),
        ]);
    }

    public function create(): Response
    {
        return Inertia::render('WorkManagement/Services/Create');
    }

    public function store(StoreServiceRequest $request): RedirectResponse
    {
        Service::create($request->validated());

        return to_route('services.index')->with('success', 'Servicio creado exitosamente.');
    }

    public function edit(Service $service): Response
    {
        return Inertia::render('WorkManagement/Services/Edit', [
            'service' => $service,
        ]);
    }

    public function update(UpdateServiceRequest $request, Service $service): RedirectResponse
    {
        $service->update($request->validated());

        return to_route('services.index')->with('success', 'Servicio actualizado exitosamente.');
    }

    public function destroy(Service $service): RedirectResponse
    {
        try {
            $service->delete();
        } catch (ValidationException $e) {
            return back()->with('error', $e->validator->errors()->first('error'));
        }

        return to_route('services.index')->with('success', 'Servicio eliminado exitosamente.');
    }
}
</file>

<file path="storage/app/.gitignore">
*
!private/
!public/
!.gitignore
</file>

<file path="storage/app/private/.gitignore">
*
!.gitignore
</file>

<file path="storage/app/public/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/.gitignore">
compiled.php
config.php
down
events.scanned.php
maintenance.php
routes.php
routes.scanned.php
schedule-*
services.json
</file>

<file path="storage/framework/cache/.gitignore">
*
!data/
!.gitignore
</file>

<file path="storage/framework/cache/data/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/sessions/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/testing/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/views/.gitignore">
*
!.gitignore
</file>

<file path="storage/logs/.gitignore">
*
!.gitignore
</file>

<file path="tests/Feature/Auth/AuthenticationTest.php">
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class AuthenticationTest extends TestCase
{
    use RefreshDatabase;

    public function test_login_screen_can_be_rendered(): void
    {
        $response = $this->get('/login');

        $response->assertStatus(200);
    }

    public function test_users_can_authenticate_using_the_login_screen(): void
    {
        $user = User::factory()->create();

        $response = $this->post('/login', [
            'email' => $user->email,
            'password' => 'password',
        ]);

        $this->assertAuthenticated();
        $response->assertRedirect(route('dashboard', absolute: false));
    }

    public function test_users_can_not_authenticate_with_invalid_password(): void
    {
        $user = User::factory()->create();

        $this->post('/login', [
            'email' => $user->email,
            'password' => 'wrong-password',
        ]);

        $this->assertGuest();
    }

    public function test_users_can_logout(): void
    {
        $user = User::factory()->create();

        $response = $this->actingAs($user)->post('/logout');

        $this->assertGuest();
        $response->assertRedirect('/');
    }
}
</file>

<file path="tests/Feature/Auth/EmailVerificationTest.php">
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use Illuminate\Auth\Events\Verified;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\URL;
use Tests\TestCase;

class EmailVerificationTest extends TestCase
{
    use RefreshDatabase;

    public function test_email_verification_screen_can_be_rendered(): void
    {
        $user = User::factory()->unverified()->create();

        $response = $this->actingAs($user)->get('/verify-email');

        $response->assertStatus(200);
    }

    public function test_email_can_be_verified(): void
    {
        $user = User::factory()->unverified()->create();

        Event::fake();

        $verificationUrl = URL::temporarySignedRoute(
            'verification.verify',
            now()->addMinutes(60),
            ['id' => $user->id, 'hash' => sha1($user->email)]
        );

        $response = $this->actingAs($user)->get($verificationUrl);

        Event::assertDispatched(Verified::class);
        $this->assertTrue($user->fresh()->hasVerifiedEmail());
        $response->assertRedirect(route('dashboard', absolute: false).'?verified=1');
    }

    public function test_email_is_not_verified_with_invalid_hash(): void
    {
        $user = User::factory()->unverified()->create();

        $verificationUrl = URL::temporarySignedRoute(
            'verification.verify',
            now()->addMinutes(60),
            ['id' => $user->id, 'hash' => sha1('wrong-email')]
        );

        $this->actingAs($user)->get($verificationUrl);

        $this->assertFalse($user->fresh()->hasVerifiedEmail());
    }
}
</file>

<file path="tests/Feature/Auth/PasswordConfirmationTest.php">
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class PasswordConfirmationTest extends TestCase
{
    use RefreshDatabase;

    public function test_confirm_password_screen_can_be_rendered(): void
    {
        $user = User::factory()->create();

        $response = $this->actingAs($user)->get('/confirm-password');

        $response->assertStatus(200);
    }

    public function test_password_can_be_confirmed(): void
    {
        $user = User::factory()->create();

        $response = $this->actingAs($user)->post('/confirm-password', [
            'password' => 'password',
        ]);

        $response->assertRedirect();
        $response->assertSessionHasNoErrors();
    }

    public function test_password_is_not_confirmed_with_invalid_password(): void
    {
        $user = User::factory()->create();

        $response = $this->actingAs($user)->post('/confirm-password', [
            'password' => 'wrong-password',
        ]);

        $response->assertSessionHasErrors();
    }
}
</file>

<file path="tests/Feature/Auth/PasswordResetTest.php">
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use Illuminate\Auth\Notifications\ResetPassword;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Notification;
use Tests\TestCase;

class PasswordResetTest extends TestCase
{
    use RefreshDatabase;

    public function test_reset_password_link_screen_can_be_rendered(): void
    {
        $response = $this->get('/forgot-password');

        $response->assertStatus(200);
    }

    public function test_reset_password_link_can_be_requested(): void
    {
        Notification::fake();

        $user = User::factory()->create();

        $this->post('/forgot-password', ['email' => $user->email]);

        Notification::assertSentTo($user, ResetPassword::class);
    }

    public function test_reset_password_screen_can_be_rendered(): void
    {
        Notification::fake();

        $user = User::factory()->create();

        $this->post('/forgot-password', ['email' => $user->email]);

        Notification::assertSentTo($user, ResetPassword::class, function ($notification) {
            $response = $this->get('/reset-password/'.$notification->token);

            $response->assertStatus(200);

            return true;
        });
    }

    public function test_password_can_be_reset_with_valid_token(): void
    {
        Notification::fake();

        $user = User::factory()->create();

        $this->post('/forgot-password', ['email' => $user->email]);

        Notification::assertSentTo($user, ResetPassword::class, function ($notification) use ($user) {
            $response = $this->post('/reset-password', [
                'token' => $notification->token,
                'email' => $user->email,
                'password' => 'password',
                'password_confirmation' => 'password',
            ]);

            $response
                ->assertSessionHasNoErrors()
                ->assertRedirect(route('login'));

            return true;
        });
    }
}
</file>

<file path="tests/Feature/Auth/PasswordUpdateTest.php">
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Hash;
use Tests\TestCase;

class PasswordUpdateTest extends TestCase
{
    use RefreshDatabase;

    public function test_password_can_be_updated(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->from('/profile')
            ->put('/password', [
                'current_password' => 'password',
                'password' => 'new-password',
                'password_confirmation' => 'new-password',
            ]);

        $response
            ->assertSessionHasNoErrors()
            ->assertRedirect('/profile');

        $this->assertTrue(Hash::check('new-password', $user->refresh()->password));
    }

    public function test_correct_password_must_be_provided_to_update_password(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->from('/profile')
            ->put('/password', [
                'current_password' => 'wrong-password',
                'password' => 'new-password',
                'password_confirmation' => 'new-password',
            ]);

        $response
            ->assertSessionHasErrors('current_password')
            ->assertRedirect('/profile');
    }
}
</file>

<file path="tests/Feature/Crm/ClientCreationTest.php">
<?php

namespace Tests\Feature\Crm;

use App\Models\User;
use Database\Seeders\DemoSeeder;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ClientCreationTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();
        $this->seed(DemoSeeder::class);
    }

    public function test_admin_can_create_a_client(): void
    {
        $admin = User::factory()->create();
        $admin->assignRole('Admin');

        $response = $this->actingAs($admin)->post(route('clientes.store'), [
            'name' => 'Nuevo Cliente',
            'apellido' => 'Test',
            'email' => 'cliente@test.com',
            'telefono' => '123456789',
            'documento_tipo' => 'DNI',
            'documento_valor' => '99887766',
        ]);

        $response->assertRedirect(route('clientes.index'));
        $this->assertDatabaseHas('users', [
            'email' => 'cliente@test.com',
            'name' => 'Nuevo Cliente',
        ]);
    }

    public function test_mechanic_cannot_create_a_client(): void
    {
        $mechanic = User::factory()->create();
        $mechanic->assignRole('Mecanico');

        $response = $this->actingAs($mechanic)->post(route('clientes.store'), [
            'name' => 'Cliente Hacker',
            'apellido' => 'Test',
            'email' => 'hacker@test.com',
            'telefono' => '123456789',
        ]);

        $response->assertStatus(403);
        $this->assertDatabaseMissing('users', [
            'email' => 'hacker@test.com',
        ]);
    }
}
</file>

<file path="tests/Feature/ExampleTest.php">
<?php

namespace Tests\Feature;

// use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_the_application_returns_a_successful_response(): void
    {
        $response = $this->get('/');

        $response->assertStatus(200);
    }
}
</file>

<file path="tests/Feature/ProfileTest.php">
<?php

namespace Tests\Feature;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ProfileTest extends TestCase
{
    use RefreshDatabase;

    public function test_profile_page_is_displayed(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->get('/profile');

        $response->assertOk();
    }

    public function test_profile_information_can_be_updated(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->patch('/profile', [
                'name' => 'Test User',
                'email' => 'test@example.com',
            ]);

        $response
            ->assertSessionHasNoErrors()
            ->assertRedirect('/profile');

        $user->refresh();

        $this->assertSame('Test User', $user->name);
        $this->assertSame('test@example.com', $user->email);
        $this->assertNull($user->email_verified_at);
    }

    public function test_email_verification_status_is_unchanged_when_the_email_address_is_unchanged(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->patch('/profile', [
                'name' => 'Test User',
                'email' => $user->email,
            ]);

        $response
            ->assertSessionHasNoErrors()
            ->assertRedirect('/profile');

        $this->assertNotNull($user->refresh()->email_verified_at);
    }

    public function test_user_can_delete_their_account(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->delete('/profile', [
                'password' => 'password',
            ]);

        $response
            ->assertSessionHasNoErrors()
            ->assertRedirect('/');

        $this->assertGuest();
        $this->assertNull($user->fresh());
    }

    public function test_correct_password_must_be_provided_to_delete_account(): void
    {
        $user = User::factory()->create();

        $response = $this
            ->actingAs($user)
            ->from('/profile')
            ->delete('/profile', [
                'password' => 'wrong-password',
            ]);

        $response
            ->assertSessionHasErrors('password')
            ->assertRedirect('/profile');

        $this->assertNotNull($user->fresh());
    }
}
</file>

<file path="tests/TestCase.php">
<?php

namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    //
}
</file>

<file path="tests/Unit/ExampleTest.php">
<?php

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_that_true_is_true(): void
    {
        $this->assertTrue(true);
    }
}
</file>

<file path="tests/Unit/ProductPriceTest.php">
<?php

namespace Tests\Unit;

use FlipperBox\Inventory\Models\Product;
use PHPUnit\Framework\TestCase;

class ProductPriceTest extends TestCase
{
    /**
     * A basic unit test example.
     */
    public function test_calculates_selling_price_correctly(): void
    {
        $product = new Product;
        $product->cost = 100.00;
        $product->iva_percentage = 21.00;
        $product->profit_margin = 50.00;

        $price = $product->calculatePrice();

        $this->assertEquals(181.50, $price);
    }

    public function test_calculates_price_with_zero_values(): void
    {
        $product = new Product;
        $product->cost = 100.00;
        $product->iva_percentage = 0;
        $product->profit_margin = 0;

        $price = $product->calculatePrice();

        $this->assertEquals(100.00, $price);
    }
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
    plugins: [
        laravel({
            input: 'resources/js/app.js',
            refresh: true,
        }),
        vue({
            template: {
                transformAssetUrls: {
                    base: null,
                    includeAbsolute: false,
                },
            },
        }),
    ],
});
</file>

<file path=".env.example">
APP_NAME=Flipperbox
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=es
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=es_AR

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

# PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

# Configuración de Base de Datos (PostgreSQL por defecto para pgvector)
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=laravel
DB_USERNAME=postgres
DB_PASSWORD=

SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=reverb
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database

CACHE_STORE=database
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# Configuración de Correo (Brevo / SMTP)
MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=smtp-relay.brevo.com
MAIL_PORT=587
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"

# Configuración de Reverb (WebSockets)
REVERB_APP_ID=
REVERB_APP_KEY=
REVERB_APP_SECRET=
REVERB_HOST="localhost"
REVERB_PORT=8080
REVERB_SCHEME=http

VITE_REVERB_APP_KEY="${REVERB_APP_KEY}"
VITE_REVERB_HOST="${REVERB_HOST}"
VITE_REVERB_PORT="${REVERB_PORT}"
VITE_REVERB_SCHEME="${REVERB_SCHEME}"

# Servicios de Inteligencia Artificial
HUGGINGFACE_API_KEY=
GROQ_API_KEY=
GROQ_MODEL=llama-3.3-70b-versatile
</file>

<file path=".github/workflows/ci.yml">
name: CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
        coverage: none

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    - name: Install Composer Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Install NPM Dependencies
      run: npm ci

    - name: Build Frontend Assets
      run: npm run build

    - name: Generate Key
      run: php artisan key:generate

    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Create Database
      run: |
        mkdir -p database
        touch database/database.sqlite

    - name: Execute Tests (PHPUnit)
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test

    - name: Check Code Style (Pint)
      run: ./vendor/bin/pint --test

  frontend-lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Run Linter (ESLint)
      run: npm run lint
      
    - name: Check Formatting (Prettier)
      run: npx prettier --check "resources/js/**/*.{js,vue}"
</file>

<file path="app/Mail/ReservationConfirmed.php">
<?php

namespace App\Mail;

use FlipperBox\Scheduling\Models\Reservation;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Mail\Mailable;
use Illuminate\Mail\Mailables\Content;
use Illuminate\Mail\Mailables\Envelope;
use Illuminate\Queue\SerializesModels;

class ReservationConfirmed extends Mailable implements ShouldQueue
{
    use Queueable, SerializesModels;

    public function __construct(
        public Reservation $reservation
    ) {
        $this->reservation->load('user', 'vehicle');
    }

    public function envelope(): Envelope
    {
        return new Envelope(
            subject: 'Confirmación de Reserva - FlipperBox',
        );
    }

    public function content(): Content
    {
        return new Content(
            markdown: 'emails.reservations.confirmed',
            with: [
                'url' => route('cliente.dashboard'),
            ],
        );
    }

    public function attachments(): array
    {
        return [];
    }
}
</file>

<file path="app/Notifications/ReservationCreated.php">
<?php

namespace App\Notifications;

use FlipperBox\Scheduling\Models\Reservation;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\BroadcastMessage;
use Illuminate\Notifications\Notification;

class ReservationCreated extends Notification implements ShouldQueue
{
    use Queueable;

    public $reservation;

    public function __construct(Reservation $reservation)
    {
        $this->reservation = $reservation->load('user', 'vehicle');
    }

    /**
     * Aquí definimos los canales: 'database' guarda en la tabla, 'broadcast' envía a Reverb.
     */
    public function via(object $notifiable): array
    {
        return ['database', 'broadcast'];
    }

    /**
     * Lo que se guarda en la tabla de base de datos (JSON).
     */
    public function toArray(object $notifiable): array
    {
        return [
            'message' => "Nueva reserva de {$this->reservation->user->name} para el vehículo {$this->reservation->vehicle->patente}.",
            'url' => route('admin.scheduling.reservations.index', ['date' => $this->reservation->reservation_date->format('Y-m-d')]),
            'reservation_id' => $this->reservation->id,
        ];
    }

    /**
     * Lo que se envía por WebSocket (Reverb).
     */
    public function toBroadcast(object $notifiable): BroadcastMessage
    {
        // Reutilizamos el array de base de datos para enviar lo mismo
        return new BroadcastMessage($this->toArray($notifiable));
    }
}
</file>

<file path="app/Observers/UserObserver.php">
<?php

namespace App\Observers;

use App\Models\User;
use Illuminate\Validation\ValidationException;

class UserObserver
{
    /**
     * Handle the User "deleting" event.
     * Esta es una red de seguridad para cualquier intento de borrado.
     */
    public function deleting(User $user): void
    {
        // Regla de negocio universal: Un usuario no puede ser borrado si es dueño
        // de vehículos que tienen CUALQUIER orden de trabajo (historial).
        if ($user->vehiculos()->whereHas('workOrders')->exists()) {
            throw ValidationException::withMessages([
                'error' => 'No se puede eliminar este usuario porque tiene un historial de órdenes de trabajo asociadas.',
            ]);
        }
    }
}
</file>

<file path="app/Observers/VehiculoObserver.php">
<?php

namespace App\Observers;

use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Validation\ValidationException;

class VehiculoObserver
{
    /**
     * Handle the Vehiculo "deleting" event.
     */
    public function deleting(Vehiculo $vehiculo): void
    {
        // Regla de Negocio: No se puede eliminar un vehículo si tiene
        // órdenes de trabajo que están 'Pendiente' o 'En Progreso'.
        if ($vehiculo->workOrders()->whereIn('status', ['Pendiente', 'En Progreso'])->exists()) {
            throw ValidationException::withMessages([
                'error' => 'No se puede eliminar este vehículo porque tiene órdenes de trabajo activas. Por favor, complete o cancele esas órdenes primero.',
            ]);
        }

        // Si llegamos aquí, significa que todas las órdenes asociadas (si las hay)
        // ya están 'Completada' o 'Cancelada', por lo que es seguro hacer un Soft Delete.
    }
}
</file>

<file path="app/Observers/WorkOrderObserver.php">
<?php

namespace App\Observers;

use FlipperBox\Inventory\Models\Product;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Support\Facades\DB;

class WorkOrderObserver
{
    /**
     * Handle the WorkOrder "deleting" event.
     * Red de seguridad final para devolver el stock.
     */
    public function deleting(WorkOrder $workOrder): void
    {
        // Solo devolvemos stock si la orden no estaba 'Completada'.
        // No se devuelve stock de trabajos finalizados y pagados.
        if ($workOrder->status !== 'Completada' && $workOrder->products()->exists()) {
            DB::transaction(function () use ($workOrder) {
                foreach ($workOrder->products as $product) {
                    // Usamos lockForUpdate para prevenir condiciones de carrera
                    $productInStock = Product::lockForUpdate()->find($product->id);
                    if ($productInStock) {
                        $productInStock->increment('current_stock', $product->pivot->quantity);
                    }
                }
            });
        }
    }
}
</file>

<file path="app/Providers/BroadcastServiceProvider.php">
<?php

namespace App\Providers;

use Illuminate\Support\Facades\Broadcast;
use Illuminate\Support\ServiceProvider;

class BroadcastServiceProvider extends ServiceProvider
{
    /**
     * Bootstrap any application services.
     */
    public function boot(): void
    {
        // Carga las rutas de autorización para los canales de broadcasting.
        Broadcast::routes();

        require base_path('routes/channels.php');
    }
}
</file>

<file path="app/Providers/PolicyServiceProvider.php">
<?php

namespace App\Providers;

use App\Policies\VehiculoPolicy;
use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;
use Illuminate\Support\Facades\Gate;

class PolicyServiceProvider extends ServiceProvider
{
    /**
     * The model to policy mappings for the application.
     *
     * @var array<class-string, class-string>
     */
    protected $policies = [
        // Dejamos este array vacío a propósito. Usaremos el método boot() para registrar.
    ];

    /**
     * Register any authentication / authorization services.
     */
    public function boot(): void
    {
        $this->registerPolicies();

        Gate::policy(Vehiculo::class, VehiculoPolicy::class);

    }
}
</file>

<file path="app/Services/ChatbotService.php">
<?php

namespace App\Services;

use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class ChatbotService
{
    private string $apiKey;

    private string $model;

    private string $apiUrl = 'https://api.groq.com/openai/v1/chat/completions';

    public function __construct()
    {
        $this->apiKey = config('services.groq.api_key');
        $this->model = config('services.groq.model');
    }

    /**
     * Genera una respuesta manteniendo el contexto de la conversación
     */
    public function answer(string $question, string $context, array $reservationInfo = [], ?string $conversationId = null): string
    {
        if (empty($this->apiKey)) {
            return 'Lo siento, hay un problema con mi configuración (Falta API Key).';
        }

        // Obtener historial de conversación si existe
        $conversationHistory = [];
        if ($conversationId) {
            $conversationHistory = Cache::get("chat_history_{$conversationId}", []);
        }

        // Obtener fecha actual
        $currentDate = now()->format('d/m/Y');
        $currentDay = now()->dayName;

        // Construcción del Prompt del Sistema mejorado
        $systemPrompt = $this->buildSystemPrompt($context, $reservationInfo, $currentDate, $currentDay);

        // Construir mensajes con historial
        $messages = $this->buildMessages($systemPrompt, $conversationHistory, $question);

        try {
            $response = Http::withToken($this->apiKey)
                ->timeout(30)
                ->post($this->apiUrl, [
                    'model' => $this->model,
                    'messages' => $messages,
                    'temperature' => 0.3,
                    'max_tokens' => 800,
                ]);

            if ($response->successful()) {
                $answer = $response->json('choices.0.message.content') ?? 'No pude generar una respuesta.';

                // Post-procesamiento para limpiar cualquier markdown residual
                $answer = $this->cleanResponse($answer);

                // Guardar historial de conversación
                if ($conversationId) {
                    $this->saveConversationHistory($conversationId, $conversationHistory, $question, $answer);
                }

                return $answer;
            }

            Log::error('Groq API Error: '.$response->body());

            return 'Tuve un problema técnico al procesar tu respuesta. Por favor intenta de nuevo.';

        } catch (\Exception $e) {
            Log::error('ChatbotService Exception: '.$e->getMessage());

            return 'Ocurrió un error de conexión. Por favor, intenta de nuevo.';
        }
    }

    /**
     * Construye el prompt del sistema con contexto mejorado
     */
    private function buildSystemPrompt(string $context, array $reservationInfo, string $currentDate, string $currentDay): string
    {
        $systemPrompt = <<<EOT
Eres 'FlipperBot', el asistente virtual experto del taller mecánico "Flipper Servicios".

INFORMACIÓN CRÍTICA SOBRE FECHA:
- Fecha actual: {$currentDate}
- Día de la semana: {$currentDay}
- Siempre debes referirte a la fecha actual correctamente en tus respuestas.

OBJETIVO PRINCIPAL:
Ayudar a los clientes respondiendo preguntas sobre productos, precios, stock y reservaciones manteniendo una conversación natural y fluida.

HABILIDADES DE CONVERSACIÓN:
1. Mantén el contexto de lo que se habló anteriormente
2. Si el usuario hace preguntas ambiguas, pide clarificación amablemente
3. Reconoce cuando el usuario quiere cambiar de tema
4. Maneja transiciones suaves entre temas
5. Recuerda detalles mencionados anteriormente en la conversación

SERVICIOS DISPONIBLES:
- Service en general
- Mecánica en general  
- Cambio de aceite
- Tren delantero
- Frenos
- Auxilios

REGLAS ESTRICTAS:
1. Tono profesional, amable y conversacional
2. NUNCA uses formato markdown
3. Para precios: "571.73 pesos" NO "$571.73"
4. Sé conciso pero útil
5. Si la información NO está en el CONTEXTO, di amablemente que no tienes esa información
6. NUNCA inventes datos sobre precios, stock o disponibilidad
7. Responde siempre en Español
8. Para derivar a humano: "Claro, puedo conectarte con uno de nuestros especialistas. ¿Podrías contarme brevemente sobre qué necesitas ayuda para que pueda dirigirte a la persona adecuada?"

INSTRUCCIONES ESPECÍFICAS:
- Para productos: nombre, precio en pesos, stock, breve descripción
- Para servicios: explica claramente qué hacen
- Para reservas: usa la información de disponibilidad proporcionada
- Siempre verifica las fechas contra la fecha actual

CONTEXTO DE PRODUCTOS Y STOCK:
{$context}

EOT;

        // Agregar información de reservaciones si está disponible
        if (! empty($reservationInfo)) {
            $systemPrompt .= "\nINFORMACIÓN DE RESERVACIONES ACTUAL:\n";
            foreach ($reservationInfo as $info) {
                $systemPrompt .= "- {$info}\n";
            }
            $systemPrompt .= "\nLos clientes pueden hacer reservas a través del sistema de reservas en nuestro sitio web.\n";
        }

        return $systemPrompt;
    }

    /**
     * Construye el array de mensajes con historial de conversación
     */
    private function buildMessages(string $systemPrompt, array $conversationHistory, string $currentQuestion): array
    {
        $messages = [
            ['role' => 'system', 'content' => $systemPrompt],
        ];

        // Agregar historial de conversación (máximo 6 mensajes para no exceder tokens)
        $recentHistory = array_slice($conversationHistory, -6);
        foreach ($recentHistory as $message) {
            $messages[] = $message;
        }

        // Agregar la pregunta actual
        $messages[] = ['role' => 'user', 'content' => $currentQuestion];

        return $messages;
    }

    /**
     * Guarda el historial de la conversación
     */
    private function saveConversationHistory(string $conversationId, array &$history, string $question, string $answer): void
    {
        // Agregar nueva interacción al historial
        $history[] = ['role' => 'user', 'content' => $question];
        $history[] = ['role' => 'assistant', 'content' => $answer];

        // Mantener máximo 10 mensajes en el historial
        if (count($history) > 10) {
            $history = array_slice($history, -10);
        }

        // Guardar en cache por 2 horas
        Cache::put("chat_history_{$conversationId}", $history, 7200);
    }

    /**
     * Limpia la respuesta de cualquier formato markdown residual y formatea precios
     */
    private function cleanResponse(string $response): string
    {
        // Eliminar markdown común
        $clean = preg_replace('/\*\*(.*?)\*\*/', '$1', $response);
        $clean = preg_replace('/\*(.*?)\*/', '$1', $clean);
        $clean = preg_replace('/#+\s?(.*)/', '$1', $clean);
        $clean = preg_replace('/`(.*?)`/', '$1', $clean);

        // Reemplazar símbolos de dólar por "pesos"
        $clean = preg_replace('/\$\s?(\d+\.?\d*)/', '$1 pesos', $clean);

        // Formatear precios para mejor legibilidad
        $clean = $this->formatPrices($clean);

        // Limpiar espacios múltiples
        $clean = preg_replace('/\s+/', ' ', $clean);

        return trim($clean);
    }

    /**
     * Formatea los precios para hacerlos más legibles
     */
    private function formatPrices(string $text): string
    {
        // Patrón para encontrar precios en formato decimal
        return preg_replace_callback('/(\d+)\.(\d+)\s*pesos/', function ($matches) {
            $parteEntera = (int) $matches[1];
            $centavos = (int) $matches[2];

            // Formatear parte entera con separadores de miles
            $parteEnteraFormateada = number_format($parteEntera, 0, '', '.');

            // Si los centavos son 00, mostrar solo la parte entera
            if ($centavos === 0) {
                return $parteEnteraFormateada.' pesos';
            }

            // Si tiene centavos, mostrar ambos
            return $parteEnteraFormateada.' pesos con '.$centavos.' centavos';
        }, $text);
    }

    /**
     * Limpia el historial de conversación
     */
    public function clearConversationHistory(string $conversationId): void
    {
        Cache::forget("chat_history_{$conversationId}");
    }
}
</file>

<file path="config/services.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Third Party Services
    |--------------------------------------------------------------------------
    |
    | This file is for storing the credentials for third party services such
    | as Mailgun, Postmark, AWS and more. This file provides the de facto
    | location for this type of information, allowing packages to have
    | a conventional file to locate the various service credentials.
    |
    */

    'postmark' => [
        'token' => env('POSTMARK_TOKEN'),
    ],

    'resend' => [
        'key' => env('RESEND_KEY'),
    ],

    'ses' => [
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
    ],

    'slack' => [
        'notifications' => [
            'bot_user_oauth_token' => env('SLACK_BOT_USER_OAUTH_TOKEN'),
            'channel' => env('SLACK_BOT_USER_DEFAULT_CHANNEL'),
        ],
    ],

    'huggingface' => [
        'api_key' => env('HUGGINGFACE_API_KEY'),
    ],

    'groq' => [
        'api_key' => env('GROQ_API_KEY'),
        'model' => env('GROQ_MODEL', 'llama-3.3-70b-versatile'),
    ],
];
</file>

<file path="database/factories/SupplierFactory.php">
<?php

namespace Database\Factories;

use FlipperBox\Inventory\Models\Supplier;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\FlipperBox\Inventory\Models\Supplier>
 */
class SupplierFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Supplier::class;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->company(),
            'contact_person' => fake()->name(),
            'phone' => fake()->e164PhoneNumber(),
            'email' => fake()->unique()->safeEmail(),
            'address' => fake()->address(),
        ];
    }
}
</file>

<file path="database/factories/VehiculoFactory.php">
<?php

namespace Database\Factories;

use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

class VehiculoFactory extends Factory
{
    protected $model = Vehiculo::class;

    public function definition(): array
    {
        return [
            'patente' => strtoupper(Str::random(3).' '.fake()->numerify('###')),
            'marca' => fake()->randomElement(['Toyota', 'Ford', 'Chevrolet', 'Volkswagen', 'Fiat', 'Renault']),
            'modelo' => fake()->randomElement(['Corolla', 'Hilux', 'Ranger', 'Onix', 'Gol', 'Sandero']),
            'anio' => fake()->numberBetween(2010, 2024),
            'kilometraje' => fake()->numberBetween(10000, 150000),
            'vin' => strtoupper(Str::random(17)),
        ];
    }
}
</file>

<file path="database/migrations/2025_11_04_010930_create_vehiculos_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('vehiculos', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained('users')->onDelete('cascade');
            $table->string('patente')->unique();
            $table->string('marca');
            $table->string('modelo');
            $table->year('anio');
            $table->unsignedInteger('kilometraje')->nullable();
            $table->string('vin')->nullable()->unique()->comment('Número de chasis');
            $table->string('numero_motor')->nullable();
            $table->text('observaciones')->nullable()->comment('Notas del mecánico sobre el vehículo');
            $table->softDeletes();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('vehiculos');
    }
};
</file>

<file path="database/migrations/2025_11_06_015636_create_services_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('services', function (Blueprint $table) {
            $table->id();
            $table->string('name')->unique();
            $table->text('description')->nullable();
            $table->decimal('price', 10, 2)->comment('Precio de la mano de obra');
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('services');
    }
};
</file>

<file path="database/migrations/2025_11_06_224636_create_reservations_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('reservations', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained('users')->onDelete('cascade');
            $table->foreignId('vehicle_id')->constrained('vehiculos')->onDelete('cascade');
            $table->date('reservation_date');
            $table->enum('status', ['Confirmada', 'Cancelada', 'Asistió', 'Ausente'])->default('Confirmada');
            $table->text('notes')->nullable()->comment('Notas del cliente al solicitar');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('reservations');
    }
};
</file>

<file path="database/migrations/2025_11_21_130534_add_embedding_to_products_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        // Verificar si la conexión es PostgreSQL
        if (DB::connection()->getDriverName() === 'pgsql') {
            // 1. Habilitar la extensión pgvector
            DB::statement('CREATE EXTENSION IF NOT EXISTS vector;');

            // 2. Añadir la columna de embedding
            Schema::table('products', function (Blueprint $table) {
                $table->vector('embedding', 768)->nullable();
            });

            // 3. Crear índice HNSW para búsquedas rápidas (solo en PostgreSQL)
            DB::statement('CREATE INDEX products_embedding_index ON products USING hnsw (embedding vector_cosine_ops);');
        } else {
            // Para otras bases de datos (MySQL, SQLite), agregar una columna normal
            Schema::table('products', function (Blueprint $table) {
                $table->text('embedding')->nullable();
            });
        }
    }

    public function down(): void
    {
        if (DB::connection()->getDriverName() === 'pgsql') {
            // Para PostgreSQL: eliminar índice y columna
            DB::statement('DROP INDEX IF EXISTS products_embedding_index;');
            Schema::table('products', function (Blueprint $table) {
                $table->dropColumn('embedding');
            });
        } else {
            // Para otras bases de datos: solo eliminar la columna
            Schema::table('products', function (Blueprint $table) {
                $table->dropColumn('embedding');
            });
        }
    }
};
</file>

<file path="Dockerfile">
# --- Etapa 1: Builder de PHP (Composer) ---
FROM composer:2 as composer_builder
WORKDIR /app
COPY . .
# Instalamos dependencias optimizadas
RUN composer install --no-dev --no-interaction --optimize-autoloader --no-scripts --ignore-platform-reqs

# --- Etapa 2: Builder de Node (Vite) ---
FROM node:20-alpine as node_builder
WORKDIR /app
COPY . .
# Copiamos los vendors para que Vite pueda encontrar archivos si es necesario
COPY --from=composer_builder /app/vendor /app/vendor
RUN npm ci

ARG VITE_REVERB_APP_KEY
ARG VITE_REVERB_HOST
ARG VITE_REVERB_PORT
ARG VITE_REVERB_SCHEME

ENV VITE_REVERB_APP_KEY=$VITE_REVERB_APP_KEY
ENV VITE_REVERB_HOST=$VITE_REVERB_HOST
ENV VITE_REVERB_PORT=$VITE_REVERB_PORT
ENV VITE_REVERB_SCHEME=$VITE_REVERB_SCHEME

RUN npm run build

# --- Etapa 3: Imagen Final ---
FROM php:8.3-fpm-alpine

# Instalar dependencias del sistema y extensiones PHP
# pcntl es obligatorio para Reverb y Queues
RUN apk add --no-cache \
    nginx \
    supervisor \
    libzip-dev \
    postgresql-dev \
    libpng-dev \
    jpeg-dev \
    freetype-dev \
    oniguruma-dev \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install pdo_pgsql pdo_mysql zip bcmath gd pcntl

# Limpiar caché de apk
RUN rm -rf /var/cache/apk/*

# Configurar Nginx y Supervisor
COPY docker/nginx.conf /etc/nginx/nginx.conf
COPY docker/supervisord.conf /etc/supervisor.d/supervisord.ini

# Configurar directorio de trabajo
WORKDIR /var/www/html

# Copiar código fuente y dependencias
COPY --from=composer_builder /app .
COPY --from=node_builder /app/public/build ./public/build

# Configurar Entrypoint
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Permisos finales
RUN chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
RUN chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

# Exponer el puerto 80 (Render inyectará la variable PORT, pero internamente escuchamos 80)
EXPOSE 80

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor.d/supervisord.ini"]
</file>

<file path="lang/es/actions.php">
<?php

declare(strict_types=1);

return [
    'accept' => 'Aceptar',
    'action' => 'Acción',
    'actions' => 'Acciones',
    'add' => 'Agregar',
    'admin' => 'Administrar',
    'agree' => 'Aceptar',
    'archive' => 'Archivar',
    'assign' => 'Asignar',
    'associate' => 'Asociar',
    'attach' => 'Adjuntar',
    'browse' => 'Navegar',
    'cancel' => 'Cancelar',
    'choose' => 'Elegir',
    'choose_file' => 'Elegir archivo',
    'choose_image' => 'Elegir Imagen',
    'click_to_copy' => 'Haga clic para copiar',
    'close' => 'Cerrar',
    'collapse' => 'Colapsar',
    'collapse_all' => 'Colapsar todo',
    'comment' => 'Comentar',
    'confirm' => 'Confirmar',
    'connect' => 'Conectar',
    'create' => 'Crear',
    'delete' => 'Borrar',
    'detach' => 'Desasociar',
    'details' => 'Detalles',
    'disable' => 'Desactivar',
    'discard' => 'Descartar',
    'done' => 'Hecho',
    'down' => 'Abajo',
    'duplicate' => 'Duplicar',
    'edit' => 'Editar',
    'enable' => 'Permitir',
    'expand' => 'Expandir',
    'expand_all' => 'Expandir todo',
    'explanation' => 'Explicación',
    'export' => 'Exportar',
    'file' => 'Archivo',
    'files' => 'Archivos',
    'go_home' => 'Ir a Inicio',
    'hide' => 'Ocultar',
    'home' => 'Inicio',
    'image' => 'Imagen',
    'impersonate' => 'Personificar',
    'impersonation' => 'Personificación',
    'import' => 'Importar',
    'introduction' => 'Introducción',
    'like' => 'Me gusta',
    'load' => 'Cargar',
    'localize' => 'Localizar',
    'log_in' => 'Acceder',
    'log_out' => 'Cerrar sesión',
    'named' => [
        'add' => 'Agregar :name',
        'choose' => 'Elegir :name',
        'create' => 'Crear :name',
        'delete' => 'Eliminar :name',
        'duplicate' => 'Duplicar :name',
        'edit' => 'Editar :name',
        'export' => 'Exportar :name',
        'hide' => 'Ocultar :name',
        'import' => 'Importar :name',
        'new' => 'Nuevo :name',
        'restore' => 'Restaurar :name',
        'save' => 'Guardar :name',
        'search' => 'Buscar :name',
        'show' => 'Mostrar :name',
        'update' => 'Actualizar :name',
        'view' => 'Ver :name',
    ],
    'new' => 'Nuevo',
    'no' => 'No',
    'open' => 'Abrir',
    'open_website' => 'Abrir en el sitio web',
    'preview' => 'Previsualizar',
    'price' => 'Precio',
    'record' => 'Registro',
    'restore' => 'Restaurar',
    'save' => 'Guardar',
    'save_and_close' => 'Guardar y cerrar',
    'save_and_return' => 'Guardar y volver',
    'search' => 'Buscar',
    'select' => 'Seleccionar',
    'select_all' => 'Seleccionar todo',
    'send' => 'Enviar',
    'settings' => 'Ajustes',
    'show' => 'Mostrar',
    'show_all' => 'Mostrar todo',
    'sign_in' => 'Iniciar sesión',
    'solve' => 'Resolver',
    'start' => 'Comenzar',
    'stop' => 'Detener',
    'submit' => 'Enviar',
    'subscribe' => 'Suscribir',
    'switch' => 'Cambiar',
    'switch_to_role' => 'Cambiar de rol',
    'tag' => 'Etiqueta',
    'tags' => 'Etiquetas',
    'target_link' => [
        'blank' => 'Abrir en una ventana nueva',
        'parent' => 'Abrir en el marco principal',
        'self' => 'Abrir en la ventana actual',
        'top' => 'Abrir en el marco superior',
    ],
    'translate' => 'Traducir',
    'translate_it' => 'Traducirlo',
    'unpack' => 'Desglosar',
    'unsubscribe' => 'Darse de baja',
    'up' => 'Arriba',
    'update' => 'Actualizar',
    'user' => 'Usuario',
    'view' => 'Ver',
    'yes' => 'Sí',
];
</file>

<file path="lang/es/auth.php">
<?php

declare(strict_types=1);

return [
    'failed' => 'Estas credenciales no coinciden con nuestros registros.',
    'password' => 'La contraseña es incorrecta.',
    'throttle' => 'Demasiados intentos de acceso. Por favor intente nuevamente en :seconds segundos.',
];
</file>

<file path="lang/es/http-statuses.php">
<?php

declare(strict_types=1);

return [
    '0' => 'Error desconocido',
    '100' => 'Continuar',
    '101' => 'Protocolos de conmutación',
    '102' => 'Procesando',
    '200' => 'DE ACUERDO',
    '201' => 'Creado',
    '202' => 'Aceptado',
    '203' => 'Información no autorizada',
    '204' => 'Sin contenido',
    '205' => 'Restablecer contenido',
    '206' => 'Contenido parcial',
    '207' => 'Multiestado',
    '208' => 'Ya Reportado',
    '226' => 'IM usado',
    '300' => 'Múltiples opciones',
    '301' => 'Movido permanentemente',
    '302' => 'Encontrado',
    '303' => 'Ver otros',
    '304' => 'No modificado',
    '305' => 'Usa proxy',
    '307' => 'Redirección temporal',
    '308' => 'Redirección permanente',
    '400' => 'Solicitud incorrecta',
    '401' => 'No autorizado',
    '402' => 'Pago requerido',
    '403' => 'Prohibido',
    '404' => 'No encontrado',
    '405' => 'Método no permitido',
    '406' => 'Inaceptable',
    '407' => 'Se requiere autenticación proxy',
    '408' => 'Solicitud de tiempo de espera',
    '409' => 'Conflicto',
    '410' => 'Recurso no disponible',
    '411' => 'Longitud requerida',
    '412' => 'Error de condición previa',
    '413' => 'Solicitud demasiado grande',
    '414' => 'URI demasiado largo',
    '415' => 'Tipo de medio no admitido',
    '416' => 'Rango no satisfactorio',
    '417' => 'Expectativa fallida',
    '418' => 'Soy una tetera',
    '419' => 'La sesión ha expirado',
    '421' => 'Solicitud mal dirigida',
    '422' => 'Entidad no procesable',
    '423' => 'Bloqueado',
    '424' => 'Dependencia fallida',
    '425' => 'Demasiado temprano',
    '426' => 'Se requiere actualización',
    '428' => 'Precondición requerida',
    '429' => 'Demasiadas solicitudes',
    '431' => 'Campos de encabezado de solicitud demasiado grandes',
    '444' => 'Conexión cerrada sin respuesta',
    '449' => 'Reintentar con',
    '451' => 'No disponible por razones legales',
    '499' => 'Solicitud cerrada del cliente',
    '500' => 'Error interno del servidor',
    '501' => 'No se ha implementado',
    '502' => 'Mala puerta de enlace',
    '503' => 'Modo de mantenimiento',
    '504' => 'Tiempo de espera de puerta de enlace',
    '505' => 'Versión HTTP no compatible',
    '506' => 'Variante También Negocia',
    '507' => 'Espacio insuficiente',
    '508' => 'Bucle detectado',
    '509' => 'Límite de ancho de banda excedido',
    '510' => 'no extendido',
    '511' => 'Se requiere autenticación de red',
    '520' => 'Error desconocido',
    '521' => 'El servidor web está caído',
    '522' => 'Tiempo de conexión agotado',
    '523' => 'El origen es inalcanzable',
    '524' => 'Se produjo un tiempo de espera',
    '525' => 'Protocolo de enlace SSL fallido',
    '526' => 'Certificado SSL no válido',
    '527' => 'Error de cañón de riel',
    '598' => 'Error de tiempo de espera de lectura de red',
    '599' => 'Error de tiempo de espera de conexión de red',
    'unknownError' => 'Error desconocido',
];
</file>

<file path="lang/es/pagination.php">
<?php

declare(strict_types=1);

return [
    'next' => 'Siguiente &raquo;',
    'previous' => '&laquo; Anterior',
];
</file>

<file path="lang/es/passwords.php">
<?php

declare(strict_types=1);

return [
    'reset' => 'Su contraseña ha sido restablecida.',
    'sent' => 'Le hemos enviado por correo electrónico el enlace para restablecer su contraseña.',
    'throttled' => 'Por favor espere antes de intentar de nuevo.',
    'token' => 'El token de restablecimiento de contraseña es inválido.',
    'user' => 'No encontramos ningún usuario con ese correo electrónico.',
];
</file>

<file path="lang/es/validation.php">
<?php

declare(strict_types=1);

return [
    'accepted' => 'El campo :attribute debe ser aceptado.',
    'accepted_if' => 'El campo :attribute debe ser aceptado cuando :other sea :value.',
    'active_url' => 'El campo :attribute debe ser una URL válida.',
    'after' => 'El campo :attribute debe ser una fecha posterior a :date.',
    'after_or_equal' => 'El campo :attribute debe ser una fecha posterior o igual a :date.',
    'alpha' => 'El campo :attribute sólo debe contener letras.',
    'alpha_dash' => 'El campo :attribute sólo debe contener letras, números, guiones y guiones bajos.',
    'alpha_num' => 'El campo :attribute sólo debe contener letras y números.',
    'any_of' => 'El campo :attribute no es válido.',
    'array' => 'El campo :attribute debe ser un conjunto.',
    'ascii' => 'El campo :attribute solo debe contener caracteres alfanuméricos y símbolos de un solo byte.',
    'before' => 'El campo :attribute debe ser una fecha anterior a :date.',
    'before_or_equal' => 'El campo :attribute debe ser una fecha anterior o igual a :date.',
    'between' => [
        'array' => 'El campo :attribute tiene que tener entre :min - :max elementos.',
        'file' => 'El campo :attribute debe pesar entre :min - :max kilobytes.',
        'numeric' => 'El campo :attribute tiene que estar entre :min - :max.',
        'string' => 'El campo :attribute tiene que tener entre :min - :max caracteres.',
    ],
    'boolean' => 'El campo :attribute debe tener un valor verdadero o falso.',
    'can' => 'El campo :attribute contiene un valor no autorizado.',
    'confirmed' => 'La confirmación de :attribute no coincide.',
    'contains' => 'Al campo :attribute le falta un valor obligatorio.',
    'current_password' => 'La contraseña es incorrecta.',
    'date' => 'El campo :attribute debe ser una fecha válida.',
    'date_equals' => 'El campo :attribute debe ser una fecha igual a :date.',
    'date_format' => 'El campo :attribute debe coincidir con el formato :format.',
    'decimal' => 'El campo :attribute debe tener :decimal cifras decimales.',
    'declined' => 'El campo :attribute debe ser rechazado.',
    'declined_if' => 'El campo :attribute debe ser rechazado cuando :other sea :value.',
    'different' => 'El campo :attribute y :other deben ser diferentes.',
    'digits' => 'El campo :attribute debe tener :digits dígitos.',
    'digits_between' => 'El campo :attribute debe tener entre :min y :max dígitos.',
    'dimensions' => 'El campo :attribute tiene dimensiones de imagen no válidas.',
    'distinct' => 'El campo :attribute contiene un valor duplicado.',
    'doesnt_contain' => 'El campo :attribute no debe contener ninguno de los siguientes valores: :values.',
    'doesnt_end_with' => 'El campo :attribute no debe finalizar con uno de los siguientes: :values.',
    'doesnt_start_with' => 'El campo :attribute no debe comenzar con uno de los siguientes: :values.',
    'email' => 'El campo :attribute no es un correo válido.',
    'ends_with' => 'El campo :attribute debe finalizar con uno de los siguientes valores: :values',
    'enum' => 'El campo :attribute no está en la lista de valores permitidos.',
    'exists' => 'El campo :attribute no existe.',
    'extensions' => 'El campo :attribute debe tener una de las siguientes extensiones: :values.',
    'file' => 'El campo :attribute debe ser un archivo.',
    'filled' => 'El campo :attribute es obligatorio.',
    'gt' => [
        'array' => 'El campo :attribute debe tener más de :value elementos.',
        'file' => 'El campo :attribute debe tener más de :value kilobytes.',
        'numeric' => 'El campo :attribute debe ser mayor que :value.',
        'string' => 'El campo :attribute debe tener más de :value caracteres.',
    ],
    'gte' => [
        'array' => 'El campo :attribute debe tener como mínimo :value elementos.',
        'file' => 'El campo :attribute debe tener como mínimo :value kilobytes.',
        'numeric' => 'El campo :attribute debe ser como mínimo :value.',
        'string' => 'El campo :attribute debe tener como mínimo :value caracteres.',
    ],
    'hex_color' => 'El campo :attribute debe tener un color hexadecimal válido.',
    'image' => 'El campo :attribute debe ser una imagen.',
    'in' => 'El campo :attribute no está en la lista de valores permitidos.',
    'in_array' => 'El campo :attribute debe existir en :other.',
    'in_array_keys' => 'El campo :attribute debe contener al menos una de las siguientes claves: :values.',
    'integer' => 'El campo :attribute debe ser un número entero.',
    'ip' => 'El campo :attribute debe ser una dirección IP válida.',
    'ipv4' => 'El campo :attribute debe ser una dirección IPv4 válida.',
    'ipv6' => 'El campo :attribute debe ser una dirección IPv6 válida.',
    'json' => 'El campo :attribute debe ser una cadena JSON válida.',
    'list' => 'El campo :attribute debe ser una lista.',
    'lowercase' => 'El campo :attribute debe estar en minúscula.',
    'lt' => [
        'array' => 'El campo :attribute debe tener menos de :value elementos.',
        'file' => 'El campo :attribute debe tener menos de :value kilobytes.',
        'numeric' => 'El campo :attribute debe ser menor que :value.',
        'string' => 'El campo :attribute debe tener menos de :value caracteres.',
    ],
    'lte' => [
        'array' => 'El campo :attribute debe tener como máximo :value elementos.',
        'file' => 'El campo :attribute debe tener como máximo :value kilobytes.',
        'numeric' => 'El campo :attribute debe ser como máximo :value.',
        'string' => 'El campo :attribute debe tener como máximo :value caracteres.',
    ],
    'mac_address' => 'El campo :attribute debe ser una dirección MAC válida.',
    'max' => [
        'array' => 'El campo :attribute no debe tener más de :max elementos.',
        'file' => 'El campo :attribute no debe ser mayor que :max kilobytes.',
        'numeric' => 'El campo :attribute no debe ser mayor que :max.',
        'string' => 'El campo :attribute no debe ser mayor que :max caracteres.',
    ],
    'max_digits' => 'El campo :attribute no debe tener más de :max dígitos.',
    'mimes' => 'El campo :attribute debe ser un archivo con formato: :values.',
    'mimetypes' => 'El campo :attribute debe ser un archivo con formato: :values.',
    'min' => [
        'array' => 'El campo :attribute debe tener al menos :min elementos.',
        'file' => 'El tamaño de :attribute debe ser de al menos :min kilobytes.',
        'numeric' => 'El tamaño de :attribute debe ser de al menos :min.',
        'string' => 'El campo :attribute debe contener al menos :min caracteres.',
    ],
    'min_digits' => 'El campo :attribute debe tener al menos :min dígitos.',
    'missing' => 'El campo :attribute no debe estar presente.',
    'missing_if' => 'El campo :attribute no debe estar presente cuando :other sea :value.',
    'missing_unless' => 'El campo :attribute no debe estar presente a menos que :other sea :value.',
    'missing_with' => 'El campo :attribute no debe estar presente si alguno de los campos :values está presente.',
    'missing_with_all' => 'El campo :attribute no debe estar presente cuando los campos :values estén presentes.',
    'multiple_of' => 'El campo :attribute debe ser múltiplo de :value',
    'not_in' => 'El campo :attribute no debe estar en la lista.',
    'not_regex' => 'El formato del campo :attribute no es válido.',
    'numeric' => 'El campo :attribute debe ser numérico.',
    'password' => [
        'letters' => 'La :attribute debe contener al menos una letra.',
        'mixed' => 'La :attribute debe contener al menos una letra mayúscula y una minúscula.',
        'numbers' => 'La :attribute debe contener al menos un número.',
        'symbols' => 'La :attribute debe contener al menos un símbolo.',
        'uncompromised' => 'La :attribute proporcionada se ha visto comprometida en una filtración de datos (data leak). Elija una :attribute diferente.',
    ],
    'present' => 'El campo :attribute debe estar presente.',
    'present_if' => 'El campo :attribute debe estar presente cuando :other es :value.',
    'present_unless' => 'El campo :attribute debe estar presente a menos que :other sea :value.',
    'present_with' => 'El campo :attribute debe estar presente cuando :values esté presente.',
    'present_with_all' => 'El campo :attribute debe estar presente cuando :values estén presentes.',
    'prohibited' => 'El campo :attribute está prohibido.',
    'prohibited_if' => 'El campo :attribute está prohibido cuando :other es :value.',
    'prohibited_if_accepted' => 'El campo :attribute está prohibido cuando se acepta :other.',
    'prohibited_if_declined' => 'El campo :attribute está prohibido cuando se rechaza :other.',
    'prohibited_unless' => 'El campo :attribute está prohibido a menos que :other sea :values.',
    'prohibits' => 'El campo :attribute prohibe que :other esté presente.',
    'regex' => 'El formato del campo :attribute no es válido.',
    'required' => 'El campo :attribute es obligatorio.',
    'required_array_keys' => 'El campo :attribute debe contener entradas para: :values.',
    'required_if' => 'El campo :attribute es obligatorio cuando :other es :value.',
    'required_if_accepted' => 'El campo :attribute es obligatorio si :other es aceptado.',
    'required_if_declined' => 'El campo :attribute es obligatorio si :other es rechazado.',
    'required_unless' => 'El campo :attribute es obligatorio a menos que :other esté en :values.',
    'required_with' => 'El campo :attribute es obligatorio cuando :values está presente.',
    'required_with_all' => 'El campo :attribute es obligatorio cuando :values están presentes.',
    'required_without' => 'El campo :attribute es obligatorio cuando :values no está presente.',
    'required_without_all' => 'El campo :attribute es obligatorio cuando ninguno de :values está presente.',
    'same' => 'Los campos :attribute y :other deben coincidir.',
    'size' => [
        'array' => 'El campo :attribute debe contener :size elementos.',
        'file' => 'El tamaño de :attribute debe ser :size kilobytes.',
        'numeric' => 'El tamaño de :attribute debe ser :size.',
        'string' => 'El campo :attribute debe contener :size caracteres.',
    ],
    'starts_with' => 'El campo :attribute debe comenzar con uno de los siguientes valores: :values',
    'string' => 'El campo :attribute debe ser una cadena de caracteres.',
    'timezone' => 'El campo :attribute debe ser una zona horaria válida.',
    'ulid' => 'El campo :attribute debe ser un ULID válido.',
    'unique' => 'El campo :attribute ya ha sido registrado.',
    'uploaded' => 'Subir :attribute ha fallado.',
    'uppercase' => 'El campo :attribute debe estar en mayúscula.',
    'url' => 'El campo :attribute debe ser una URL válida.',
    'uuid' => 'El campo :attribute debe ser un UUID válido.',
    'attributes' => [
        'address' => 'dirección',
        'affiliate_url' => 'URL de afiliado',
        'age' => 'edad',
        'amount' => 'cantidad',
        'announcement' => 'anuncio',
        'area' => 'área',
        'audience_prize' => 'premio del público',
        'audience_winner' => 'ganador del público',
        'available' => 'disponible',
        'birthday' => 'cumpleaños',
        'body' => 'contenido',
        'city' => 'ciudad',
        'company' => 'compañía',
        'compilation' => 'compilación',
        'concept' => 'concepto',
        'conditions' => 'condiciones',
        'content' => 'contenido',
        'contest' => 'concurso',
        'country' => 'país',
        'cover' => 'portada',
        'created_at' => 'creado el',
        'creator' => 'creador',
        'currency' => 'moneda',
        'current_password' => 'contraseña actual',
        'customer' => 'cliente',
        'date' => 'fecha',
        'date_of_birth' => 'fecha de nacimiento',
        'dates' => 'fechas',
        'day' => 'día',
        'deleted_at' => 'eliminado el',
        'description' => 'descripción',
        'display_type' => 'tipo de visualización',
        'district' => 'distrito',
        'duration' => 'duración',
        'email' => 'correo electrónico',
        'excerpt' => 'extracto',
        'filter' => 'filtro',
        'finished_at' => 'terminado el',
        'first_name' => 'nombre',
        'gender' => 'género',
        'grand_prize' => 'gran Premio',
        'group' => 'grupo',
        'hour' => 'hora',
        'image' => 'imagen',
        'image_desktop' => 'imagen de escritorio',
        'image_main' => 'imagen principal',
        'image_mobile' => 'imagen móvil',
        'images' => 'imágenes',
        'is_audience_winner' => 'es ganador de audiencia',
        'is_hidden' => 'está oculto',
        'is_subscribed' => 'está suscrito',
        'is_visible' => 'es visible',
        'is_winner' => 'es ganador',
        'items' => 'elementos',
        'key' => 'clave',
        'last_name' => 'apellidos',
        'lesson' => 'lección',
        'line_address_1' => 'línea de dirección 1',
        'line_address_2' => 'línea de dirección 2',
        'login' => 'acceso',
        'message' => 'mensaje',
        'middle_name' => 'segundo nombre',
        'minute' => 'minuto',
        'mobile' => 'móvil',
        'month' => 'mes',
        'name' => 'nombre',
        'national_code' => 'código nacional',
        'number' => 'número',
        'password' => 'contraseña',
        'password_confirmation' => 'confirmación de la contraseña',
        'phone' => 'teléfono',
        'photo' => 'foto',
        'portfolio' => 'portafolio',
        'postal_code' => 'código postal',
        'preview' => 'vista preliminar',
        'price' => 'precio',
        'product_id' => 'ID del producto',
        'product_uid' => 'UID del producto',
        'product_uuid' => 'UUID del producto',
        'promo_code' => 'código promocional',
        'province' => 'provincia',
        'quantity' => 'cantidad',
        'reason' => 'razón',
        'recaptcha_response_field' => 'respuesta del recaptcha',
        'referee' => 'árbitro',
        'referees' => 'árbitros',
        'reject_reason' => 'motivo de rechazo',
        'remember' => 'recordar',
        'restored_at' => 'restaurado el',
        'result_text_under_image' => 'texto bajo la imagen',
        'role' => 'rol',
        'rule' => 'regla',
        'rules' => 'reglas',
        'second' => 'segundo',
        'sex' => 'sexo',
        'shipment' => 'envío',
        'short_text' => 'texto corto',
        'size' => 'tamaño',
        'skills' => 'habilidades',
        'slug' => 'slug',
        'specialization' => 'especialización',
        'started_at' => 'comenzado el',
        'state' => 'estado',
        'status' => 'estado',
        'street' => 'calle',
        'student' => 'estudiante',
        'subject' => 'asunto',
        'tag' => 'etiqueta',
        'tags' => 'etiquetas',
        'teacher' => 'profesor',
        'terms' => 'términos',
        'test_description' => 'descripción de prueba',
        'test_locale' => 'idioma de prueba',
        'test_name' => 'nombre de prueba',
        'text' => 'texto',
        'time' => 'hora',
        'title' => 'título',
        'type' => 'tipo',
        'updated_at' => 'actualizado el',
        'user' => 'usuario',
        'username' => 'usuario',
        'value' => 'valor',
        'winner' => 'ganador',
        'work' => 'trabajo',
        'year' => 'año',
    ],
];
</file>

<file path="resources/js/bootstrap.js">
import axios from 'axios';
window.axios = axios;

window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

// --- CONFIGURACIÓN DE LARAVEL ECHO ---

import Echo from 'laravel-echo';
import Pusher from 'pusher-js';

window.Pusher = Pusher;

window.Echo = new Echo({
    broadcaster: 'reverb',
    key: import.meta.env.VITE_REVERB_APP_KEY,
    wsHost: import.meta.env.VITE_REVERB_HOST,
    wsPort: import.meta.env.VITE_REVERB_PORT ?? 80,
    wssPort: import.meta.env.VITE_REVERB_PORT ?? 443,
    forceTLS: (import.meta.env.VITE_REVERB_SCHEME ?? 'https') === 'https',
    enabledTransports: ['ws', 'wss'],
});
</file>

<file path="resources/js/Components/ChatbotWidget.vue">
<script setup>
import { ref, nextTick, computed, onMounted } from 'vue';
import axios from 'axios';
import { useAudioSynthesis } from '@/Composables/useAudioSynthesis';

// --- ESTADO DEL CHAT ---
const isOpen = ref(false);
const messages = ref([
    {
        id: 1,
        role: 'assistant',
        content:
            '¡Hola! Soy FlipperBot 🤖, tu asistente del taller Flipper Servicios. Puedo ayudarte con información sobre productos, precios, stock disponible y también con reservaciones. ¿En qué puedo asistirte hoy?',
        displayedContent: '',
        isTyping: false,
        fullyDisplayed: true,
    },
]);
const userInput = ref('');
const isLoading = ref(false);
const messagesContainer = ref(null);

// --- COMPOSABLE DE AUDIO ---
const { isSpeaking, isMuted, volume, speak, cancel, toggleMute, setVolume } = useAudioSynthesis();

// --- RECONOCIMIENTO DE VOZ (STT) ---
const isListening = ref(false);
const speechRecognitionSupported = ref(false);
let recognition = null;

// Inicialización completa del reconocimiento de voz
const initializeSpeechRecognition = () => {
    if (typeof window === 'undefined') return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        console.warn('Speech Recognition no soportado en este navegador');
        return;
    }

    speechRecognitionSupported.value = true;
    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
        isListening.value = true;
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        // Pequeño delay para que el usuario vea que se capturó su voz
        setTimeout(() => {
            sendMessage();
        }, 500);
    };

    recognition.onend = () => {
        isListening.value = false;
    };

    recognition.onerror = (event) => {
        console.error('Error de reconocimiento de voz:', event.error);
        isListening.value = false;

        // Manejo de errores específicos
        if (event.error === 'not-allowed') {
            addAssistantMessage(
                'Permiso de micrófono denegado. Por favor, permite el acceso al micrófono en tu navegador para usar el reconocimiento de voz.'
            );
        } else if (event.error === 'no-speech') {
            addAssistantMessage('No se detectó voz. Por favor, intenta de nuevo.');
        } else if (event.error === 'audio-capture') {
            addAssistantMessage('No se pudo acceder al micrófono. Verifica que esté conectado y tenga permisos.');
        }
    };
};

// --- EFECTO TYPEWRITER ---
const typewriterSpeed = 15;

const startTypewriterEffect = (messageId, fullContent) => {
    const messageIndex = messages.value.findIndex((msg) => msg.id === messageId);
    if (messageIndex === -1) return;

    messages.value[messageIndex].isTyping = true;
    messages.value[messageIndex].displayedContent = '';
    messages.value[messageIndex].fullyDisplayed = false;

    let index = 0;
    const typeInterval = setInterval(() => {
        if (index < fullContent.length) {
            messages.value[messageIndex].displayedContent += fullContent.charAt(index);
            index++;
            scrollToBottom();
        } else {
            clearInterval(typeInterval);
            messages.value[messageIndex].isTyping = false;
            messages.value[messageIndex].fullyDisplayed = true;
        }
    }, typewriterSpeed);
};

// --- FUNCIONES AUXILIARES ---
const addAssistantMessage = (content) => {
    const messageId = Date.now() + 1;
    const newMessage = {
        id: messageId,
        role: 'assistant',
        content: content,
        displayedContent: '',
        isTyping: true,
        fullyDisplayed: false,
    };

    messages.value.push(newMessage);
    scrollToBottom();

    // ✅ AUDIO INMEDIATO - Comienza al mismo tiempo que el typewriter
    if (!isMuted.value) {
        speak(content);
    }

    // ✅ TYPEWRITER SIMULTÁNEO
    startTypewriterEffect(messageId, content);

    return messageId;
};

const addUserMessage = (content) => {
    const newMessage = {
        id: Date.now(),
        role: 'user',
        content: content,
        displayedContent: content,
        isTyping: false,
        fullyDisplayed: true,
    };

    messages.value.push(newMessage);
    scrollToBottom();
};

const toggleMicrophone = () => {
    if (!speechRecognitionSupported.value || !recognition) {
        addAssistantMessage(
            'Tu navegador no soporta reconocimiento de voz. Te recomendamos usar Chrome, Edge o Safari para esta función.'
        );
        return;
    }

    if (isListening.value) {
        recognition.stop();
    } else {
        // Detener cualquier audio actual antes de escuchar
        cancel();

        try {
            recognition.start();
        } catch (error) {
            console.error('Error al iniciar reconocimiento de voz:', error);
            isListening.value = false;
            addAssistantMessage('Error al iniciar el reconocimiento de voz. Por favor, intenta de nuevo.');
        }
    }
};

// --- FUNCIÓN LIMPIAR CHAT ---
const clearChat = async () => {
    try {
        // Llamar al backend para limpiar el historial de la conversación
        await axios.post(
            route('chatbot.clear-history'),
            {},
            {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            }
        );

        // Limpiar el frontend: mantener solo el mensaje inicial
        const initialMessage = messages.value[0];
        messages.value = [
            {
                ...initialMessage,
                displayedContent: initialMessage.content,
                isTyping: false,
                fullyDisplayed: true,
            },
        ];

        // Cancelar cualquier audio en reproducción
        cancel();

        scrollToBottom();
    } catch (error) {
        console.error('Error al limpiar el historial:', error);

        // Mostrar un mensaje de error al usuario
        let errorMessage = 'No pude limpiar el historial de la conversación. ';

        if (error.response?.status === 419) {
            errorMessage += 'Error de sesión. Por favor, recarga la página.';
        } else if (error.response?.status >= 500) {
            errorMessage += 'Error del servidor. Intenta más tarde.';
        } else {
            errorMessage += 'Intenta de nuevo.';
        }

        console.error(errorMessage);
    }
};

// --- LÓGICA DEL CHAT ---
const toggleChat = () => {
    isOpen.value = !isOpen.value;
    if (isOpen.value) {
        scrollToBottom();
    }
};

const scrollToBottom = () => {
    nextTick(() => {
        if (messagesContainer.value) {
            const scrollHeight = messagesContainer.value.scrollHeight;
            const height = messagesContainer.value.clientHeight;
            const maxScrollTop = scrollHeight - height;
            messagesContainer.value.scrollTop = maxScrollTop > 0 ? maxScrollTop : 0;
        }
    });
};

const sendMessage = async () => {
    const trimmedInput = userInput.value.trim();
    if (!trimmedInput || isLoading.value) return;

    const question = trimmedInput;

    // 1. Agregar mensaje del usuario
    addUserMessage(question);
    userInput.value = '';
    isLoading.value = true;
    scrollToBottom();

    try {
        // 2. Llamada al Backend (RAG)
        const response = await axios.post(
            route('chatbot.ask'),
            {
                message: question,
            },
            {
                timeout: 30000,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            }
        );

        const answer = response.data.response;

        // 3. Agregar respuesta del bot (audio + typewriter simultáneos)
        addAssistantMessage(answer);
    } catch (error) {
        console.error('Error en la comunicación con el chatbot:', error);

        let errorMessage = 'Lo siento, tuve un error de conexión. Intenta de nuevo.';

        if (error.code === 'ECONNABORTED' || error.response?.status === 408) {
            errorMessage = 'La solicitud está tomando demasiado tiempo. Por favor, intenta de nuevo.';
        } else if (error.response?.status >= 500) {
            errorMessage = 'Error del servidor. Por favor, intenta más tarde.';
        } else if (error.response?.status === 429) {
            errorMessage = 'Demasiadas solicitudes. Por favor, espera un momento antes de intentar de nuevo.';
        }

        addAssistantMessage(errorMessage);
    } finally {
        isLoading.value = false;
        scrollToBottom();
    }
};

// Computed para mostrar el contenido correcto
const displayMessages = computed(() => {
    return messages.value.map((msg) => ({
        ...msg,
        displayContent: msg.isTyping ? msg.displayedContent : msg.content,
    }));
});

// Computed para mostrar el puntito rojo solo cuando hay mensajes nuevos
const hasNewMessages = computed(() => {
    return messages.value.length > 1;
});

// Manejar la tecla Enter para enviar mensaje
const handleKeyPress = (event) => {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
};

// Inicializar cuando el componente se monta
onMounted(() => {
    initializeSpeechRecognition();

    // Inicializar el mensaje de bienvenida
    if (messages.value[0]) {
        messages.value[0].displayedContent = messages.value[0].content;
        messages.value[0].fullyDisplayed = true;
    }
});
</script>

<template>
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end space-y-4">
        <!-- VENTANA DEL CHAT -->
        <transition
            enter-active-class="transition ease-out duration-300"
            enter-from-class="opacity-0 translate-y-4 scale-95"
            enter-to-class="opacity-100 translate-y-0 scale-100"
            leave-active-class="transition ease-in duration-200"
            leave-from-class="opacity-100 translate-y-0 scale-100"
            leave-to-class="opacity-0 translate-y-4 scale-95"
        >
            <div
                v-show="isOpen"
                class="w-[450px] bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden h-[650px]"
            >
                <!-- CABECERA Y CONTROLES DE AUDIO -->
                <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-white font-bold flex items-center text-lg">
                            <span class="text-2xl mr-3">🤖</span>
                            <div>
                                <div>FlipperBot</div>
                                <div class="text-xs font-normal opacity-90">Asistente Virtual</div>
                            </div>
                        </h3>
                        <div class="flex items-center space-x-3">
                            <!-- BOTÓN LIMPIAR CHAT -->
                            <button
                                v-if="hasNewMessages"
                                class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"
                                title="Limpiar conversación"
                                aria-label="Limpiar conversación"
                                @click="clearChat"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                    ></path>
                                </svg>
                            </button>
                            <button
                                class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"
                                aria-label="Cerrar chat"
                                @click="toggleChat"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"
                                    ></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- PANEL DE CONTROL DE AUDIO SIMPLIFICADO -->
                    <div class="bg-black/20 rounded-lg p-3 flex items-center justify-between text-white">
                        <div class="flex space-x-3">
                            <!-- Stop -->
                            <button
                                class="hover:text-red-300 transition-colors duration-200 p-2 rounded-full hover:bg-white/10"
                                :class="{ 'opacity-50 cursor-not-allowed': !isSpeaking }"
                                :disabled="!isSpeaking"
                                title="Detener audio"
                                aria-label="Detener audio"
                                @click="cancel"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                            </button>

                            <!-- Mute -->
                            <button
                                class="hover:text-cyan-200 transition-colors duration-200 p-2 rounded-full hover:bg-white/10"
                                :class="{ 'text-red-400': isMuted }"
                                title="Silenciar audio"
                                aria-label="Silenciar audio"
                                @click="toggleMute"
                            >
                                <svg
                                    v-if="isMuted"
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                                        clip-rule="evenodd"
                                    ></path>
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"
                                    ></path>
                                </svg>
                                <svg v-else class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        fill-rule="evenodd"
                                        d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                            </button>
                        </div>
                        <!-- Slider Volumen -->
                        <div class="flex items-center space-x-3">
                            <span class="text-sm text-white/80">Volumen</span>
                            <input
                                v-model="volume"
                                type="range"
                                min="0"
                                max="1"
                                step="0.1"
                                class="w-24 accent-cyan-300 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                aria-label="Volumen"
                                @input="setVolume($event.target.value)"
                            />
                        </div>
                    </div>
                </div>

                <!-- AREA DE MENSAJES -->
                <div
                    ref="messagesContainer"
                    class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50 dark:bg-gray-900 scroll-smooth custom-scrollbar"
                >
                    <div
                        v-for="msg in displayMessages"
                        :key="msg.id"
                        :class="{
                            'flex justify-end': msg.role === 'user',
                            'flex justify-start': msg.role === 'assistant',
                        }"
                        class="message-item"
                    >
                        <div
                            :class="{
                                'bg-blue-600 text-white': msg.role === 'user',
                                'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600':
                                    msg.role === 'assistant',
                            }"
                            class="max-w-[85%] rounded-2xl px-5 py-3 shadow-sm text-sm transition-all duration-200"
                        >
                            <!-- Contenido del mensaje con efecto typewriter -->
                            <div class="whitespace-pre-wrap break-words leading-relaxed">
                                {{ msg.displayContent }}
                                <!-- Cursor parpadeante para mensajes que se están escribiendo -->
                                <span
                                    v-if="msg.isTyping && msg.role === 'assistant'"
                                    class="inline-block w-2 h-4 bg-blue-500 ml-1 animate-pulse align-middle"
                                ></span>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div v-if="isLoading" class="flex justify-start">
                        <div
                            class="bg-white dark:bg-gray-700 rounded-2xl px-5 py-3 border border-gray-200 dark:border-gray-600 shadow-sm"
                        >
                            <div class="flex space-x-2 items-center">
                                <div class="text-sm text-gray-600 dark:text-gray-300 mr-3">
                                    FlipperBot está pensando...
                                </div>
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                                    <div
                                        class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                                        style="animation-delay: 0.1s"
                                    ></div>
                                    <div
                                        class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                                        style="animation-delay: 0.2s"
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INPUT AREA MÁS GRANDE -->
                <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="text-xs text-gray-500 dark:text-gray-400 flex-1">
                            Escribe tu pregunta o usa el micrófono
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ userInput.length }}/500</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button
                            class="p-3 rounded-full transition-all duration-300 relative group flex-shrink-0"
                            :class="{
                                'text-red-500 bg-red-50 dark:bg-red-900/20 animate-pulse': isListening,
                                'text-gray-500 hover:text-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700':
                                    !isListening,
                            }"
                            :title="isListening ? 'Detener grabación' : 'Hablar con voz'"
                            :disabled="isLoading || !speechRecognitionSupported"
                            aria-label="Activar micrófono"
                            @click="toggleMicrophone"
                        >
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    fill-rule="evenodd"
                                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            <!-- Indicador de grabación -->
                            <div
                                v-if="isListening"
                                class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"
                            ></div>
                            <div
                                v-if="isListening"
                                class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"
                            ></div>
                        </button>

                        <input
                            v-model="userInput"
                            type="text"
                            placeholder="Escribe tu consulta sobre productos, precios, stock o reservaciones..."
                            class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-2xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 py-3 px-4 transition-all duration-200 placeholder-gray-500 dark:placeholder-gray-400"
                            :disabled="isLoading"
                            maxlength="500"
                            aria-label="Escribir mensaje"
                            @keyup="handleKeyPress"
                        />

                        <button
                            class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 active:scale-95 flex-shrink-0"
                            :disabled="!userInput.trim() || isLoading"
                            title="Enviar mensaje"
                            aria-label="Enviar mensaje"
                            @click="sendMessage"
                        >
                            <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- BOTÓN FLOTANTE -->
        <button
            class="w-16 h-16 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-full shadow-2xl hover:shadow-cyan-500/50 hover:scale-110 transition-all duration-300 transform flex items-center justify-center text-white focus:outline-none focus:ring-4 focus:ring-cyan-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 group"
            :aria-expanded="isOpen"
            aria-label="Abrir chat de FlipperBot"
            @click="toggleChat"
        >
            <span v-if="!isOpen" class="text-3xl group-hover:scale-110 transition-transform">💬</span>
            <svg
                v-else
                class="w-8 h-8 group-hover:scale-110 transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>

            <!-- PUNTITO ROJO SOLO CUANDO HAY MENSAJES NUEVOS -->
            <div
                v-if="!isOpen && hasNewMessages"
                class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full animate-pulse border-2 border-white dark:border-gray-800"
            ></div>
        </button>
    </div>
</template>

<style scoped>
/* Scrollbar personalizado para navegadores WebKit */
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.7);
}

/* Mejoras de accesibilidad */
@media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition,
    .transform {
        transition: none !important;
    }

    .animate-pulse,
    .animate-bounce,
    .animate-ping {
        animation: none !important;
    }
}

/* Mejoras para modo oscuro */
@media (prefers-color-scheme: dark) {
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(75, 85, 99, 0.5);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(75, 85, 99, 0.7);
    }
}

/* Mejoras de estilo para mensajes */
.message-item:last-child {
    margin-bottom: 0;
}
</style>
</file>

<file path="resources/js/Components/Checkbox.vue">
<script setup>
import { computed } from 'vue';

const emit = defineEmits(['update:checked']);

const props = defineProps({
    checked: {
        type: [Array, Boolean],
        required: true,
    },
    value: {
        default: null,
    },
});

const proxyChecked = computed({
    get() {
        return props.checked;
    },

    set(val) {
        emit('update:checked', val);
    },
});
</script>

<template>
    <input
        v-model="proxyChecked"
        type="checkbox"
        :value="value"
        class="rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500"
    />
</template>
</file>

<file path="resources/js/Components/DropdownLink.vue">
<script setup>
import { Link } from '@inertiajs/vue3';
defineProps({ href: { type: String, required: true } });
</script>
<template>
    <Link
        :href="href"
        class="block w-full px-4 py-2 text-left text-sm leading-5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:bg-gray-100 dark:focus:bg-gray-600 transition duration-150 ease-in-out"
    >
        <slot />
    </Link>
</template>
</file>

<file path="resources/js/Components/InputLabel.vue">
<script setup>
defineProps({
    value: {
        type: String,
    },
});
</script>

<template>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        <span v-if="value">{{ value }}</span>
        <span v-else><slot /></span>
    </label>
</template>
</file>

<file path="resources/js/Components/Modal.vue">
<script setup>
import { computed, onMounted, onUnmounted, ref, watch } from 'vue';

const props = defineProps({
    show: {
        type: Boolean,
        default: false,
    },
    maxWidth: {
        type: String,
        default: '2xl',
    },
    closeable: {
        type: Boolean,
        default: true,
    },
});

const emit = defineEmits(['close']);
const dialog = ref();
const showSlot = ref(props.show);

watch(
    () => props.show,
    () => {
        if (props.show) {
            document.body.style.overflow = 'hidden';
            showSlot.value = true;

            dialog.value?.showModal();
        } else {
            document.body.style.overflow = '';

            setTimeout(() => {
                dialog.value?.close();
                showSlot.value = false;
            }, 200);
        }
    }
);

const close = () => {
    if (props.closeable) {
        emit('close');
    }
};

const closeOnEscape = (e) => {
    if (e.key === 'Escape') {
        e.preventDefault();

        if (props.show) {
            close();
        }
    }
};

onMounted(() => document.addEventListener('keydown', closeOnEscape));

onUnmounted(() => {
    document.removeEventListener('keydown', closeOnEscape);

    document.body.style.overflow = '';
});

const maxWidthClass = computed(() => {
    return {
        sm: 'sm:max-w-sm',
        md: 'sm:max-w-md',
        lg: 'sm:max-w-lg',
        xl: 'sm:max-w-xl',
        '2xl': 'sm:max-w-2xl',
    }[props.maxWidth];
});
</script>

<template>
    <dialog ref="dialog" class="z-50 m-0 min-h-full min-w-full overflow-y-auto bg-transparent backdrop:bg-transparent">
        <div class="fixed inset-0 z-50 overflow-y-auto px-4 py-6 sm:px-0" scroll-region>
            <Transition
                enter-active-class="ease-out duration-300"
                enter-from-class="opacity-0"
                enter-to-class="opacity-100"
                leave-active-class="ease-in duration-200"
                leave-from-class="opacity-100"
                leave-to-class="opacity-0"
            >
                <div v-show="show" class="fixed inset-0 transform transition-all" @click="close">
                    <div class="absolute inset-0 bg-gray-500 opacity-75" />
                </div>
            </Transition>

            <Transition
                enter-active-class="ease-out duration-300"
                enter-from-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                enter-to-class="opacity-100 translate-y-0 sm:scale-100"
                leave-active-class="ease-in duration-200"
                leave-from-class="opacity-100 translate-y-0 sm:scale-100"
                leave-to-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
                <div
                    v-show="show"
                    class="mb-6 transform overflow-hidden rounded-lg bg-white shadow-xl transition-all sm:mx-auto sm:w-full"
                    :class="maxWidthClass"
                >
                    <slot v-if="showSlot" />
                </div>
            </Transition>
        </div>
    </dialog>
</template>
</file>

<file path="resources/js/Components/NavLink.vue">
<script setup>
import { computed } from 'vue';
import { Link } from '@inertiajs/vue3';

const props = defineProps({
    href: {
        type: String,
        required: true,
    },
    active: {
        type: Boolean,
    },
});

const classes = computed(() =>
    props.active
        ? 'inline-flex items-center px-1 pt-1 border-b-2 border-indigo-400 text-sm font-medium leading-5 text-gray-900 focus:outline-none focus:border-indigo-700 transition duration-150 ease-in-out'
        : 'inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition duration-150 ease-in-out'
);
</script>

<template>
    <Link :href="href" :class="classes">
        <slot />
    </Link>
</template>
</file>

<file path="resources/js/Composables/useAudioSynthesis.js">
import { ref, onUnmounted } from 'vue';

export function useAudioSynthesis() {
    const synth = window.speechSynthesis;
    const utterance = ref(null);

    // Estado reactivo
    const isSpeaking = ref(false);
    const isMuted = ref(false);
    const volume = ref(1.0);

    // Configuración de voz
    const getSpanishVoice = () => {
        const voices = synth.getVoices();

        // Priorizar voces en español
        const spanishVoices = voices.filter((v) => v.lang.includes('es'));

        // Ordenar por preferencia
        return (
            spanishVoices.find((v) => v.lang.includes('es-ES')) ||
            spanishVoices.find((v) => v.lang.includes('es-419')) ||
            spanishVoices.find((v) => v.lang.includes('es-MX')) ||
            spanishVoices[0] ||
            voices[0]
        );
    };

    const speak = (text) => {
        if (isMuted.value || !text.trim()) return;

        // Cancelar cualquier audio previo
        cancel();

        const newUtterance = new SpeechSynthesisUtterance(text);

        newUtterance.lang = 'es-ES';
        newUtterance.rate = 1.0;
        newUtterance.pitch = 1.0;
        newUtterance.volume = volume.value;

        // Intentar asignar voz en español
        const voice = getSpanishVoice();
        if (voice) {
            newUtterance.voice = voice;
        }

        // Eventos
        newUtterance.onstart = () => {
            isSpeaking.value = true;
        };

        newUtterance.onend = () => {
            isSpeaking.value = false;
            utterance.value = null;
        };

        newUtterance.onerror = (e) => {
            console.error('TTS Error:', e);
            isSpeaking.value = false;
        };

        utterance.value = newUtterance;
        synth.speak(newUtterance);
    };

    const cancel = () => {
        synth.cancel();
        isSpeaking.value = false;
        utterance.value = null;
    };

    const toggleMute = () => {
        isMuted.value = !isMuted.value;
        if (isMuted.value) {
            cancel();
        }
    };

    const setVolume = (val) => {
        volume.value = parseFloat(val);
        // El volumen se aplicará al próximo utterance
        // No interrumpimos el audio actual
    };

    // Cargar voces cuando estén disponibles
    if (typeof window !== 'undefined') {
        if (synth.getVoices().length > 0) {
            getSpanishVoice();
        } else {
            synth.addEventListener('voiceschanged', () => {
                getSpanishVoice();
            });
        }
    }

    // Limpieza al desmontar el componente
    onUnmounted(() => {
        cancel();
    });

    return {
        isSpeaking,
        isMuted,
        volume,
        speak,
        cancel,
        toggleMute,
        setVolume,
    };
}
</file>

<file path="resources/js/Pages/Auth/ConfirmPassword.vue">
<script setup>
import GuestLayout from '@/Layouts/GuestLayout.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Head, useForm } from '@inertiajs/vue3';

const form = useForm({
    password: '',
});

const submit = () => {
    form.post(route('password.confirm'), {
        onFinish: () => form.reset(),
    });
};
</script>

<template>
    <GuestLayout>
        <Head title="Confirm Password" />

        <div class="mb-4 text-sm text-gray-600">
            This is a secure area of the application. Please confirm your password before continuing.
        </div>

        <form @submit.prevent="submit">
            <div>
                <InputLabel for="password" value="Password" />
                <TextInput
                    id="password"
                    v-model="form.password"
                    type="password"
                    class="mt-1 block w-full"
                    required
                    autocomplete="current-password"
                    autofocus
                />
                <InputError class="mt-2" :message="form.errors.password" />
            </div>

            <div class="mt-4 flex justify-end">
                <PrimaryButton class="ms-4" :class="{ 'opacity-25': form.processing }" :disabled="form.processing">
                    Confirm
                </PrimaryButton>
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/Auth/ResetPassword.vue">
<script setup>
import GuestLayout from '@/Layouts/GuestLayout.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Head, useForm } from '@inertiajs/vue3';

const props = defineProps({
    email: {
        type: String,
        required: true,
    },
    token: {
        type: String,
        required: true,
    },
});

const form = useForm({
    token: props.token,
    email: props.email,
    password: '',
    password_confirmation: '',
});

const submit = () => {
    form.post(route('password.store'), {
        onFinish: () => form.reset('password', 'password_confirmation'),
    });
};
</script>

<template>
    <GuestLayout>
        <Head title="Reset Password" />

        <form @submit.prevent="submit">
            <div>
                <InputLabel for="email" value="Email" />

                <TextInput
                    id="email"
                    v-model="form.email"
                    type="email"
                    class="mt-1 block w-full"
                    required
                    autofocus
                    autocomplete="username"
                />

                <InputError class="mt-2" :message="form.errors.email" />
            </div>

            <div class="mt-4">
                <InputLabel for="password" value="Password" />

                <TextInput
                    id="password"
                    v-model="form.password"
                    type="password"
                    class="mt-1 block w-full"
                    required
                    autocomplete="new-password"
                />

                <InputError class="mt-2" :message="form.errors.password" />
            </div>

            <div class="mt-4">
                <InputLabel for="password_confirmation" value="Confirm Password" />

                <TextInput
                    id="password_confirmation"
                    v-model="form.password_confirmation"
                    type="password"
                    class="mt-1 block w-full"
                    required
                    autocomplete="new-password"
                />

                <InputError class="mt-2" :message="form.errors.password_confirmation" />
            </div>

            <div class="mt-4 flex items-center justify-end">
                <PrimaryButton :class="{ 'opacity-25': form.processing }" :disabled="form.processing">
                    Reset Password
                </PrimaryButton>
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/Auth/VerifyEmail.vue">
<script setup>
import { computed } from 'vue';
import GuestLayout from '@/Layouts/GuestLayout.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import { Head, Link, useForm } from '@inertiajs/vue3';

const props = defineProps({
    status: {
        type: String,
    },
});

const form = useForm({});

const submit = () => {
    form.post(route('verification.send'));
};

const verificationLinkSent = computed(() => props.status === 'verification-link-sent');
</script>

<template>
    <GuestLayout>
        <Head title="Email Verification" />

        <div class="mb-4 text-sm text-gray-600">
            Thanks for signing up! Before getting started, could you verify your email address by clicking on the link
            we just emailed to you? If you didn't receive the email, we will gladly send you another.
        </div>

        <div v-if="verificationLinkSent" class="mb-4 text-sm font-medium text-green-600">
            A new verification link has been sent to the email address you provided during registration.
        </div>

        <form @submit.prevent="submit">
            <div class="mt-4 flex items-center justify-between">
                <PrimaryButton :class="{ 'opacity-25': form.processing }" :disabled="form.processing">
                    Resend Verification Email
                </PrimaryButton>

                <Link
                    :href="route('logout')"
                    method="post"
                    as="button"
                    class="rounded-md text-sm text-gray-600 underline hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    >Log Out</Link
                >
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/MechanicPanel/Dashboard.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head } from '@inertiajs/vue3';
</script>

<template>
    <Head title="Panel de Mecánico" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Panel de Mecánico</h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">¡Bienvenido!</h3>
                            <p class="text-gray-600 dark:text-gray-400">
                                Aquí verás tus tareas asignadas y el estado de las órdenes de trabajo.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Profile/Partials/DeleteUserForm.vue">
<script setup>
import DangerButton from '@/Components/DangerButton.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import Modal from '@/Components/Modal.vue';
import SecondaryButton from '@/Components/SecondaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { useForm } from '@inertiajs/vue3';
import { nextTick, ref } from 'vue';

const confirmingUserDeletion = ref(false);
const passwordInput = ref(null);

const form = useForm({
    password: '',
});

const confirmUserDeletion = () => {
    confirmingUserDeletion.value = true;

    nextTick(() => passwordInput.value.focus());
};

const deleteUser = () => {
    form.delete(route('profile.destroy'), {
        preserveScroll: true,
        onSuccess: () => closeModal(),
        onError: () => passwordInput.value.focus(),
        onFinish: () => form.reset(),
    });
};

const closeModal = () => {
    confirmingUserDeletion.value = false;

    form.clearErrors();
    form.reset();
};
</script>

<template>
    <section class="space-y-6">
        <header>
            <h2 class="text-lg font-medium text-gray-900">Delete Account</h2>

            <p class="mt-1 text-sm text-gray-600">
                Once your account is deleted, all of its resources and data will be permanently deleted. Before deleting
                your account, please download any data or information that you wish to retain.
            </p>
        </header>

        <DangerButton @click="confirmUserDeletion">Delete Account</DangerButton>

        <Modal :show="confirmingUserDeletion" @close="closeModal">
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900">Are you sure you want to delete your account?</h2>

                <p class="mt-1 text-sm text-gray-600">
                    Once your account is deleted, all of its resources and data will be permanently deleted. Please
                    enter your password to confirm you would like to permanently delete your account.
                </p>

                <div class="mt-6">
                    <InputLabel for="password" value="Password" class="sr-only" />

                    <TextInput
                        id="password"
                        ref="passwordInput"
                        v-model="form.password"
                        type="password"
                        class="mt-1 block w-3/4"
                        placeholder="Password"
                        @keyup.enter="deleteUser"
                    />

                    <InputError :message="form.errors.password" class="mt-2" />
                </div>

                <div class="mt-6 flex justify-end">
                    <SecondaryButton @click="closeModal"> Cancel </SecondaryButton>

                    <DangerButton
                        class="ms-3"
                        :class="{ 'opacity-25': form.processing }"
                        :disabled="form.processing"
                        @click="deleteUser"
                    >
                        Delete Account
                    </DangerButton>
                </div>
            </div>
        </Modal>
    </section>
</template>
</file>

<file path="resources/js/Pages/Profile/Partials/UpdatePasswordForm.vue">
<script setup>
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { useForm } from '@inertiajs/vue3';
import { ref } from 'vue';

const passwordInput = ref(null);
const currentPasswordInput = ref(null);

const form = useForm({
    current_password: '',
    password: '',
    password_confirmation: '',
});

const updatePassword = () => {
    form.put(route('password.update'), {
        preserveScroll: true,
        onSuccess: () => form.reset(),
        onError: () => {
            if (form.errors.password) {
                form.reset('password', 'password_confirmation');
                passwordInput.value.focus();
            }
            if (form.errors.current_password) {
                form.reset('current_password');
                currentPasswordInput.value.focus();
            }
        },
    });
};
</script>

<template>
    <section>
        <header>
            <h2 class="text-lg font-medium text-gray-900">Update Password</h2>

            <p class="mt-1 text-sm text-gray-600">
                Ensure your account is using a long, random password to stay secure.
            </p>
        </header>

        <form class="mt-6 space-y-6" @submit.prevent="updatePassword">
            <div>
                <InputLabel for="current_password" value="Current Password" />

                <TextInput
                    id="current_password"
                    ref="currentPasswordInput"
                    v-model="form.current_password"
                    type="password"
                    class="mt-1 block w-full"
                    autocomplete="current-password"
                />

                <InputError :message="form.errors.current_password" class="mt-2" />
            </div>

            <div>
                <InputLabel for="password" value="New Password" />

                <TextInput
                    id="password"
                    ref="passwordInput"
                    v-model="form.password"
                    type="password"
                    class="mt-1 block w-full"
                    autocomplete="new-password"
                />

                <InputError :message="form.errors.password" class="mt-2" />
            </div>

            <div>
                <InputLabel for="password_confirmation" value="Confirm Password" />

                <TextInput
                    id="password_confirmation"
                    v-model="form.password_confirmation"
                    type="password"
                    class="mt-1 block w-full"
                    autocomplete="new-password"
                />

                <InputError :message="form.errors.password_confirmation" class="mt-2" />
            </div>

            <div class="flex items-center gap-4">
                <PrimaryButton :disabled="form.processing">Save</PrimaryButton>

                <Transition
                    enter-active-class="transition ease-in-out"
                    enter-from-class="opacity-0"
                    leave-active-class="transition ease-in-out"
                    leave-to-class="opacity-0"
                >
                    <p v-if="form.recentlySuccessful" class="text-sm text-gray-600">Saved.</p>
                </Transition>
            </div>
        </form>
    </section>
</template>
</file>

<file path="resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.vue">
<script setup>
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Link, useForm, usePage } from '@inertiajs/vue3';

defineProps({
    mustVerifyEmail: {
        type: Boolean,
    },
    status: {
        type: String,
    },
});

const user = usePage().props.auth.user;

const form = useForm({
    name: user.name,
    email: user.email,
});
</script>

<template>
    <section>
        <header>
            <h2 class="text-lg font-medium text-gray-900">Profile Information</h2>

            <p class="mt-1 text-sm text-gray-600">Update your account's profile information and email address.</p>
        </header>

        <form class="mt-6 space-y-6" @submit.prevent="form.patch(route('profile.update'))">
            <div>
                <InputLabel for="name" value="Name" />

                <TextInput
                    id="name"
                    v-model="form.name"
                    type="text"
                    class="mt-1 block w-full"
                    required
                    autofocus
                    autocomplete="name"
                />

                <InputError class="mt-2" :message="form.errors.name" />
            </div>

            <div>
                <InputLabel for="email" value="Email" />

                <TextInput
                    id="email"
                    v-model="form.email"
                    type="email"
                    class="mt-1 block w-full"
                    required
                    autocomplete="username"
                />

                <InputError class="mt-2" :message="form.errors.email" />
            </div>

            <div v-if="mustVerifyEmail && user.email_verified_at === null">
                <p class="mt-2 text-sm text-gray-800">
                    Your email address is unverified.
                    <Link
                        :href="route('verification.send')"
                        method="post"
                        as="button"
                        class="rounded-md text-sm text-gray-600 underline hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    >
                        Click here to re-send the verification email.
                    </Link>
                </p>

                <div v-show="status === 'verification-link-sent'" class="mt-2 text-sm font-medium text-green-600">
                    A new verification link has been sent to your email address.
                </div>
            </div>

            <div class="flex items-center gap-4">
                <PrimaryButton :disabled="form.processing">Save</PrimaryButton>

                <Transition
                    enter-active-class="transition ease-in-out"
                    enter-from-class="opacity-0"
                    leave-active-class="transition ease-in-out"
                    leave-to-class="opacity-0"
                >
                    <p v-if="form.recentlySuccessful" class="text-sm text-gray-600">Saved.</p>
                </Transition>
            </div>
        </form>
    </section>
</template>
</file>

<file path="resources/js/ziggy.js">
const Ziggy = {
    url: 'http:\/\/localhost',
    port: null,
    defaults: {},
    routes: {
        'sanctum.csrf-cookie': { uri: 'sanctum\/csrf-cookie', methods: ['GET', 'HEAD'] },
        'admin.scheduling.capacities.index': { uri: 'admin\/scheduling\/capacidades', methods: ['GET', 'HEAD'] },
        'admin.scheduling.capacities.store': { uri: 'admin\/scheduling\/capacidades', methods: ['POST'] },
        'cliente.dashboard': { uri: 'cliente\/dashboard', methods: ['GET', 'HEAD'] },
        dashboard: { uri: 'dashboard', methods: ['GET', 'HEAD'] },
        'profile.edit': { uri: 'profile', methods: ['GET', 'HEAD'] },
        'profile.update': { uri: 'profile', methods: ['PATCH'] },
        'profile.destroy': { uri: 'profile', methods: ['DELETE'] },
        register: { uri: 'register', methods: ['GET', 'HEAD'] },
        login: { uri: 'login', methods: ['GET', 'HEAD'] },
        'password.request': { uri: 'forgot-password', methods: ['GET', 'HEAD'] },
        'password.email': { uri: 'forgot-password', methods: ['POST'] },
        'password.reset': { uri: 'reset-password\/{token}', methods: ['GET', 'HEAD'], parameters: ['token'] },
        'password.store': { uri: 'reset-password', methods: ['POST'] },
        'verification.notice': { uri: 'verify-email', methods: ['GET', 'HEAD'] },
        'verification.verify': {
            uri: 'verify-email\/{id}\/{hash}',
            methods: ['GET', 'HEAD'],
            parameters: ['id', 'hash'],
        },
        'verification.send': { uri: 'email\/verification-notification', methods: ['POST'] },
        'password.confirm': { uri: 'confirm-password', methods: ['GET', 'HEAD'] },
        'password.update': { uri: 'password', methods: ['PUT'] },
        logout: { uri: 'logout', methods: ['POST'] },
        'clientes.index': { uri: 'clientes', methods: ['GET', 'HEAD'] },
        'clientes.create': { uri: 'clientes\/crear', methods: ['GET', 'HEAD'] },
        'clientes.store': { uri: 'clientes', methods: ['POST'] },
        'clientes.show': {
            uri: 'clientes\/{cliente}',
            methods: ['GET', 'HEAD'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.edit': {
            uri: 'clientes\/{cliente}\/editar',
            methods: ['GET', 'HEAD'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.update': {
            uri: 'clientes\/{cliente}',
            methods: ['PATCH'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.destroy': {
            uri: 'clientes\/{cliente}',
            methods: ['DELETE'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.vehiculos.create': {
            uri: 'clientes\/{cliente}\/vehiculos\/crear',
            methods: ['GET', 'HEAD'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.vehiculos.store': {
            uri: 'clientes\/{cliente}\/vehiculos',
            methods: ['POST'],
            parameters: ['cliente'],
            bindings: { cliente: 'id' },
        },
        'clientes.vehiculos.edit': {
            uri: 'clientes\/{cliente}\/vehiculos\/{vehiculo}\/editar',
            methods: ['GET', 'HEAD'],
            parameters: ['cliente', 'vehiculo'],
            bindings: { cliente: 'id', vehiculo: 'id' },
        },
        'clientes.vehiculos.update': {
            uri: 'clientes\/{cliente}\/vehiculos\/{vehiculo}',
            methods: ['PATCH'],
            parameters: ['cliente', 'vehiculo'],
            bindings: { cliente: 'id', vehiculo: 'id' },
        },
        'clientes.vehiculos.destroy': {
            uri: 'clientes\/{cliente}\/vehiculos\/{vehiculo}',
            methods: ['DELETE'],
            parameters: ['cliente', 'vehiculo'],
            bindings: { cliente: 'id', vehiculo: 'id' },
        },
        'inventario.products.index': { uri: 'inventario\/productos', methods: ['GET', 'HEAD'] },
        'inventario.products.create': { uri: 'inventario\/productos\/crear', methods: ['GET', 'HEAD'] },
        'inventario.products.store': { uri: 'inventario\/productos', methods: ['POST'] },
        'inventario.products.edit': {
            uri: 'inventario\/productos\/{product}\/editar',
            methods: ['GET', 'HEAD'],
            parameters: ['product'],
            bindings: { product: 'id' },
        },
        'inventario.products.update': {
            uri: 'inventario\/productos\/{product}',
            methods: ['PATCH'],
            parameters: ['product'],
            bindings: { product: 'id' },
        },
        'inventario.products.destroy': {
            uri: 'inventario\/productos\/{product}',
            methods: ['DELETE'],
            parameters: ['product'],
            bindings: { product: 'id' },
        },
        'inventario.suppliers.index': { uri: 'inventario\/proveedores', methods: ['GET', 'HEAD'] },
        'inventario.suppliers.create': { uri: 'inventario\/proveedores\/crear', methods: ['GET', 'HEAD'] },
        'inventario.suppliers.store': { uri: 'inventario\/proveedores', methods: ['POST'] },
        'inventario.suppliers.edit': {
            uri: 'inventario\/proveedores\/{supplier}\/editar',
            methods: ['GET', 'HEAD'],
            parameters: ['supplier'],
            bindings: { supplier: 'id' },
        },
        'inventario.suppliers.update': {
            uri: 'inventario\/proveedores\/{supplier}',
            methods: ['PATCH'],
            parameters: ['supplier'],
            bindings: { supplier: 'id' },
        },
        'inventario.suppliers.destroy': {
            uri: 'inventario\/proveedores\/{supplier}',
            methods: ['DELETE'],
            parameters: ['supplier'],
            bindings: { supplier: 'id' },
        },
        'mecanico.dashboard': { uri: 'mecanico\/dashboard', methods: ['GET', 'HEAD'] },
        'work-orders.index': { uri: 'ordenes-trabajo', methods: ['GET', 'HEAD'] },
        'work-orders.create': {
            uri: 'ordenes-trabajo\/crear\/vehiculo\/{vehiculo}',
            methods: ['GET', 'HEAD'],
            parameters: ['vehiculo'],
            bindings: { vehiculo: 'id' },
        },
        'work-orders.store': { uri: 'ordenes-trabajo', methods: ['POST'] },
        'work-orders.show': {
            uri: 'ordenes-trabajo\/{workOrder}',
            methods: ['GET', 'HEAD'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.update': {
            uri: 'ordenes-trabajo\/{workOrder}',
            methods: ['PATCH'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.destroy': {
            uri: 'ordenes-trabajo\/{workOrder}',
            methods: ['DELETE'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.products.add': {
            uri: 'ordenes-trabajo\/{workOrder}\/products',
            methods: ['POST'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.products.remove': {
            uri: 'ordenes-trabajo\/{workOrder}\/products\/{product}',
            methods: ['DELETE'],
            parameters: ['workOrder', 'product'],
            bindings: { workOrder: 'id', product: 'id' },
        },
        'work-orders.services.add': {
            uri: 'ordenes-trabajo\/{workOrder}\/services',
            methods: ['POST'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.services.remove': {
            uri: 'ordenes-trabajo\/{workOrder}\/services\/{service}',
            methods: ['DELETE'],
            parameters: ['workOrder', 'service'],
            bindings: { workOrder: 'id', service: 'id' },
        },
        'work-orders.external-costs.add': {
            uri: 'ordenes-trabajo\/{workOrder}\/external-costs',
            methods: ['POST'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'work-orders.external-costs.remove': {
            uri: 'ordenes-trabajo\/external-costs\/{externalCost}',
            methods: ['DELETE'],
            parameters: ['externalCost'],
            bindings: { externalCost: 'id' },
        },
        'work-orders.assign-mechanic': {
            uri: 'ordenes-trabajo\/{workOrder}\/assign-mechanic',
            methods: ['PATCH'],
            parameters: ['workOrder'],
            bindings: { workOrder: 'id' },
        },
        'storage.local': {
            uri: 'storage\/{path}',
            methods: ['GET', 'HEAD'],
            wheres: { path: '.*' },
            parameters: ['path'],
        },
    },
};
if (typeof window !== 'undefined' && typeof window.Ziggy !== 'undefined') {
    Object.assign(Ziggy.routes, window.Ziggy.routes);
}
export { Ziggy };
</file>

<file path="src/ClientPortal/Providers/ClientPortalServiceProvider.php">
<?php

namespace FlipperBox\ClientPortal\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class ClientPortalServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->prefix('cliente')
            ->name('cliente.')
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/ClientScheduling/Providers/ClientSchedulingServiceProvider.php">
<?php

namespace FlipperBox\ClientScheduling\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class ClientSchedulingServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->prefix('cliente/reservas')
            ->name('cliente.reservations.')
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/Core/Http/Controllers/ChatbotController.php">
<?php

namespace FlipperBox\Core\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Services\ChatbotService;
use App\Services\EmbeddingService;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\Scheduling\Models\DailyCapacity;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ChatbotController extends Controller
{
    public function __construct(
        protected EmbeddingService $embeddingService,
        protected ChatbotService $chatbotService
    ) {}

    public function handle(Request $request)
    {
        // 1. Validar entrada
        $request->validate([
            'message' => 'required|string|max:500',
        ]);

        $question = $request->input('message');

        // 2. Generar Embedding de la pregunta
        $questionEmbedding = $this->embeddingService->generate($question);

        if (! $questionEmbedding) {
            return response()->json([
                'response' => 'Lo siento, no pude entender tu pregunta en este momento (Error de vectorización).',
            ]);
        }

        // 3. Búsqueda Vectorial (RAG) - Productos
        $vectorString = json_encode($questionEmbedding);

        $similarProducts = Product::query()
            ->select('name', 'description', 'price', 'current_stock')
            ->selectRaw("embedding <=> '{$vectorString}' as distance")
            ->orderBy('distance', 'asc')
            ->limit(4)
            ->get();

        // 4. Construir el Contexto para la IA
        $context = '';
        foreach ($similarProducts as $product) {
            // Formatear precio correctamente
            $precioFormateado = $this->formatPriceForContext($product->price);

            // Formatear para que sea más legible en el contexto
            $context .= "Producto: {$product->name}. Precio: {$precioFormateado}. Stock: {$product->current_stock}. Descripción: {$product->description}. ";
        }

        if ($similarProducts->isEmpty()) {
            $context = 'No se encontraron productos relevantes en el inventario.';
        }

        // 5. DETECCIÓN DE INTENCIÓN MEJORADA
        $reservationInfo = [];
        $isReservationQuestion = $this->detectReservationIntent($question);

        if ($isReservationQuestion) {
            $reservationInfo = $this->getReservationAvailability();
        }

        // 6. Obtener conversationId (usar la sesión o generar una)
        $conversationId = $this->getConversationId($request);

        // 7. Generar Respuesta con LLM (con historial de conversación)
        $answer = $this->chatbotService->answer($question, $context, $reservationInfo, $conversationId);

        return response()->json([
            'response' => $answer,
            'conversation_id' => $conversationId, // Opcional: para debugging
        ]);
    }

    /**
     * Obtiene o genera un ID de conversación único
     */
    private function getConversationId(Request $request): string
    {
        // Intentar obtener de la sesión
        if ($request->hasSession()) {
            $conversationId = $request->session()->get('chatbot_conversation_id');
            if (! $conversationId) {
                $conversationId = uniqid('chat_', true);
                $request->session()->put('chatbot_conversation_id', $conversationId);
            }

            return $conversationId;
        }

        // Si no hay sesión, usar el IP + User-Agent como fallback
        $userIp = $request->ip() ?? 'unknown';
        $userAgent = $request->userAgent() ?? 'unknown';

        return 'chat_'.md5($userIp.$userAgent);
    }

    /**
     * Endpoint para limpiar el historial de conversación
     */
    public function clearHistory(Request $request)
    {
        $conversationId = $this->getConversationId($request);
        $this->chatbotService->clearConversationHistory($conversationId);

        return response()->json([
            'success' => true,
            'message' => 'Historial de conversación limpiado',
        ]);
    }

    /**
     * Formatea el precio para el contexto del LLM
     */
    private function formatPriceForContext(float $price): string
    {
        $parteEntera = (int) floor($price);
        $centavos = (int) round(($price - $parteEntera) * 100);

        $parteEnteraFormateada = number_format($parteEntera, 0, '', '.');

        if ($centavos === 0) {
            return $parteEnteraFormateada.' pesos';
        }

        return $parteEnteraFormateada.' pesos con '.$centavos.' centavos';
    }

    /**
     * Detecta si la pregunta está relacionada con reservaciones (MEJORADO)
     */
    private function detectReservationIntent(string $question): bool
    {
        $reservationKeywords = [
            'reserva', 'reservar', 'reservación', 'cita', 'agendar', 'turno',
            'cupo', 'disponibilidad', 'fecha disponible', 'horario', 'día disponible',
            'programar', 'citación', 'booking', 'schedule', 'appointment',
            'quiero reservar', 'necesito turno', 'hay cupo', 'tienen horarios',
            'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo',
            'mañana', 'pasado mañana', 'esta semana', 'próxima semana',
        ];

        $question = mb_strtolower($question);

        foreach ($reservationKeywords as $keyword) {
            if (str_contains($question, $keyword)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Obtiene información de disponibilidad de reservaciones
     */
    private function getReservationAvailability(): array
    {
        $info = [];

        try {
            // Obtener disponibilidad de los próximos 7 días
            $availabilities = DailyCapacity::where('date', '>=', now()->toDateString())
                ->where('date', '<=', now()->addDays(7)->toDateString())
                ->orderBy('date')
                ->get();

            foreach ($availabilities as $availability) {
                $availableSlots = $availability->total_slots - $availability->booked_slots;
                $dateFormatted = $availability->date->format('d/m/Y');
                $dayName = $availability->date->dayName;

                if ($availableSlots > 0) {
                    $info[] = "{$dayName} {$dateFormatted}: {$availableSlots} cupos disponibles";
                } else {
                    $info[] = "{$dayName} {$dateFormatted}: Sin cupos disponibles";
                }
            }

            if (empty($info)) {
                $info[] = 'No hay cupos disponibles en los próximos 7 días.';
            } else {
                // Agregar instrucciones generales
                $info[] = 'Para hacer una reserva, visita nuestra sección de reservas en el sitio web y selecciona tu vehículo y la fecha deseada.';
            }

        } catch (\Exception $e) {
            Log::error('Error obteniendo disponibilidad: '.$e->getMessage());
            $info[] = 'No pude consultar la disponibilidad en este momento. Por favor, visita la sección de reservas para ver los horarios disponibles.';
        }

        return $info;
    }
}
</file>

<file path="src/Core/Providers/CoreServiceProvider.php">
<?php

namespace FlipperBox\Core\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class CoreServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap services.
     */
    public function boot(): void
    {
        Route::middleware('web')
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/Crm/Actions/CreateUserAsClientAction.php">
<?php

namespace FlipperBox\Crm\Actions;

use App\Models\User;
use Illuminate\Support\Facades\Hash;
use Spatie\Permission\Models\Role;

class CreateUserAsClientAction
{
    public function execute(array $data): User
    {
        // Añadimos la contraseña por defecto
        $data['password'] = Hash::make('password');

        $user = User::create($data);

        // Asignamos el rol 'Cliente'
        $clienteRole = Role::findByName('Cliente');
        $user->assignRole($clienteRole);

        return $user;
    }
}
</file>

<file path="src/Crm/Http/Requests/StoreUserAsClientRequest.php">
<?php

namespace FlipperBox\Crm\Http\Requests;

use App\Models\User;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;

class StoreUserAsClientRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('crear clientes');
    }

    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:255'],
            'apellido' => ['nullable', 'string', 'max:255'],
            'email' => ['required', 'string', 'lowercase', 'email', 'max:255', 'unique:'.User::class],
            'telefono' => ['nullable', 'string', 'max:20', 'unique:'.User::class],
            'documento_tipo' => ['nullable', 'string', 'max:50'],
            'documento_valor' => ['nullable', 'string', 'max:50', 'unique:'.User::class],
        ];
    }
}
</file>

<file path="src/Crm/Http/Requests/UpdateUserAsClientRequest.php">
<?php

namespace FlipperBox\Crm\Http\Requests;

use App\Models\User;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class UpdateUserAsClientRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('editar clientes');
    }

    public function rules(): array
    {
        $userId = $this->route('user')->id;

        return [
            'name' => ['required', 'string', 'max:255'],
            'apellido' => ['nullable', 'string', 'max:255'],
            'email' => ['required', 'string', 'lowercase', 'email', 'max:255', Rule::unique(User::class)->ignore($userId)],
            'telefono' => ['nullable', 'string', 'max:20', Rule::unique(User::class)->ignore($userId)],
            'documento_tipo' => ['nullable', 'string', 'max:50'],
            'documento_valor' => ['nullable', 'string', 'max:50', Rule::unique(User::class)->ignore($userId)],
        ];
    }
}
</file>

<file path="src/Crm/Http/Requests/UpdateVehiculoRequest.php">
<?php

namespace FlipperBox\Crm\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class UpdateVehiculoRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('editar vehiculos');
    }

    public function rules(): array
    {
        // Obtenemos el ID del vehículo que se está editando desde la ruta
        $vehiculoId = $this->route('vehiculo')->id;

        return [
            'patente' => ['required', 'string', 'max:255', Rule::unique('vehiculos', 'patente')->ignore($vehiculoId)],
            'marca' => ['required', 'string', 'max:255'],
            'modelo' => ['required', 'string', 'max:255'],
            'anio' => ['required', 'integer', 'min:1950', 'max:'.date('Y')],
            'kilometraje' => ['nullable', 'integer', 'min:0'],
            'vin' => ['nullable', 'string', 'max:255', Rule::unique('vehiculos', 'vin')->ignore($vehiculoId)],
            'numero_motor' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
        ];
    }
}
</file>

<file path="src/Inventory/Actions/ActualizarProductoAction.php">
<?php

namespace FlipperBox\Inventory\Actions;

use FlipperBox\Inventory\Models\Product;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class ActualizarProductoAction
{
    public function execute(Product $product, array $data): Product
    {
        return DB::transaction(function () use ($product, $data) {
            // 1. Actualizar los datos principales del producto.
            // El evento 'saving' en el modelo se encargará de recalcular el 'price'.
            $product->update($data);

            // 2. Actualizar el costo en la tabla pivot para el proveedor seleccionado.
            // updateExistingPivot asume que la relación ya existe.
            $product->suppliers()->updateExistingPivot($data['supplier_id'], [
                'cost' => $data['cost'],
            ]);

            Log::info("Producto actualizado: ID {$product->id} - {$product->name}");

            return $product;
        });
    }
}
</file>

<file path="src/Inventory/Http/Requests/StoreSupplierRequest.php">
<?php

namespace FlipperBox\Inventory\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;

class StoreSupplierRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar proveedores');
    }

    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:255', 'unique:suppliers,name'],
            'contact_person' => ['nullable', 'string', 'max:255'],
            'phone' => ['nullable', 'string', 'max:255'],
            'email' => ['nullable', 'email', 'max:255', 'unique:suppliers,email'],
            'address' => ['nullable', 'string'],
        ];
    }
}
</file>

<file path="src/Inventory/Http/Requests/UpdateProductRequest.php">
<?php

namespace FlipperBox\Inventory\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class UpdateProductRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar inventario');
    }

    public function rules(): array
    {
        $productId = $this->route('product')->id;

        return [
            'name' => ['required', 'string', 'max:255'],
            'sku' => ['required', 'string', 'max:255', Rule::unique('products', 'sku')->ignore($productId)],
            'description' => ['nullable', 'string'],
            'cost' => ['required', 'numeric', 'min:0'],
            'iva_percentage' => ['required', 'numeric', 'min:0'],
            'profit_margin' => ['required', 'numeric', 'min:0'],
            'current_stock' => ['required', 'integer', 'min:0'],
            'min_threshold' => ['required', 'integer', 'min:0'],
            'supplier_id' => ['required', 'exists:suppliers,id'],
        ];
    }
}
</file>

<file path="src/Inventory/Http/Requests/UpdateSupplierRequest.php">
<?php

namespace FlipperBox\Inventory\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class UpdateSupplierRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar proveedores');
    }

    public function rules(): array
    {
        $supplierId = $this->route('supplier')->id;

        return [
            'name' => ['required', 'string', 'max:255', Rule::unique('suppliers', 'name')->ignore($supplierId)],
            'contact_person' => ['nullable', 'string', 'max:255'],
            'phone' => ['nullable', 'string', 'max:255'],
            'email' => ['nullable', 'email', 'max:255', Rule::unique('suppliers', 'email')->ignore($supplierId)],
            'address' => ['nullable', 'string'],
        ];
    }
}
</file>

<file path="src/Inventory/Models/InventoryMovement.php">
<?php

namespace FlipperBox\Inventory\Models;

use App\Models\User;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class InventoryMovement extends Model
{
    use HasFactory;

    protected $fillable = ['product_id', 'user_id', 'type', 'quantity', 'reason'];

    public function product(): BelongsTo
    {
        return $this->belongsTo(Product::class);
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="src/Inventory/Models/Supplier.php">
<?php

namespace FlipperBox\Inventory\Models;

use Database\Factories\SupplierFactory;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\SoftDeletes;

class Supplier extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = ['name', 'contact_person', 'phone', 'email', 'address'];

    public function products(): BelongsToMany
    {
        return $this->belongsToMany(Product::class)
            ->withPivot('cost')
            ->withTimestamps();
    }

    protected static function newFactory()
    {
        return SupplierFactory::new();
    }
}
</file>

<file path="src/Inventory/Providers/InventoryServiceProvider.php">
<?php

namespace FlipperBox\Inventory\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class InventoryServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/MechanicPanel/Http/Controllers/DashboardController.php">
<?php

namespace FlipperBox\MechanicPanel\Http\Controllers;

use App\Http\Controllers\Controller;
use Inertia\Inertia;
use Inertia\Response;

class DashboardController extends Controller
{
    public function index(): Response
    {
        return Inertia::render('MechanicPanel/Dashboard');
    }
}
</file>

<file path="src/MechanicPanel/Providers/MechanicPanelServiceProvider.php">
<?php

namespace FlipperBox\MechanicPanel\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class MechanicPanelServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap services.
     */
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->prefix('mecanico')
            ->name('mecanico.')
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/MechanicPanel/routes/web.php">
<?php

use FlipperBox\MechanicPanel\Http\Controllers\DashboardController;
use Illuminate\Support\Facades\Route;

Route::get('/dashboard', [DashboardController::class, 'index'])->name('dashboard');
</file>

<file path="src/Scheduling/Models/DailyCapacity.php">
<?php

namespace FlipperBox\Scheduling\Models;

use Illuminate\Database\Eloquent\Model;

class DailyCapacity extends Model
{
    protected $fillable = ['date', 'total_slots', 'booked_slots'];

    protected $casts = ['date' => 'date'];
}
</file>

<file path="src/Scheduling/Models/Reservation.php">
<?php

namespace FlipperBox\Scheduling\Models;

use App\Models\User;
use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Reservation extends Model
{
    protected $fillable = ['user_id', 'vehicle_id', 'reservation_date', 'status', 'notes'];

    protected $casts = ['reservation_date' => 'date'];

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(Vehiculo::class);
    }
}
</file>

<file path="src/Scheduling/Providers/SchedulingServiceProvider.php">
<?php

namespace FlipperBox\Scheduling\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class SchedulingServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->group(function () {
                Route::middleware('can:gestionar cupos')
                    ->prefix('admin/scheduling')
                    ->name('admin.scheduling.')
                    ->group(function () {
                        $this->loadRoutesFrom(__DIR__.'/../routes/admin.php');
                    });
            });
    }
}
</file>

<file path="src/WorkManagement/Http/Requests/StoreServiceRequest.php">
<?php

namespace FlipperBox\WorkManagement\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class StoreServiceRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar servicios');
    }

    public function rules(): array
    {
        return [
            'name' => [
                'required',
                'string',
                'max:255',
                Rule::unique('services', 'name')->whereNull('deleted_at'),
            ],
            'description' => ['nullable', 'string', 'max:1000'],
            'price' => ['required', 'numeric', 'min:0'],
        ];
    }
}
</file>

<file path="src/WorkManagement/Http/Requests/UpdateServiceRequest.php">
<?php

namespace FlipperBox\WorkManagement\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class UpdateServiceRequest extends FormRequest
{
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar servicios');
    }

    public function rules(): array
    {
        $serviceId = $this->route('service')->id;

        return [
            'name' => [
                'required',
                'string',
                'max:255',
                Rule::unique('services', 'name')->ignore($serviceId)->whereNull('deleted_at'),
            ],
            'description' => ['nullable', 'string', 'max:1000'],
            'price' => ['required', 'numeric', 'min:0'],
        ];
    }
}
</file>

<file path="src/WorkManagement/Providers/WorkManagementServiceProvider.php">
<?php

namespace FlipperBox\WorkManagement\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class WorkManagementServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Route::middleware(['web', 'auth'])
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="tailwind.config.js">
import defaultTheme from 'tailwindcss/defaultTheme';
import forms from '@tailwindcss/forms';

/** @type {import('tailwindcss').Config} */
export default {
    darkMode: 'class',
    content: [
        './vendor/laravel/framework/src/Illuminate/Pagination/resources/views/*.blade.php',
        './storage/framework/views/*.php',
        './resources/views/**/*.blade.php',
        './resources/js/**/*.vue',
    ],

    theme: {
        extend: {
            fontFamily: {
                sans: ['Figtree', ...defaultTheme.fontFamily.sans],
            },
        },
    },

    plugins: [forms],
};
</file>

<file path=".husky/pre-commit">
npx lint-staged
php artisan test
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Routing\Controller as BaseController;

class Controller extends BaseController
{
    use AuthorizesRequests, ValidatesRequests;
}
</file>

<file path="app/Observers/ProductObserver.php">
<?php

namespace App\Observers;

use App\Services\EmbeddingService;
use FlipperBox\Inventory\Models\Product;
use Illuminate\Contracts\Events\ShouldHandleEventsAfterCommit;
use Illuminate\Validation\ValidationException;

class ProductObserver implements ShouldHandleEventsAfterCommit
{
    public function __construct(
        protected EmbeddingService $embeddingService
    ) {}

    /**
     * Handle the Product "saved" event.
     * Se ejecuta después de created y updated, solo si la transacción fue exitosa.
     */
    public function saved(Product $product): void
    {
        // Solo generamos embedding si cambió información relevante o es nuevo
        if ($product->wasRecentlyCreated || $product->isDirty(['name', 'description', 'sku'])) {
            $this->updateEmbedding($product);
        }
    }

    /**
     * Handle the Product "deleting" event.
     */
    public function deleting(Product $product): void
    {
        // Regla de negocio: No se puede eliminar (ni siquiera soft delete) un producto
        // si ya ha sido utilizado en CUALQUIER orden de trabajo.
        if ($product->workOrders()->exists()) {
            throw ValidationException::withMessages([
                'error' => 'No se puede eliminar este producto porque tiene un historial en órdenes de trabajo. Puede desactivarlo o archivarlo en una futura actualización.',
            ]);
        }
    }

    private function updateEmbedding(Product $product): void
    {
        // Construimos un texto rico semánticamente para el embedding
        $textToEmbed = "Producto: {$product->name}. SKU: {$product->sku}. Descripción: {$product->description}. Precio: {$product->price}.";

        $embedding = $this->embeddingService->generate($textToEmbed);

        if ($embedding) {
            // Usamos saveQuietly para evitar un bucle infinito de eventos 'saved'
            $product->embedding = $embedding;
            $product->saveQuietly();
        }
    }
}
</file>

<file path="app/Policies/VehiculoPolicy.php">
<?php

namespace App\Policies;

use App\Models\User;
use FlipperBox\Crm\Models\Vehiculo;

class VehiculoPolicy
{
    /**
     * Realiza una verificación "antes" de cualquier otro método.
     * Si el usuario es un Admin, se le concede acceso total inmediatamente.
     */
    public function before(User $user, string $ability): ?bool
    {
        if ($user->hasRole('Admin')) {
            return true;
        }

        return null; // Dejar que las otras reglas decidan
    }

    /**
     * Determina si el usuario puede ver la lista de sus vehículos.
     */
    public function viewAny(User $user): bool
    {
        // Verificamos el permiso explícito que creamos para el rol 'Cliente'.
        return $user->can('ver mis vehiculos');
    }

    /**
     * Determina si el usuario puede ver un vehículo específico.
     */
    public function view(User $user, Vehiculo $vehiculo): bool
    {
        // Un usuario puede ver un vehículo si es SU vehículo.
        return $user->id === $vehiculo->user_id;
    }

    /**
     * Determina si el usuario puede crear vehículos.
     */
    public function create(User $user): bool
    {
        // Cualquier usuario con permiso para ver la lista, puede crear.
        return $user->can('ver mis vehiculos');
    }

    /**
     * Determina si el usuario puede actualizar un vehículo.
     */
    public function update(User $user, Vehiculo $vehiculo): bool
    {
        // Un usuario puede actualizar un vehículo si es SU vehículo.
        return $user->id === $vehiculo->user_id;
    }

    /**
     * Determina si el usuario puede eliminar un vehículo.
     */
    public function delete(User $user, Vehiculo $vehiculo): bool
    {
        // Un usuario puede eliminar un vehículo si es SU vehículo.
        return $user->id === $vehiculo->user_id;
    }
}
</file>

<file path="config/database.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for database operations. This is
    | the connection which will be utilized unless another connection
    | is explicitly specified when you execute a query / statement.
    |
    */

    'default' => env('DB_CONNECTION', 'sqlite'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Below are all of the database connections defined for your application.
    | An example configuration is provided for each database system which
    | is supported by Laravel. You're free to add / remove connections.
    |
    */

    'connections' => [

        'sqlite' => [
            'driver' => 'sqlite',
            'url' => env('DB_URL'),
            'database' => env('DB_DATABASE', database_path('database.sqlite')),
            'prefix' => '',
            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),
            'busy_timeout' => null,
            'journal_mode' => null,
            'synchronous' => null,
            'transaction_mode' => 'DEFERRED',
        ],

        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'mariadb' => [
            'driver' => 'mariadb',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'pgsql' => [
            'driver' => 'pgsql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '5432'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            'search_path' => 'public',
            'sslmode' => 'prefer',
            'options' => [
                PDO::ATTR_EMULATE_PREPARES => true,
            ],
        ],

        'sqlsrv' => [
            'driver' => 'sqlsrv',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', 'localhost'),
            'port' => env('DB_PORT', '1433'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            // 'encrypt' => env('DB_ENCRYPT', 'yes'),
            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run on the database.
    |
    */

    'migrations' => [
        'table' => 'migrations',
        'update_date_on_publish' => true,
    ],

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer body of commands than a typical key-value system
    | such as Memcached. You may define your connection settings here.
    |
    */

    'redis' => [

        'client' => env('REDIS_CLIENT', 'phpredis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-database-'),
            'persistent' => env('REDIS_PERSISTENT', false),
        ],

        'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

    ],

];
</file>

<file path="database/factories/ProductFactory.php">
<?php

namespace Database\Factories;

use FlipperBox\Inventory\Models\Product;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\FlipperBox\Inventory\Models\Product>
 */
class ProductFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Product::class;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        $productName = 'Filtro de '.fake()->randomElement(['Aceite', 'Aire', 'Combustible']).' '.fake()->word();

        $cost = fake()->randomFloat(2, 5, 300);
        $ivaPercentage = 21.00;
        $profitMargin = fake()->randomElement([30, 40, 50]);

        // Calcular el precio: (Costo + IVA) × (1 + Margen%)
        $costWithIva = $cost * (1 + ($ivaPercentage / 100));
        $price = $costWithIva * (1 + ($profitMargin / 100));

        return [
            'name' => $productName,
            'sku' => 'SKU-'.strtoupper(Str::random(8)),
            'description' => fake()->sentence(10),
            'cost' => $cost,
            'iva_percentage' => $ivaPercentage,
            'profit_margin' => $profitMargin,
            'price' => round($price, 2),
            'current_stock' => fake()->numberBetween(0, 100),
            'min_threshold' => fake()->numberBetween(5, 20),
        ];
    }
}
</file>

<file path="database/factories/UserFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\App\Models\User>
 */
class UserFactory extends Factory
{
    /**
     * The current password being used by the factory.
     */
    protected static ?string $password;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->firstName(),
            'apellido' => fake()->lastName(),
            'email' => fake()->unique()->safeEmail(),
            'telefono' => fake()->unique()->e164PhoneNumber(),
            'email_verified_at' => now(),
            'password' => static::$password ??= Hash::make('password'),
            'remember_token' => Str::random(10),
        ];
    }

    /**
     * Indicate that the model's email address should be unverified.
     */
    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }
}
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('apellido')->nullable();
            $table->string('email')->unique();
            $table->string('telefono')->nullable()->unique();
            $table->string('documento_tipo')->nullable();
            $table->string('documento_valor')->nullable()->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
</file>

<file path="database/migrations/2025_11_04_193251_create_products_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('sku')->unique()->comment('Stock Keeping Unit');
            $table->text('description')->nullable();
            $table->decimal('cost', 10, 2)->comment('Precio de compra');
            $table->decimal('iva_percentage', 5, 2)->default(21.00)->comment('Porcentaje de IVA');
            $table->decimal('profit_margin', 5, 2)->default(40.00)->comment('Margen de ganancia');
            $table->decimal('price', 10, 2)->comment('Precio de venta (calculado)');
            $table->integer('current_stock')->default(0);
            $table->integer('min_threshold')->default(5)->comment('Umbral de stock bajo');
            $table->timestamps();
            $table->softDeletes();
            $table->index('name');
            $table->index('sku');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('products');
    }
};
</file>

<file path="database/seeders/DatabaseSeeder.php">
<?php

namespace Database\Seeders;

use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    use WithoutModelEvents;

    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        $this->call(DemoSeeder::class);
    }
}
</file>

<file path="README.md">
<p align="center">
    <img src="./public/images/logo-full.jpg" width="400" alt="FlipperBox Logo">
</p>

<h1 align="center">FlipperBox</h1>

<p align="center">
    <strong>Sistema Integral de Gestión para Talleres Mecánicos y Lubricentros</strong>
</p>

<p align="center">
    <a href="https://laravel.com"><img src="https://img.shields.io/badge/Laravel-12-FF2D20?style=flat-square&logo=laravel" alt="Laravel 12"></a>
    <a href="https://vuejs.org/"><img src="https://img.shields.io/badge/Vue.js-3-4FC08D?style=flat-square&logo=vue.js" alt="Vue 3"></a>
    <a href="https://inertiajs.com/"><img src="https://img.shields.io/badge/Inertia.js-2.0-9553E9?style=flat-square&logo=inertia" alt="Inertia"></a>
    <a href="https://tailwindcss.com/"><img src="https://img.shields.io/badge/Tailwind_CSS-3.4-38B2AC?style=flat-square&logo=tailwind-css" alt="Tailwind CSS"></a>
    <a href="https://www.postgresql.org/"><img src="https://img.shields.io/badge/PostgreSQL-16-4169E1?style=flat-square&logo=postgresql" alt="PostgreSQL"></a>
</p>

---

## 🚀 Sobre el Proyecto

**FlipperBox** es una plataforma SaaS diseñada para modernizar la gestión operativa del taller "Flipper Servicios y Lubricantes". Transforma procesos manuales y descentralizados en un ecosistema digital eficiente.

El sistema centraliza la gestión de clientes, vehículos, inventario y órdenes de trabajo, ofreciendo además un portal de autogestión para clientes y herramientas avanzadas como un **Chatbot con IA (RAG)** y notificaciones en tiempo real.

### ✨ Características Principales

- **🔐 Roles y Permisos (RBAC):** Paneles diferenciados para Administradores, Mecánicos y Clientes.
- **🚗 Gestión de Flota:** Historial clínico completo de cada vehículo.
- **📦 Inventario Inteligente:** Control de stock transaccional con cálculo automático de precios (Costo + IVA + Margen).
- **🔧 Órdenes de Trabajo:** Flujo completo desde la recepción hasta la facturación, con gestión de mano de obra y costos externos.
- **📅 Turnos y Cupos:** Sistema de reservas online con control de capacidad diaria.
- **🤖 Asistente IA:** Chatbot integrado con RAG para responder consultas sobre stock y servicios las 24/7.
- **🔔 Notificaciones Real-Time:** Avisos instantáneos (WebSockets) y por correo electrónico (Transactional Email).

---

## 🛠️ Stack Tecnológico

- **Backend:** Laravel 12 (PHP 8.3)
- **Frontend:** Vue 3 + Inertia.js
- **Base de Datos:** PostgreSQL (con extensión `pgvector` para IA)
- **Estilos:** Tailwind CSS
- **Tiempo Real:** Laravel Reverb (WebSockets) + Laravel Echo
- **IA:** Integración con Hugging Face (Embeddings) y Groq (LLM)
- **Calidad de Código:** Laravel Pint, ESLint, Prettier, Husky (Git Hooks)

---

## ⚙️ Instalación y Despliegue Local

Sigue estos pasos para levantar el proyecto en tu entorno local.

### Prerrequisitos
- PHP 8.3+
- Composer
- Node.js & NPM
- PostgreSQL

### Pasos

1.  **Clonar el repositorio**
    ```bash
    git clone https://github.com/tu-usuario/flipperbox.git
    cd flipperbox
    ```

2.  **Instalar dependencias**
    ```bash
    composer install
    npm install
    ```

3.  **Configurar entorno**
    ```bash
    cp .env.example .env
    php artisan key:generate
    ```
    *Configura tus credenciales de base de datos (DB_*) y servicios externos (REVERB, GROQ, HUGGINGFACE) en el archivo `.env`.*

4.  **Base de Datos y Seeders**
    ```bash
    php artisan migrate:fresh --seed
    ```

5.  **Ejecutar servidores**
    Necesitarás correr estos comandos en terminales separadas:
    ```bash
    # Servidor Web
    php artisan serve

    # Compilación de Assets (Vite)
    npm run dev

    # Servidor de WebSockets (Reverb)
    php artisan reverb:start

    # Worker de Colas (Para emails y notificaciones)
    php artisan queue:work
    ```

---

## 🧪 Testing y Calidad

El proyecto cuenta con pipelines de CI/CD y herramientas de calidad configuradas.

- **Ejecutar Tests (PHPUnit):** `php artisan test`
- **Formatear Código (Pint):** `./vendor/bin/pint`
- **Linting Frontend:** `npm run lint`

---

## 📄 Licencia

Este proyecto es de código abierto y está licenciado bajo la [MIT license](https://opensource.org/licenses/MIT).
</file>

<file path="resources/js/app.js">
import '../css/app.css';
import './bootstrap';

import { createInertiaApp } from '@inertiajs/vue3';
import { resolvePageComponent } from 'laravel-vite-plugin/inertia-helpers';
import { createApp, h } from 'vue';
import { ZiggyVue } from '../../vendor/tightenco/ziggy';

if (
    localStorage.theme === 'dark' ||
    (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
) {
    document.documentElement.classList.add('dark');
} else {
    document.documentElement.classList.remove('dark');
}

const appName = import.meta.env.VITE_APP_NAME || 'Laravel';

createInertiaApp({
    title: (title) => `${title} - ${appName}`,
    resolve: (name) => resolvePageComponent(`./Pages/${name}.vue`, import.meta.glob('./Pages/**/*.vue')),
    setup({ el, App, props, plugin }) {
        return createApp({ render: () => h(App, props) })
            .use(plugin)
            .use(ZiggyVue)
            .mount(el);
    },
    progress: {
        color: '#4B5563',
    },
});
</file>

<file path="resources/js/Components/ApplicationLogo.vue">
<template>
    <div v-bind="$attrs">
        <!-- Logo para Modo Claro (se oculta en dark) -->
        <img src="/images/logo-light.png" alt="FlipperBox Logo" class="dark:hidden h-full w-auto object-contain" />
        <!-- Logo para Modo Oscuro (se oculta en light) -->
        <img src="/images/logo-dark.png" alt="FlipperBox Logo" class="hidden dark:block h-full w-auto object-contain" />
    </div>
</template>
</file>

<file path="resources/js/Components/ConfirmationModal.vue">
<script setup>
import Modal from './Modal.vue';

const emit = defineEmits(['close', 'confirm']);

defineProps({
    show: { type: Boolean, default: false },
    title: { type: String, default: 'Confirmar Acción' },
    message: { type: String, default: '¿Estás seguro de que deseas realizar esta acción?' },

    // --- NUEVAS PROPS PARA FLEXIBILIDAD ---
    confirmButtonText: { type: String, default: 'Confirmar' },
    confirmButtonClass: { type: String, default: 'bg-red-600 hover:bg-red-700' }, // Color por defecto (peligro)
});

const closeModal = () => emit('close');
const confirmAction = () => emit('confirm');
</script>

<template>
    <Modal :show="show" @close="closeModal">
        <div class="p-6">
            <h2 class="text-lg font-medium text-gray-900">
                {{ title }}
            </h2>

            <p class="mt-1 text-sm text-gray-600">
                {{ message }}
            </p>

            <div class="mt-6 flex justify-end">
                <button
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none"
                    @click="closeModal"
                >
                    Cancelar
                </button>

                <!-- AHORA EL BOTÓN ES DINÁMICO -->
                <button
                    class="ml-3 px-4 py-2 text-sm font-medium text-white border border-transparent rounded-md shadow-sm focus:outline-none"
                    :class="confirmButtonClass"
                    @click="confirmAction"
                >
                    {{ confirmButtonText }}
                </button>
            </div>
        </div>
    </Modal>
</template>
</file>

<file path="resources/js/Components/Dashboard/BarChart.vue">
<script setup>
import { Bar } from 'vue-chartjs';
import { Chart as ChartJS, Title, Tooltip, Legend, BarElement, CategoryScale, LinearScale } from 'chart.js';
ChartJS.register(Title, Tooltip, Legend, BarElement, CategoryScale, LinearScale);

defineProps({
    chartData: { type: Object, required: true },
});

// Opciones fijas que funcionan en ambos modos
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false,
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            bodyColor: '#ffffff',
            titleColor: '#ffffff',
            padding: 12,
            cornerRadius: 8,
        },
    },
    scales: {
        x: {
            grid: {
                display: false,
            },
            ticks: {
                font: {
                    size: 12,
                },
                color: '#6B7280', // Color gris que funciona en ambos modos
            },
        },
        y: {
            beginAtZero: true,
            grid: {
                color: 'rgba(0, 0, 0, 0.1)',
            },
            ticks: {
                font: {
                    size: 12,
                },
                stepSize: 1,
                color: '#6B7280', // Color gris que funciona en ambos modos
            },
        },
    },
};
</script>

<template>
    <Bar :data="chartData" :options="chartOptions" />
</template>
</file>

<file path="resources/js/Components/Dashboard/DoughnutChart.vue">
<script setup>
import { Doughnut } from 'vue-chartjs';
import { Chart as ChartJS, Title, Tooltip, Legend, ArcElement, CategoryScale } from 'chart.js';
ChartJS.register(Title, Tooltip, Legend, ArcElement, CategoryScale);

defineProps({
    chartData: { type: Object, required: true },
});

// Opciones fijas que funcionan en ambos modos
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'left',
            labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                font: {
                    size: 11,
                },
                boxWidth: 10,
                color: '#6B7280', // Color gris que funciona en ambos modos
            },
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            bodyColor: '#ffffff',
            titleColor: '#ffffff',
            padding: 12,
            cornerRadius: 8,
        },
    },
};
</script>

<template>
    <Doughnut :data="chartData" :options="chartOptions" />
</template>
</file>

<file path="resources/js/Components/Dashboard/StatCard.vue">
<template>
    <div
        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl rounded-2xl border border-gray-100 dark:border-gray-700 transition-all duration-300 ease-in-out hover:-translate-y-1 hover:shadow-2xl dark:hover:shadow-gray-900/50 hover:border-blue-200 dark:hover:border-blue-900/50"
    >
        <div class="p-6">
            <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 tracking-widest uppercase mb-4">
                <slot name="title" />
            </h3>
            <div class="mt-1">
                <slot name="content" />
            </div>
        </div>
    </div>
</template>
</file>

<file path="resources/js/Components/Dropdown.vue">
<script setup>
import { computed, onMounted, onUnmounted, ref } from 'vue';

const props = defineProps({
    align: {
        type: String,
        default: 'right',
    },
    width: {
        type: String,
        default: '48',
    },
    contentClasses: {
        type: String,
        default: 'py-1 bg-white',
    },
});

const closeOnEscape = (e) => {
    if (open.value && e.key === 'Escape') {
        open.value = false;
    }
};

onMounted(() => document.addEventListener('keydown', closeOnEscape));
onUnmounted(() => document.removeEventListener('keydown', closeOnEscape));

const widthClass = computed(() => {
    return {
        48: 'w-48',
    }[props.width.toString()];
});

const alignmentClasses = computed(() => {
    if (props.align === 'left') {
        return 'ltr:origin-top-left rtl:origin-top-right start-0';
    } else if (props.align === 'right') {
        return 'ltr:origin-top-right rtl:origin-top-left end-0';
    } else {
        return 'origin-top';
    }
});

const open = ref(false);
</script>

<template>
    <div class="relative">
        <div @click="open = !open">
            <slot name="trigger" />
        </div>

        <!-- Full Screen Dropdown Overlay -->
        <div v-show="open" class="fixed inset-0 z-40" @click="open = false"></div>

        <Transition
            enter-active-class="transition ease-out duration-200"
            enter-from-class="opacity-0 scale-95"
            enter-to-class="opacity-100 scale-100"
            leave-active-class="transition ease-in duration-75"
            leave-from-class="opacity-100 scale-100"
            leave-to-class="opacity-0 scale-95"
        >
            <div
                v-show="open"
                class="absolute z-50 mt-2 rounded-md shadow-lg"
                :class="[widthClass, alignmentClasses]"
                style="display: none"
                @click="open = false"
            >
                <div
                    class="rounded-md ring-1 ring-black ring-opacity-5 bg-white dark:bg-gray-700 dark:ring-white/10"
                    :class="contentClasses"
                >
                    <slot name="content" />
                </div>
            </div>
        </Transition>
    </div>
</template>
</file>

<file path="resources/js/Components/FlashMessage.vue">
<script setup>
import { ref } from 'vue';
import { usePage, router } from '@inertiajs/vue3';
import { onMounted, onUnmounted } from 'vue';

const page = usePage();
const show = ref(false);
const style = ref('success');
const message = ref('');
let removeFinishEventListener = null;

// Esta función se llamará cada vez que Inertia termine una visita a una página
const handleFlashMessage = () => {
    const flash = page.props.flash;
    if (flash && (flash.success || flash.error)) {
        style.value = flash.success ? 'success' : 'danger';
        message.value = flash.success || flash.error;
        show.value = true;

        // Ocultar el mensaje automáticamente después de 5 segundos
        setTimeout(() => {
            show.value = false;
            // Limpiamos el flash prop para la siguiente navegación
            page.props.flash = {};
        }, 5000);
    }
};

// Nos enganchamos a los eventos de Inertia
onMounted(() => {
    handleFlashMessage(); // Verificar si hay un mensaje en la carga inicial
    removeFinishEventListener = router.on('finish', handleFlashMessage);
});

onUnmounted(() => {
    if (removeFinishEventListener) {
        removeFinishEventListener();
    }
});

// Estilos para los diferentes tipos de notificación
const styles = {
    success: 'bg-green-100 border-green-500 text-green-700',
    danger: 'bg-red-100 border-red-500 text-red-700',
};
</script>

<template>
    <div>
        <transition
            enter-active-class="ease-out duration-300"
            enter-from-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            enter-to-class="opacity-100 translate-y-0 sm:scale-100"
            leave-active-class="ease-in duration-200"
            leave-from-class="opacity-100 translate-y-0 sm:scale-100"
            leave-to-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        >
            <div v-if="show && message" :class="styles[style]" class="border-l-4 p-4 mx-8 mt-4" role="alert">
                <div class="flex">
                    <div class="py-1">
                        <svg
                            v-if="style === 'success'"
                            class="w-6 h-6 mr-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        <svg
                            v-if="style === 'danger'"
                            class="w-6 h-6 mr-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold">{{ style === 'success' ? 'Éxito' : 'Error' }}</p>
                        <p>{{ message }}</p>
                    </div>
                    <div class="ml-auto">
                        <button class="text-gray-500 hover:text-gray-700" @click.prevent="show = false">
                            <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>
</template>
</file>

<file path="resources/js/Components/ResponsiveNavLink.vue">
<script setup>
import { computed } from 'vue';
import { Link } from '@inertiajs/vue3';

const props = defineProps({
    href: { type: String, required: true },
    active: { type: Boolean },
});

const classes = computed(() =>
    props.active
        ? 'block w-full pl-3 pr-4 py-2 border-l-4 border-blue-400 text-left text-base font-medium text-blue-700 bg-blue-50 dark:bg-blue-900/50 dark:text-blue-300 dark:border-blue-500 focus:outline-none transition duration-150 ease-in-out'
        : 'block w-full pl-3 pr-4 py-2 border-l-4 border-transparent text-left text-base font-medium text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 focus:outline-none transition duration-150 ease-in-out'
);
</script>

<template>
    <Link :href="href" :class="classes">
        <slot />
    </Link>
</template>
</file>

<file path="resources/js/Components/TextInput.vue">
<script setup>
import { onMounted, ref } from 'vue';

const model = defineModel({
    type: String,
    required: true,
});

const input = ref(null);

onMounted(() => {
    if (input.value.hasAttribute('autofocus')) {
        input.value.focus();
    }
});

defineExpose({ focus: () => input.value.focus() });
</script>

<template>
    <input
        ref="input"
        v-model="model"
        class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-indigo-600 dark:focus:ring-indigo-600"
    />
</template>
</file>

<file path="resources/js/Pages/Auth/ForgotPassword.vue">
<script setup>
import GuestLayout from '@/Layouts/GuestLayout.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Head, useForm } from '@inertiajs/vue3';

defineProps({
    status: {
        type: String,
    },
});

const form = useForm({
    email: '',
});

const submit = () => {
    form.post(route('password.email'));
};
</script>

<template>
    <GuestLayout>
        <Head title="Restablecer Contraseña" />

        <div class="mb-4 text-sm text-white">
            ¿Olvidaste tu contraseña? No hay problema. Solo dinos tu dirección de correo electrónico y te enviaremos un
            enlace para restablecer tu contraseña que te permitirá elegir una nueva.
        </div>

        <div v-if="status" class="mb-4 text-sm font-medium text-green-400">
            {{ status }}
        </div>

        <form @submit.prevent="submit">
            <div>
                <InputLabel for="email" value="Correo Electrónico" class="text-white" />

                <TextInput
                    id="email"
                    v-model="form.email"
                    type="email"
                    class="mt-1 block w-full"
                    required
                    autofocus
                    autocomplete="username"
                />

                <InputError class="mt-2" :message="form.errors.email" />
            </div>

            <div class="mt-4 flex items-center justify-end">
                <PrimaryButton :class="{ 'opacity-25': form.processing }" :disabled="form.processing">
                    Enviar Enlace de Restablecimiento
                </PrimaryButton>
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/ClientPortal/Vehicles/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';

const form = useForm({ patente: '', marca: '', modelo: '', anio: new Date().getFullYear(), kilometraje: '' });
const submit = () => form.post(route('cliente.vehiculos.store'));
</script>

<template>
    <Head title="Agregar Vehículo" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Agregar Nuevo Vehículo</h2>
                <Link
                    :href="route('cliente.vehiculos.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver a Mis Vehículos
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <InputLabel for="patente" value="Patente" />
                                    <TextInput
                                        id="patente"
                                        v-model="form.patente"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.patente" />
                                </div>
                                <div>
                                    <InputLabel for="marca" value="Marca" />
                                    <TextInput
                                        id="marca"
                                        v-model="form.marca"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.marca" />
                                </div>
                                <div>
                                    <InputLabel for="modelo" value="Modelo" />
                                    <TextInput
                                        id="modelo"
                                        v-model="form.modelo"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.modelo" />
                                </div>
                                <div>
                                    <InputLabel for="anio" value="Año" />
                                    <TextInput
                                        id="anio"
                                        v-model.number="form.anio"
                                        type="number"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.anio" />
                                </div>
                                <div class="md:col-span-2">
                                    <InputLabel for="kilometraje" value="Kilometraje (Opcional)" />
                                    <TextInput
                                        id="kilometraje"
                                        v-model.number="form.kilometraje"
                                        type="number"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.kilometraje" />
                                </div>
                            </div>
                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Vehículo</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/ClientPortal/Vehicles/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';

const props = defineProps({ vehiculo: Object });

const form = useForm({
    patente: props.vehiculo.patente,
    marca: props.vehiculo.marca,
    modelo: props.vehiculo.modelo,
    anio: props.vehiculo.anio,
    kilometraje: props.vehiculo.kilometraje,
});

const submit = () => form.patch(route('cliente.vehiculos.update', props.vehiculo.id));
</script>

<template>
    <Head :title="`Editar Vehículo: ${vehiculo.patente}`" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Editar Vehículo</h2>
                <Link
                    :href="route('cliente.vehiculos.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver a Mis Vehículos
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <InputLabel for="patente" value="Patente" />
                                    <TextInput
                                        id="patente"
                                        v-model="form.patente"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.patente" />
                                </div>
                                <div>
                                    <InputLabel for="marca" value="Marca" />
                                    <TextInput
                                        id="marca"
                                        v-model="form.marca"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.marca" />
                                </div>
                                <div>
                                    <InputLabel for="modelo" value="Modelo" />
                                    <TextInput
                                        id="modelo"
                                        v-model="form.modelo"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.modelo" />
                                </div>
                                <div>
                                    <InputLabel for="anio" value="Año" />
                                    <TextInput
                                        id="anio"
                                        v-model.number="form.anio"
                                        type="number"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.anio" />
                                </div>
                                <div class="md:col-span-2">
                                    <InputLabel for="kilometraje" value="Kilometraje (Opcional)" />
                                    <TextInput
                                        id="kilometraje"
                                        v-model.number="form.kilometraje"
                                        type="number"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.kilometraje" />
                                </div>
                            </div>
                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    Actualizar Vehículo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/ClientPortal/Vehicles/Index.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import { ref } from 'vue';

defineProps({ vehiculos: Object });

const confirmingVehicleDeletion = ref(false);
const vehicleToDelete = ref(null);

const confirmVehicleDeletion = (vehiculo) => {
    vehicleToDelete.value = vehiculo;
    confirmingVehicleDeletion.value = true;
};

const deleteVehicle = () => {
    router.delete(route('cliente.vehiculos.destroy', vehicleToDelete.value.id), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};

const closeModal = () => (confirmingVehicleDeletion.value = false);
</script>

<template>
    <Head title="Mis Vehículos" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Mis Vehículos</h2>
                <Link
                    :href="route('cliente.vehiculos.create')"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 text-sm"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Agregar Vehículo
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Patente</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Marca</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Modelo</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Año</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider text-right">
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="vehiculo in vehiculos.data"
                                        :key="vehiculo.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <th
                                            scope="row"
                                            class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap"
                                        >
                                            {{ vehiculo.patente }}
                                        </th>
                                        <td class="px-6 py-4">{{ vehiculo.marca }}</td>
                                        <td class="px-6 py-4">{{ vehiculo.modelo }}</td>
                                        <td class="px-6 py-4">{{ vehiculo.anio }}</td>
                                        <td class="px-6 py-4 text-right whitespace-nowrap text-sm font-medium">
                                            <Link
                                                :href="route('cliente.vehiculos.edit', vehiculo.id)"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                >Editar</Link
                                            >
                                            <button
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmVehicleDeletion(vehiculo)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="vehiculos.data.length === 0">
                                        <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            <div class="flex flex-col items-center justify-center">
                                                <svg
                                                    class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-3"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                                    ></path>
                                                </svg>
                                                <p class="text-lg font-medium">No tienes vehículos registrados.</p>
                                                <p class="text-sm">¡Agrega tu primer vehículo!</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Paginación -->
                    <div
                        v-if="vehiculos.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="vehiculos.links" />
                    </div>
                </div>
            </div>
        </div>

        <ConfirmationModal
            :show="confirmingVehicleDeletion"
            title="Eliminar Vehículo"
            :message="`¿Estás seguro de que deseas eliminar tu vehículo con patente ${vehicleToDelete?.patente}?`"
            @close="closeModal"
            @confirm="deleteVehicle"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Products/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import { computed } from 'vue';

const props = defineProps({
    product: {
        type: Object,
        required: true,
    },
    suppliers: {
        type: Array,
        required: true,
    },
});

const form = useForm({
    name: props.product.name,
    sku: props.product.sku,
    description: props.product.description,
    cost: props.product.cost,
    iva_percentage: props.product.iva_percentage,
    profit_margin: props.product.profit_margin,
    current_stock: props.product.current_stock,
    min_threshold: props.product.min_threshold,
    // Asume que un producto tiene al menos un proveedor y lo preselecciona
    supplier_id: props.product.suppliers.length > 0 ? props.product.suppliers[0].id : null,
});

const calculatedPrice = computed(() => {
    const cost = parseFloat(form.cost) || 0;
    const ivaPercentage = parseFloat(form.iva_percentage) || 0;
    const profitMargin = parseFloat(form.profit_margin) || 0;
    const costWithIva = cost * (1 + ivaPercentage / 100);
    const finalPrice = costWithIva * (1 + profitMargin / 100);
    return finalPrice.toFixed(2);
});

const submit = () => {
    form.patch(route('inventario.products.update', props.product.id), {
        preserveScroll: true,
    });
};
</script>

<template>
    <Head :title="`Editar Producto: ${product.name}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Editar Producto</h2>
                <Link
                    :href="route('inventario.products.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-8" @submit.prevent="submit">
                            <!-- SECCIÓN 1: DATOS DEL PRODUCTO -->
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Datos del Producto
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label
                                            for="name"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Nombre del Producto</label
                                        >
                                        <input
                                            id="name"
                                            v-model="form.name"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                            autofocus
                                        />
                                        <div
                                            v-if="form.errors.name"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.name }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="sku"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >SKU (Código Único)</label
                                        >
                                        <input
                                            id="sku"
                                            v-model="form.sku"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                        <div v-if="form.errors.sku" class="text-sm text-red-600 dark:text-red-400 mt-1">
                                            {{ form.errors.sku }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="supplier_id"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Proveedor Principal</label
                                        >
                                        <select
                                            id="supplier_id"
                                            v-model="form.supplier_id"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        >
                                            <option
                                                v-for="supplier in suppliers"
                                                :key="supplier.id"
                                                :value="supplier.id"
                                            >
                                                {{ supplier.name }}
                                            </option>
                                        </select>
                                        <div
                                            v-if="form.errors.supplier_id"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.supplier_id }}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <label
                                        for="description"
                                        class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                        >Descripción (Opcional)</label
                                    >
                                    <textarea
                                        id="description"
                                        v-model="form.description"
                                        rows="4"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        placeholder="Descripción del producto..."
                                    ></textarea>
                                </div>
                            </div>

                            <!-- SECCIÓN 2: PRECIOS Y STOCK -->
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Precios y Stock
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label
                                            for="cost"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Precio de Costo ($)</label
                                        >
                                        <input
                                            id="cost"
                                            v-model="form.cost"
                                            type="number"
                                            step="0.01"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                        <div
                                            v-if="form.errors.cost"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.cost }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="iva_percentage"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >IVA (%)</label
                                        >
                                        <input
                                            id="iva_percentage"
                                            v-model="form.iva_percentage"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label
                                            for="profit_margin"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Margen de Ganancia (%)</label
                                        >
                                        <input
                                            id="profit_margin"
                                            v-model="form.profit_margin"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div
                                        class="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl border border-gray-200 dark:border-gray-600 flex items-center justify-center"
                                    >
                                        <div class="text-center">
                                            <label class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                                >Precio de Venta Calculado</label
                                            >
                                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                                                ${{ calculatedPrice }}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="current_stock"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Stock Actual</label
                                        >
                                        <input
                                            id="current_stock"
                                            v-model="form.current_stock"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label
                                            for="min_threshold"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Umbral de Stock Bajo</label
                                        >
                                        <input
                                            id="min_threshold"
                                            v-model="form.min_threshold"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-200 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Actualizando...</span>
                                    <span v-else>Actualizar Producto</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Suppliers/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const form = useForm({
    name: '',
    contact_person: '',
    phone: '',
    email: '',
    address: '',
});

const submit = () => {
    form.post(route('inventario.suppliers.store'));
};
</script>

<template>
    <Head title="Crear Proveedor" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Crear Nuevo Proveedor</h2>
                <Link
                    :href="route('inventario.suppliers.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-8" @submit.prevent="submit">
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Información del Proveedor
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label
                                            for="name"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Nombre del Proveedor</label
                                        >
                                        <input
                                            id="name"
                                            v-model="form.name"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                            autofocus
                                        />
                                        <div
                                            v-if="form.errors.name"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.name }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="contact_person"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Persona de Contacto (Opcional)</label
                                        >
                                        <input
                                            id="contact_person"
                                            v-model="form.contact_person"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.contact_person"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.contact_person }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="phone"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Teléfono (Opcional)</label
                                        >
                                        <input
                                            id="phone"
                                            v-model="form.phone"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.phone"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.phone }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="email"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Email (Opcional)</label
                                        >
                                        <input
                                            id="email"
                                            v-model="form.email"
                                            type="email"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.email"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.email }}
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label
                                            for="address"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Dirección (Opcional)</label
                                        >
                                        <textarea
                                            id="address"
                                            v-model="form.address"
                                            rows="4"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            placeholder="Dirección completa del proveedor..."
                                        ></textarea>
                                        <div
                                            v-if="form.errors.address"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.address }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-200 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Proveedor</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Suppliers/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const props = defineProps({
    supplier: {
        type: Object,
        required: true,
    },
});

const form = useForm({
    name: props.supplier.name,
    contact_person: props.supplier.contact_person,
    phone: props.supplier.phone,
    email: props.supplier.email,
    address: props.supplier.address,
});

const submit = () => {
    form.patch(route('inventario.suppliers.update', props.supplier.id));
};
</script>

<template>
    <Head :title="`Editar Proveedor: ${supplier.name}`" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Editar Proveedor</h2>
                <Link
                    :href="route('inventario.suppliers.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-8" @submit.prevent="submit">
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Información del Proveedor
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label
                                            for="name"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Nombre del Proveedor</label
                                        >
                                        <input
                                            id="name"
                                            v-model="form.name"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                            autofocus
                                        />
                                        <div
                                            v-if="form.errors.name"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.name }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="contact_person"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Persona de Contacto (Opcional)</label
                                        >
                                        <input
                                            id="contact_person"
                                            v-model="form.contact_person"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.contact_person"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.contact_person }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="phone"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Teléfono (Opcional)</label
                                        >
                                        <input
                                            id="phone"
                                            v-model="form.phone"
                                            type="text"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.phone"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.phone }}
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            for="email"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Email (Opcional)</label
                                        >
                                        <input
                                            id="email"
                                            v-model="form.email"
                                            type="email"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        />
                                        <div
                                            v-if="form.errors.email"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.email }}
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label
                                            for="address"
                                            class="block font-medium text-sm text-gray-700 dark:text-gray-300"
                                            >Dirección (Opcional)</label
                                        >
                                        <textarea
                                            id="address"
                                            v-model="form.address"
                                            rows="4"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            placeholder="Dirección completa del proveedor..."
                                        ></textarea>
                                        <div
                                            v-if="form.errors.address"
                                            class="text-sm text-red-600 dark:text-red-400 mt-1"
                                        >
                                            {{ form.errors.address }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-200 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Actualizando...</span>
                                    <span v-else>Actualizar Proveedor</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Profile/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import DeleteUserForm from './Partials/DeleteUserForm.vue';
import UpdatePasswordForm from './Partials/UpdatePasswordForm.vue';
import UpdateProfileInformationForm from './Partials/UpdateProfileInformationForm.vue';
import { Head } from '@inertiajs/vue3';

defineProps({
    mustVerifyEmail: {
        type: Boolean,
    },
    status: {
        type: String,
    },
});
</script>

<template>
    <Head title="Perfil" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Configuración del Perfil</h2>
            </div>
        </template>

        <div class="py-12">
            <div class="mx-auto max-w-7xl space-y-6 sm:px-6 lg:px-8">
                <!-- Información del Perfil -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <UpdateProfileInformationForm
                            :must-verify-email="mustVerifyEmail"
                            :status="status"
                            class="max-w-xl"
                        />
                    </div>
                </div>

                <!-- Actualizar Contraseña -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <UpdatePasswordForm class="max-w-xl" />
                    </div>
                </div>

                <!-- Eliminar Cuenta -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <DeleteUserForm class="max-w-xl" />
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Scheduling/Admin/CapacityIndex.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, router } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import InputError from '@/Components/InputError.vue';
import { ref, computed } from 'vue';

const props = defineProps({
    capacities: Array,
    currentYear: Number,
    currentMonth: Number,
});

const selectedDate = ref(null);
const selectedCapacity = ref(null);

const form = useForm({
    date: '',
    total_slots: 10,
});

const monthNames = [
    'Enero',
    'Febrero',
    'Marzo',
    'Abril',
    'Mayo',
    'Junio',
    'Julio',
    'Agosto',
    'Septiembre',
    'Octubre',
    'Noviembre',
    'Diciembre',
];

// Computed properties
const displayMonth = computed(() => monthNames[props.currentMonth - 1]);
const displayYear = computed(() => props.currentYear);

const daysInMonth = computed(() => {
    return new Date(props.currentYear, props.currentMonth, 0).getDate();
});

const firstDayOfMonth = computed(() => {
    const date = new Date(props.currentYear, props.currentMonth - 1, 1);
    let day = date.getDay();
    return day === 0 ? 6 : day - 1;
});

// Función para obtener capacidad por fecha
const getCapacityForDate = (day) => {
    const dateStr = `${props.currentYear}-${String(props.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    // Buscar la capacidad para esta fecha
    const capacity = props.capacities.find((c) => {
        // Extraer solo la parte de la fecha (YYYY-MM-DD) del string ISO
        const capacityDate = c.date.split('T')[0];
        return capacityDate === dateStr;
    });

    return capacity;
};

const openModal = (day) => {
    const date = new Date(props.currentYear, props.currentMonth - 1, day);
    selectedDate.value = date.toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
    });

    form.date = `${props.currentYear}-${String(props.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    const capacity = getCapacityForDate(day);
    form.total_slots = capacity ? capacity.total_slots : 10;
    selectedCapacity.value = capacity;
};

const closeModal = () => {
    selectedDate.value = null;
    form.reset();
    form.clearErrors();
};

const submit = () => {
    form.post(route('admin.scheduling.capacities.store'), {
        onSuccess: () => {
            closeModal();
        },
        onError: (_errors) => {
            // Los errores se mostrarán automáticamente en los campos
        },
        preserveState: false,
    });
};

const changeMonth = (offset) => {
    const newDate = new Date(props.currentYear, props.currentMonth - 1);
    newDate.setMonth(newDate.getMonth() + offset);

    router.get(
        route('admin.scheduling.capacities.index'),
        {
            year: newDate.getFullYear(),
            month: newDate.getMonth() + 1,
        },
        {
            preserveState: true,
            preserveScroll: true,
        }
    );
};
</script>

<template>
    <Head title="Gestión de Cupos" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Gestión de Cupos Diarios</h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <!-- Controles del Calendario -->
                        <div class="flex justify-between items-center mb-8">
                            <button
                                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                                @click="changeMonth(-1)"
                            >
                                &larr; Anterior
                            </button>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                {{ displayMonth }} {{ displayYear }}
                            </h3>
                            <button
                                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                                @click="changeMonth(1)"
                            >
                                Siguiente &rarr;
                            </button>
                        </div>

                        <!-- Calendario -->
                        <div class="grid grid-cols-7 gap-3 text-center">
                            <div
                                v-for="day in ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']"
                                :key="day"
                                class="font-bold text-sm text-gray-600 dark:text-gray-400 py-3"
                            >
                                {{ day }}
                            </div>
                            <div v-for="blank in firstDayOfMonth" :key="`blank-${blank}`"></div>
                            <div
                                v-for="day in daysInMonth"
                                :key="day"
                                class="p-3 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 min-h-[5rem] flex flex-col justify-between transition-all duration-200 bg-white dark:bg-gray-800"
                                @click="openModal(day)"
                            >
                                <div class="font-bold text-right text-gray-700 dark:text-gray-300">{{ day }}</div>
                                <div v-if="getCapacityForDate(day)" class="text-xs text-left space-y-1">
                                    <p class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Reservados:</span>
                                        <span class="font-bold text-green-600 dark:text-green-400">{{
                                            getCapacityForDate(day).booked_slots
                                        }}</span>
                                    </p>
                                    <p class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Total:</span>
                                        <span class="font-bold text-blue-600 dark:text-blue-400">{{
                                            getCapacityForDate(day).total_slots
                                        }}</span>
                                    </p>
                                </div>
                                <div v-else class="text-xs text-left text-gray-400 dark:text-gray-500 italic">
                                    Sin definir
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para editar capacidad -->
        <div
            v-if="selectedDate"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300"
            @click.self="closeModal"
        >
            <div
                class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-gray-700 transition-colors duration-300"
            >
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                    Establecer Capacidad para el {{ selectedDate }}
                </h3>

                <!-- Mostrar errores generales del formulario -->
                <div
                    v-if="form.hasErrors"
                    class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 rounded-xl"
                >
                    <p class="font-semibold">Por favor, corrige los siguientes errores:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li v-for="error in Object.values(form.errors)" :key="error">{{ error }}</li>
                    </ul>
                </div>

                <form class="space-y-6" @submit.prevent="submit">
                    <div>
                        <InputLabel for="total_slots" value="Número Total de Cupos" />
                        <input
                            id="total_slots"
                            v-model.number="form.total_slots"
                            type="number"
                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm transition-colors duration-200"
                            :class="{ 'border-red-500 dark:border-red-400': form.errors.total_slots }"
                            min="1"
                            required
                        />
                        <InputError class="mt-2" :message="form.errors.total_slots" />
                    </div>

                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-100 dark:border-gray-700">
                        <button
                            type="button"
                            class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                            :disabled="form.processing"
                            @click="closeModal"
                        >
                            Cancelar
                        </button>
                        <button
                            type="submit"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 disabled:opacity-50"
                            :disabled="form.processing"
                        >
                            <span v-if="form.processing">Guardando...</span>
                            <span v-else>Guardar</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="routes/channels.php">
<?php

use Illuminate\Support\Facades\Broadcast;

Broadcast::routes();

/*
|--------------------------------------------------------------------------
| Broadcast Channels
|--------------------------------------------------------------------------
|
| Here you may register all of the event broadcasting channels that your
| application supports. The given channel authorization callbacks are
| used to check if an authenticated user can listen to the channel.
|
*/

// Canal estándar de Laravel para notificaciones privadas de usuario
Broadcast::channel('App.Models.User.{id}', function ($user, $id) {
    return (int) $user->id === (int) $id;
});
</file>

<file path="src/ClientPortal/Http/Controllers/DashboardController.php">
<?php

namespace FlipperBox\ClientPortal\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Inertia\Inertia;
use Inertia\Response;

class DashboardController extends Controller
{
    /**
     * Muestra el dashboard del cliente, incluyendo su flota de vehículos y el historial de servicios.
     */
    public function index(): Response
    {
        /** @var \App\Models\User $user */
        $user = Auth::user();

        // Eager Loading anidado: Cargamos los vehículos del usuario,
        // y para cada vehículo, cargamos sus órdenes de trabajo ordenadas por la más reciente
        $user->load(['vehiculos.workOrders' => function ($query) {
            $query->latest('entry_date');
        }]);

        return Inertia::render('ClientPortal/Dashboard', [
            'user' => $user,
        ]);
    }
}
</file>

<file path="src/ClientPortal/routes/web.php">
<?php

use FlipperBox\ClientPortal\Http\Controllers\DashboardController;
use FlipperBox\ClientPortal\Http\Controllers\VehiculoController;
use Illuminate\Support\Facades\Route;

// Ruta del Dashboard del Cliente
Route::get('/dashboard', [DashboardController::class, 'index'])->name('dashboard');

// Grupo de Rutas para la Gestión de Vehículos del Cliente
Route::prefix('vehiculos')->name('vehiculos.')->group(function () {
    Route::get('/', [VehiculoController::class, 'index'])->name('index');
    Route::get('/crear', [VehiculoController::class, 'create'])->name('create');
    Route::post('/', [VehiculoController::class, 'store'])->name('store');
    Route::get('/{vehiculo}/editar', [VehiculoController::class, 'edit'])->name('edit');
    Route::patch('/{vehiculo}', [VehiculoController::class, 'update'])->name('update');
    Route::delete('/{vehiculo}', [VehiculoController::class, 'destroy'])->name('destroy');
});
</file>

<file path="src/ClientScheduling/routes/web.php">
<?php

use FlipperBox\ClientScheduling\Http\Controllers\BookingController;
use Illuminate\Support\Facades\Route;

Route::middleware('can:solicitar reserva')->group(function () {
    Route::get('/', [BookingController::class, 'index'])->name('index');
    Route::post('/', [BookingController::class, 'store'])->name('store');
    Route::delete('/reservations/{reservation}', [BookingController::class, 'destroy'])
        ->name('destroy');
});
</file>

<file path="src/Core/Http/Controllers/DashboardController.php">
<?php

namespace FlipperBox\Core\Http\Controllers;

use App\Http\Controllers\Controller;
use Carbon\Carbon;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Inertia\Inertia;
use Inertia\Response;

class DashboardController extends Controller
{
    public function index(Request $request): Response
    {
        /** @var \App\Models\User $user */
        $user = $request->user();

        // --- MÉTRICA 1: RESUMEN FINANCIERO (CON CASTEO A FLOAT) ---
        $ingresosMes = (float) WorkOrder::where('status', 'Completada')
            ->whereMonth('completion_date', now()->month)
            ->whereYear('completion_date', now()->year)
            ->sum('total');

        // --- MÉTRICA 2: ACTIVIDAD DEL TALLER ---
        $activityData = WorkOrder::select(
            DB::raw('DATE(completion_date) as date'),
            DB::raw('count(*) as count')
        )
            ->where('status', 'Completada')
            ->whereBetween('completion_date', [now()->subDays(29), now()])
            ->groupBy('date')
            ->orderBy('date', 'asc')
            ->get()
            ->pluck('count', 'date');

        $dailyActivityChart = [];
        for ($i = 29; $i >= 0; $i--) {
            $date = now()->subDays($i)->format('Y-m-d');
            $dailyActivityChart['labels'][] = Carbon::parse($date)->format('d/m');
            $dailyActivityChart['data'][] = $activityData->get($date, 0);
        }

        // --- MÉTRICA 3: TOP 5 PRODUCTOS MÁS VENDIDOS DEL MES ---
        $topProducts = DB::table('work_order_product')
            ->join('products', 'work_order_product.product_id', '=', 'products.id')
            ->join('work_orders', 'work_order_product.work_order_id', '=', 'work_orders.id')
            ->select(
                'products.name',
                DB::raw('SUM(work_order_product.quantity * work_order_product.unit_price) as total_revenue')
            )
            ->where('work_orders.status', 'Completada')
            ->whereMonth('work_orders.completion_date', now()->month)
            ->whereYear('work_orders.completion_date', now()->year)
            ->groupBy('products.name')
            ->orderBy('total_revenue', 'desc')
            ->limit(5)
            ->get();

        // --- MÉTRICA 4: PRODUCTOS CON STOCK BAJO ---
        $lowStockProducts = Product::where('current_stock', '<=', DB::raw('min_threshold'))
            ->orderBy('current_stock', 'asc')
            ->limit(5)
            ->get(['name', 'current_stock', 'min_threshold']);

        // --- MÉTRICA 5: ESTADO DE ÓRDENES DE TRABAJO (GRÁFICO CIRCULAR) ---
        $workOrderStatus = WorkOrder::select('status', DB::raw('count(*) as count'))
            ->where('created_at', '>=', now()->subDays(30))
            ->groupBy('status')
            ->get()
            ->pluck('count', 'status');

        $workOrderStatusChart = [
            'labels' => $workOrderStatus->keys(),
            'data' => $workOrderStatus->values(),
        ];

        // --- DATOS PARA NOTIFICACIONES ---
        $notifications = $user->unreadNotifications()->limit(5)->get();

        return Inertia::render('Dashboard', [
            'ingresosMes' => $ingresosMes,
            'dailyActivityChart' => $dailyActivityChart,
            'topProducts' => $topProducts,
            'lowStockProducts' => $lowStockProducts,
            'workOrderStatusChart' => $workOrderStatusChart,
            'notifications' => $notifications,
        ]);
    }
}
</file>

<file path="src/Crm/Providers/CrmServiceProvider.php">
<?php

namespace FlipperBox\Crm\Providers;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class CrmServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap services.
     */
    public function boot(): void
    {
        Route::middleware('web')
            ->group(function () {
                $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
            });
    }
}
</file>

<file path="src/Inventory/Actions/CrearNuevoProductoAction.php">
<?php

namespace FlipperBox\Inventory\Actions;

use FlipperBox\Inventory\Models\InventoryMovement;
use FlipperBox\Inventory\Models\Product;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class CrearNuevoProductoAction
{
    public function execute(array $data): Product
    {
        return DB::transaction(function () use ($data) {
            // 1. Instanciamos el modelo y asignamos propiedades
            $product = new Product;
            $product->fill($data);
            $product->save();

            // 2. Vinculamos el producto con el proveedor en la tabla pivot
            $product->suppliers()->attach($data['supplier_id'], ['cost' => $data['cost']]);

            // 3. Si hay stock inicial, crear el primer movimiento de inventario
            if ($product->current_stock > 0) {
                InventoryMovement::create([
                    'product_id' => $product->id,
                    'user_id' => Auth::id(),
                    'type' => 'in',
                    'quantity' => $product->current_stock,
                    'reason' => 'Stock Inicial',
                ]);
            }

            Log::info("Nuevo producto creado: ID {$product->id} - {$product->name}");

            return $product;
        });
    }
}
</file>

<file path="src/Inventory/Http/Requests/StoreProductRequest.php">
<?php

namespace FlipperBox\Inventory\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;

class StoreProductRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     */
    public function authorize(): bool
    {
        return Auth::user()->can('gestionar inventario');
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:255'],
            'sku' => ['required', 'string', 'max:255', 'unique:products,sku'],
            'description' => ['nullable', 'string'],
            'cost' => ['required', 'numeric', 'min:0'],
            'iva_percentage' => ['required', 'numeric', 'min:0', 'max:100'],
            'profit_margin' => ['required', 'numeric', 'min:0'],
            'current_stock' => ['required', 'integer', 'min:0'],
            'min_threshold' => ['required', 'integer', 'min:0'],
            'supplier_id' => ['required', 'exists:suppliers,id'],
        ];
    }

    /**
     * Get the custom validation messages for the defined rules.
     *
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            'name.required' => 'El nombre del producto es obligatorio.',
            'sku.required' => 'El SKU es obligatorio.',
            'sku.unique' => 'Este SKU ya está registrado. Por favor, elige otro.',
            'cost.required' => 'El precio de costo es obligatorio.',
            'cost.numeric' => 'El costo debe ser un valor numérico.',
            'cost.min' => 'El costo no puede ser negativo.',
            'iva_percentage.required' => 'El porcentaje de IVA es obligatorio.',
            'iva_percentage.numeric' => 'El IVA debe ser un valor numérico.',
            'profit_margin.required' => 'El margen de ganancia es obligatorio.',
            'profit_margin.numeric' => 'El margen de ganancia debe ser un valor numérico.',
            'current_stock.required' => 'El stock inicial es obligatorio.',
            'current_stock.integer' => 'El stock debe ser un número entero.',
            'current_stock.min' => 'El stock no puede ser negativo.',
            'min_threshold.required' => 'El umbral de stock bajo es obligatorio.',
            'min_threshold.integer' => 'El umbral debe ser un número entero.',
            'min_threshold.min' => 'El umbral no puede ser negativo.',
            'supplier_id.required' => 'Debes seleccionar un proveedor.',
            'supplier_id.exists' => 'El proveedor seleccionado no es válido.',
        ];
    }
}
</file>

<file path="src/Scheduling/Http/Controllers/CapacityController.php">
<?php

namespace FlipperBox\Scheduling\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\Scheduling\Models\DailyCapacity;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Carbon;
use Inertia\Inertia;
use Inertia\Response;

class CapacityController extends Controller
{
    public function index(Request $request): Response
    {
        $year = $request->input('year', now()->year);
        $month = $request->input('month', now()->month);

        // Obtener capacidades para el mes especÃ­fico
        $capacities = DailyCapacity::whereYear('date', $year)
            ->whereMonth('date', $month)
            ->orderBy('date')
            ->get()
            ->map(function ($capacity) {
                return [
                    'id' => $capacity->id,
                    'date' => $capacity->date->format('Y-m-d'),
                    'total_slots' => $capacity->total_slots,
                    'booked_slots' => $capacity->booked_slots,
                    'created_at' => $capacity->created_at,
                    'updated_at' => $capacity->updated_at,
                ];
            });

        return Inertia::render('Scheduling/Admin/CapacityIndex', [
            'capacities' => $capacities,
            'currentYear' => (int) $year,
            'currentMonth' => (int) $month,
        ]);
    }

    public function store(Request $request): RedirectResponse
    {
        $validated = $request->validate([
            'date' => ['required', 'date'],
            'total_slots' => ['required', 'integer', 'min:1'],
        ]);

        DailyCapacity::updateOrCreate(
            ['date' => $validated['date']],
            ['total_slots' => $validated['total_slots']]
        );

        $date = Carbon::parse($validated['date']);

        return redirect()->route('admin.scheduling.capacities.index', [
            'year' => $date->year,
            'month' => $date->month,
        ])->with('success', 'Capacidad guardada correctamente.');
    }
}
</file>

<file path="src/Scheduling/Http/Controllers/ReservationController.php">
<?php

namespace FlipperBox\Scheduling\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\Scheduling\Models\DailyCapacity;
use FlipperBox\Scheduling\Models\Reservation;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Validation\Rule;
use Inertia\Inertia;
use Inertia\Response;

class ReservationController extends Controller
{
    /**
     * Muestra una lista filtrable y paginada de todas las reservas.
     */
    public function index(Request $request): Response
    {
        $reservations = Reservation::with(['user', 'vehicle'])
            ->when($request->input('status'), function ($query, $status) {
                $query->where('status', $status);
            })
            ->when($request->input('date'), function ($query, $date) {
                $query->whereDate('reservation_date', $date);
            })
            ->orderBy('reservation_date', 'desc')
            ->paginate(15)
            ->withQueryString();

        return Inertia::render('Scheduling/Admin/ReservationIndex', [
            'reservations' => $reservations,
            'filters' => $request->only(['status', 'date']),
        ]);
    }

    /**
     * Actualiza el estado de una reserva.
     */
    public function update(Request $request, Reservation $reservation): RedirectResponse
    {
        $validated = $request->validate([
            'status' => ['required', Rule::in(['Confirmada', 'Cancelada', 'Asistió', 'Ausente'])],
        ]);

        $originalStatus = $reservation->status;
        $newStatus = $validated['status'];
        $reservationDate = Carbon::parse($reservation->reservation_date)->startOfDay();

        // --- REGLA DE NEGOCIO : VALIDACIÓN DE FECHA ---
        // Solo permite marcar como Asistió o Ausente si la fecha de la reserva ya pasó o es el día de hoy.
        if (in_array($newStatus, ['Asistió', 'Ausente']) && $reservationDate->isFuture()) {
            return back()->with('error', 'No se puede marcar como "Asistió" o "Ausente" una reserva que aún no ha ocurrido.');
        }

        // --- REGLA DE NEGOCIO: UNA ORDEN COMPLETADA NO SE PUEDE MODIFICAR ---
        if (in_array($originalStatus, ['Asistió', 'Ausente', 'Cancelada'])) {
            return back()->with('error', 'No se puede cambiar el estado de una reserva que ya ha sido finalizada o cancelada.');
        }

        // --- LÓGICA DE GESTIÓN DE CUPOS ---
        // Si la reserva no estaba 'Confirmada' y ahora sí lo está, o viceversa, ajustamos el cupo.
        if ($originalStatus !== 'Confirmada' && $newStatus === 'Confirmada') {
            DB::transaction(function () use ($reservation) {
                $capacity = DailyCapacity::where('date', $reservation->reservation_date)->lockForUpdate()->first();
                if ($capacity) {
                    $capacity->increment('booked_slots');
                }
            });
        } elseif ($originalStatus === 'Confirmada' && $newStatus !== 'Confirmada') {
            DB::transaction(function () use ($reservation) {
                $capacity = DailyCapacity::where('date', $reservation->reservation_date)->lockForUpdate()->first();
                if ($capacity && $capacity->booked_slots > 0) {
                    $capacity->decrement('booked_slots');
                }
            });
        }

        // Finalmente, actualizamos el estado en la base de datos
        $reservation->update(['status' => $newStatus]);

        return back()->with('success', 'El estado de la reserva ha sido actualizado.');
    }
}
</file>

<file path="src/Scheduling/routes/admin.php">
<?php

use FlipperBox\Scheduling\Http\Controllers\CapacityController;
use FlipperBox\Scheduling\Http\Controllers\ReservationController;
use Illuminate\Support\Facades\Route;

Route::get('/capacidades', [CapacityController::class, 'index'])->name('capacities.index');
Route::post('/capacidades', [CapacityController::class, 'store'])->name('capacities.store');

Route::middleware('can:gestionar reservas')->prefix('reservas')->name('reservations.')->group(function () {
    Route::get('/', [ReservationController::class, 'index'])->name('index');
    Route::patch('/{reservation}', [ReservationController::class, 'update'])->name('update');
});
</file>

<file path="src/WorkManagement/Models/ExternalCost.php">
<?php

namespace FlipperBox\WorkManagement\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class ExternalCost extends Model
{
    protected $fillable = ['work_order_id', 'description', 'cost', 'price'];

    /**
     * Define la relación inversa: Un costo externo pertenece a una orden de trabajo.
     */
    public function workOrder(): BelongsTo
    {
        return $this->belongsTo(WorkOrder::class);
    }
}
</file>

<file path="src/WorkManagement/Models/WorkOrder.php">
<?php

namespace FlipperBox\WorkManagement\Models;

use App\Models\User;
use FlipperBox\Crm\Models\Vehiculo;
use FlipperBox\Inventory\Models\Product;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\SoftDeletes;

class WorkOrder extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = ['vehicle_id', 'mechanic_id', 'status', 'description', 'notes', 'entry_date', 'completion_date', 'total'];

    protected $casts = ['entry_date' => 'datetime', 'completion_date' => 'datetime'];

    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(Vehiculo::class, 'vehicle_id')->withTrashed();
    }

    public function mechanic(): BelongsTo
    {
        return $this->belongsTo(User::class, 'mechanic_id');
    }

    public function products(): BelongsToMany
    {
        return $this->belongsToMany(Product::class, 'work_order_product')
            ->withPivot('quantity', 'unit_price')
            ->withTimestamps()
            ->withTrashed();
    }

    public function services(): BelongsToMany
    {
        return $this->belongsToMany(Service::class, 'work_order_service')
            ->withPivot('price')
            ->withTimestamps();
    }

    public function externalCosts(): HasMany
    {
        return $this->hasMany(ExternalCost::class);
    }
}
</file>

<file path="app/Http/Controllers/Auth/AuthenticatedSessionController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Http\Requests\Auth\LoginRequest;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Route;
use Inertia\Inertia;
use Inertia\Response;

class AuthenticatedSessionController extends Controller
{
    /**
     * Display the login view.
     */
    public function create(): Response
    {
        return Inertia::render('Auth/Login', [
            'canResetPassword' => Route::has('password.request'),
            'status' => session('status'),
        ]);
    }

    /**
     * Handle an incoming authentication request.
     */
    public function store(LoginRequest $request): RedirectResponse
    {
        $request->authenticate();
        $request->session()->regenerate();
        $user = $request->user();

        if ($user->hasRole('Admin')) {
            return redirect()->intended(route('dashboard'));
        }
        if ($user->hasRole('Mecanico')) {
            return redirect()->intended(route('mecanico.dashboard'));
        }
        if ($user->hasRole('Cliente')) {
            return redirect()->intended(route('cliente.dashboard'));
        }

        // Fallback por si un usuario no tiene un rol principal
        return redirect()->intended(route('dashboard'));
    }

    /**
     * Destroy an authenticated session.
     */
    public function destroy(Request $request): RedirectResponse
    {
        Auth::guard('web')->logout();

        $request->session()->invalidate();

        $request->session()->regenerateToken();

        return redirect('/');
    }
}
</file>

<file path="app/Providers/AppServiceProvider.php">
<?php

namespace App\Providers;

use App\Models\User;
use App\Observers\ProductObserver;
use App\Observers\ServiceObserver;
use App\Observers\UserObserver;
use App\Observers\VehiculoObserver;
use App\Observers\WorkOrderObserver;
use FlipperBox\Crm\Models\Vehiculo;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\WorkManagement\Models\Service;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Support\Facades\Vite;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap any application services.
     */
    public function boot(): void
    {
        Vite::prefetch(concurrency: 3);

        Product::observe(ProductObserver::class);
        Service::observe(ServiceObserver::class);
        User::observe(UserObserver::class);
        Vehiculo::observe(VehiculoObserver::class);
        WorkOrder::observe(WorkOrderObserver::class);
    }
}
</file>

<file path="resources/js/Components/NotificationBell.vue">
<script setup>
import { ref, onMounted, computed } from 'vue';
import { Link, usePage, router } from '@inertiajs/vue3';

const page = usePage();

// El estado inicial ahora se carga desde las props globales
const notifications = ref(page.props.notifications || []);
const showDropdown = ref(false);

const unreadCount = computed(() => notifications.value.filter((n) => !n.read_at).length);
const canViewNotifications = computed(() => page.props.auth.user?.permissions?.includes('gestionar reservas'));

onMounted(() => {
    if (canViewNotifications.value) {
        // AHORA (Notificación estándar de Laravel)
        // Usamos el ID del usuario autenticado para escuchar SU canal privado
        window.Echo.private(`App.Models.User.${page.props.auth.user.id}`).notification((notification) => {
            const newNotification = {
                id: notification.id,
                data: {
                    message: notification.message, // Nota: Ya no viene dentro de 'data' anidado, Laravel lo aplana
                    url: notification.url,
                },
                created_at: new Date().toISOString(),
                read_at: null,
            };
            notifications.value.unshift(newNotification);

            // Opcional: Reproducir un sonido
            // playNotificationSound();
        });
    }
});

const markAsRead = () => {
    if (unreadCount.value > 0) {
        // Enviamos una petición al backend para marcar como leídas
        router.post(
            route('notifications.markAsRead'),
            {},
            {
                preserveScroll: true,
                onSuccess: () => {
                    notifications.value.forEach((n) => (n.read_at = new Date().toISOString()));
                },
            }
        );
    }
};

// Función opcional para reproducir sonido de notificación
//const playNotificationSound = () => {
// implementar un sonido de notificación aquí
// const audio = new Audio('/sounds/notification.mp3');
// audio.play().catch(e => console.log('Error reproduciendo sonido:', e));
//};
</script>

<template>
    <div v-if="canViewNotifications" class="relative">
        <!-- Icono de la Campanita -->
        <!-- Agregamos z-50 para que el botón quede por encima de todo si es necesario -->
        <button
            class="relative z-50 text-gray-500 hover:text-gray-700 focus:outline-none"
            @click="
                showDropdown = !showDropdown;
                markAsRead();
            "
        >
            <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                ></path>
            </svg>
            <span
                v-if="unreadCount > 0"
                class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full"
            >
                {{ unreadCount }}
            </span>
        </button>

        <!-- NUEVO: Overlay invisible para detectar clic afuera -->
        <!-- Este div cubre toda la pantalla. Al hacer clic en él, cierra el dropdown -->
        <div v-show="showDropdown" class="fixed inset-0 z-40 cursor-default" @click="showDropdown = false"></div>

        <!-- Dropdown de Notificaciones -->
        <!-- Eliminamos @click.away y ajustamos el z-index a 50 para que flote sobre el overlay -->
        <div
            v-show="showDropdown"
            class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg overflow-hidden z-50"
        >
            <div class="py-2">
                <div v-if="notifications.length > 0">
                    <!-- Limitamos a las últimas 5 para que no sea enorme -->
                    <Link
                        v-for="notification in notifications.slice(0, 5)"
                        :key="notification.id"
                        :href="notification.data.url"
                        class="flex items-center px-4 py-3 border-b hover:bg-gray-100 -mx-2"
                        @click="showDropdown = false"
                    >
                        <div class="mx-3">
                            <p class="text-sm text-gray-600">{{ notification.data.message }}</p>
                            <p class="text-xs text-gray-400">
                                {{ new Date(notification.created_at).toLocaleString('es-ES') }}
                            </p>
                        </div>
                    </Link>
                </div>
                <div v-else class="px-4 py-3 text-sm text-gray-500 text-center">No hay notificaciones.</div>
            </div>
        </div>
    </div>
</template>
</file>

<file path="resources/js/Components/Pagination.vue">
<script setup>
import { Link } from '@inertiajs/vue3';

defineProps({
    links: {
        type: Array,
        required: true,
    },
});
</script>

<template>
    <div v-if="links.length > 3">
        <nav class="flex items-center justify-center flex-wrap gap-1">
            <template v-for="(link, key) in links" :key="key">
                <!-- Sin URL -->
                <div
                    v-if="link.url === null"
                    class="px-3 py-2 text-sm leading-4 text-gray-400 dark:text-gray-500 border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800"
                    v-html="link.label"
                />

                <!-- Con URL -->
                <Link
                    v-else
                    class="px-3 py-2 text-sm leading-4 border rounded-md transition-colors duration-150"
                    :class="{
                        'bg-blue-600 text-white border-blue-600': link.active,
                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700':
                            !link.active,
                    }"
                    :href="link.url"
                >
                    <span v-html="link.label"></span>
                </Link>
            </template>
        </nav>
    </div>
</template>
</file>

<file path="resources/js/Pages/Auth/Login.vue">
<script setup>
import Checkbox from '@/Components/Checkbox.vue';
import GuestLayout from '@/Layouts/GuestLayout.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Head, Link, useForm } from '@inertiajs/vue3';

defineProps({
    canResetPassword: { type: Boolean },
    status: { type: String },
});

const form = useForm({
    email: '',
    password: '',
    remember: false,
});

const submit = () => {
    form.post(route('login'), {
        onFinish: () => form.reset('password'),
    });
};
</script>

<template>
    <GuestLayout>
        <Head title="Iniciar Sesión" />

        <h2 class="text-2xl font-bold text-white text-center mb-6">Bienvenido de nuevo</h2>

        <div v-if="status" class="mb-4 font-medium text-sm text-green-400 text-center">
            {{ status }}
        </div>

        <form class="space-y-5" @submit.prevent="submit">
            <div>
                <InputLabel for="email" value="Correo Electrónico" class="text-white" />
                <TextInput
                    id="email"
                    v-model="form.email"
                    type="email"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    autofocus
                    autocomplete="username"
                    placeholder="ejemplo@correo.com"
                />
                <InputError class="mt-2" :message="form.errors.email" />
            </div>

            <div>
                <InputLabel for="password" value="Contraseña" class="text-white" />
                <TextInput
                    id="password"
                    v-model="form.password"
                    type="password"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    autocomplete="current-password"
                    placeholder="••••••••"
                />
                <InputError class="mt-2" :message="form.errors.password" />
            </div>

            <div class="block mt-4">
                <label class="flex items-center">
                    <Checkbox
                        v-model:checked="form.remember"
                        name="remember"
                        class="bg-white/10 border-gray-500 text-cyan-500 focus:ring-cyan-500"
                    />
                    <span class="ms-2 text-sm text-gray-300">Recordarme</span>
                </label>
            </div>

            <div class="flex flex-col-reverse sm:flex-row items-center justify-between gap-4 mt-6">
                <Link
                    v-if="canResetPassword"
                    :href="route('password.request')"
                    class="text-sm text-gray-300 hover:text-white underline decoration-1 underline-offset-2 transition"
                >
                    ¿Olvidaste tu contraseña?
                </Link>

                <PrimaryButton
                    class="w-full sm:w-auto justify-center bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 border-0 font-bold py-3"
                    :class="{ 'opacity-25': form.processing }"
                    :disabled="form.processing"
                >
                    Ingresar
                </PrimaryButton>
            </div>

            <div class="mt-6 text-center border-t border-white/20 pt-4">
                <Link
                    :href="route('register')"
                    class="text-sm text-cyan-400 hover:text-cyan-300 font-medium transition"
                >
                    ¿No tienes cuenta? <span class="underline">Regístrate aquí</span>
                </Link>
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/Auth/Register.vue">
<script setup>
import GuestLayout from '@/Layouts/GuestLayout.vue';
import InputError from '@/Components/InputError.vue';
import InputLabel from '@/Components/InputLabel.vue';
import PrimaryButton from '@/Components/PrimaryButton.vue';
import TextInput from '@/Components/TextInput.vue';
import { Head, Link, useForm } from '@inertiajs/vue3';

const form = useForm({
    name: '',
    apellido: '',
    email: '',
    telefono: '',
    password: '',
    password_confirmation: '',
});

const submit = () => {
    form.post(route('register'), {
        onFinish: () => form.reset('password', 'password_confirmation'),
    });
};
</script>

<template>
    <GuestLayout>
        <Head title="Crear Cuenta" />

        <h2 class="text-2xl font-bold text-white text-center mb-6">Únete a FlipperBox</h2>

        <form class="space-y-4" @submit.prevent="submit">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <InputLabel for="name" value="Nombre" class="text-white" />
                    <TextInput
                        id="name"
                        v-model="form.name"
                        type="text"
                        class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                        required
                        autofocus
                        autocomplete="given-name"
                        placeholder="Juan"
                    />
                    <InputError class="mt-2" :message="form.errors.name" />
                </div>

                <div>
                    <InputLabel for="apellido" value="Apellido" class="text-white" />
                    <TextInput
                        id="apellido"
                        v-model="form.apellido"
                        type="text"
                        class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                        required
                        autocomplete="family-name"
                        placeholder="Pérez"
                    />
                    <InputError class="mt-2" :message="form.errors.apellido" />
                </div>
            </div>

            <div>
                <InputLabel for="email" value="Correo Electrónico" class="text-white" />
                <TextInput
                    id="email"
                    v-model="form.email"
                    type="email"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    autocomplete="username"
                    placeholder="juan.perez@ejemplo.com"
                />
                <InputError class="mt-2" :message="form.errors.email" />
            </div>

            <div>
                <InputLabel for="telefono" value="Teléfono / Celular" class="text-white" />
                <TextInput
                    id="telefono"
                    v-model="form.telefono"
                    type="text"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    placeholder="3704..."
                />
                <InputError class="mt-2" :message="form.errors.telefono" />
            </div>

            <div>
                <InputLabel for="password" value="Contraseña" class="text-white" />
                <TextInput
                    id="password"
                    v-model="form.password"
                    type="password"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    autocomplete="new-password"
                    placeholder="Mínimo 8 caracteres"
                />
                <InputError class="mt-2" :message="form.errors.password" />
            </div>

            <div>
                <InputLabel for="password_confirmation" value="Confirmar Contraseña" class="text-white" />
                <TextInput
                    id="password_confirmation"
                    v-model="form.password_confirmation"
                    type="password"
                    class="mt-1 block w-full bg-white/10 border-gray-500 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-cyan-500"
                    required
                    autocomplete="new-password"
                    placeholder="Repite la contraseña"
                />
                <InputError class="mt-2" :message="form.errors.password_confirmation" />
            </div>

            <div class="flex flex-col-reverse sm:flex-row items-center justify-between gap-4 mt-8">
                <Link
                    :href="route('login')"
                    class="text-sm text-gray-300 hover:text-white underline decoration-1 underline-offset-2 transition"
                >
                    ¿Ya tienes cuenta?
                </Link>

                <PrimaryButton
                    class="w-full sm:w-auto justify-center bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 border-0 font-bold py-3"
                    :class="{ 'opacity-25': form.processing }"
                    :disabled="form.processing"
                >
                    Registrarse
                </PrimaryButton>
            </div>
        </form>
    </GuestLayout>
</template>
</file>

<file path="resources/js/Pages/ClientPortal/Dashboard.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link } from '@inertiajs/vue3';

defineProps({
    user: Object,
});

const statusClass = (status) => ({
    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300': status === 'Pendiente',
    'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300': status === 'En Progreso',
    'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': status === 'Completada',
    'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300': status === 'Cancelada',
});

const formatDate = (dateString) =>
    new Date(dateString).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
</script>

<template>
    <Head title="Mi Portal" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Portal del Cliente</h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
                <!-- Tarjeta de Bienvenida -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                            ¡Bienvenido/a, {{ user.name }} {{ user.apellido }}!
                        </h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            Aquí puedes ver el historial de servicios para tus vehículos registrados.
                        </p>
                    </div>
                </div>

                <!-- Vehículos y Historial -->
                <div v-if="user.vehiculos && user.vehiculos.length > 0" class="space-y-6">
                    <div
                        v-for="vehiculo in user.vehiculos"
                        :key="vehiculo.id"
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-8">
                            <h3
                                class="text-xl font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-4 mb-6"
                            >
                                {{ vehiculo.marca }} {{ vehiculo.modelo }}
                                <span
                                    class="font-mono bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-3 py-1 rounded-xl text-base ml-2"
                                >
                                    {{ vehiculo.patente }}
                                </span>
                            </h3>

                            <div v-if="vehiculo.work_orders && vehiculo.work_orders.length > 0">
                                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">
                                    Historial de Servicios:
                                </h4>
                                <ul class="space-y-4">
                                    <li
                                        v-for="orden in vehiculo.work_orders"
                                        :key="orden.id"
                                        class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200 flex justify-between items-center"
                                    >
                                        <div>
                                            <p class="font-semibold text-gray-900 dark:text-white">
                                                {{ orden.description }}
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                                Fecha: {{ formatDate(orden.entry_date) }}
                                            </p>
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <span
                                                class="px-3 py-1 text-xs font-semibold leading-tight rounded-full"
                                                :class="statusClass(orden.status)"
                                            >
                                                {{ orden.status }}
                                            </span>
                                            <Link
                                                :href="route('work-orders.show', orden.id)"
                                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl shadow-md transition-all duration-200 text-sm"
                                            >
                                                Ver Detalle
                                            </Link>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div v-else class="text-center py-8">
                                <p class="text-gray-500 dark:text-gray-400">
                                    Este vehículo aún no tiene un historial de servicios.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sin vehículos -->
                <div v-else class="text-center py-12">
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300 p-8"
                    >
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Aún no has registrado ningún vehículo.</p>
                        <Link
                            :href="route('cliente.vehiculos.index')"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl shadow-md transition-all duration-200 inline-flex items-center gap-2"
                        >
                            Ir a Mis Vehículos
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Crm/Clientes/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const form = useForm({
    name: '',
    apellido: '',
    telefono: '',
    email: '',
    documento_tipo: 'DNI',
    documento_valor: '',
});

const submit = () => {
    form.post(route('clientes.store'));
};
</script>

<template>
    <Head title="Crear Cliente" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Crear Nuevo Cliente</h2>
                <Link
                    :href="route('clientes.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Nombre -->
                                <div>
                                    <InputLabel for="name" value="Nombre" />
                                    <TextInput
                                        id="name"
                                        v-model="form.name"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.name" />
                                </div>

                                <!-- Apellido -->
                                <div>
                                    <InputLabel for="apellido" value="Apellido" />
                                    <TextInput
                                        id="apellido"
                                        v-model="form.apellido"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.apellido" />
                                </div>

                                <!-- Teléfono -->
                                <div>
                                    <InputLabel for="telefono" value="Teléfono" />
                                    <TextInput
                                        id="telefono"
                                        v-model="form.telefono"
                                        type="text"
                                        class="mt-1 block w-full"
                                        placeholder="Ej: 3704..."
                                    />
                                    <InputError class="mt-2" :message="form.errors.telefono" />
                                </div>

                                <!-- Email -->
                                <div>
                                    <InputLabel for="email" value="Email" />
                                    <TextInput
                                        id="email"
                                        v-model="form.email"
                                        type="email"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.email" />
                                </div>

                                <!-- Tipo Doc -->
                                <div>
                                    <InputLabel for="documento_tipo" value="Tipo de Documento" />
                                    <select
                                        id="documento_tipo"
                                        v-model="form.documento_tipo"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm"
                                    >
                                        <option>DNI</option>
                                        <option>Pasaporte</option>
                                        <option>Otro</option>
                                    </select>
                                </div>

                                <!-- Valor Doc -->
                                <div>
                                    <InputLabel for="documento_valor" value="Número de Documento" />
                                    <TextInput
                                        id="documento_valor"
                                        v-model="form.documento_valor"
                                        type="text"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.documento_valor" />
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-4 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Cliente</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Crm/Clientes/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';

const props = defineProps({
    cliente: { type: Object, required: true },
});

const form = useForm({
    name: props.cliente.name,
    apellido: props.cliente.apellido,
    telefono: props.cliente.telefono,
    email: props.cliente.email,
    documento_tipo: props.cliente.documento_tipo,
    documento_valor: props.cliente.documento_valor,
});

const submit = () => {
    form.patch(route('clientes.update', { user: props.cliente.id }), {
        preserveScroll: true,
    });
};
</script>

<template>
    <Head :title="`Editar Cliente: ${cliente.name}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Editar Cliente</h2>
                <Link
                    :href="route('clientes.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <InputLabel for="name" value="Nombre" />
                                    <TextInput
                                        id="name"
                                        v-model="form.name"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.name" />
                                </div>
                                <div>
                                    <InputLabel for="apellido" value="Apellido" />
                                    <TextInput
                                        id="apellido"
                                        v-model="form.apellido"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.apellido" />
                                </div>
                                <div>
                                    <InputLabel for="telefono" value="Teléfono" />
                                    <TextInput
                                        id="telefono"
                                        v-model="form.telefono"
                                        type="text"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.telefono" />
                                </div>
                                <div>
                                    <InputLabel for="email" value="Email" />
                                    <TextInput
                                        id="email"
                                        v-model="form.email"
                                        type="email"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.email" />
                                </div>
                                <div>
                                    <InputLabel for="documento_tipo" value="Tipo de Documento" />
                                    <select
                                        id="documento_tipo"
                                        v-model="form.documento_tipo"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm"
                                    >
                                        <option>DNI</option>
                                        <option>Pasaporte</option>
                                        <option>Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <InputLabel for="documento_valor" value="Número de Documento" />
                                    <TextInput
                                        id="documento_valor"
                                        v-model="form.documento_valor"
                                        type="text"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.documento_valor" />
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-4 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    Actualizar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Crm/Vehiculos/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';

const props = defineProps({
    cliente: {
        type: Object,
        required: true,
    },
});

const form = useForm({
    patente: '',
    marca: '',
    modelo: '',
    anio: new Date().getFullYear(),
    kilometraje: '',
    vin: '',
    numero_motor: '',
    observaciones: '',
});

const submit = () => {
    form.post(route('clientes.vehiculos.store', { user: props.cliente.id }));
};
</script>

<template>
    <Head title="Agregar Vehículo" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Agregar Vehículo a: <span class="font-bold">{{ cliente.name }} {{ cliente.apellido }}</span>
                </h2>
                <Link
                    :href="route('clientes.show', { user: cliente.id })"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al cliente
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Campo Patente -->
                                <div>
                                    <InputLabel for="patente" value="Patente" />
                                    <TextInput
                                        id="patente"
                                        v-model="form.patente"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.patente" />
                                </div>

                                <!-- Campo Marca -->
                                <div>
                                    <InputLabel for="marca" value="Marca" />
                                    <TextInput
                                        id="marca"
                                        v-model="form.marca"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.marca" />
                                </div>

                                <!-- Campo Modelo -->
                                <div>
                                    <InputLabel for="modelo" value="Modelo" />
                                    <TextInput
                                        id="modelo"
                                        v-model="form.modelo"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.modelo" />
                                </div>

                                <!-- Campo Año -->
                                <div>
                                    <InputLabel for="anio" value="Año" />
                                    <TextInput
                                        id="anio"
                                        v-model.number="form.anio"
                                        type="number"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.anio" />
                                </div>

                                <!-- Campo Kilometraje -->
                                <div>
                                    <InputLabel for="kilometraje" value="Kilometraje (Opcional)" />
                                    <TextInput
                                        id="kilometraje"
                                        v-model.number="form.kilometraje"
                                        type="number"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.kilometraje" />
                                </div>

                                <!-- Campo VIN -->
                                <div>
                                    <InputLabel for="vin" value="N° de Chasis (VIN) (Opcional)" />
                                    <TextInput id="vin" v-model="form.vin" type="text" class="mt-1 block w-full" />
                                    <InputError class="mt-2" :message="form.errors.vin" />
                                </div>

                                <!-- Campo Número de Motor -->
                                <div>
                                    <InputLabel for="numero_motor" value="Número de Motor (Opcional)" />
                                    <TextInput
                                        id="numero_motor"
                                        v-model="form.numero_motor"
                                        type="text"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.numero_motor" />
                                </div>

                                <!-- Campo Observaciones -->
                                <div class="md:col-span-2">
                                    <InputLabel for="observaciones" value="Observaciones (Opcional)" />
                                    <textarea
                                        id="observaciones"
                                        v-model="form.observaciones"
                                        rows="4"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm transition-colors duration-200"
                                        placeholder="Observaciones adicionales sobre el vehículo..."
                                    ></textarea>
                                    <InputError class="mt-2" :message="form.errors.observaciones" />
                                </div>
                            </div>

                            <!-- Botón de Envío -->
                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Vehículo</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Crm/Vehiculos/Edit.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';

const props = defineProps({
    cliente: {
        type: Object,
        required: true,
    },
    vehiculo: {
        type: Object,
        required: true,
    },
});

const form = useForm({
    patente: props.vehiculo.patente,
    marca: props.vehiculo.marca,
    modelo: props.vehiculo.modelo,
    anio: props.vehiculo.anio,
    kilometraje: props.vehiculo.kilometraje,
    vin: props.vehiculo.vin,
    numero_motor: props.vehiculo.numero_motor,
    observaciones: props.vehiculo.observaciones,
});

const submit = () => {
    form.patch(route('clientes.vehiculos.update', { user: props.cliente.id, vehiculo: props.vehiculo.id }), {
        preserveScroll: true,
    });
};
</script>

<template>
    <Head :title="`Editar Vehículo: ${vehiculo.patente}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Editar Vehículo: <span class="font-bold">{{ vehiculo.patente }}</span>
                </h2>
                <Link
                    :href="route('clientes.show', { user: cliente.id })"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al cliente
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-6" @submit.prevent="submit">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Campo Patente -->
                                <div>
                                    <InputLabel for="patente" value="Patente" />
                                    <TextInput
                                        id="patente"
                                        v-model="form.patente"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                        autofocus
                                    />
                                    <InputError class="mt-2" :message="form.errors.patente" />
                                </div>

                                <!-- Campo Marca -->
                                <div>
                                    <InputLabel for="marca" value="Marca" />
                                    <TextInput
                                        id="marca"
                                        v-model="form.marca"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.marca" />
                                </div>

                                <!-- Campo Modelo -->
                                <div>
                                    <InputLabel for="modelo" value="Modelo" />
                                    <TextInput
                                        id="modelo"
                                        v-model="form.modelo"
                                        type="text"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.modelo" />
                                </div>

                                <!-- Campo Año -->
                                <div>
                                    <InputLabel for="anio" value="Año" />
                                    <TextInput
                                        id="anio"
                                        v-model.number="form.anio"
                                        type="number"
                                        class="mt-1 block w-full"
                                        required
                                    />
                                    <InputError class="mt-2" :message="form.errors.anio" />
                                </div>

                                <!-- Campo Kilometraje -->
                                <div>
                                    <InputLabel for="kilometraje" value="Kilometraje (Opcional)" />
                                    <TextInput
                                        id="kilometraje"
                                        v-model.number="form.kilometraje"
                                        type="number"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.kilometraje" />
                                </div>

                                <!-- Campo VIN -->
                                <div>
                                    <InputLabel for="vin" value="N° de Chasis (VIN) (Opcional)" />
                                    <TextInput id="vin" v-model="form.vin" type="text" class="mt-1 block w-full" />
                                    <InputError class="mt-2" :message="form.errors.vin" />
                                </div>

                                <!-- Campo Número de Motor -->
                                <div>
                                    <InputLabel for="numero_motor" value="Número de Motor (Opcional)" />
                                    <TextInput
                                        id="numero_motor"
                                        v-model="form.numero_motor"
                                        type="text"
                                        class="mt-1 block w-full"
                                    />
                                    <InputError class="mt-2" :message="form.errors.numero_motor" />
                                </div>

                                <!-- Campo Observaciones -->
                                <div class="md:col-span-2">
                                    <InputLabel for="observaciones" value="Observaciones (Opcional)" />
                                    <textarea
                                        id="observaciones"
                                        v-model="form.observaciones"
                                        rows="4"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm transition-colors duration-200"
                                        placeholder="Observaciones adicionales sobre el vehículo..."
                                    ></textarea>
                                    <InputError class="mt-2" :message="form.errors.observaciones" />
                                </div>
                            </div>

                            <!-- Botón de Envío -->
                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Actualizando...</span>
                                    <span v-else>Actualizar Vehículo</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Dashboard.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import StatCard from '@/Components/Dashboard/StatCard.vue';
import BarChart from '@/Components/Dashboard/BarChart.vue';
import DoughnutChart from '@/Components/Dashboard/DoughnutChart.vue';
import { Head } from '@inertiajs/vue3';
import { computed } from 'vue';

const props = defineProps({
    ingresosMes: Number,
    dailyActivityChart: Object,
    topProducts: Array,
    lowStockProducts: Array,
    workOrderStatusChart: Object,
});

const formatCurrency = (value) =>
    new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS',
    }).format(value);

// --- Datos para los gráficos ---
const barChartData = computed(() => ({
    labels: props.dailyActivityChart?.labels || [],
    datasets: [
        {
            label: 'Órdenes Completadas',
            backgroundColor: '#3b82f6',
            data: props.dailyActivityChart?.data || [],
        },
    ],
}));

const doughnutChartData = computed(() => ({
    labels: props.workOrderStatusChart?.labels || [],
    datasets: [
        {
            backgroundColor: ['#facc15', '#3b82f6', '#22c55e', '#ef4444', '#8b5cf6'],
            data: props.workOrderStatusChart?.data || [],
        },
    ],
}));
</script>

<template>
    <Head title="Dashboard" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Dashboard de Administración
                </h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Widget 1: Ingresos del Mes -->
                    <StatCard>
                        <template #title>Ingresos del Mes (Completadas)</template>
                        <template #content>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white">
                                {{ formatCurrency(ingresosMes) }}
                            </p>
                        </template>
                    </StatCard>

                    <!-- Widget 2: Estado de Órdenes -->
                    <StatCard>
                        <template #title>Estado de Órdenes (Últimos 30 días)</template>
                        <template #content>
                            <div class="h-40">
                                <DoughnutChart
                                    v-if="
                                        workOrderStatusChart &&
                                        workOrderStatusChart.data &&
                                        workOrderStatusChart.data.length
                                    "
                                    :chart-data="doughnutChartData"
                                />
                                <p v-else class="text-gray-500 dark:text-gray-400 text-center py-8">
                                    No hay datos disponibles.
                                </p>
                            </div>
                        </template>
                    </StatCard>

                    <!-- Widget 3: Top Productos -->
                    <StatCard class="lg:col-span-2">
                        <template #title>Top 5 Productos Rentables (Mes Actual)</template>
                        <template #content>
                            <ul v-if="topProducts.length > 0" class="space-y-3">
                                <li
                                    v-for="product in topProducts"
                                    :key="product.name"
                                    class="flex justify-between items-center text-sm py-2 border-b border-gray-100 dark:border-gray-700 last:border-0"
                                >
                                    <span class="text-gray-700 dark:text-gray-300">{{ product.name }}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white">
                                        {{ formatCurrency(product.total_revenue) }}
                                    </span>
                                </li>
                            </ul>
                            <p v-else class="text-gray-500 dark:text-gray-400">No hay ventas registradas este mes.</p>
                        </template>
                    </StatCard>

                    <!-- Widget 4: Gráfico de Actividad -->
                    <StatCard class="md:col-span-2 lg:col-span-3">
                        <template #title>Órdenes Completadas (Últimos 30 días)</template>
                        <template #content>
                            <div class="h-64">
                                <BarChart
                                    v-if="
                                        dailyActivityChart && dailyActivityChart.data && dailyActivityChart.data.length
                                    "
                                    :chart-data="barChartData"
                                />
                                <p v-else class="text-gray-500 dark:text-gray-400 text-center py-16">
                                    No hay actividad registrada en los últimos 30 días.
                                </p>
                            </div>
                        </template>
                    </StatCard>

                    <!-- Widget 5: Productos con Stock Bajo -->
                    <StatCard>
                        <template #title>Alerta de Stock Bajo (Top 5)</template>
                        <template #content>
                            <ul v-if="lowStockProducts.length > 0" class="space-y-3">
                                <li
                                    v-for="product in lowStockProducts"
                                    :key="product.name"
                                    class="flex justify-between items-center text-sm py-2 border-b border-gray-100 dark:border-gray-700 last:border-0"
                                >
                                    <span class="text-gray-700 dark:text-gray-300">{{ product.name }}</span>
                                    <span class="font-semibold text-red-600 dark:text-red-400">
                                        {{ product.current_stock }} /
                                        <span class="text-gray-500 dark:text-gray-400">{{
                                            product.min_threshold
                                        }}</span>
                                    </span>
                                </li>
                            </ul>
                            <p v-else class="text-gray-500 dark:text-gray-400">No hay productos con stock bajo.</p>
                        </template>
                    </StatCard>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Products/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import TextInput from '@/Components/TextInput.vue';
import InputError from '@/Components/InputError.vue';
import { computed } from 'vue';

const props = defineProps({
    suppliers: {
        type: Array,
        required: true,
    },
});

const form = useForm({
    name: '',
    sku: '',
    description: '',
    cost: 0.0,
    iva_percentage: 21,
    profit_margin: 40,
    current_stock: 0,
    min_threshold: 5,
    supplier_id: props.suppliers.length > 0 ? props.suppliers[0].id : null,
});

const calculatedPrice = computed(() => {
    const cost = parseFloat(form.cost) || 0;
    const ivaPercentage = parseFloat(form.iva_percentage) || 0;
    const profitMargin = parseFloat(form.profit_margin) || 0;
    const costWithIva = cost * (1 + ivaPercentage / 100);
    const finalPrice = costWithIva * (1 + profitMargin / 100);
    return finalPrice.toFixed(2);
});

const submit = () => {
    form.post(route('inventario.products.store'));
};
</script>

<template>
    <Head title="Crear Producto" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Crear Nuevo Producto</h2>
                <Link
                    :href="route('inventario.products.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <form class="space-y-8" @submit.prevent="submit">
                            <!-- SECCIÓN 1: DATOS DEL PRODUCTO -->
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Datos del Producto
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <InputLabel for="name" value="Nombre del Producto" />
                                        <TextInput
                                            id="name"
                                            v-model="form.name"
                                            type="text"
                                            class="mt-1 block w-full"
                                            required
                                            autofocus
                                        />
                                        <InputError class="mt-2" :message="form.errors.name" />
                                    </div>
                                    <div>
                                        <InputLabel for="sku" value="SKU (Código Único)" />
                                        <TextInput
                                            id="sku"
                                            v-model="form.sku"
                                            type="text"
                                            class="mt-1 block w-full"
                                            required
                                        />
                                        <InputError class="mt-2" :message="form.errors.sku" />
                                    </div>
                                    <div>
                                        <InputLabel for="supplier_id" value="Proveedor" />
                                        <select
                                            id="supplier_id"
                                            v-model="form.supplier_id"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        >
                                            <option
                                                v-for="supplier in suppliers"
                                                :key="supplier.id"
                                                :value="supplier.id"
                                            >
                                                {{ supplier.name }}
                                            </option>
                                        </select>
                                        <InputError class="mt-2" :message="form.errors.supplier_id" />
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <InputLabel for="description" value="Descripción (Opcional)" />
                                    <textarea
                                        id="description"
                                        v-model="form.description"
                                        rows="4"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                        placeholder="Descripción del producto..."
                                    ></textarea>
                                </div>
                            </div>

                            <!-- SECCIÓN 2: PRECIOS Y STOCK -->
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900 dark:text-white mb-6 pb-4 border-b border-gray-200 dark:border-gray-700"
                                >
                                    Precios y Stock
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <InputLabel for="cost" value="Precio de Costo ($)" />
                                        <input
                                            id="cost"
                                            v-model.number="form.cost"
                                            type="number"
                                            step="0.01"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                        <InputError class="mt-2" :message="form.errors.cost" />
                                    </div>
                                    <div>
                                        <InputLabel for="iva_percentage" value="IVA (%)" />
                                        <input
                                            id="iva_percentage"
                                            v-model.number="form.iva_percentage"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <InputLabel for="profit_margin" value="Margen de Ganancia (%)" />
                                        <input
                                            id="profit_margin"
                                            v-model.number="form.profit_margin"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div
                                        class="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl border border-gray-200 dark:border-gray-600 flex items-center justify-center"
                                    >
                                        <div class="text-center">
                                            <InputLabel value="Precio de Venta Calculado" />
                                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                                                ${{ calculatedPrice }}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <InputLabel for="current_stock" value="Stock Inicial" />
                                        <input
                                            id="current_stock"
                                            v-model.number="form.current_stock"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <InputLabel for="min_threshold" value="Umbral de Stock Bajo" />
                                        <input
                                            id="min_threshold"
                                            v-model.number="form.min_threshold"
                                            type="number"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-200 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Guardando...</span>
                                    <span v-else>Guardar Producto</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Suppliers/Index.vue">
<!-- Archivo: resources/js/Pages/Inventory/Suppliers/Index.vue -->
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import SearchInput from '@/Components/SearchInput.vue';
import { ref } from 'vue';

defineProps({ suppliers: Object, filters: Object });
const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

const confirmingSupplierDeletion = ref(false);
const supplierToDelete = ref(null);
const confirmSupplierDeletion = (s) => {
    supplierToDelete.value = s;
    confirmingSupplierDeletion.value = true;
};
const deleteSupplier = () => {
    router.delete(route('inventario.suppliers.destroy', supplierToDelete.value.id), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};
const closeModal = () => {
    confirmingSupplierDeletion.value = false;
    supplierToDelete.value = null;
};
</script>

<template>
    <Head title="Proveedores" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Gestión de Proveedores</h2>
                <Link
                    v-if="can('gestionar proveedores')"
                    :href="route('inventario.suppliers.create')"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 text-sm"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Nuevo Proveedor
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="mb-6">
                    <SearchInput :model-value="filters.search" placeholder="Buscar proveedor..." />
                </div>
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors"
                >
                    <div class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th class="px-6 py-4 font-bold tracking-wider">Proveedor</th>
                                        <th class="px-6 py-4 font-bold tracking-wider">Contacto</th>
                                        <th class="px-6 py-4 font-bold tracking-wider text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="supplier in suppliers.data"
                                        :key="supplier.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                                    >
                                        <th class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-base font-semibold text-gray-900 dark:text-white">
                                                {{ supplier.name }}
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {{ supplier.email }}
                                            </div>
                                        </th>
                                        <td class="px-6 py-4 text-gray-600 dark:text-gray-300">
                                            <div class="font-medium">{{ supplier.contact_person }}</div>
                                            <div class="text-xs">{{ supplier.phone }}</div>
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm font-medium">
                                            <Link
                                                v-if="can('gestionar proveedores')"
                                                :href="route('inventario.suppliers.edit', supplier.id)"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                >Editar</Link
                                            >
                                            <button
                                                v-if="can('gestionar proveedores')"
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmSupplierDeletion(supplier)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="suppliers.data.length === 0">
                                        <td colspan="4" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            No se encontraron proveedores.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div
                        v-if="suppliers.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="suppliers.links" />
                    </div>
                </div>
            </div>
        </div>
        <ConfirmationModal
            :show="confirmingSupplierDeletion"
            title="Eliminar Proveedor"
            :message="`¿Estás seguro de que deseas eliminar al proveedor '${supplierToDelete?.name}'? Esta acción no se puede deshacer.`"
            @close="closeModal"
            @confirm="deleteSupplier"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Scheduling/Admin/ReservationIndex.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import InputLabel from '@/Components/InputLabel.vue';
import { ref, watch } from 'vue';
import { throttle } from 'lodash';

const props = defineProps({
    reservations: Object,
    filters: Object,
});

const confirmingAction = ref(false);
const actionToConfirm = ref({});

// Objeto reactivo para los filtros
const filters = ref({
    status: props.filters.status || '',
    date: props.filters.date || '',
});

// Observador que reacciona a los cambios en los filtros y recarga la página
watch(
    filters,
    throttle(() => {
        router.get(route('admin.scheduling.reservations.index'), filters.value, {
            preserveState: true,
            replace: true,
        });
    }, 300),
    { deep: true }
);

const statusClass = (status) => ({
    'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': status === 'Confirmada',
    'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300': status === 'Asistió',
    'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300': status === 'Ausente',
    'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300': status === 'Cancelada',
});

const formatDate = (dateString) =>
    new Date(dateString).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });

// --- NUEVA FUNCIÓN HELPER ---
// Función para verificar si una fecha de reserva es futura
const isFutureReservation = (dateString) => {
    const reservationDate = new Date(dateString);
    reservationDate.setHours(0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return reservationDate > today;
};

const setupConfirmation = (config) => {
    actionToConfirm.value = config;
    confirmingAction.value = true;
};

const confirmStatusChange = (reservation, newStatus) => {
    let title = '';
    let message = '';
    let buttonText = '';
    let buttonClass = '';

    if (newStatus === 'Asistió') {
        title = 'Marcar como Asistió';
        message = `¿Confirmas que el cliente para la reserva #${reservation.id} ha asistido?`;
        buttonText = 'Sí, Confirmar Asistencia';
        buttonClass = 'bg-green-600 hover:bg-green-700';
    } else if (newStatus === 'Ausente') {
        title = 'Marcar como Ausente';
        message = `¿Confirmas que el cliente para la reserva #${reservation.id} no ha asistido?`;
        buttonText = 'Sí, Marcar Ausente';
        buttonClass = 'bg-orange-500 hover:bg-orange-600';
    }

    setupConfirmation({
        title,
        message,
        confirmButtonText: buttonText,
        confirmButtonClass: buttonClass,
        method: () =>
            router.patch(
                route('admin.scheduling.reservations.update', reservation.id),
                { status: newStatus },
                {
                    onSuccess: () => closeModal(),
                    preserveScroll: true,
                }
            ),
    });
};

const closeModal = () => (confirmingAction.value = false);
</script>

<template>
    <Head title="Gestión de Reservas" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Gestión de Reservas de Clientes
                </h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <!-- Filtros -->
                    <div class="p-8 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-100 dark:border-gray-700">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                            <div>
                                <InputLabel for="status" value="Filtrar por Estado" />
                                <select
                                    id="status"
                                    v-model="filters.status"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                >
                                    <option value="">Todos</option>
                                    <option value="Confirmada">Confirmada</option>
                                    <option value="Asistió">Asistió</option>
                                    <option value="Ausente">Ausente</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div>
                                <InputLabel for="date" value="Filtrar por Fecha" />
                                <input
                                    id="date"
                                    v-model="filters.date"
                                    type="date"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                                />
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Fecha Reserva</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Cliente</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Vehículo</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Estado</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider text-right">
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="reservation in reservations.data"
                                        :key="reservation.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <th
                                            scope="row"
                                            class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap"
                                        >
                                            {{ formatDate(reservation.reservation_date) }}
                                        </th>
                                        <td class="px-6 py-4">
                                            {{ reservation.user.name }} {{ reservation.user.apellido }}
                                        </td>
                                        <td class="px-6 py-4">
                                            {{ reservation.vehicle.marca }} {{ reservation.vehicle.modelo }} ({{
                                                reservation.vehicle.patente
                                            }})
                                        </td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="px-3 py-1 font-semibold leading-tight text-xs rounded-full"
                                                :class="statusClass(reservation.status)"
                                            >
                                                {{ reservation.status }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-right whitespace-nowrap text-sm font-medium">
                                            <div v-if="reservation.status === 'Confirmada'">
                                                <button
                                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-xl shadow-md transition-all duration-200 mr-3"
                                                    :disabled="isFutureReservation(reservation.reservation_date)"
                                                    :class="{
                                                        'opacity-50 cursor-not-allowed': isFutureReservation(
                                                            reservation.reservation_date
                                                        ),
                                                    }"
                                                    title="Solo se puede marcar en o después de la fecha de la reserva"
                                                    @click="confirmStatusChange(reservation, 'Asistió')"
                                                >
                                                    Asistió
                                                </button>
                                                <button
                                                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-xl shadow-md transition-all duration-200"
                                                    :disabled="isFutureReservation(reservation.reservation_date)"
                                                    :class="{
                                                        'opacity-50 cursor-not-allowed': isFutureReservation(
                                                            reservation.reservation_date
                                                        ),
                                                    }"
                                                    title="Solo se puede marcar en o después de la fecha de la reserva"
                                                    @click="confirmStatusChange(reservation, 'Ausente')"
                                                >
                                                    Ausente
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-if="reservations.data.length === 0">
                                        <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            <div class="flex flex-col items-center justify-center">
                                                <svg
                                                    class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-3"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                    ></path>
                                                </svg>
                                                <p class="text-lg font-medium">No se encontraron reservas</p>
                                                <p class="text-sm">con los filtros actuales.</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Paginación -->
                    <div
                        v-if="reservations.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="reservations.links" />
                    </div>
                </div>
            </div>
        </div>

        <ConfirmationModal
            :show="confirmingAction"
            :title="actionToConfirm.title"
            :message="actionToConfirm.message"
            :confirm-button-text="actionToConfirm.confirmButtonText"
            :confirm-button-class="actionToConfirm.confirmButtonClass"
            @close="closeModal"
            @confirm="actionToConfirm.method"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Create.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, useForm, Link } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import InputError from '@/Components/InputError.vue';

const props = defineProps({
    vehiculo: {
        type: Object,
        required: true,
    },
});

const form = useForm({
    vehicle_id: props.vehiculo.id,
    description: '',
});

const submit = () => {
    form.post(route('work-orders.store'));
};
</script>

<template>
    <Head title="Crear Orden de Trabajo" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Nueva Orden de Trabajo</h2>
                <Link
                    :href="route('clientes.show', { user: vehiculo.user_id })"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al Cliente
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <!-- Información del Vehículo -->
                        <div
                            class="mb-8 p-6 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-200 dark:border-gray-600"
                        >
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-3">Vehículo Seleccionado</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-semibold text-gray-700 dark:text-gray-300">Cliente:</span>
                                    <p class="text-gray-900 dark:text-white">
                                        {{ vehiculo.cliente.name }} {{ vehiculo.cliente.apellido }}
                                    </p>
                                </div>
                                <div>
                                    <span class="font-semibold text-gray-700 dark:text-gray-300">Patente:</span>
                                    <p
                                        class="text-gray-900 dark:text-white font-mono bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded inline-block"
                                    >
                                        {{ vehiculo.patente }}
                                    </p>
                                </div>
                                <div>
                                    <span class="font-semibold text-gray-700 dark:text-gray-300">Marca y Modelo:</span>
                                    <p class="text-gray-900 dark:text-white">
                                        {{ vehiculo.marca }} {{ vehiculo.modelo }}
                                    </p>
                                </div>
                                <div>
                                    <span class="font-semibold text-gray-700 dark:text-gray-300">Año:</span>
                                    <p class="text-gray-900 dark:text-white">{{ vehiculo.anio }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario -->
                        <form class="space-y-6" @submit.prevent="submit">
                            <div>
                                <InputLabel for="description" value="Descripción del Problema o Servicio Solicitado" />
                                <textarea
                                    id="description"
                                    v-model="form.description"
                                    rows="6"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 rounded-md shadow-sm transition-colors duration-200"
                                    required
                                    autofocus
                                    placeholder="Describa el problema o servicio requerido..."
                                ></textarea>
                                <InputError class="mt-2" :message="form.errors.description" />
                            </div>

                            <div
                                class="flex items-center justify-end pt-6 border-t border-gray-100 dark:border-gray-700"
                            >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2"
                                    :disabled="form.processing"
                                >
                                    <span v-if="form.processing">Creando...</span>
                                    <span v-else>Crear Orden de Trabajo</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="src/ClientPortal/Http/Controllers/VehiculoController.php">
<?php

namespace FlipperBox\ClientPortal\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class VehiculoController extends Controller
{
    public function __construct()
    {
        $this->authorizeResource(Vehiculo::class, 'vehiculo');
    }

    public function index(): Response
    {
        /** @var \App\Models\User $user */
        $user = Auth::user();

        $vehiculos = $user->vehiculos()->latest()->paginate(10);

        return Inertia::render('ClientPortal/Vehicles/Index', [
            'vehiculos' => $vehiculos,
        ]);
    }

    public function create(): Response
    {
        return Inertia::render('ClientPortal/Vehicles/Create');
    }

    public function store(Request $request): RedirectResponse
    {
        $validated = $request->validate([
            'patente' => ['required', 'string', 'max:255', 'unique:vehiculos,patente'],
            'marca' => ['required', 'string', 'max:255'],
            'modelo' => ['required', 'string', 'max:255'],
            'anio' => ['required', 'integer', 'min:1950', 'max:'.date('Y')],
            'kilometraje' => ['nullable', 'integer', 'min:0'],
        ]);

        /** @var \App\Models\User $user */
        $user = Auth::user();

        $user->vehiculos()->create($validated);

        return to_route('cliente.vehiculos.index')->with('success', 'Vehículo agregado exitosamente.');
    }

    public function edit(Vehiculo $vehiculo): Response
    {
        return Inertia::render('ClientPortal/Vehicles/Edit', [
            'vehiculo' => $vehiculo,
        ]);
    }

    public function update(Request $request, Vehiculo $vehiculo): RedirectResponse
    {
        $validated = $request->validate([
            'patente' => ['required', 'string', 'max:255', Rule::unique('vehiculos', 'patente')->ignore($vehiculo->id)],
            'marca' => ['required', 'string', 'max:255'],
            'modelo' => ['required', 'string', 'max:255'],
            'anio' => ['required', 'integer', 'min:1950', 'max:'.date('Y')],
            'kilometraje' => ['nullable', 'integer', 'min:0'],
        ]);

        $vehiculo->update($validated);

        return to_route('cliente.vehiculos.index')->with('success', 'Vehículo actualizado exitosamente.');
    }

    /**
     * Elimina (Soft Delete) un vehículo.
     */
    public function destroy(Vehiculo $vehiculo): RedirectResponse
    {
        $this->authorize('delete', $vehiculo);

        try {
            $vehiculo->delete();
        } catch (ValidationException $e) {
            // Atrapamos la excepción del observer y la convertimos en un mensaje de error flash.
            return back()->with('error', $e->validator->errors()->first());
        }

        return to_route('cliente.vehiculos.index')->with('success', 'Vehículo eliminado exitosamente.');
    }
}
</file>

<file path="src/Crm/Http/Controllers/CrmController.php">
<?php

namespace FlipperBox\Crm\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\User;
use FlipperBox\Crm\Actions\CreateUserAsClientAction;
use FlipperBox\Crm\Http\Requests\StoreUserAsClientRequest;
use FlipperBox\Crm\Http\Requests\UpdateUserAsClientRequest;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class CrmController extends Controller
{
    public function index(Request $request): Response
    {
        $query = User::role('Cliente')->latest();

        // Lógica de Búsqueda Global
        if ($request->has('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                    ->orWhere('apellido', 'like', "%{$search}%")
                    ->orWhere('email', 'like', "%{$search}%")
                    ->orWhere('telefono', 'like', "%{$search}%")
                    ->orWhere('documento_valor', 'like', "%{$search}%");
            });
        }

        return Inertia::render('Crm/Clientes/Index', [
            'clientes' => $query->paginate(10)->withQueryString(),
            'filters' => $request->only(['search']),
        ]);
    }

    public function create(): Response
    {
        return Inertia::render('Crm/Clientes/Create');
    }

    public function store(StoreUserAsClientRequest $request, CreateUserAsClientAction $createUserAsClient): RedirectResponse
    {
        $createUserAsClient->execute($request->validated());

        return to_route('clientes.index')->with('success', 'Cliente creado exitosamente.');
    }

    public function show(User $user): Response
    {
        abort_if(! $user->hasRole('Cliente'), 404);
        $user->load('vehiculos');

        return Inertia::render('Crm/Clientes/Show', [
            'cliente' => $user,
        ]);
    }

    public function edit(User $user): Response
    {
        abort_if(! $user->hasRole('Cliente'), 404);

        return Inertia::render('Crm/Clientes/Edit', [
            'cliente' => $user,
        ]);
    }

    public function update(UpdateUserAsClientRequest $request, User $user): RedirectResponse
    {
        $user->update($request->validated());

        return to_route('clientes.index')->with('success', 'Cliente actualizado exitosamente.');
    }

    public function destroy(User $user): RedirectResponse
    {
        // 1. Verificación de Rol explícita
        if (! $user->hasRole('Cliente')) {
            return back()->with('error', 'La acción de eliminación solo es aplicable a usuarios con el rol de Cliente.');
        }

        // 2. Verificación de Regla de Negocio explícita
        if ($user->vehiculos()->whereHas('workOrders')->exists()) {
            return back()->with('error', 'No se puede eliminar este cliente porque tiene órdenes de trabajo asociadas. Por favor, gestione esas órdenes primero.');
        }

        // Si pasa las validaciones, procedemos a eliminar
        try {
            $user->delete();
        } catch (ValidationException $e) {
            // El catch se mantiene como una segunda capa de seguridad por si un Observer lanza una excepción
            return back()->with('error', $e->validator->errors()->first('error'));
        }

        return to_route('clientes.index')->with('success', 'Cliente eliminado exitosamente.');
    }
}
</file>

<file path="src/Inventory/Models/Product.php">
<?php

namespace FlipperBox\Inventory\Models;

use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\SoftDeletes;

class Product extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'name',
        'sku',
        'description',
        'cost',
        'iva_percentage',
        'profit_margin',
        'price',
        'current_stock',
        'min_threshold',
    ];

    protected $casts = [
        'cost' => 'decimal:2',
        'iva_percentage' => 'decimal:2',
        'profit_margin' => 'decimal:2',
        'price' => 'decimal:2',
    ];

    protected static function boot()
    {
        parent::boot();

        // Calcular automáticamente el precio antes de guardar
        static::saving(function ($product) {
            if (empty($product->price) || $product->isDirty(['cost', 'iva_percentage', 'profit_margin'])) {
                $product->price = $product->calculatePrice();
            }
        });
    }

    /**
     * Calcular el precio basado en costo, IVA y margen
     * Fórmula: (Costo + IVA) × (1 + Margen%)
     */
    public function calculatePrice(): float
    {
        $costWithIva = $this->cost * (1 + ($this->iva_percentage / 100));
        $price = $costWithIva * (1 + ($this->profit_margin / 100));

        return round($price, 2);
    }

    // Relaciones
    public function suppliers()
    {
        return $this->belongsToMany(Supplier::class)
            ->withPivot('cost')
            ->withTimestamps();
    }

    public function inventoryMovements()
    {
        return $this->hasMany(InventoryMovement::class);
    }

    public function workOrders(): BelongsToMany
    {
        return $this->belongsToMany(WorkOrder::class, 'work_order_product')
            ->withPivot('quantity', 'unit_price')
            ->withTimestamps();
    }
}
</file>

<file path="src/WorkManagement/Models/Service.php">
<?php

namespace FlipperBox\WorkManagement\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\SoftDeletes;

class Service extends Model
{
    use SoftDeletes;

    protected $fillable = ['name', 'description', 'price'];

    /**
     * Define la relación: Un servicio puede estar en muchas órdenes de trabajo.
     */
    public function workOrders(): BelongsToMany
    {
        return $this->belongsToMany(WorkOrder::class, 'work_order_service')
            ->withPivot('price')
            ->withTimestamps();
    }
}
</file>

<file path="tests/Feature/Auth/RegistrationTest.php">
<?php

namespace Tests\Feature\Auth;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Spatie\Permission\Models\Role;
use Tests\TestCase;

class RegistrationTest extends TestCase
{
    use RefreshDatabase;

    public function test_registration_screen_can_be_rendered(): void
    {
        $response = $this->get('/register');

        $response->assertStatus(200);
    }

    public function test_new_users_can_register(): void
    {
        Role::create(['name' => 'Cliente', 'guard_name' => 'web']);

        $role = Role::findByName('Cliente');
        $role->givePermissionTo(\Spatie\Permission\Models\Permission::create(['name' => 'ver mis vehiculos', 'guard_name' => 'web']));

        $response = $this->post('/register', [
            'name' => 'Test User',
            'apellido' => 'Test Apellido',
            'telefono' => '1122334455',
            'email' => 'test@example.com',
            'password' => 'password',
            'password_confirmation' => 'password',
        ]);

        $this->assertAuthenticated();
        $response->assertRedirect(route('cliente.dashboard'));

        $this->assertDatabaseHas('users', [
            'email' => 'test@example.com',
            'apellido' => 'Test Apellido',
            'telefono' => '1122334455',
        ]);
    }
}
</file>

<file path="app/Models/User.php">
<?php

namespace App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use FlipperBox\Crm\Models\Vehiculo;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasFactory, HasRoles, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'name',
        'apellido',
        'email',
        'telefono',
        'documento_tipo',
        'documento_valor',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var array<int, string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }

    /**
     * Define la relación: Un usuario (si es cliente) puede tener muchos vehículos.
     */
    public function vehiculos(): HasMany
    {
        return $this->hasMany(Vehiculo::class);
    }

    /**
     * Define la relación: Un usuario (si es mecánico) puede tener muchas órdenes de trabajo asignadas.
     */
    public function workOrders(): HasMany
    {
        return $this->hasMany(WorkOrder::class, 'mechanic_id');
    }
}
</file>

<file path="resources/js/Layouts/GuestLayout.vue">
<script setup>
import PublicLayout from '@/Layouts/PublicLayout.vue';
</script>

<template>
    <PublicLayout>
        <div class="min-h-[calc(100vh-140px)] flex flex-col justify-center items-center relative overflow-hidden py-12">
            <!-- Video Fondo -->
            <div class="absolute inset-0 z-0">
                <video autoplay loop muted playsinline class="w-full h-full object-cover">
                    <source src="/videos/mechanic-bg.mp4" type="video/mp4" />
                </video>
                <div class="absolute inset-0 bg-black/60"></div>
            </div>

            <!-- Tarjeta de Formulario -->
            <div
                class="relative z-10 w-full sm:max-w-md px-6 py-8 bg-white/10 backdrop-blur-xl border border-white/20 shadow-2xl rounded-2xl"
            >
                <!-- Slot para el formulario -->
                <slot />
            </div>
        </div>
    </PublicLayout>
</template>
</file>

<file path="resources/js/Pages/ClientScheduling/BookingIndex.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, useForm, router } from '@inertiajs/vue3';
import InputLabel from '@/Components/InputLabel.vue';
import InputError from '@/Components/InputError.vue';
import { ref, computed } from 'vue';

const props = defineProps({
    hasVehicles: Boolean,
    vehicles: Array,
    capacities: Array,
    currentYear: Number,
    currentMonth: Number,
    userReservations: Array,
});

const showBookingModal = ref(false);
const showCancelModal = ref(false);
const selectedDay = ref(null);
const reservationToCancel = ref(null);

// --- NUEVAS PROPIEDADES COMPUTADAS PARA SEPARAR RESERVAS ---
const upcomingReservations = computed(() => props.userReservations.filter((r) => r.status === 'Confirmada'));

const pastReservations = computed(() => props.userReservations.filter((r) => r.status !== 'Confirmada'));

// SOLO para UX - mostrar qué vehículos tienen reservas activas
const vehiclesWithActiveReservations = computed(() => {
    if (!props.userReservations || !props.vehicles) return new Set();
    // FILTRAR SOLO RESERVAS CONFIRMADAS
    const confirmedReservations = props.userReservations.filter((r) => r.status === 'Confirmada');
    return new Set(confirmedReservations.map((r) => r.vehicle_id));
});

// Función para formatear fechas de ISO a dd-mm-aaaa
const formatDisplayDate = (dateString) => {
    if (!dateString) return '';

    // Parsear directamente desde YYYY-MM-DD sin usar Date
    const [year, month, day] = dateString.split('-');
    return `${day}-${month}-${year}`;
};

// Función para formatear la fecha seleccionada en el modal
const formatSelectedDate = (dateString) => {
    if (!dateString) return '';

    try {
        // Parsear desde YYYY-MM-DD
        const [year, month, day] = dateString.split('-');
        const date = new Date(year, month - 1, day); // Crear fecha en hora local

        return date.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    } catch (error) {
        console.error('Error formateando fecha seleccionada:', error);
        return dateString;
    }
};

const form = useForm({
    vehicle_id: props.vehicles && props.vehicles.length > 0 ? props.vehicles[0].id : null,
    reservation_date: '',
    notes: '',
});

const monthNames = [
    'Enero',
    'Febrero',
    'Marzo',
    'Abril',
    'Mayo',
    'Junio',
    'Julio',
    'Agosto',
    'Septiembre',
    'Octubre',
    'Noviembre',
    'Diciembre',
];

const displayMonth = computed(() => monthNames[props.currentMonth - 1]);
const displayYear = computed(() => props.currentYear);

const daysInMonth = computed(() => new Date(props.currentYear, props.currentMonth, 0).getDate());
const firstDayOfMonth = computed(() => {
    const day = new Date(props.currentYear, props.currentMonth - 1, 1).getDay();
    return day === 0 ? 6 : day - 1;
});

// SOLO para UX - mostrar información visual
const getDayInfo = (day) => {
    const dateStr = `${props.currentYear}-${String(props.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    // Crear fecha local para comparación (sin problemas de timezone)
    const date = new Date(props.currentYear, props.currentMonth - 1, day);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Verificar si el usuario tiene reserva CONFIRMADA para este día - FILTRAR SOLO CONFIRMADAS
    const userReservationForThisDay = props.userReservations?.find((r) => {
        // Comparar directamente los strings YYYY-MM-DD y SOLO reservas confirmadas
        return r.reservation_date === dateStr && r.status === 'Confirmada';
    });

    if (userReservationForThisDay) {
        const vehicle = props.vehicles?.find((v) => v.id === userReservationForThisDay.vehicle_id);
        return {
            hasUserReservation: true,
            vehiclePatente: vehicle?.patente || '',
            isPast: false,
            capacity: null,
            reservationId: userReservationForThisDay.id,
            canCancel: userReservationForThisDay.can_cancel,
        };
    }

    // Verificar si es una fecha pasada
    if (date < today) {
        return {
            isPast: true,
            hasUserReservation: false,
            capacity: null,
        };
    }

    const capacity = props.capacities?.find((c) => c.date === dateStr);
    return {
        isPast: false,
        hasUserReservation: false,
        capacity: capacity || null,
    };
};

const openModal = (day) => {
    const dayInfo = getDayInfo(day);

    // SOLO verificación básica para UX
    if (dayInfo.isPast || dayInfo.hasUserReservation || !dayInfo.capacity || dayInfo.capacity.available_slots <= 0) {
        return;
    }

    const dateStr = `${props.currentYear}-${String(props.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    selectedDay.value = formatSelectedDate(dateStr);
    form.reservation_date = dateStr;

    showBookingModal.value = true;
};

const closeModal = () => {
    showBookingModal.value = false;
    form.reset();
    form.clearErrors();
};

const submit = () => {
    // El backend se encargará de TODA la validación de negocio
    form.post(route('cliente.reservations.store'), {
        onSuccess: () => {
            closeModal();
        },
        preserveState: false,
    });
};

// Funciones para cancelar reservas
const openCancelModal = (reservationId, event) => {
    if (event) {
        event.stopPropagation();
    }
    reservationToCancel.value = reservationId;
    showCancelModal.value = true;
};

const closeCancelModal = () => {
    showCancelModal.value = false;
    reservationToCancel.value = null;
};

const confirmCancel = () => {
    if (reservationToCancel.value) {
        router.delete(route('cliente.reservations.destroy', reservationToCancel.value), {
            preserveState: false,
            onSuccess: () => {
                closeCancelModal();
            },
        });
    }
};

const changeMonth = (offset) => {
    const newDate = new Date(props.currentYear, props.currentMonth - 1);
    newDate.setMonth(newDate.getMonth() + offset);

    router.get(
        route('cliente.reservations.index'),
        {
            year: newDate.getFullYear(),
            month: newDate.getMonth() + 1,
        },
        { preserveState: true, preserveScroll: true }
    );
};
</script>

<template>
    <Head title="Solicitar Reserva" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Solicitar Reserva de Cupo
                </h2>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
                <!-- CASO 1: USUARIO SIN VEHÍCULOS -->
                <div
                    v-if="!hasVehicles"
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8 text-center">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">¡Un paso más!</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">
                            Para poder solicitar una reserva, primero necesitas agregar al menos un vehículo a tu
                            perfil.
                        </p>
                        <Link
                            :href="route('cliente.vehiculos.create')"
                            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                        >
                            Agregar mi Primer Vehículo
                        </Link>
                    </div>
                </div>

                <!-- CASO 2: USUARIO CON VEHÍCULOS -->
                <div v-else class="space-y-6">
                    <!-- SECCIÓN DE PRÓXIMAS RESERVAS -->
                    <div
                        v-if="upcomingReservations.length > 0"
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-8">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Mis Próximas Reservas</h3>
                            <div class="space-y-4">
                                <div
                                    v-for="reservation in upcomingReservations"
                                    :key="reservation.id"
                                    class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl flex justify-between items-center"
                                >
                                    <div class="text-gray-700 dark:text-gray-300">
                                        <strong class="text-gray-900 dark:text-white">{{
                                            formatDisplayDate(reservation.reservation_date)
                                        }}</strong>
                                        -
                                        {{ vehicles.find((v) => v.id === reservation.vehicle_id)?.marca }}
                                        ({{ vehicles.find((v) => v.id === reservation.vehicle_id)?.patente }})
                                    </div>
                                    <button
                                        v-if="reservation.can_cancel"
                                        class="px-4 py-2 text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 border border-red-300 dark:border-red-600 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/30 transition-all duration-200 text-sm font-medium"
                                        title="Cancelar esta reserva"
                                        @click="openCancelModal(reservation.id, $event)"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN DEL CALENDARIO -->
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-8">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
                                Solicitar Nueva Reserva
                            </h3>

                            <div class="flex justify-between items-center mb-8">
                                <button
                                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                                    @click="changeMonth(-1)"
                                >
                                    &larr; Anterior
                                </button>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    {{ displayMonth }} {{ displayYear }}
                                </h3>
                                <button
                                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                                    @click="changeMonth(1)"
                                >
                                    Siguiente &rarr;
                                </button>
                            </div>
                            <div class="grid grid-cols-7 gap-3 text-center">
                                <div
                                    v-for="day in ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']"
                                    :key="day"
                                    class="font-bold text-sm text-gray-600 dark:text-gray-400 py-3"
                                >
                                    {{ day }}
                                </div>
                                <div v-for="blank in firstDayOfMonth" :key="`blank-${blank}`"></div>
                                <div
                                    v-for="day in daysInMonth"
                                    :key="day"
                                    :class="{
                                        'cursor-not-allowed bg-gray-100 dark:bg-gray-900 text-gray-400 dark:text-gray-600 border-gray-300 dark:border-gray-700':
                                            getDayInfo(day).isPast ||
                                            getDayInfo(day).hasUserReservation ||
                                            !getDayInfo(day).capacity ||
                                            getDayInfo(day).capacity.available_slots <= 0,
                                        'cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 border-gray-200 dark:border-gray-700':
                                            !getDayInfo(day).isPast &&
                                            !getDayInfo(day).hasUserReservation &&
                                            getDayInfo(day).capacity &&
                                            getDayInfo(day).capacity.available_slots > 0,
                                        'bg-blue-600 text-white cursor-default border-blue-500':
                                            getDayInfo(day).hasUserReservation,
                                    }"
                                    class="p-3 border rounded-xl min-h-[5rem] flex flex-col justify-between transition-all duration-200 bg-white dark:bg-gray-800"
                                    @click="openModal(day)"
                                >
                                    <div class="font-bold text-right text-gray-700 dark:text-white">{{ day }}</div>
                                    <div class="text-xs text-left">
                                        <div v-if="getDayInfo(day).hasUserReservation">
                                            <p class="font-bold">Mi Reserva</p>
                                            <p class="text-blue-200">{{ getDayInfo(day).vehiclePatente }}</p>
                                            <p v-if="getDayInfo(day).canCancel" class="text-blue-200 text-xs mt-1">
                                                ✔️ Cancelable
                                            </p>
                                            <p v-else class="text-blue-200 text-xs mt-1">⚠️ No cancelable</p>
                                        </div>
                                        <div v-else-if="!getDayInfo(day).isPast && getDayInfo(day).capacity">
                                            <p
                                                v-if="getDayInfo(day).capacity.available_slots > 5"
                                                class="font-bold text-green-600 dark:text-green-400"
                                            >
                                                Disponible
                                            </p>
                                            <p
                                                v-else-if="getDayInfo(day).capacity.available_slots > 0"
                                                class="font-bold text-orange-500 dark:text-orange-400"
                                            >
                                                Pocos Cupos
                                            </p>
                                            <p v-else class="font-bold text-red-500 dark:text-red-400">Completo</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN HISTORIAL DE RESERVAS -->
                    <div
                        v-if="pastReservations.length > 0"
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-8">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Historial de Reservas</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead
                                        class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                    >
                                        <tr>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Fecha</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Vehículo</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr
                                            v-for="reservation in pastReservations"
                                            :key="reservation.id"
                                            class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                        >
                                            <td
                                                class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap"
                                            >
                                                {{ formatDisplayDate(reservation.reservation_date) }}
                                            </td>
                                            <td class="px-6 py-4">
                                                {{ vehicles.find((v) => v.id === reservation.vehicle_id)?.marca }}
                                                {{ vehicles.find((v) => v.id === reservation.vehicle_id)?.modelo }}
                                                ({{ vehicles.find((v) => v.id === reservation.vehicle_id)?.patente }})
                                            </td>
                                            <td class="px-6 py-4">
                                                <span
                                                    class="px-3 py-1 text-xs font-semibold rounded-full"
                                                    :class="{
                                                        'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                                                            reservation.status === 'Asistió',
                                                        'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                                                            reservation.status === 'Cancelada',
                                                        'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300':
                                                            reservation.status === 'Ausente',
                                                    }"
                                                >
                                                    {{ reservation.status }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE RESERVA -->
        <div
            v-if="showBookingModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300"
            @click.self="closeModal"
        >
            <div
                class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-lg border border-gray-100 dark:border-gray-700 transition-colors duration-300"
            >
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                    Confirmar Reserva para el {{ selectedDay }}
                </h3>
                <form class="space-y-6" @submit.prevent="submit">
                    <div>
                        <InputLabel for="vehicle_id" value="¿Qué vehículo traerás?" />
                        <select
                            id="vehicle_id"
                            v-model="form.vehicle_id"
                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                            required
                        >
                            <!-- MOSTRAMOS TODOS los vehículos - el backend validará cuáles pueden reservar -->
                            <option v-for="vehicle in vehicles" :key="vehicle.id" :value="vehicle.id">
                                {{ vehicle.marca }} {{ vehicle.modelo }} ({{ vehicle.patente }})
                                <!-- SOLO mostrar "Ya tiene reserva activa" para reservas CONFIRMADAS -->
                                <span v-if="vehiclesWithActiveReservations.has(vehicle.id)">
                                    - Ya tiene reserva activa</span
                                >
                            </option>
                        </select>
                        <InputError class="mt-2" :message="form.errors.vehicle_id" />
                    </div>
                    <div>
                        <InputLabel for="notes" value="Notas Adicionales (Opcional)" />
                        <textarea
                            id="notes"
                            v-model="form.notes"
                            rows="4"
                            placeholder="Ej: Falla en el motor, ruido al frenar, etc."
                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600 transition-colors duration-200"
                        ></textarea>
                        <InputError class="mt-2" :message="form.errors.notes" />
                    </div>
                    <div
                        v-if="form.errors.reservation_date"
                        class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 rounded-xl"
                    >
                        {{ form.errors.reservation_date }}
                    </div>
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-100 dark:border-gray-700">
                        <button
                            type="button"
                            class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                            :disabled="form.processing"
                            @click="closeModal"
                        >
                            Cancelar
                        </button>
                        <button
                            type="submit"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 disabled:opacity-50"
                            :disabled="form.processing"
                        >
                            <span v-if="form.processing">Enviando...</span>
                            <span v-else>Confirmar Solicitud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN DE CANCELACIÓN -->
        <div
            v-if="showCancelModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300"
        >
            <div
                class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-gray-700 transition-colors duration-300"
            >
                <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-6">Confirmar Cancelación</h3>
                <p class="mb-4 text-gray-700 dark:text-gray-300">¿Estás seguro de que quieres cancelar esta reserva?</p>
                <p class="mb-6 text-sm text-gray-600 dark:text-gray-400">Esta acción no se puede deshacer.</p>
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-100 dark:border-gray-700">
                    <button
                        class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 shadow-sm"
                        @click="closeCancelModal"
                    >
                        Mantener Reserva
                    </button>
                    <button
                        class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200"
                        @click="confirmCancel"
                    >
                        Sí, Cancelar Reserva
                    </button>
                </div>
            </div>
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Inventory/Products/Index.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import SearchInput from '@/Components/SearchInput.vue';
import { ref } from 'vue';

defineProps({
    products: Object,
    filters: Object,
});

const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

// --- Lógica Modal de eliminación ---
const confirmingProductDeletion = ref(false);
const productToDelete = ref(null);
const confirmProductDeletion = (product) => {
    productToDelete.value = product;
    confirmingProductDeletion.value = true;
};
const deleteProduct = () => {
    router.delete(route('inventario.products.destroy', productToDelete.value.id), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};
const closeModal = () => {
    confirmingProductDeletion.value = false;
    productToDelete.value = null;
};

const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
</script>

<template>
    <Head title="Productos" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Gestión de Productos</h2>
                <Link
                    v-if="can('gestionar inventario')"
                    :href="route('inventario.products.create')"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 text-sm"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                        ></path>
                    </svg>
                    Nuevo Producto
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <!-- Barra de Búsqueda -->
                <div class="mb-6">
                    <SearchInput :model-value="filters.search" placeholder="Buscar por nombre, SKU..." />
                </div>

                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th class="px-6 py-4 font-bold tracking-wider">Producto</th>
                                        <th class="px-6 py-4 font-bold tracking-wider">Precio</th>
                                        <th class="px-6 py-4 font-bold tracking-wider">Stock</th>
                                        <th class="px-6 py-4 font-bold tracking-wider text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="product in products.data"
                                        :key="product.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                                    >
                                        <th class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-base font-semibold text-gray-900 dark:text-white">
                                                {{ product.name }}
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">
                                                {{ product.sku }}
                                            </div>
                                        </th>
                                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-gray-300">
                                            {{ formatCurrency(product.price) }}
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="font-bold"
                                                    :class="
                                                        product.current_stock <= product.min_threshold
                                                            ? 'text-red-600 dark:text-red-400'
                                                            : 'text-green-600 dark:text-green-400'
                                                    "
                                                >
                                                    {{ product.current_stock }}
                                                </span>
                                                <span
                                                    v-if="product.current_stock <= product.min_threshold"
                                                    class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 uppercase tracking-wide"
                                                    >Bajo</span
                                                >
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm font-medium">
                                            <Link
                                                v-if="can('gestionar inventario')"
                                                :href="route('inventario.products.edit', product.id)"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                >Editar</Link
                                            >
                                            <button
                                                v-if="can('gestionar inventario')"
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmProductDeletion(product)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="products.data.length === 0">
                                        <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            <p class="text-lg font-medium">No se encontraron productos.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div
                        v-if="products.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="products.links" />
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN PARA PRODUCTOS -->
        <ConfirmationModal
            :show="confirmingProductDeletion"
            title="Eliminar Producto"
            :message="`¿Estás seguro de que deseas eliminar el producto '${productToDelete?.name}'? Esta acción no se puede deshacer.`"
            @close="closeModal"
            @confirm="deleteProduct"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/Welcome.vue">
<script setup>
import { Head, Link } from '@inertiajs/vue3';
import PublicLayout from '@/Layouts/PublicLayout.vue';

defineProps({
    canLogin: Boolean,
    canRegister: Boolean,
});
</script>

<template>
    <Head title="Bienvenido" />

    <PublicLayout :can-login="canLogin" :can-register="canRegister">
        <!-- 1. HERO SECTION -->
        <div
            class="relative min-h-[calc(100vh-74px)] flex flex-col justify-center items-center text-center px-4 overflow-hidden pb-20"
        >
            <!-- Video de Fondo -->
            <div class="absolute inset-0 z-0">
                <video autoplay loop muted playsinline class="w-full h-full object-cover">
                    <source src="/videos/mechanic-bg.mp4" type="video/mp4" />
                </video>
                <!-- Overlay oscuro -->
                <div class="absolute inset-0 bg-black/60"></div>
            </div>

            <!-- Contenido del Hero -->
            <div class="relative z-10 max-w-4xl mx-auto mt-10">
                <!-- Logo del Taller -->
                <div class="mb-10 transform hover:scale-105 transition duration-700 ease-out inline-block">
                    <img
                        src="/images/logo-full.jpg"
                        alt="Flipper Servicios"
                        class="h-32 md:h-52 mx-auto rounded-3xl shadow-2xl border-4 border-white/10"
                    />
                </div>

                <h1 class="text-5xl md:text-7xl font-black text-white tracking-tight mb-6 drop-shadow-2xl">
                    Tu Taller,
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500"
                        >Evolucionado.</span
                    >
                </h1>

                <p class="text-xl text-gray-200 mb-12 max-w-2xl mx-auto leading-relaxed font-light drop-shadow-md">
                    Gestión inteligente de turnos, historial clínico de tu vehículo y alertas en tiempo real.
                    <span class="text-white font-medium">La confianza de siempre, ahora digital.</span>
                </p>

                <div class="flex flex-col sm:flex-row justify-center gap-5">
                    <Link
                        :href="route('register')"
                        class="px-8 py-4 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-xl hover:bg-blue-500 transition transform hover:-translate-y-1 w-full sm:w-auto"
                    >
                        Solicitar Turno Ahora
                    </Link>
                    <a
                        href="#servicios"
                        class="px-8 py-4 rounded-xl bg-white/10 backdrop-blur-md border border-white/30 text-white font-semibold text-lg hover:bg-white/20 transition w-full sm:w-auto"
                    >
                        Ver Servicios
                    </a>
                </div>
            </div>

            <!-- Indicador de Scroll (Flecha) -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 animate-bounce text-white/50">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7-7-7"></path>
                </svg>
            </div>
        </div>

        <!-- 2. SERVICIOS -->
        <section id="servicios" class="relative z-10 py-24 px-6 transition-colors duration-500">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <span class="text-cyan-600 dark:text-cyan-400 font-bold uppercase tracking-wider text-sm"
                        >¿Por qué elegirnos?</span
                    >
                    <h2 class="text-3xl md:text-4xl font-black mt-3 text-gray-900 dark:text-white">
                        Innovación al Servicio de tu Vehículo
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <!-- Card 1 -->
                    <div
                        class="p-8 rounded-[2rem] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-cyan-500 dark:hover:border-cyan-500 transition-all duration-300 hover:-translate-y-2 group shadow-lg hover:shadow-2xl dark:shadow-none"
                    >
                        <div
                            class="w-16 h-16 rounded-2xl bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center text-4xl mb-8 group-hover:rotate-6 transition duration-300"
                        >
                            📅
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Turnos Online 24/7</h3>
                        <p class="text-gray-600 dark:text-gray-400 leading-relaxed text-lg">
                            Reserva tu lugar desde tu celular en segundos, las 24hs. Sin llamadas, sin esperas.
                        </p>
                    </div>

                    <!-- Card 2 -->
                    <div
                        class="p-8 rounded-[2rem] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all duration-300 hover:-translate-y-2 group shadow-lg hover:shadow-2xl dark:shadow-none"
                    >
                        <div
                            class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-4xl mb-8 group-hover:rotate-6 transition duration-300"
                        >
                            🔧
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Historial Digital</h3>
                        <p class="text-gray-600 dark:text-gray-400 leading-relaxed text-lg">
                            Accede al historial completo de reparaciones y servicios de tu vehículo. Transparencia total
                            en cada servicio.
                        </p>
                    </div>

                    <!-- Card 3 -->
                    <div
                        class="p-8 rounded-[2rem] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-purple-500 dark:hover:border-purple-500 transition-all duration-300 hover:-translate-y-2 group shadow-lg hover:shadow-2xl dark:shadow-none"
                    >
                        <div
                            class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-4xl mb-8 group-hover:rotate-6 transition duration-300"
                        >
                            🔔
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Alertas en Vivo</h3>
                        <p class="text-gray-600 dark:text-gray-400 leading-relaxed text-lg">
                            Recibe notificaciones instantáneas cuando tu vehículo esté listo para retirar o necesite un
                            servicio.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </PublicLayout>
</template>
</file>

<file path="src/Crm/Http/Controllers/VehiculoController.php">
<?php

namespace FlipperBox\Crm\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\User;
use FlipperBox\Crm\Http\Requests\UpdateVehiculoRequest;
use FlipperBox\Crm\Models\Vehiculo;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class VehiculoController extends Controller
{
    /**
     * Muestra el formulario para crear un nuevo vehículo para un cliente (User).
     */
    public function create(User $user): Response
    {
        abort_if(! $user->hasRole('Cliente'), 404);

        return Inertia::render('Crm/Vehiculos/Create', [
            'cliente' => $user,
        ]);
    }

    /**
     * Almacena un nuevo vehículo y lo asocia a un cliente (User).
     */
    public function store(Request $request, User $user): RedirectResponse
    {
        abort_if(! $user->hasRole('Cliente'), 404);

        $validated = $request->validate([
            'patente' => ['required', 'string', 'max:255', 'unique:vehiculos,patente'],
            'marca' => ['required', 'string', 'max:255'],
            'modelo' => ['required', 'string', 'max:255'],
            'anio' => ['required', 'integer', 'min:1950', 'max:'.date('Y')],
            'kilometraje' => ['nullable', 'integer', 'min:0'],
            'vin' => ['nullable', 'string', 'max:255', 'unique:vehiculos,vin'],
            'numero_motor' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
        ]);

        // Creamos el vehículo a través de la relación definida en el modelo User
        $user->vehiculos()->create($validated);

        return to_route('clientes.show', $user->id)->with('success', 'Vehículo agregado exitosamente.');
    }

    /**
     * Muestra el formulario para editar un vehículo.
     * El Model-Route Binding se encarga de que $user y $vehiculo sean los correctos.
     */
    public function edit(User $user, Vehiculo $vehiculo): Response
    {
        abort_if(! $user->hasRole('Cliente'), 404);

        return Inertia::render('Crm/Vehiculos/Edit', [
            'cliente' => $user,
            'vehiculo' => $vehiculo,
        ]);
    }

    /**
     * Actualiza un vehículo existente.
     */
    public function update(UpdateVehiculoRequest $request, User $user, Vehiculo $vehiculo): RedirectResponse
    {
        $vehiculo->update($request->validated());

        return to_route('clientes.show', $user->id)->with('success', 'Vehículo actualizado exitosamente.');
    }

    /**
     * Elimina (Soft Delete) un vehículo.
     */
    public function destroy(User $user, Vehiculo $vehiculo): RedirectResponse
    {
        try {
            $vehiculo->delete();
        } catch (ValidationException $e) {
            return back()->with('error', $e->validator->errors()->first());
        }

        return to_route('clientes.show', $user->id)->with('success', 'Vehículo eliminado exitosamente.');
    }
}
</file>

<file path="src/Crm/Models/Vehiculo.php">
<?php

namespace FlipperBox\Crm\Models;

use App\Models\User;
use Database\Factories\VehiculoFactory;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\SoftDeletes;

class Vehiculo extends Model
{
    use HasFactory, SoftDeletes;

    protected $table = 'vehiculos';

    protected $fillable = [
        'cliente_id',
        'patente',
        'marca',
        'modelo',
        'anio',
        'kilometraje',
        'vin', // Número de chasis
        'numero_motor',
        'observaciones',
    ];

    /**
     * Define la relación: Un vehículo pertenece a un cliente.
     */
    public function cliente(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    /**
     * Crea una nueva instancia de la factory para el modelo.
     */
    protected static function newFactory()
    {
        return VehiculoFactory::new();
    }

    public function workOrders(): HasMany
    {
        return $this->hasMany(WorkOrder::class, 'vehicle_id');
    }
}
</file>

<file path="src/Inventory/Http/Controllers/SupplierController.php">
<?php

namespace FlipperBox\Inventory\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\Inventory\Http\Requests\StoreSupplierRequest;
use FlipperBox\Inventory\Http\Requests\UpdateSupplierRequest;
use FlipperBox\Inventory\Models\Supplier;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Inertia\Inertia;
use Inertia\Response;

class SupplierController extends Controller
{
    public function index(Request $request): Response
    {
        $query = Supplier::latest();

        if ($request->has('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('name', 'ilike', "%{$search}%")
                    ->orWhere('contact_person', 'ilike', "%{$search}%")
                    ->orWhere('email', 'ilike', "%{$search}%")
                    ->orWhere('phone', 'ilike', "%{$search}%");
            });
        }

        return Inertia::render('Inventory/Suppliers/Index', [
            'suppliers' => $query->paginate(10)->withQueryString(),
            'filters' => $request->only(['search']),
        ]);
    }

    public function create(): Response
    {
        return Inertia::render('Inventory/Suppliers/Create');
    }

    public function store(StoreSupplierRequest $request): RedirectResponse
    {
        Supplier::create($request->validated());

        return to_route('inventario.suppliers.index')->with('success', 'Proveedor creado exitosamente.');
    }

    public function edit(Supplier $supplier): Response
    {
        return Inertia::render('Inventory/Suppliers/Edit', [
            'supplier' => $supplier,
        ]);
    }

    public function update(UpdateSupplierRequest $request, Supplier $supplier): RedirectResponse
    {
        $supplier->update($request->validated());

        return to_route('inventario.suppliers.index')->with('success', 'Proveedor actualizado exitosamente.');
    }

    public function destroy(Supplier $supplier): RedirectResponse
    {
        $supplier->delete(); // Usamos Soft Delete

        return to_route('inventario.suppliers.index')->with('success', 'Proveedor eliminado exitosamente.');
    }
}
</file>

<file path="src/Inventory/routes/web.php">
<?php

use FlipperBox\Inventory\Http\Controllers\ProductController;
use FlipperBox\Inventory\Http\Controllers\SupplierController;
use Illuminate\Support\Facades\Route;

// Rutas para Productos
Route::middleware('can:ver inventario')->prefix('inventario')->name('inventario.')->group(function () {
    Route::get('/productos', [ProductController::class, 'index'])->name('products.index');

    Route::middleware('can:gestionar inventario')->group(function () {
        Route::get('/productos/crear', [ProductController::class, 'create'])->name('products.create');
        Route::post('/productos', [ProductController::class, 'store'])->name('products.store');
        Route::get('/productos/{product}/editar', [ProductController::class, 'edit'])->name('products.edit');
        Route::patch('/productos/{product}', [ProductController::class, 'update'])->name('products.update');
        Route::delete('/productos/{product}', [ProductController::class, 'destroy'])->name('products.destroy');
    });
});

// Rutas para Proveedores
Route::prefix('inventario')->name('inventario.')->group(function () {
    Route::get('/proveedores', [SupplierController::class, 'index'])->middleware('can:ver proveedores')->name('suppliers.index');

    Route::middleware('can:gestionar proveedores')->group(function () {
        Route::get('/proveedores/crear', [SupplierController::class, 'create'])->name('suppliers.create');
        Route::post('/proveedores', [SupplierController::class, 'store'])->name('suppliers.store');
        Route::get('/proveedores/{supplier}/editar', [SupplierController::class, 'edit'])->name('suppliers.edit');
        Route::patch('/proveedores/{supplier}', [SupplierController::class, 'update'])->name('suppliers.update');
        Route::delete('/proveedores/{supplier}', [SupplierController::class, 'destroy'])->name('suppliers.destroy');
    });
});
</file>

<file path="src/WorkManagement/routes/web.php">
<?php

use FlipperBox\WorkManagement\Http\Controllers\ServiceController;
use FlipperBox\WorkManagement\Http\Controllers\WorkOrderController;
use Illuminate\Support\Facades\Route;

// Rutas de órdenes de trabajo
Route::middleware('can:ver ordenes de trabajo')->prefix('ordenes-trabajo')->name('work-orders.')->group(function () {
    Route::get('/', [WorkOrderController::class, 'index'])->name('index');

    Route::middleware('can:gestionar ordenes de trabajo')->group(function () {
        Route::get('/crear/vehiculo/{vehiculo}', [WorkOrderController::class, 'create'])->name('create');
        Route::post('/', [WorkOrderController::class, 'store'])->name('store');
        Route::get('/{workOrder}', [WorkOrderController::class, 'show'])->name('show');
        Route::patch('/{workOrder}', [WorkOrderController::class, 'update'])->name('update');
        Route::delete('/{workOrder}', [WorkOrderController::class, 'destroy'])->name('destroy');

        // Rutas para gestionar los ítems de una orden de trabajo
        Route::post('/{workOrder}/products', [WorkOrderController::class, 'addProduct'])->name('products.add');
        Route::delete('/{workOrder}/products/{product}', [WorkOrderController::class, 'removeProduct'])->name('products.remove');

        Route::post('/{workOrder}/services', [WorkOrderController::class, 'addService'])->name('services.add');
        Route::delete('/{workOrder}/services/{service}', [WorkOrderController::class, 'removeService'])->name('services.remove');

        Route::post('/{workOrder}/external-costs', [WorkOrderController::class, 'addExternalCost'])->name('external-costs.add');
        Route::delete('/external-costs/{externalCost}', [WorkOrderController::class, 'removeExternalCost'])->name('external-costs.remove');

        Route::patch('/{workOrder}/assign-mechanic', [WorkOrderController::class, 'assignMechanic'])->name('assign-mechanic');
    });
});

// --- RUTAS PARA GESTIÓN DE SERVICIOS ---
Route::middleware('can:ver servicios')->group(function () {
    Route::get('/servicios', [ServiceController::class, 'index'])->name('services.index');

    Route::middleware('can:gestionar servicios')->group(function () {
        Route::get('/servicios/crear', [ServiceController::class, 'create'])->name('services.create');
        Route::post('/servicios', [ServiceController::class, 'store'])->name('services.store');
        Route::get('/servicios/{service}/editar', [ServiceController::class, 'edit'])->name('services.edit');
        Route::patch('/servicios/{service}', [ServiceController::class, 'update'])->name('services.update');
        Route::delete('/servicios/{service}', [ServiceController::class, 'destroy'])->name('services.destroy');
    });
});
</file>

<file path="app/Http/Controllers/Auth/RegisteredUserController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Auth\Events\Registered;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules;
use Inertia\Inertia;
use Inertia\Response;
use Spatie\Permission\Models\Role;

class RegisteredUserController extends Controller
{
    /**
     * Display the registration view.
     */
    public function create(): Response
    {
        return Inertia::render('Auth/Register');
    }

    /**
     * Handle an incoming registration request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'name' => 'required|string|max:255',
            'apellido' => 'required|string|max:255',
            'email' => 'required|string|lowercase|email|max:255|unique:'.User::class,
            'telefono' => 'required|string|max:20|unique:'.User::class,
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
        ]);

        $user = User::create([
            'name' => $request->name,
            'apellido' => $request->apellido,
            'email' => $request->email,
            'telefono' => $request->telefono,
            'password' => Hash::make($request->password),
        ]);

        $clienteRole = Role::findByName('Cliente');
        $user->assignRole($clienteRole);

        event(new Registered($user));
        Auth::login($user);

        // Redirección correcta al dashboard del cliente
        return redirect(route('cliente.dashboard'));
    }
}
</file>

<file path="bootstrap/app.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        commands: __DIR__.'/../routes/console.php',
        channels: __DIR__.'/../routes/channels.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {

        $middleware->trustProxies(at: '*');

        $middleware->web(append: [
            \App\Http\Middleware\HandleInertiaRequests::class,
        ]);

        $middleware->alias([
            'role' => \Spatie\Permission\Middleware\RoleMiddleware::class,
            'permission' => \Spatie\Permission\Middleware\PermissionMiddleware::class,
            'role_or_permission' => \Spatie\Permission\Middleware\RoleOrPermissionMiddleware::class,
        ]);
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })->create();
</file>

<file path="resources/js/Pages/Crm/Clientes/Show.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import { ref } from 'vue';

const props = defineProps({
    cliente: {
        type: Object,
        required: true,
    },
});

const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

const confirmingVehicleDeletion = ref(false);
const vehicleToDelete = ref(null);

const confirmVehicleDeletion = (vehiculo) => {
    vehicleToDelete.value = vehiculo;
    confirmingVehicleDeletion.value = true;
};

const deleteVehicle = () => {
    router.delete(route('clientes.vehiculos.destroy', { user: props.cliente.id, vehiculo: vehicleToDelete.value.id }), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};

const closeModal = () => {
    confirmingVehicleDeletion.value = false;
    vehicleToDelete.value = null;
};
</script>

<template>
    <Head :title="`Cliente: ${cliente.name} ${cliente.apellido}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Detalle del Cliente</h2>
                <Link
                    :href="route('clientes.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
                <!-- Sección de Datos del Cliente -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <section>
                            <header>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                                    {{ cliente.name }} {{ cliente.apellido }}
                                </h2>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                    Información de contacto y personal del cliente.
                                </p>
                            </header>
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <span class="font-bold text-gray-700 dark:text-gray-300">Email:</span>
                                    <span class="ml-2 text-gray-900 dark:text-white">{{
                                        cliente.email || 'No especificado'
                                    }}</span>
                                </div>
                                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <span class="font-bold text-gray-700 dark:text-gray-300">Teléfono:</span>
                                    <span class="ml-2 text-gray-900 dark:text-white">{{
                                        cliente.telefono || 'No especificado'
                                    }}</span>
                                </div>
                                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <span class="font-bold text-gray-700 dark:text-gray-300">Documento:</span>
                                    <span class="ml-2 text-gray-900 dark:text-white">
                                        <span v-if="cliente.documento_valor" class="flex items-center gap-2">
                                            <span
                                                class="text-xs font-bold uppercase bg-gray-100 dark:bg-gray-600 px-2 py-0.5 rounded text-gray-500 dark:text-gray-400"
                                            >
                                                {{ cliente.documento_tipo || 'DNI' }}
                                            </span>
                                            {{ cliente.documento_valor }}
                                        </span>
                                        <span v-else class="text-gray-400 italic">No especificado</span>
                                    </span>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Sección de Vehículos Asociados -->
                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-8">
                        <section>
                            <header class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                                        Vehículos Registrados
                                    </h2>
                                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                        Listado de vehículos asociados a este cliente.
                                    </p>
                                </div>
                                <Link
                                    v-if="can('crear vehiculos')"
                                    :href="route('clientes.vehiculos.create', { user: cliente.id })"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 flex items-center gap-2"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 4v16m8-8H4"
                                        ></path>
                                    </svg>
                                    Agregar Vehículo
                                </Link>
                            </header>
                            <div class="mt-6 overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead
                                        class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                    >
                                        <tr>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Patente</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Marca</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Modelo</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider">Año</th>
                                            <th scope="col" class="px-6 py-4 font-bold tracking-wider text-right">
                                                Acciones
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr
                                            v-for="vehiculo in cliente.vehiculos"
                                            :key="vehiculo.id"
                                            class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                        >
                                            <th
                                                scope="row"
                                                class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap"
                                            >
                                                {{ vehiculo.patente }}
                                            </th>
                                            <td class="px-6 py-4">{{ vehiculo.marca }}</td>
                                            <td class="px-6 py-4">{{ vehiculo.modelo }}</td>
                                            <td class="px-6 py-4">{{ vehiculo.anio }}</td>
                                            <td class="px-6 py-4 text-right whitespace-nowrap text-sm font-medium">
                                                <Link
                                                    :href="route('work-orders.create', { vehiculo: vehiculo.id })"
                                                    class="text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300 mr-4 transition"
                                                    >Crear OT</Link
                                                >
                                                <Link
                                                    v-if="can('editar vehiculos')"
                                                    :href="
                                                        route('clientes.vehiculos.edit', {
                                                            user: cliente.id,
                                                            vehiculo: vehiculo.id,
                                                        })
                                                    "
                                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                    >Editar</Link
                                                >
                                                <button
                                                    v-if="can('eliminar vehiculos')"
                                                    class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                    @click="confirmVehicleDeletion(vehiculo)"
                                                >
                                                    Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="cliente.vehiculos.length === 0">
                                            <td
                                                colspan="5"
                                                class="px-6 py-12 text-center text-gray-500 dark:text-gray-400"
                                            >
                                                <div class="flex flex-col items-center justify-center">
                                                    <svg
                                                        class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-3"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                                        ></path>
                                                    </svg>
                                                    <p class="text-lg font-medium">
                                                        Este cliente no tiene vehículos registrados.
                                                    </p>
                                                    <p class="text-sm">Agrega un vehículo para comenzar.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN PARA VEHÍCULOS -->
        <ConfirmationModal
            :show="confirmingVehicleDeletion"
            title="Eliminar Vehículo"
            :message="`¿Estás seguro de que deseas eliminar el vehículo con patente ${vehicleToDelete?.patente}? Esta acción no se puede deshacer.`"
            @close="closeModal"
            @confirm="deleteVehicle"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Index.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import SearchInput from '@/Components/SearchInput.vue';
import { ref } from 'vue';

defineProps({ workOrders: Object, filters: Object });
const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

const statusClass = (status) => ({
    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300 border border-yellow-200 dark:border-yellow-800':
        status === 'Pendiente',
    'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 border border-blue-200 dark:border-blue-800':
        status === 'En Progreso',
    'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border border-green-200 dark:border-green-800':
        status === 'Completada',
    'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 border border-red-200 dark:border-red-800':
        status === 'Cancelada',
});

const formatDate = (dateString) =>
    new Date(dateString).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });

// Lógica Modal (igual que antes)
const confirmingOrderDeletion = ref(false);
const orderToDelete = ref(null);
const confirmOrderDeletion = (o) => {
    orderToDelete.value = o;
    confirmingOrderDeletion.value = true;
};
const deleteOrder = () => {
    router.delete(route('work-orders.destroy', orderToDelete.value.id), { onSuccess: () => closeModal() });
};
const closeModal = () => {
    confirmingOrderDeletion.value = false;
    orderToDelete.value = null;
};
</script>

<template>
    <Head title="Órdenes de Trabajo" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Órdenes de Trabajo</h2>
                <p v-if="can('gestionar ordenes de trabajo')" class="text-sm text-gray-500 dark:text-gray-400">
                    Para crear una orden, ve al detalle del cliente.
                </p>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="mb-6">
                    <SearchInput :model-value="filters.search" placeholder="Buscar por ID, patente, cliente..." />
                </div>

                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors"
                >
                    <div class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th class="px-6 py-4 font-bold">ID</th>
                                        <th class="px-6 py-4 font-bold">Vehículo</th>
                                        <th class="px-6 py-4 font-bold">Cliente</th>
                                        <th class="px-6 py-4 font-bold">Estado</th>
                                        <th class="px-6 py-4 font-bold">Fecha</th>
                                        <th class="px-6 py-4 font-bold text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="workOrder in workOrders.data"
                                        :key="workOrder.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                                    >
                                        <th class="px-6 py-4 font-mono font-bold text-gray-900 dark:text-white">
                                            #{{ workOrder.id }}
                                        </th>
                                        <td class="px-6 py-4 text-gray-600 dark:text-gray-300 font-medium">
                                            {{ workOrder.vehicle.patente }}
                                            <span
                                                v-if="workOrder.vehicle.deleted_at"
                                                class="ml-2 text-[10px] uppercase bg-red-100 text-red-600 px-2 py-0.5 rounded-full border border-red-200"
                                                >Archivado</span
                                            >
                                        </td>
                                        <td class="px-6 py-4 text-gray-600 dark:text-gray-300">
                                            {{ workOrder.vehicle.cliente.name }}
                                            {{ workOrder.vehicle.cliente.apellido }}
                                        </td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="px-3 py-1 font-bold text-[10px] uppercase tracking-wider rounded-full"
                                                :class="statusClass(workOrder.status)"
                                            >
                                                {{ workOrder.status }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-gray-500 dark:text-gray-400">
                                            {{ formatDate(workOrder.entry_date) }}
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm font-medium">
                                            <Link
                                                :href="route('work-orders.show', workOrder.id)"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                >Ver Detalle</Link
                                            >
                                            <button
                                                v-if="
                                                    can('gestionar ordenes de trabajo') &&
                                                    workOrder.status !== 'Completada'
                                                "
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmOrderDeletion(workOrder)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="workOrders.data.length === 0">
                                        <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            No se encontraron órdenes.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div
                        v-if="workOrders.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="workOrders.links" />
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal de Confirmación -->
        <ConfirmationModal
            :show="confirmingOrderDeletion"
            title="Eliminar Orden de Trabajo"
            :message="`¿Estás seguro de que deseas eliminar la orden #${orderToDelete?.id}? Si se utilizaron productos, el stock será devuelto. Esta acción no se puede deshacer.`"
            @close="closeModal"
            @confirm="deleteOrder"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="resources/js/Pages/WorkManagement/Show.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, useForm, usePage, router } from '@inertiajs/vue3';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import { ref, computed } from 'vue';

// --- PROPS ---
const props = defineProps({
    workOrder: Object,
    products: Array, // Catálogo de productos disponibles
    services: Array, // Catálogo de servicios disponibles
    mechanics: Array, // Lista de mecánicos disponibles
});

// --- COMPUTED PROPERTIES ---
// Propiedad computada para determinar si la orden está finalizada (no se puede editar)
const isFinalized = computed(() => props.workOrder.status === 'Completada' || props.workOrder.status === 'Cancelada');

// --- HELPERS ---
const can = (permission) => usePage().props.auth.user.permissions.includes(permission);
const formatDate = (dateString) =>
    new Date(dateString).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });

// --- FORMULARIOS ---
const addProductForm = useForm({ product_id: null, quantity: 1 });
const addServiceForm = useForm({ service_id: null });
const addExternalCostForm = useForm({ description: '', cost: 0, price: 0 });
const assignMechanicForm = useForm({ mechanic_id: props.workOrder.mechanic?.id || null });

// --- FUNCIONES DE SUBMIT (CON RECARGA DE DATOS PARA SOLUCIONAR BUG DE RENDERIZADO) ---
const submitProduct = () =>
    addProductForm.post(route('work-orders.products.add', props.workOrder.id), {
        preserveScroll: true,
        onSuccess: () => {
            addProductForm.reset();
            router.reload({ only: ['workOrder'] });
        },
    });
const submitService = () =>
    addServiceForm.post(route('work-orders.services.add', props.workOrder.id), {
        preserveScroll: true,
        onSuccess: () => {
            addServiceForm.reset();
            router.reload({ only: ['workOrder'] });
        },
    });
const submitExternalCost = () =>
    addExternalCostForm.post(route('work-orders.external-costs.add', props.workOrder.id), {
        preserveScroll: true,
        onSuccess: () => {
            addExternalCostForm.reset();
            router.reload({ only: ['workOrder'] });
        },
    });
const submitMechanicAssignment = () =>
    assignMechanicForm.patch(route('work-orders.assign-mechanic', props.workOrder.id), {
        preserveState: true,
        preserveScroll: true,
    });

// --- LÓGICA PARA MODALES DE CONFIRMACIÓN ---
const confirmingAction = ref(false);
const actionToConfirm = ref({}); // Objeto para guardar la configuración completa del modal

// Función genérica para abrir el modal con una configuración específica
const setupConfirmation = (config) => {
    actionToConfirm.value = config;
    confirmingAction.value = true;
};

const confirmItemDeletion = (item, type) => {
    let routeName = '';
    let params = {};
    let itemName = '';

    if (type === 'product') {
        routeName = 'work-orders.products.remove';
        params = { workOrder: props.workOrder.id, product: item.id };
        itemName = item.name;
    } else if (type === 'service') {
        routeName = 'work-orders.services.remove';
        params = { workOrder: props.workOrder.id, service: item.id };
        itemName = item.name;
    } else if (type === 'externalCost') {
        routeName = 'work-orders.external-costs.remove';
        params = { externalCost: item.id };
        itemName = item.description;
    }

    setupConfirmation({
        title: 'Quitar Ítem',
        message: `¿Estás seguro de que deseas quitar "${itemName}" de la orden de trabajo?`,
        confirmButtonText: 'Sí, Quitar',
        confirmButtonClass: 'bg-red-600 hover:bg-red-700',
        method: () =>
            router.delete(route(routeName, params), {
                onSuccess: () => closeModal(),
                preserveScroll: true,
            }),
    });
};

const confirmStatusChange = (status) => {
    let config = {};
    if (status === 'Completada') {
        config = {
            title: 'Completar Orden de Trabajo',
            message:
                '¿Estás seguro de que deseas marcar esta orden como "Completada"? Ya no podrás realizar modificaciones.',
            confirmButtonText: 'Sí, Completar',
            confirmButtonClass: 'bg-green-600 hover:bg-green-700',
        };
    } else if (status === 'Cancelada') {
        config = {
            title: 'Cancelar Orden de Trabajo',
            message:
                '¿Estás seguro de que deseas cancelar esta orden? Si se utilizaron productos del inventario, el stock será devuelto.',
            confirmButtonText: 'Sí, Cancelar Orden',
            confirmButtonClass: 'bg-orange-600 hover:bg-orange-700',
        };
    }

    config.method = () =>
        router.patch(
            route('work-orders.update', props.workOrder.id),
            { status: status },
            {
                onSuccess: () => closeModal(),
                preserveScroll: true,
            }
        );

    setupConfirmation(config);
};

const closeModal = () => (confirmingAction.value = false);
</script>

<template>
    <Head :title="`Orden de Trabajo #${workOrder.id}`" />

    <AuthenticatedLayout>
        <template #header>
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">
                    Detalle de Orden de Trabajo #{{ workOrder.id }}
                </h2>
                <Link
                    :href="route('work-orders.index')"
                    class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 underline transition"
                >
                    &larr; Volver al listado
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna Izquierda: Detalles e Items -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Mensaje de Advertencia si está Finalizada -->
                    <div
                        v-if="isFinalized"
                        class="p-4 rounded-xl border transition-colors duration-300"
                        :class="
                            workOrder.status === 'Completada'
                                ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-300'
                                : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-300'
                        "
                    >
                        <p class="font-bold">
                            Esta orden de trabajo está {{ workOrder.status.toLowerCase() }} y ya no puede ser
                            modificada.
                        </p>
                    </div>

                    <!-- Productos del Inventario -->
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Productos del Inventario</h3>
                        </div>
                        <div class="p-6">
                            <form
                                v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                class="flex gap-4 items-end mb-6"
                                @submit.prevent="submitProduct"
                            >
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                        >Producto</label
                                    >
                                    <select
                                        v-model="addProductForm.product_id"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                    >
                                        <option :value="null" disabled>Selecciona un producto</option>
                                        <option v-for="product in products" :key="product.id" :value="product.id">
                                            {{ product.name }} (Stock: {{ product.current_stock }})
                                        </option>
                                    </select>
                                    <div
                                        v-if="addProductForm.errors.product_id"
                                        class="text-sm text-red-600 dark:text-red-400 mt-1"
                                    >
                                        {{ addProductForm.errors.product_id }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                        >Cantidad</label
                                    >
                                    <input
                                        v-model="addProductForm.quantity"
                                        type="number"
                                        class="mt-1 block w-24 border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                    />
                                    <div
                                        v-if="addProductForm.errors.quantity"
                                        class="text-sm text-red-600 dark:text-red-400 mt-1"
                                    >
                                        {{ addProductForm.errors.quantity }}
                                    </div>
                                </div>
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 text-sm"
                                    :disabled="addProductForm.processing"
                                >
                                    Agregar
                                </button>
                            </form>
                            <table
                                v-if="workOrder.products && workOrder.products.length > 0"
                                class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
                            >
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider">Producto</th>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider text-center">
                                            Cantidad
                                        </th>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider text-right">Total</th>
                                        <th
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            scope="col"
                                            class="px-6 py-3 font-bold tracking-wider text-right"
                                        >
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="product in workOrder.products"
                                        :key="`prod-${product.id}`"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                            {{ product.name }}
                                            <span
                                                v-if="product.deleted_at"
                                                class="ml-2 text-xs text-red-500 bg-red-100 dark:bg-red-900/30 px-2 py-1 rounded-full"
                                                >Archivado</span
                                            >
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            {{ product.pivot.quantity }} x ${{ product.pivot.unit_price }}
                                        </td>
                                        <td class="px-6 py-4 text-right font-bold text-gray-900 dark:text-white">
                                            ${{ (product.pivot.quantity * product.pivot.unit_price).toFixed(2) }}
                                        </td>
                                        <td
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            class="px-6 py-4 text-right"
                                        >
                                            <button
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition text-sm"
                                                @click="confirmItemDeletion(product, 'product')"
                                            >
                                                Quitar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p v-else class="text-sm text-gray-500 dark:text-gray-400 italic">
                                No hay productos agregados a esta orden.
                            </p>
                        </div>
                    </div>

                    <!-- Servicios (Mano de Obra) -->
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Servicios (Mano de Obra)</h3>
                        </div>
                        <div class="p-6">
                            <form
                                v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                class="flex gap-4 items-end mb-6"
                                @submit.prevent="submitService"
                            >
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                        >Servicio</label
                                    >
                                    <select
                                        v-model="addServiceForm.service_id"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                    >
                                        <option :value="null" disabled>Selecciona un servicio</option>
                                        <option v-for="service in services" :key="service.id" :value="service.id">
                                            {{ service.name }}
                                        </option>
                                    </select>
                                </div>
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 text-sm"
                                    :disabled="addServiceForm.processing"
                                >
                                    Agregar
                                </button>
                            </form>
                            <table
                                v-if="workOrder.services && workOrder.services.length > 0"
                                class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
                            >
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider">Servicio</th>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider text-right">
                                            Precio
                                        </th>
                                        <th
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            scope="col"
                                            class="px-6 py-3 font-bold tracking-wider text-right"
                                        >
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="service in workOrder.services"
                                        :key="`serv-${service.id}`"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                            {{ service.name }}
                                        </td>
                                        <td class="px-6 py-4 text-right font-bold text-gray-900 dark:text-white">
                                            ${{ service.pivot.price }}
                                        </td>
                                        <td
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            class="px-6 py-4 text-right"
                                        >
                                            <button
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition text-sm"
                                                @click="confirmItemDeletion(service, 'service')"
                                            >
                                                Quitar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p v-else class="text-sm text-gray-500 dark:text-gray-400 italic">
                                No hay servicios agregados a esta orden.
                            </p>
                        </div>
                    </div>

                    <!-- Costos Externos -->
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Costos Externos</h3>
                        </div>
                        <div class="p-6">
                            <form
                                v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                class="space-y-4 mb-6"
                                @submit.prevent="submitExternalCost"
                            >
                                <div>
                                    <label
                                        for="ext-desc"
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                        >Descripción</label
                                    >
                                    <input
                                        id="ext-desc"
                                        v-model="addExternalCostForm.description"
                                        type="text"
                                        placeholder="Ej: Repuesto comprado por fuera"
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                        required
                                    />
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            for="ext-cost"
                                            class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                            >Costo ($)</label
                                        >
                                        <input
                                            id="ext-cost"
                                            v-model="addExternalCostForm.cost"
                                            type="number"
                                            step="0.01"
                                            placeholder="Lo que costó"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label
                                            for="ext-price"
                                            class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                                            >Precio Venta ($)</label
                                        >
                                        <input
                                            id="ext-price"
                                            v-model="addExternalCostForm.price"
                                            type="number"
                                            step="0.01"
                                            placeholder="A cobrar al cliente"
                                            class="mt-1 block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                            required
                                        />
                                    </div>
                                </div>
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 w-full text-sm"
                                    :disabled="addExternalCostForm.processing"
                                >
                                    Agregar Costo Externo
                                </button>
                            </form>
                            <table
                                v-if="workOrder.external_costs && workOrder.external_costs.length > 0"
                                class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
                            >
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider">Descripción</th>
                                        <th scope="col" class="px-6 py-3 font-bold tracking-wider text-right">
                                            Precio
                                        </th>
                                        <th
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            scope="col"
                                            class="px-6 py-3 font-bold tracking-wider text-right"
                                        >
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="cost in workOrder.external_costs"
                                        :key="`ext-${cost.id}`"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                            {{ cost.description }}
                                        </td>
                                        <td class="px-6 py-4 text-right font-bold text-gray-900 dark:text-white">
                                            ${{ cost.price }}
                                        </td>
                                        <td
                                            v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                                            class="px-6 py-4 text-right"
                                        >
                                            <button
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition text-sm"
                                                @click="confirmItemDeletion(cost, 'externalCost')"
                                            >
                                                Quitar
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p v-else class="text-sm text-gray-500 dark:text-gray-400 italic">
                                No hay costos externos agregados a esta orden.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Estado y Total -->
                <div class="lg:col-span-1 space-y-6">
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Detalles de la Orden</h3>
                            <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                                <p>
                                    <strong class="text-gray-900 dark:text-white">Cliente:</strong>
                                    {{ workOrder.vehicle.cliente.name }}
                                    {{ workOrder.vehicle.cliente.apellido }}
                                </p>
                                <p>
                                    <strong class="text-gray-900 dark:text-white">Vehículo:</strong>
                                    {{ workOrder.vehicle.marca }} {{ workOrder.vehicle.modelo }} ({{
                                        workOrder.vehicle.patente
                                    }})
                                </p>
                                <p>
                                    <strong class="text-gray-900 dark:text-white">Fecha Ingreso:</strong>
                                    {{ formatDate(workOrder.entry_date) }}
                                </p>
                                <p>
                                    <strong class="text-gray-900 dark:text-white">Descripción:</strong>
                                    {{ workOrder.description }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Asignar Mecánico</h3>
                            <form @submit.prevent="submitMechanicAssignment">
                                <select
                                    v-model="assignMechanicForm.mechanic_id"
                                    class="block w-full border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md shadow-sm text-sm focus:border-indigo-500 dark:focus:border-indigo-600 focus:ring-indigo-500 dark:focus:ring-indigo-600"
                                    @change="submitMechanicAssignment"
                                >
                                    <option :value="null">Sin asignar</option>
                                    <option v-for="mechanic in mechanics" :key="mechanic.id" :value="mechanic.id">
                                        {{ mechanic.name }}
                                    </option>
                                </select>
                            </form>
                            <p class="text-sm mt-4">
                                <strong class="text-gray-900 dark:text-white">Estado Actual: </strong
                                ><span
                                    class="px-3 py-1 font-semibold leading-tight text-xs rounded-full"
                                    :class="{
                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300':
                                            workOrder.status === 'Pendiente',
                                        'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300':
                                            workOrder.status === 'En Progreso',
                                        'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                                            workOrder.status === 'Completada',
                                        'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                                            workOrder.status === 'Cancelada',
                                    }"
                                    >{{ workOrder.status }}</span
                                >
                            </p>
                        </div>
                    </div>
                    <!-- Panel de Acciones de la Orden -->
                    <div
                        v-if="!isFinalized && can('gestionar ordenes de trabajo')"
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Acciones de la Orden</h3>
                            <div class="space-y-3">
                                <button
                                    class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-md transition-all duration-200 text-sm"
                                    @click="confirmStatusChange('Completada')"
                                >
                                    Marcar como Completada
                                </button>
                                <button
                                    class="w-full px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-xl shadow-md transition-all duration-200 text-sm"
                                    @click="confirmStatusChange('Cancelada')"
                                >
                                    Marcar como Cancelada
                                </button>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                    >
                        <div class="p-6 text-center">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Total de la Orden</h3>
                            <p class="text-3xl font-extrabold text-gray-900 dark:text-white mt-2">
                                ${{ parseFloat(workOrder.total || 0).toFixed(2) }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <ConfirmationModal
            :show="confirmingAction"
            :title="actionToConfirm.title"
            :message="actionToConfirm.message"
            :confirm-button-text="actionToConfirm.confirmButtonText"
            :confirm-button-class="actionToConfirm.confirmButtonClass"
            @close="closeModal"
            @confirm="actionToConfirm.method"
        />
    </AuthenticatedLayout>
</template>
</file>

<file path="app/Http/Middleware/HandleInertiaRequests.php">
<?php

namespace App\Http\Middleware;

use Illuminate\Http\Request;
use Inertia\Middleware;

class HandleInertiaRequests extends Middleware
{
    /**
     * The root template that is loaded on the first page visit.
     *
     * @var string
     */
    protected $rootView = 'app';

    /**
     * Determine the current asset version.
     */
    public function version(Request $request): ?string
    {
        return parent::version($request);
    }

    /**
     * Define the props that are shared by default.
     *
     * @return array<string, mixed>
     */
    public function share(Request $request): array
    {
        return [
            // Heredamos cualquier prop compartida por el middleware padre.
            ...parent::share($request),

            // Compartimos la información de autenticación de forma "lazy" (diferida).
            // El código dentro de la función solo se ejecutará si el frontend lo necesita.
            'auth' => function () use ($request) {
                return [
                    'user' => $request->user() ? [
                        'id' => $request->user()->id,
                        'name' => $request->user()->name,
                        'email' => $request->user()->email,
                        // Los permisos solo se calculan si el usuario existe.
                        'permissions' => $request->user()->getAllPermissions()->pluck('name'),
                    ] : null,
                ];
            },

            // Compartimos los mensajes flash también de forma "lazy".
            'flash' => [
                'success' => fn () => $request->session()->get('success'),
                'error' => fn () => $request->session()->get('error'),
            ],
            // Comparte las notificaciones en cada petición si el usuario está logueado.
            'notifications' => $request->user()
                ? $request->user()->notifications()->limit(5)->get()
                : [],
        ];
    }
}
</file>

<file path="config/app.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application, which will be used when the
    | framework needs to place the application's name in a notification or
    | other UI elements where an application name needs to be displayed.
    |
    */

    'name' => env('APP_NAME', 'Laravel'),

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services the application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => (bool) env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | the application so that it's available within Artisan commands.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. The timezone
    | is set to "UTC" by default as it is suitable for most use cases.
    |
    */

    'timezone' => 'America/Argentina/Buenos_Aires',

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by Laravel's translation / localization methods. This option can be
    | set to any locale for which you plan to have translation strings.
    |
    */

    'locale' => env('APP_LOCALE', 'en'),

    'fallback_locale' => env('APP_FALLBACK_LOCALE', 'en'),

    'faker_locale' => env('APP_FAKER_LOCALE', 'en_US'),

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is utilized by Laravel's encryption services and should be set
    | to a random, 32 character string to ensure that all encrypted values
    | are secure. You should do this prior to deploying the application.
    |
    */

    'cipher' => 'AES-256-CBC',

    'key' => env('APP_KEY'),

    'previous_keys' => [
        ...array_filter(
            explode(',', (string) env('APP_PREVIOUS_KEYS', ''))
        ),
    ],

    /*
    |--------------------------------------------------------------------------
    | Maintenance Mode Driver
    |--------------------------------------------------------------------------
    |
    | These configuration options determine the driver used to determine and
    | manage Laravel's "maintenance mode" status. The "cache" driver will
    | allow maintenance mode to be controlled across multiple machines.
    |
    | Supported drivers: "file", "cache"
    |
    */

    'maintenance' => [
        'driver' => env('APP_MAINTENANCE_DRIVER', 'file'),
        'store' => env('APP_MAINTENANCE_STORE', 'database'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Autoloaded Service Providers
    |--------------------------------------------------------------------------
    |
    | The service providers listed here will be automatically loaded on the
    | request to your application. Feel free to add your own services to
    | this array to grant expanded functionality to your applications.
    |
    */

    'providers' => [

        /*
         * Laravel Framework Service Providers...
         */
        Illuminate\Auth\AuthServiceProvider::class,
        Illuminate\Broadcasting\BroadcastServiceProvider::class,
        Illuminate\Bus\BusServiceProvider::class,
        Illuminate\Cache\CacheServiceProvider::class,
        Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,
        Illuminate\Cookie\CookieServiceProvider::class,
        Illuminate\Database\DatabaseServiceProvider::class,
        Illuminate\Encryption\EncryptionServiceProvider::class,
        Illuminate\Filesystem\FilesystemServiceProvider::class,
        Illuminate\Foundation\Providers\FoundationServiceProvider::class,
        Illuminate\Hashing\HashServiceProvider::class,
        Illuminate\Mail\MailServiceProvider::class,
        Illuminate\Notifications\NotificationServiceProvider::class,
        Illuminate\Pagination\PaginationServiceProvider::class,
        Illuminate\Pipeline\PipelineServiceProvider::class,
        Illuminate\Queue\QueueServiceProvider::class,
        Illuminate\Redis\RedisServiceProvider::class,
        Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
        Illuminate\Session\SessionServiceProvider::class,
        Illuminate\Translation\TranslationServiceProvider::class,
        Illuminate\Validation\ValidationServiceProvider::class,
        Illuminate\View\ViewServiceProvider::class,

        /*
         * Package Service Providers...
         */

        /*
         * Application Service Providers...
         */
        App\Providers\AppServiceProvider::class,
        // App\Providers\AuthServiceProvider::class,
        // App\Providers\BroadcastServiceProvider::class,
        // App\Providers\EventServiceProvider::class,
        // App\Providers\RouteServiceProvider::class,

        /*
         * Módulos de la Aplicación FlipperBox
         */
        // FlipperBox\Core\Providers\CoreServiceProvider::class,
        // FlipperBox\Crm\Providers\CrmServiceProvider::class,
        // FlipperBox\MechanicPanel\Providers\MechanicPanelServiceProvider::class,

    ],

];
</file>

<file path="src/ClientScheduling/Http/Controllers/BookingController.php">
<?php

namespace FlipperBox\ClientScheduling\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Mail\ReservationConfirmed;
use App\Models\User;
use App\Notifications\ReservationCreated;
use Carbon\Carbon;
use FlipperBox\Scheduling\Models\DailyCapacity;
use FlipperBox\Scheduling\Models\Reservation;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Mail;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class BookingController extends Controller
{
    public function index(Request $request): Response
    {
        /** @var \App\Models\User $user */
        $user = Auth::user();
        $user->load('vehiculos');

        if ($user->vehiculos->isEmpty()) {
            return Inertia::render('ClientScheduling/BookingIndex', [
                'hasVehicles' => false,
                'capacities' => [],
                'userReservations' => [],
                'currentYear' => now()->year,
                'currentMonth' => now()->month,
            ]);
        }

        $year = $request->input('year', now()->year);
        $month = $request->input('month', now()->month);

        $capacities = DailyCapacity::whereYear('date', $year)
            ->whereMonth('date', $month)
            ->where('date', '>=', today())
            ->orderBy('date')
            ->get()
            ->map(fn ($capacity) => [
                'date' => $capacity->date->format('Y-m-d'),
                'available_slots' => $capacity->total_slots - $capacity->booked_slots,
            ]);

        $userReservations = Reservation::where('user_id', $user->id)
            ->orderBy('reservation_date', 'desc')
            ->get()
            ->map(function ($reservation) {
                $reservationDate = Carbon::parse($reservation->reservation_date)->startOfDay();
                $now = Carbon::now()->startOfDay();
                $hoursDifference = $now->diffInHours($reservationDate, false);

                return [
                    'id' => $reservation->id,
                    'reservation_date' => $reservation->reservation_date->format('Y-m-d'),
                    'vehicle_id' => $reservation->vehicle_id,
                    'status' => $reservation->status,
                    'can_cancel' => $hoursDifference > 24 && $reservation->status === 'Confirmada',
                    'hours_until_reservation' => $hoursDifference,
                ];
            });

        return Inertia::render('ClientScheduling/BookingIndex', [
            'hasVehicles' => true,
            'vehicles' => $user->vehiculos,
            'capacities' => $capacities,
            'currentYear' => (int) $year,
            'currentMonth' => (int) $month,
            'userReservations' => $userReservations,
        ]);
    }

    public function store(Request $request): RedirectResponse
    {
        $validated = $request->validate([
            'vehicle_id' => ['required', 'exists:vehiculos,id'],
            'reservation_date' => ['required', 'date', 'after_or_equal:today'],
            'notes' => ['nullable', 'string', 'max:1000'],
        ]);

        /** @var \App\Models\User $user */
        $user = Auth::user();

        // Verificar que el vehículo pertenece al usuario
        if (! $user->vehiculos()->where('id', $validated['vehicle_id'])->exists()) {
            return back()->with('error', 'El vehículo seleccionado no es válido.');
        }

        // Verificar que el usuario no tenga ya una reserva confirmada para esta fecha
        $alreadyBookedOnDate = Reservation::where('user_id', $user->id)
            ->where('reservation_date', $validated['reservation_date'])
            ->where('status', 'Confirmada')
            ->exists();

        if ($alreadyBookedOnDate) {
            throw ValidationException::withMessages([
                'reservation_date' => 'Ya tienes una reserva confirmada para este día.',
            ]);
        }

        // Solo verificar reservas del MISMO vehículo en la MISMA fecha
        $hasActiveReservationForVehicleOnThisDate = Reservation::where('vehicle_id', $validated['vehicle_id'])
            ->where('reservation_date', $validated['reservation_date'])
            ->where('status', 'Confirmada')
            ->exists();

        if ($hasActiveReservationForVehicleOnThisDate) {
            throw ValidationException::withMessages([
                'vehicle_id' => 'Este vehículo ya tiene una reserva confirmada para esta fecha específica.',
            ]);
        }

        $reservation = DB::transaction(function () use ($validated, $user) {
            $capacity = DailyCapacity::where('date', $validated['reservation_date'])->lockForUpdate()->first();

            if (! $capacity || $capacity->booked_slots >= $capacity->total_slots) {
                throw ValidationException::withMessages([
                    'reservation_date' => 'No hay cupos disponibles para la fecha seleccionada.',
                ]);
            }

            // Creamos la reserva y la guardamos en una variable
            $newReservation = Reservation::create([
                'user_id' => $user->id,
                'vehicle_id' => $validated['vehicle_id'],
                'reservation_date' => $validated['reservation_date'],
                'notes' => $validated['notes'],
                'status' => 'Confirmada',
            ]);

            $capacity->increment('booked_slots');

            return $newReservation; // Devolvemos la reserva creada desde la transacción
        });

        // --- NUEVO SISTEMA DE NOTIFICACIONES ---
        // 1. Buscamos a los usuarios que tienen permiso de ver reservas (Admins)
        $admins = User::permission('gestionar reservas')->get();

        // 2. Enviamos la notificación (esto guardará en DB y enviará por Reverb)
        foreach ($admins as $admin) {
            $admin->notify(new ReservationCreated($reservation));
        }

        // 3. Enviar Email al Cliente (NUEVO CÓDIGO)
        Mail::to($user)->send(new ReservationConfirmed($reservation));

        return back()->with('success', '¡Tu reserva ha sido confirmada! Te esperamos.');
    }

    public function destroy(Reservation $reservation): RedirectResponse
    {
        /** @var \App\Models\User $user */
        $user = Auth::user();

        if ($reservation->user_id !== $user->id) {
            return back()->with('error', 'No tienes permiso para cancelar esta reserva.');
        }

        if ($reservation->status !== 'Confirmada') {
            return back()->with('error', 'Esta reserva no se puede cancelar.');
        }

        $reservationDate = Carbon::parse($reservation->reservation_date);
        $now = Carbon::now();
        $hoursDifference = $now->diffInHours($reservationDate, false);

        if ($hoursDifference <= 24) {
            return back()->with('error', 'Solo puedes cancelar reservas con más de 24 horas de anticipación.');
        }

        DB::transaction(function () use ($reservation) {
            $reservation->update(['status' => 'Cancelada']);

            $capacity = DailyCapacity::where('date', $reservation->reservation_date)->first();
            if ($capacity && $capacity->booked_slots > 0) {
                $capacity->decrement('booked_slots');
            }
        });

        return back()->with('success', 'Reserva cancelada exitosamente.');
    }
}
</file>

<file path="src/WorkManagement/Http/Controllers/WorkOrderController.php">
<?php

namespace FlipperBox\WorkManagement\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\User;
use FlipperBox\Crm\Models\Vehiculo;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\WorkManagement\Models\ExternalCost;
use FlipperBox\WorkManagement\Models\Service;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Validation\Rule;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class WorkOrderController extends Controller
{
    public function index(Request $request): Response
    {
        $query = WorkOrder::with(['vehicle.cliente', 'mechanic'])->latest('entry_date');

        // Lógica de Búsqueda
        if ($request->has('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('id', 'like', "%{$search}%")
                    ->orWhere('description', 'ilike', "%{$search}%")
                    ->orWhereHas('vehicle', function ($q) use ($search) {
                        $q->where('patente', 'ilike', "%{$search}%")
                            ->orWhere('marca', 'ilike', "%{$search}%")
                            ->orWhere('modelo', 'ilike', "%{$search}%");
                    })
                    ->orWhereHas('vehicle.cliente', function ($q) use ($search) {
                        $q->where('name', 'ilike', "%{$search}%")
                            ->orWhere('apellido', 'ilike', "%{$search}%");
                    });
            });
        }

        return Inertia::render('WorkManagement/Index', [
            'workOrders' => $query->paginate(15)->withQueryString(),
            'filters' => $request->only(['search']),
        ]);
    }

    public function create(Vehiculo $vehiculo): Response
    {
        // La relación 'cliente' ahora es 'user'
        return Inertia::render('WorkManagement/Create', ['vehiculo' => $vehiculo->load('cliente')]);
    }

    public function store(Request $request): RedirectResponse
    {
        $validated = $request->validate(['vehicle_id' => ['required', 'exists:vehiculos,id'], 'description' => ['required', 'string']]);
        $workOrder = WorkOrder::create($validated);

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Orden de Trabajo creada exitosamente.');
    }

    public function show(WorkOrder $workOrder): Response
    {
        $workOrder->load(['vehicle.cliente', 'mechanic', 'products', 'services', 'externalCosts']);
        $mechanics = User::role('Mecanico')->orderBy('name')->get(['id', 'name']);

        return Inertia::render('WorkManagement/Show', [
            'workOrder' => $workOrder,
            'products' => Product::orderBy('name')->get(['id', 'name', 'price', 'current_stock']),
            'services' => Service::orderBy('name')->get(['id', 'name', 'price']),
            'mechanics' => $mechanics,
        ]);
    }

    /**
     * Actualiza el estado de una Orden de Trabajo.
     */
    public function update(Request $request, WorkOrder $workOrder): RedirectResponse
    {
        $validated = $request->validate([
            'status' => ['required', Rule::in(['En Progreso', 'Completada', 'Cancelada'])],
        ]);

        if ($workOrder->status === 'Completada' && $validated['status'] !== 'Cancelada') {
            return back()->with('error', 'Una orden completada solo puede ser cancelada.');
        }

        $originalStatus = $workOrder->status;
        $workOrder->status = $validated['status'];

        if ($validated['status'] === 'Completada') {
            $workOrder->completion_date = now();
        }

        // Si se cancela una orden que tenía productos, el Observer se encargará de devolver el stock.
        if ($originalStatus !== 'Cancelada' && $validated['status'] === 'Cancelada') {
            // La lógica de devolución de stock se ha movido al WorkOrderObserver en el evento 'updating'.
            // Aquí solo guardamos el cambio de estado.
        }

        $workOrder->save();

        return back()->with('success', 'Estado de la orden actualizado.');
    }

    /**
     * Elimina (Soft Delete) una Orden de Trabajo.
     */
    public function destroy(WorkOrder $workOrder): RedirectResponse
    {
        if ($workOrder->status === 'Completada') {
            return to_route('work-orders.index')->with('error', 'No se puede eliminar una orden de trabajo completada.');
        }

        $workOrder->delete(); // El Observer se encargará de devolver el stock

        return to_route('work-orders.index')->with('success', 'Orden de trabajo eliminada exitosamente.');
    }

    // --- MÉTODOS PARA AÑADIR ÍTEMS ---
    public function addProduct(Request $request, WorkOrder $workOrder): RedirectResponse
    {
        $validated = $request->validate(['product_id' => ['required', 'exists:products,id'], 'quantity' => ['required', 'integer', 'min:1']]);
        DB::transaction(function () use ($validated, $workOrder) {
            $product = Product::lockForUpdate()->find($validated['product_id']);
            if ($product->current_stock < $validated['quantity']) {
                throw ValidationException::withMessages(['quantity' => 'Stock insuficiente. Stock actual: '.$product->current_stock]);
            }
            $product->decrement('current_stock', $validated['quantity']);
            $existingProduct = $workOrder->products()->where('product_id', $product->id)->first();
            if ($existingProduct) {
                $newQuantity = $existingProduct->pivot->quantity + $validated['quantity'];
                $workOrder->products()->updateExistingPivot($product->id, ['quantity' => $newQuantity]);
            } else {
                $workOrder->products()->attach($product->id, ['quantity' => $validated['quantity'], 'unit_price' => $product->price]);
            }
            $this->recalculateTotal($workOrder);
        });

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Producto agregado.');
    }

    public function addService(Request $request, WorkOrder $workOrder): RedirectResponse
    {
        $validated = $request->validate(['service_id' => ['required', 'exists:services,id']]);
        $service = Service::find($validated['service_id']);
        if (! $workOrder->services()->where('service_id', $service->id)->exists()) {
            $workOrder->services()->attach($service->id, ['price' => $service->price]);
            $this->recalculateTotal($workOrder);
        }

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Servicio agregado.');
    }

    public function addExternalCost(Request $request, WorkOrder $workOrder): RedirectResponse
    {
        $validated = $request->validate([
            'description' => ['required', 'string', 'max:255'],
            'cost' => ['required', 'numeric', 'min:0'],
            'price' => ['required', 'numeric', 'min:0'],
        ]);
        $workOrder->externalCosts()->create($validated);
        $workOrder->load('externalCosts');
        $this->recalculateTotal($workOrder);

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Costo externo agregado.');
    }

    // --- MÉTODO PARA ASIGNAR MECÁNICO ---
    public function assignMechanic(Request $request, WorkOrder $workOrder): RedirectResponse
    {
        $validated = $request->validate(['mechanic_id' => ['nullable', 'exists:users,id']]);
        $workOrder->update([
            'mechanic_id' => $validated['mechanic_id'],
            'status' => $workOrder->status === 'Pendiente' && $validated['mechanic_id'] ? 'En Progreso' : $workOrder->status,
        ]);

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Mecánico asignado/actualizado.');
    }

    // --- MÉTODOS PARA ELIMINAR ÍTEMS ---
    public function removeProduct(WorkOrder $workOrder, Product $product): RedirectResponse
    {
        DB::transaction(function () use ($workOrder, $product) {
            $pivot = DB::table('work_order_product')->where('work_order_id', $workOrder->id)->where('product_id', $product->id)->first();
            if ($pivot) {
                $productToUpdate = Product::lockForUpdate()->find($product->id);
                $productToUpdate->increment('current_stock', $pivot->quantity);
                $workOrder->products()->detach($product->id);
                $this->recalculateTotal($workOrder);
            }
        });

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Producto eliminado de la orden.');
    }

    public function removeService(WorkOrder $workOrder, Service $service): RedirectResponse
    {
        $workOrder->services()->detach($service->id);
        $this->recalculateTotal($workOrder);

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Servicio eliminado de la orden.');
    }

    public function removeExternalCost(ExternalCost $externalCost): RedirectResponse
    {
        $workOrder = $externalCost->workOrder;
        $externalCost->delete();
        $workOrder->load('externalCosts');
        $this->recalculateTotal($workOrder);

        return to_route('work-orders.show', $workOrder->id)->with('success', 'Costo externo eliminado de la orden.');
    }

    // --- MÉTODO PRIVADO PARA RECALCULAR TOTALES ---
    private function recalculateTotal(WorkOrder $workOrder)
    {
        $workOrder->load(['products', 'services', 'externalCosts']);
        $totalProducts = $workOrder->products->sum(fn ($p) => $p->pivot->unit_price * $p->pivot->quantity);
        $totalServices = $workOrder->services->sum('pivot.price');
        $totalExternalCosts = $workOrder->externalCosts->sum('price');
        $workOrder->total = $totalProducts + $totalServices + $totalExternalCosts;
        $workOrder->save();
    }
}
</file>

<file path="package.json">
{
  "$schema": "https://json.schemastore.org/package.json",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite",
    "format": "prettier --write \"resources/js/**/*.{js,vue}\"",
    "lint": "eslint \"resources/js/**/*.{js,vue}\" --fix",
    "prepare": "husky"
  },
  "devDependencies": {
    "@inertiajs/vue3": "^2.0.0",
    "@laravel/echo-vue": "^2.2.6",
    "@tailwindcss/forms": "^0.5.3",
    "@tailwindcss/vite": "^4.0.0",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.12",
    "axios": "^1.11.0",
    "concurrently": "^9.0.1",
    "eslint": "^9.39.1",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-prettier": "^5.5.4",
    "eslint-plugin-vue": "^10.5.1",
    "globals": "^16.5.0",
    "husky": "^9.1.7",
    "laravel-echo": "^2.2.6",
    "laravel-vite-plugin": "^2.0.0",
    "lint-staged": "^16.2.7",
    "lodash": "^4.17.21",
    "postcss": "^8.4.31",
    "prettier": "^3.6.2",
    "pusher-js": "^8.4.0",
    "tailwindcss": "^3.2.1",
    "vite": "^7.0.7",
    "vue": "^3.4.0"
  },
  "dependencies": {
    "chart.js": "^4.5.1",
    "vue-chartjs": "^5.3.3"
  },
  "lint-staged": {
    "**/*.{js,vue}": [
      "prettier --write",
      "eslint --fix"
    ],
    "**/*.php": [
      "php vendor/bin/pint"
    ]
  }
}
</file>

<file path="src/Inventory/Http/Controllers/ProductController.php">
<?php

namespace FlipperBox\Inventory\Http\Controllers;

use App\Http\Controllers\Controller;
use FlipperBox\Inventory\Actions\ActualizarProductoAction;
use FlipperBox\Inventory\Actions\CrearNuevoProductoAction;
use FlipperBox\Inventory\Http\Requests\StoreProductRequest;
use FlipperBox\Inventory\Http\Requests\UpdateProductRequest;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\Inventory\Models\Supplier;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Inertia\Response;

class ProductController extends Controller
{
    public function index(Request $request): Response
    {
        $query = Product::with('suppliers')->latest();

        if ($request->has('search')) {
            $search = $request->input('search');
            $query->where(function ($q) use ($search) {
                $q->where('name', 'ilike', "%{$search}%")
                    ->orWhere('sku', 'ilike', "%{$search}%")
                    ->orWhere('description', 'ilike', "%{$search}%");
            });
        }

        return Inertia::render('Inventory/Products/Index', [
            'products' => $query->paginate(10)->withQueryString(),
            'filters' => $request->only(['search']),
        ]);
    }

    public function create(): Response
    {
        return Inertia::render('Inventory/Products/Create', [
            'suppliers' => Supplier::orderBy('name')->get(['id', 'name']),
        ]);
    }

    public function store(StoreProductRequest $request, CrearNuevoProductoAction $crearNuevoProducto): RedirectResponse
    {
        $crearNuevoProducto->execute($request->validated());

        return to_route('inventario.products.index')->with('success', 'Producto creado exitosamente.');
    }

    public function edit(Product $product): Response
    {
        // Cargamos la relación para saber qué proveedor tiene asociado
        $product->load('suppliers');

        return Inertia::render('Inventory/Products/Edit', [
            'product' => $product,
            'suppliers' => Supplier::orderBy('name')->get(['id', 'name']),
        ]);
    }

    public function update(UpdateProductRequest $request, Product $product, ActualizarProductoAction $actualizarProducto): RedirectResponse
    {
        $actualizarProducto->execute($product, $request->validated());

        return to_route('inventario.products.index')->with('success', 'Producto actualizado exitosamente.');
    }

    public function destroy(Product $product): RedirectResponse
    {
        try {
            // Esto disparará el Observer. Si falla, el catch lo manejará.
            $product->delete();
        } catch (ValidationException $e) {
            return back()->with('error', $e->validator->errors()->first('error'));
        }

        return to_route('inventario.products.index')->with('success', 'Producto eliminado exitosamente.');
    }
}
</file>

<file path="src/Core/routes/web.php">
<?php

use App\Http\Controllers\ProfileController;
use FlipperBox\Core\Http\Controllers\ChatbotController;
use FlipperBox\Core\Http\Controllers\DashboardController;
use Illuminate\Foundation\Application;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use Inertia\Inertia;

/*
|--------------------------------------------------------------------------
| Rutas del Módulo Core
|--------------------------------------------------------------------------
|
| Este archivo contiene las rutas fundamentales de la aplicación, como la
| página de bienvenida, el dashboard principal y la gestión de perfiles.
| Todas estas rutas se cargan a través del CoreServiceProvider.
|
*/

// --- Ruta de Bienvenida (Pública) ---
Route::get('/', function () {
    return Inertia::render('Welcome', [
        'canLogin' => Route::has('login'),
        'canRegister' => Route::has('register'),
        'laravelVersion' => Application::VERSION,
        'phpVersion' => PHP_VERSION,
    ]);
});

// --- RUTA DEL DASHBOARD PRINCIPAL ---
Route::get('/dashboard', [DashboardController::class, 'index'])
    ->middleware(['auth', 'verified', 'role:Admin'])
    ->name('dashboard');

// --- Rutas de Gestión de Perfil (Accesible para cualquier usuario autenticado) ---
Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
});

Route::post('/notifications/mark-as-read', function (Request $request) {
    $request->user()->unreadNotifications->markAsRead();

    return back();
})->middleware('auth')->name('notifications.markAsRead');

// Rutas del Chatbot (Públicas)
Route::post('/chatbot/ask', [ChatbotController::class, 'handle'])->name('chatbot.ask');
Route::post('/chatbot/clear-history', [ChatbotController::class, 'clearHistory'])->name('chatbot.clear-history');

// --- Inclusión de las Rutas de Autenticación (Login, Registro, etc.) ---
require __DIR__.'/../../../routes/auth.php';
</file>

<file path="src/Crm/routes/web.php">
<?php

use FlipperBox\Crm\Http\Controllers\CrmController;
use FlipperBox\Crm\Http\Controllers\VehiculoController;
use Illuminate\Support\Facades\Route;

Route::middleware(['auth', 'verified'])->group(function () {
    // Rutas de Clientes (gestionan el modelo User)
    Route::get('/clientes', [CrmController::class, 'index'])->middleware('can:ver clientes')->name('clientes.index');
    Route::get('/clientes/crear', [CrmController::class, 'create'])->middleware('can:crear clientes')->name('clientes.create');
    Route::post('/clientes', [CrmController::class, 'store'])->middleware('can:crear clientes')->name('clientes.store');
    Route::get('/clientes/{user}', [CrmController::class, 'show'])->middleware('can:ver clientes')->name('clientes.show');
    Route::get('/clientes/{user}/editar', [CrmController::class, 'edit'])->middleware('can:editar clientes')->name('clientes.edit');
    Route::patch('/clientes/{user}', [CrmController::class, 'update'])->middleware('can:editar clientes')->name('clientes.update');
    Route::delete('/clientes/{user}', [CrmController::class, 'destroy'])->middleware('can:eliminar clientes')->name('clientes.destroy');

    // Rutas Anidadas para Vehículos (refactorizadas)
    Route::prefix('/clientes/{user}/vehiculos')->name('clientes.vehiculos.')->group(function () {
        Route::get('/crear', [VehiculoController::class, 'create'])->middleware('can:crear vehiculos')->name('create');
        Route::post('/', [VehiculoController::class, 'store'])->middleware('can:crear vehiculos')->name('store');
        Route::get('/{vehiculo}/editar', [VehiculoController::class, 'edit'])->middleware('can:editar vehiculos')->name('edit');
        Route::patch('/{vehiculo}', [VehiculoController::class, 'update'])->middleware('can:editar vehiculos')->name('update');
        Route::delete('/{vehiculo}', [VehiculoController::class, 'destroy'])->middleware('can:eliminar vehiculos')->name('destroy');
    });
});
</file>

<file path="resources/js/Pages/Crm/Clientes/Index.vue">
<script setup>
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { Head, Link, usePage, router } from '@inertiajs/vue3';
import Pagination from '@/Components/Pagination.vue';
import ConfirmationModal from '@/Components/ConfirmationModal.vue';
import SearchInput from '@/Components/SearchInput.vue';
import { ref } from 'vue';

defineProps({
    clientes: {
        type: Object,
        required: true,
    },
    filters: {
        type: Object,
        default: () => ({}),
    },
});

const can = (permission) => usePage().props.auth.user.permissions.includes(permission);

// --- Lógica de Eliminación ---
const confirmingClientDeletion = ref(false);
const clientToDelete = ref(null);

const confirmClientDeletion = (cliente) => {
    clientToDelete.value = cliente;
    confirmingClientDeletion.value = true;
};

const deleteClient = () => {
    router.delete(route('clientes.destroy', { user: clientToDelete.value.id }), {
        onSuccess: () => closeModal(),
        preserveScroll: true,
    });
};

const closeModal = () => {
    confirmingClientDeletion.value = false;
    clientToDelete.value = null;
};

// --- Lógica de WhatsApp ---
const getWhatsAppLink = (phone) => {
    if (!phone) return '#';
    const cleanNumber = phone.replace(/\D/g, '');
    return `https://wa.me/549${cleanNumber}`;
};
</script>

<template>
    <Head title="Clientes" />
    <AuthenticatedLayout>
        <template #header>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-2xl text-gray-800 dark:text-white leading-tight">Gestión de Clientes</h2>
                <Link
                    v-if="can('crear clientes')"
                    :href="route('clientes.create')"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 text-sm"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Nuevo Cliente
                </Link>
            </div>
        </template>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <!-- Barra de Herramientas (Búsqueda) -->
                <div class="mb-6 w-full">
                    <div class="w-full max-w-full">
                        <SearchInput :model-value="filters.search" placeholder="Buscar por nombre, DNI, email..." />
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 overflow-hidden shadow-xl sm:rounded-2xl border border-gray-100 dark:border-gray-700 transition-colors duration-300"
                >
                    <div class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700"
                                >
                                    <tr>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Cliente</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Contacto</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider">Documento</th>
                                        <th scope="col" class="px-6 py-4 font-bold tracking-wider text-right">
                                            Acciones
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr
                                        v-for="cliente in clientes.data"
                                        :key="cliente.id"
                                        class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150"
                                    >
                                        <!-- Nombre y Avatar -->
                                        <th scope="row" class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div
                                                    class="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold text-lg mr-3"
                                                >
                                                    {{ cliente.name.charAt(0) }}
                                                </div>
                                                <div>
                                                    <Link
                                                        :href="route('clientes.show', { user: cliente.id })"
                                                        class="text-base font-semibold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition"
                                                    >
                                                        {{ cliente.name }} {{ cliente.apellido }}
                                                    </Link>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                                        {{ cliente.email }}
                                                    </div>
                                                </div>
                                            </div>
                                        </th>

                                        <!-- Contacto con WhatsApp -->
                                        <td class="px-6 py-4">
                                            <div class="flex flex-col">
                                                <a
                                                    v-if="cliente.telefono"
                                                    :href="getWhatsAppLink(cliente.telefono)"
                                                    target="_blank"
                                                    class="flex items-center text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 font-medium transition gap-1"
                                                    title="Enviar mensaje por WhatsApp"
                                                >
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                        <path
                                                            d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.876 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"
                                                        />
                                                    </svg>
                                                    {{ cliente.telefono }}
                                                </a>
                                                <span v-else class="text-gray-400 italic text-xs">Sin teléfono</span>
                                            </div>
                                        </td>

                                        <td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">
                                            <div v-if="cliente.documento_valor">
                                                <span
                                                    class="text-xs font-bold uppercase bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 dark:text-gray-400 mr-1"
                                                    >{{ cliente.documento_tipo || 'DNI' }}</span
                                                >
                                                {{ cliente.documento_valor }}
                                            </div>
                                            <span v-else class="text-gray-400 italic text-xs">-</span>
                                        </td>

                                        <td class="px-6 py-4 text-right whitespace-nowrap text-sm font-medium">
                                            <Link
                                                v-if="can('editar clientes')"
                                                :href="route('clientes.edit', { user: cliente.id })"
                                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-4 transition"
                                                >Editar</Link
                                            >
                                            <button
                                                v-if="can('eliminar clientes')"
                                                class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition"
                                                @click="confirmClientDeletion(cliente)"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>

                                    <!-- Empty State -->
                                    <tr v-if="clientes.data.length === 0">
                                        <td colspan="4" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            <div class="flex flex-col items-center justify-center">
                                                <svg
                                                    class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-3"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                                    ></path>
                                                </svg>
                                                <p class="text-lg font-medium">No se encontraron clientes.</p>
                                                <p class="text-sm">Intenta ajustar tu búsqueda o agrega uno nuevo.</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Paginación -->
                    <div
                        v-if="clientes.links.length > 3"
                        class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
                    >
                        <Pagination :links="clientes.links" />
                    </div>
                </div>
            </div>

            <!-- MODAL DE CONFIRMACIÓN -->
            <ConfirmationModal
                :show="confirmingClientDeletion"
                title="Eliminar Cliente"
                :message="`¿Estás seguro de que deseas eliminar a ${clientToDelete?.name} ${clientToDelete?.apellido}? Esta acción no se puede deshacer.`"
                @close="closeModal"
                @confirm="deleteClient"
            />
        </div>
    </AuthenticatedLayout>
</template>
</file>

<file path="composer.json">
{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^8.2",
        "inertiajs/inertia-laravel": "^2.0",
        "laravel/framework": "^12.0",
        "laravel/reverb": "^1.0",
        "laravel/sanctum": "^4.0",
        "laravel/tinker": "^2.10.1",
        "spatie/laravel-permission": "^6.22",
        "tightenco/ziggy": "^2.0"
    },
    "require-dev": {
        "fakerphp/faker": "^1.23",
        "laravel-lang/common": "^6.7",
        "laravel/breeze": "^2.3",
        "laravel/pail": "^1.2.2",
        "laravel/pint": "^1.24",
        "laravel/sail": "^1.41",
        "mockery/mockery": "^1.6",
        "nunomaduro/collision": "^8.6",
        "phpunit/phpunit": "^11.5.3"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "FlipperBox\\Core\\": "src/Core/",
            "FlipperBox\\Crm\\": "src/Crm/",
            "FlipperBox\\MechanicPanel\\": "src/MechanicPanel/",
            "FlipperBox\\ClientPortal\\": "src/ClientPortal/",
            "FlipperBox\\Inventory\\": "src/Inventory/",
            "FlipperBox\\WorkManagement\\": "src/WorkManagement/",
            "FlipperBox\\Scheduling\\": "src/Scheduling/",
            "FlipperBox\\ClientScheduling\\": "src/ClientScheduling/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "setup": [
            "composer install",
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\"",
            "@php artisan key:generate",
            "@php artisan migrate --force",
            "npm install",
            "npm run build"
        ],
        "dev": [
            "Composer\\Config::disableProcessTimeout",
            "npx concurrently -c \"#93c5fd,#c4b5fd,#fb7185,#fdba74\" \"php artisan serve\" \"php artisan queue:listen --tries=1\" \"php artisan pail --timeout=0\" \"npm run dev\" --names=server,queue,logs,vite --kill-others"
        ],
        "test": [
            "@php artisan config:clear --ansi",
            "@php artisan test"
        ],
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "pre-package-uninstall": [
            "Illuminate\\Foundation\\ComposerScripts::prePackageUninstall"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
</file>

<file path="bootstrap/providers.php">
<?php

return [
    App\Providers\AppServiceProvider::class,
    App\Providers\PolicyServiceProvider::class,
    App\Providers\BroadcastServiceProvider::class,
    FlipperBox\ClientScheduling\Providers\ClientSchedulingServiceProvider::class,
    FlipperBox\ClientPortal\Providers\ClientPortalServiceProvider::class,
    FlipperBox\Core\Providers\CoreServiceProvider::class,
    FlipperBox\Crm\Providers\CrmServiceProvider::class,
    FlipperBox\Inventory\Providers\InventoryServiceProvider::class,
    FlipperBox\MechanicPanel\Providers\MechanicPanelServiceProvider::class,
    FlipperBox\Scheduling\Providers\SchedulingServiceProvider::class,
    FlipperBox\WorkManagement\Providers\WorkManagementServiceProvider::class,
];
</file>

<file path="resources/js/Components/Sidebar.vue">
<script setup>
import { Link, usePage } from '@inertiajs/vue3';
import ApplicationLogo from '@/Components/ApplicationLogo.vue';
import { computed } from 'vue';

const page = usePage();
const user = page.props.auth.user;

const dashboardRoute = computed(() => {
    if (user.permissions.includes('ver mis vehiculos')) {
        return 'cliente.dashboard';
    }
    if (user.permissions.includes('gestionar ordenes de trabajo') && !user.permissions.includes('crear usuarios')) {
        return 'mecanico.dashboard';
    }
    return 'dashboard';
});

const navigationLinks = computed(() => [
    { name: 'Dashboard', href: route(dashboardRoute.value), permission: null },
    { name: 'Clientes', href: route('clientes.index'), permission: 'ver clientes' },
    { name: 'Productos', href: route('inventario.products.index'), permission: 'ver inventario' },
    { name: 'Servicios', href: route('services.index'), permission: 'ver servicios' },
    { name: 'Proveedores', href: route('inventario.suppliers.index'), permission: 'ver proveedores' },
    { name: 'Órdenes de Trabajo', href: route('work-orders.index'), permission: 'ver ordenes de trabajo' },
    { name: 'Gestión de Cupos', href: route('admin.scheduling.capacities.index'), permission: 'gestionar cupos' },
    { name: 'Mis Vehículos', href: route('cliente.vehiculos.index'), permission: 'ver mis vehiculos' },
    { name: 'Solicitar Reserva', href: route('cliente.reservations.index'), permission: 'solicitar reserva' },
    {
        name: 'Gestión de Reservas',
        href: route('admin.scheduling.reservations.index'),
        permission: 'gestionar reservas',
    },
]);

const can = (permission) => {
    if (!permission) return true;
    return user.permissions.includes(permission);
};
</script>

<template>
    <div
        class="flex flex-col h-full py-6 px-4 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transition-colors duration-300"
    >
        <!-- Logo -->
        <div class="flex items-center justify-center mb-8">
            <Link :href="route(dashboardRoute)">
                <ApplicationLogo class="block h-12 w-auto" />
            </Link>
        </div>

        <!-- Links de Navegación -->
        <nav class="flex-1 space-y-1">
            <template v-for="link in navigationLinks" :key="link.name">
                <Link
                    v-if="can(link.permission)"
                    :href="link.href"
                    :class="{
                        'bg-blue-50 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border-l-4 border-blue-600':
                            $page.url.startsWith(link.href.substring(link.href.lastIndexOf('/'))),
                        'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-200':
                            !$page.url.startsWith(link.href.substring(link.href.lastIndexOf('/'))),
                    }"
                    class="flex items-center px-4 py-3 text-sm font-medium rounded-md transition-colors duration-200 group"
                >
                    <span class="truncate">{{ link.name }}</span>
                </Link>
            </template>
        </nav>
    </div>
</template>
</file>

<file path="database/seeders/DemoSeeder.php">
<?php

namespace Database\Seeders;

use App\Models\User;
use FlipperBox\Crm\Models\Vehiculo;
use FlipperBox\Inventory\Models\Product;
use FlipperBox\Inventory\Models\Supplier;
use FlipperBox\WorkManagement\Models\Service;
use FlipperBox\WorkManagement\Models\WorkOrder;
use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Permission;
use Spatie\Permission\Models\Role;
use Spatie\Permission\PermissionRegistrar;

class DemoSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Resetear roles y permisos cacheados para evitar problemas de caché
        app()[PermissionRegistrar::class]->forgetCachedPermissions();

        // Definimos el guard explícitamente para asegurar la consistencia
        $guard = 'web';

        // --- CREACIÓN DE PERMISOS ---
        $permissions = [
            'ver clientes',
            'crear clientes',
            'editar clientes',
            'eliminar clientes',
            'crear vehiculos',
            'editar vehiculos',
            'eliminar vehiculos',
            'ver inventario',
            'gestionar inventario',
            'ver proveedores',
            'gestionar proveedores',
            'ver ordenes de trabajo',
            'gestionar ordenes de trabajo',
            'ver cupos',
            'gestionar cupos',
            'ver reservas',
            'gestionar reservas',
            'ver mis vehiculos',
            'solicitar reserva',
            'ver servicios',
            'gestionar servicios',
        ];

        foreach ($permissions as $permission) {
            Permission::create(['name' => $permission, 'guard_name' => $guard]);
        }

        // --- CREACIÓN DE ROLES ---
        $adminRole = Role::create(['name' => 'Admin', 'guard_name' => $guard]);
        $mecanicoRole = Role::create(['name' => 'Mecanico', 'guard_name' => $guard]);
        $clienteRole = Role::create(['name' => 'Cliente', 'guard_name' => $guard]);

        // --- ASIGNACIÓN DE PERMISOS A ROLES ---

        // Usamos Permission::all() y luego removemos los permisos del cliente
        $todosLosPermisos = Permission::all();

        // Admin: todos los permisos EXCEPTO los del cliente
        $permisosAdmin = $todosLosPermisos->reject(function ($permiso) {
            return in_array($permiso->name, ['ver mis vehiculos', 'solicitar reserva']);
        });
        $adminRole->givePermissionTo($permisosAdmin);

        // Mecánico: permisos específicos
        $mecanicoRole->givePermissionTo(['ver clientes', 'ver inventario', 'ver ordenes de trabajo']);

        // Cliente: solo sus permisos específicos
        $clienteRole->givePermissionTo(['ver mis vehiculos', 'solicitar reserva']);

        // --- CREACIÓN DE USUARIOS DE PRUEBA ---
        $adminUser = User::factory()->create([
            'name' => 'Administrador',
            'apellido' => 'Flipper',
            'email' => 'admin@flipperbox.com',
        ]);
        $adminUser->assignRole($adminRole);

        $mecanicoUser = User::factory()->create([
            'name' => 'Mecánico',
            'apellido' => 'de Prueba',
            'email' => 'mecanico@flipperbox.com',
        ]);
        $mecanicoUser->assignRole($mecanicoRole);

        // --- REFACTORIZACIÓN: CREACIÓN DE CLIENTES (COMO USUARIOS) Y VEHÍCULOS ---
        User::factory(50)
            ->create()
            ->each(function ($user) use ($clienteRole) {
                $user->assignRole($clienteRole);
                $user->vehiculos()->saveMany(
                    Vehiculo::factory(fake()->numberBetween(1, 3))->make()
                );
            });

        // --- INVENTARIO REAL ---
        // 1. Creamos los Proveedores
        $hasting = Supplier::create(['name' => 'HASTING', 'contact_person' => 'Ventas Resistencia']);
        $wurth = Supplier::create(['name' => 'WURTH', 'contact_person' => 'Vendedor Juan Perez']);
        $indeser = Supplier::create(['name' => 'INDESER', 'contact_person' => 'Oficina Santa Fe']);

        // 2. Creamos los Productos
        $productosData = [
            ['name' => 'Filtro Aceite VW Gol/Trend/Fox', 'sku' => 'J3393PA', 'cost' => 85.00, 'iva_percentage' => 21, 'profit_margin' => 40, 'current_stock' => 20, 'min_threshold' => 5, 'supplier' => $hasting, 'supplier_cost' => 80.00],
            ['name' => 'Filtro Aire Renault Logan 1.6 8v', 'sku' => 'J3605PA', 'cost' => 100.00, 'iva_percentage' => 21, 'profit_margin' => 40, 'current_stock' => 15, 'min_threshold' => 5, 'supplier' => $hasting, 'supplier_cost' => 95.00],
            ['name' => 'Abrazadera Zincada 8x12x9', 'sku' => 'WURTH-ABZ-01', 'cost' => 5.50, 'iva_percentage' => 21, 'profit_margin' => 50, 'current_stock' => 100, 'min_threshold' => 20, 'supplier' => $wurth, 'supplier_cost' => 5.00],
            ['name' => 'Desengrasante 5Lts', 'sku' => 'IND-DEG-05', 'cost' => 350.00, 'iva_percentage' => 21, 'profit_margin' => 35, 'current_stock' => 10, 'min_threshold' => 2, 'supplier' => $indeser, 'supplier_cost' => 350.00],
        ];

        foreach ($productosData as $data) {
            $costWithIva = $data['cost'] * (1 + ($data['iva_percentage'] / 100));
            $price = $costWithIva * (1 + ($data['profit_margin'] / 100));

            $product = Product::create([
                'name' => $data['name'], 'sku' => $data['sku'], 'cost' => $data['cost'], 'iva_percentage' => $data['iva_percentage'],
                'profit_margin' => $data['profit_margin'], 'price' => round($price, 2), 'current_stock' => $data['current_stock'], 'min_threshold' => $data['min_threshold'],
            ]);

            if (isset($data['supplier'])) {
                $product->suppliers()->attach($data['supplier']->id, ['cost' => $data['supplier_cost']]);
            }
        }

        // --- SERVICIOS ---
        $servicioCambioAceite = Service::create(['name' => 'Cambio de Aceite y Filtros', 'price' => 50.00]);
        Service::create(['name' => 'Diagnóstico General', 'price' => 30.00]);
        Service::create(['name' => 'Reparación de Tren Delantero', 'price' => 150.00]);

        // --- ÓRDENES DE TRABAJO DE PRUEBA ---
        $vehiculos = Vehiculo::all();
        $mecanico = User::where('email', 'mecanico@flipperbox.com')->first();
        $filtroAceite = Product::where('sku', 'J3393PA')->first();

        if ($vehiculos->count() > 0 && $mecanico && $filtroAceite && $servicioCambioAceite) {
            // --- Orden Completada (con ítems) ---
            $ordenCompletada = WorkOrder::create([
                'vehicle_id' => $vehiculos->random()->id,
                'mechanic_id' => $mecanico->id,
                'status' => 'Completada',
                'description' => 'Servicio completo de 50.000km.',
                'completion_date' => now(),
            ]);

            $ordenCompletada->products()->attach($filtroAceite->id, ['quantity' => 1, 'unit_price' => $filtroAceite->price]);
            $ordenCompletada->services()->attach($servicioCambioAceite->id, ['price' => $servicioCambioAceite->price]);

            $total = ($filtroAceite->price * 1) + $servicioCambioAceite->price;
            $ordenCompletada->update(['total' => $total]);

            // --- Orden en Progreso ---
            WorkOrder::create(['vehicle_id' => $vehiculos->random()->id, 'mechanic_id' => $mecanico->id, 'status' => 'En Progreso', 'description' => 'Revisión de tren delantero, ruido al girar.']);
            // --- Orden Pendiente ---
            WorkOrder::create(['vehicle_id' => $vehiculos->random()->id, 'status' => 'Pendiente', 'description' => 'Falla en el arranque, posible problema eléctrico.']);
        }
    }
}
</file>

<file path="resources/js/Layouts/AuthenticatedLayout.vue">
<script setup>
import { ref, computed } from 'vue';
import ApplicationLogo from '@/Components/ApplicationLogo.vue';
import Dropdown from '@/Components/Dropdown.vue';
import DropdownLink from '@/Components/DropdownLink.vue';
import ResponsiveNavLink from '@/Components/ResponsiveNavLink.vue';
import { Link, usePage } from '@inertiajs/vue3';
import Sidebar from '@/Components/Sidebar.vue';
import FlashMessage from '@/Components/FlashMessage.vue';
import NotificationBell from '@/Components/NotificationBell.vue';
import ChatbotWidget from '@/Components/ChatbotWidget.vue';
import { useDarkMode } from '@/Composables/useDarkMode';

const { isDark, toggleDarkMode } = useDarkMode();

const showingNavigationDropdown = ref(false);

const page = usePage();
const user = page.props.auth.user;

// Lógica para determinar el dashboard correcto
const dashboardRouteName = computed(() => {
    if (user.permissions.includes('ver mis vehiculos')) return 'cliente.dashboard';
    if (user.permissions.includes('gestionar ordenes de trabajo') && !user.permissions.includes('crear usuarios'))
        return 'mecanico.dashboard';
    return 'dashboard';
});

const navigationLinks = computed(() => [
    { name: 'Dashboard', routeName: dashboardRouteName.value, permission: null },
    { name: 'Clientes', routeName: 'clientes.index', permission: 'ver clientes' },
    { name: 'Productos', routeName: 'inventario.products.index', permission: 'ver inventario' },
    { name: 'Servicios', routeName: 'services.index', permission: 'ver servicios' },
    { name: 'Proveedores', routeName: 'inventario.suppliers.index', permission: 'ver proveedores' },
    { name: 'Órdenes de Trabajo', routeName: 'work-orders.index', permission: 'ver ordenes de trabajo' },
    { name: 'Gestión de Cupos', routeName: 'admin.scheduling.capacities.index', permission: 'gestionar cupos' },
    { name: 'Mis Vehículos', routeName: 'cliente.vehiculos.index', permission: 'ver mis vehiculos' },
    { name: 'Solicitar Reserva', routeName: 'cliente.reservations.index', permission: 'solicitar reserva' },
    { name: 'Gestión de Reservas', routeName: 'admin.scheduling.reservations.index', permission: 'gestionar reservas' },
]);

const can = (permission) => {
    if (!permission) return true;
    return user.permissions.includes(permission);
};
</script>

<template>
    <!-- Fondo base adaptable: gris claro o gris muy oscuro -->
    <div class="flex h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
        <!-- Sidebar para Escritorio -->
        <aside
            class="z-20 h-full w-64 overflow-y-auto bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 hidden md:block transition-colors duration-300"
        >
            <Sidebar />
        </aside>

        <!-- Menú Hamburguesa para Móvil -->
        <div
            v-show="showingNavigationDropdown"
            class="fixed inset-0 z-20 bg-black/50 backdrop-blur-sm md:hidden"
            @click="showingNavigationDropdown = false"
        ></div>

        <aside
            v-show="showingNavigationDropdown"
            class="fixed inset-y-0 z-30 flex-shrink-0 w-64 overflow-y-auto bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 md:hidden transition-colors duration-300"
        >
            <div class="py-4 flex justify-center border-b border-gray-200 dark:border-gray-700">
                <Link :href="route(dashboardRouteName)">
                    <ApplicationLogo class="block h-12 w-auto" />
                </Link>
            </div>

            <div class="space-y-1 pb-3 pt-2 px-2">
                <template v-for="link in navigationLinks" :key="link.name">
                    <ResponsiveNavLink
                        v-if="can(link.permission)"
                        :href="route(link.routeName)"
                        :active="route().current(link.routeName)"
                    >
                        {{ link.name }}
                    </ResponsiveNavLink>
                </template>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 pb-1 pt-4 px-4">
                <div class="text-base font-medium text-gray-800 dark:text-gray-200">
                    {{ $page.props.auth.user.name }}
                </div>
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
                    {{ $page.props.auth.user.email }}
                </div>

                <div class="mt-4 space-y-2">
                    <ResponsiveNavLink :href="route('profile.edit')"> Perfil </ResponsiveNavLink>
                    <ResponsiveNavLink :href="route('logout')" method="post" as="button">
                        Cerrar Sesión
                    </ResponsiveNavLink>
                </div>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex flex-col flex-1 w-full overflow-hidden">
            <!-- Barra de Navegación Superior -->
            <header
                class="z-10 py-3 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 transition-colors duration-300"
            >
                <div class="container flex items-center justify-between h-full px-6 mx-auto">
                    <!-- Botón Hamburguesa -->
                    <button
                        class="p-2 mr-5 -ml-1 rounded-md md:hidden text-gray-500 dark:text-gray-200 focus:outline-none hover:bg-gray-100 dark:hover:bg-gray-700"
                        @click="showingNavigationDropdown = !showingNavigationDropdown"
                    >
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                fill-rule="evenodd"
                                d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </button>

                    <div class="flex-1"></div>

                    <!-- Iconos de la derecha -->
                    <div class="flex items-center space-x-4">
                        <!-- BOTÓN TOGGLE DARK MODE -->
                        <button
                            class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition text-gray-600 dark:text-gray-300"
                            :title="isDark ? 'Cambiar a modo Claro' : 'Cambiar a modo Oscuro'"
                            @click="toggleDarkMode"
                        >
                            <svg
                                v-if="isDark"
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                                />
                            </svg>
                            <svg
                                v-else
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                                />
                            </svg>
                        </button>

                        <NotificationBell :initial-notifications="$page.props.notifications || []" />

                        <div class="hidden sm:flex sm:items-center">
                            <div class="relative">
                                <Dropdown align="right" width="48">
                                    <template #trigger>
                                        <button
                                            class="flex items-center text-sm font-medium text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white focus:outline-none transition duration-150 ease-in-out"
                                        >
                                            <div>{{ $page.props.auth.user.name }}</div>
                                            <div class="ml-1">
                                                <svg
                                                    class="fill-current h-4 w-4"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 20 20"
                                                >
                                                    <path
                                                        fill-rule="evenodd"
                                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                        clip-rule="evenodd"
                                                    />
                                                </svg>
                                            </div>
                                        </button>
                                    </template>
                                    <template #content>
                                        <DropdownLink :href="route('profile.edit')"> Perfil </DropdownLink>
                                        <DropdownLink :href="route('logout')" method="post" as="button">
                                            Cerrar Sesión
                                        </DropdownLink>
                                    </template>
                                </Dropdown>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <FlashMessage />

            <!-- Contenido con scroll -->
            <main class="h-full overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-300">
                <!-- Header de Página (Título) -->
                <div v-if="$slots.header" class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                        <slot name="header" />
                    </h2>
                </div>

                <slot />
            </main>
        </div>
        <ChatbotWidget />
    </div>
</template>
</file>

</files>
